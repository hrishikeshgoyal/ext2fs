cscope 15 $HOME/netbsd/src/sys/ufs/ext2fs               0000192564
	@ext2fs.h

62 
	#fsbtodb
(
fs
, 
b
Ë((
daddr_t
)(bË<< (fs)->
e2fs_fsbtodb
)

	)

63 
	#lblkno
(
fs
, 
loc
) \

64 ((
loc
Ë>> (
fs
->
e2fs_bshi·
))

	)

65 
	#blksize
(
fs
, 
ù
, 
lbn
Ë((fs)->
e2fs_bsize
)

	)

67 #i‚de‡
_UFS_EXT2FS_EXT2FS_H_


68 
	#_UFS_EXT2FS_EXT2FS_H_


	)

70 
	~<sys/bsw≠.h
>

87 
	#BBSIZE
 1024

	)

88 
	#SBSIZE
 1024

	)

89 
	#BBOFF
 ((
off_t
)(0))

	)

90 
	#SBOFF
 ((
off_t
)(
BBOFF
 + 
BBSIZE
))

	)

91 
	#BBLOCK
 ((
daddr_t
)(0))

	)

92 
	#SBLOCK
 ((
daddr_t
)(
BBLOCK
 + 
BBSIZE
 / 
DEV_BSIZE
))

	)

106 
	#LOG_MINBSIZE
 10

	)

107 
	#MINBSIZE
 (1 << 
LOG_MINBSIZE
)

	)

114 
	#MAXMNTLEN
 512

	)

128 
	#MINFREE
 5

	)

133 
	sext2fs
 {

134 
uöt32_t
 
	me2fs_icou¡
;

135 
uöt32_t
 
	me2fs_bcou¡
;

136 
uöt32_t
 
	me2fs_rbcou¡
;

137 
uöt32_t
 
	me2fs_fbcou¡
;

138 
uöt32_t
 
	me2fs_ficou¡
;

139 
uöt32_t
 
	me2fs_fú°_dblock
;

140 
uöt32_t
 
	me2fs_log_bsize
;

141 
uöt32_t
 
	me2fs_fsize
;

142 
uöt32_t
 
	me2fs_bpg
;

143 
uöt32_t
 
	me2fs_Âg
;

144 
uöt32_t
 
	me2fs_ùg
;

145 
uöt32_t
 
	me2fs_mtime
;

146 
uöt32_t
 
	me2fs_wtime
;

147 
uöt16_t
 
	me2fs_m¡_cou¡
;

148 
uöt16_t
 
	me2fs_max_m¡_cou¡
;

149 
uöt16_t
 
	me2fs_magic
;

150 
uöt16_t
 
	me2fs_°©e
;

151 
uöt16_t
 
	me2fs_beh
;

152 
uöt16_t
 
	me2fs_möªv
;

153 
uöt32_t
 
	me2fs_œ°fsck
;

154 
uöt32_t
 
	me2fs_fsckötv
;

155 
uöt32_t
 
	me2fs_¸ót‹
;

156 
uöt32_t
 
	me2fs_ªv
;

157 
uöt16_t
 
	me2fs_ruid
;

158 
uöt16_t
 
	me2fs_rgid
;

160 
uöt32_t
 
	me2fs_fú°_öo
;

161 
uöt16_t
 
	me2fs_öode_size
;

162 
uöt16_t
 
	me2fs_block_group_ƒ
;

163 
uöt32_t
 
	me2fs_„©uªs_com∑t
;

164 
uöt32_t
 
	me2fs_„©uªs_öcom∑t
;

165 
uöt32_t
 
	me2fs_„©uªs_rocom∑t
;

166 
uöt8_t
 
	me2fs_uuid
[16];

167 
	me2fs_v«me
[16];

168 
	me2fs_fsm¡
[64];

169 
uöt32_t
 
	me2fs_Ægo
;

170 
uöt8_t
 
	me2fs_¥óŒoc
;

171 
uöt8_t
 
	me2fs_dú_¥óŒoc
;

172 
uöt16_t
 
	me2fs_ª£rved_ngdb
;

176 
	me3fs_jou∫Æ_uuid
[16];

177 
uöt32_t
 
	me3fs_jou∫Æ_öum
;

178 
uöt32_t
 
	me3fs_jou∫Æ_dev
;

179 
uöt32_t
 
	me3fs_œ°_‹ph™
;

180 
uöt32_t
 
	me3fs_hash_£ed
[4];

181 
	me3fs_def_hash_vîsi⁄
;

182 
	me3fs_j∆_backup_ty≥
;

183 
uöt16_t
 
	me3fs_desc_size
;

184 
uöt32_t
 
	me3fs_deÁu…_mou¡_›ts
;

185 
uöt32_t
 
	me3fs_fú°_mëa_bg
;

186 
uöt32_t
 
	me3fs_mkfs_time
;

187 
uöt32_t
 
	me3fs_j∆_blks
[17];

188 
uöt32_t
 
	me4fs_bcou¡_hi
;

189 
uöt32_t
 
	me4fs_rbcou¡_hi
;

190 
uöt32_t
 
	me4fs_fbcou¡_hi
;

191 
uöt16_t
 
	me4fs_mö_exåa_isize
;

192 
uöt16_t
 
	me4fs_w™t_exåa_isize
;

193 
uöt32_t
 
	me4fs_Êags
;

194 
uöt16_t
 
	me4fs_øid_°ride
;

195 
uöt16_t
 
	me4fs_mmpötv
;

196 
uöt64_t
 
	me4fs_mmpblk
;

197 
uöt32_t
 
	me4fs_øid_°rùe_wid
;

198 
uöt8_t
 
	me4fs_log_gpf
;

199 
uöt8_t
 
	me4fs_chksum_ty≥
;

200 
uöt8_t
 
	me4fs_í¸y±
;

201 
uöt8_t
 
	me4fs_ª£rved_∑d
;

202 
uöt64_t
 
	me4fs_kbyãs_wrôãn
;

203 
uöt32_t
 
	me4fs_¢≠öum
;

204 
uöt32_t
 
	me4fs_¢≠id
;

205 
uöt64_t
 
	me4fs_¢≠rbcou¡
;

206 
uöt32_t
 
	me4fs_¢≠li°
;

207 
uöt32_t
 
	me4fs_îrcou¡
;

208 
uöt32_t
 
	me4fs_fú°_îπime
;

209 
uöt32_t
 
	me4fs_fú°_îröo
;

210 
uöt64_t
 
	me4fs_fú°_îrblk
;

211 
uöt8_t
 
	me4fs_fú°_îrfunc
[32];

212 
uöt32_t
 
	me4fs_fú°_îæöe
;

213 
uöt32_t
 
	me4fs_œ°_îπime
;

214 
uöt32_t
 
	me4fs_œ°_îröo
;

215 
uöt32_t
 
	me4fs_œ°_îæöe
;

216 
uöt64_t
 
	me4fs_œ°_îrblk
;

217 
uöt8_t
 
	me4fs_œ°_îrfunc
[32];

218 
uöt8_t
 
	me4fs_mou¡_›ts
[64];

219 
uöt32_t
 
	me4fs_u§quŸa_öum
;

220 
uöt32_t
 
	me4fs_gΩquŸa_öum
;

221 
uöt32_t
 
	me4fs_ovîhód_˛u°îs
;

222 
uöt32_t
 
	me4fs_backup_bgs
[2];

223 
uöt8_t
 
	me4fs_í¸y±_Ægos
[4];

224 
uöt8_t
 
	me4fs_í¸y±_pw_ß…
[16];

225 
uöt32_t
 
	me4fs_Õf_öo
;

226 
uöt32_t
 
	me4fs_¥oj_quŸa_öum
;

227 
uöt32_t
 
	me4fs_chksum_£ed
;

228 
uöt32_t
 
	me4fs_ª£rved
[98];

229 
uöt32_t
 
	me4fs_sbchksum
;

234 
	sm_ext2fs
 {

235 
ext2fs
 
	me2fs
;

236 
u_ch¨
 
	me2fs_fsm¡
[
MAXMNTLEN
];

237 
öt8_t
 
	me2fs_r⁄ly
;

238 
öt8_t
 
	me2fs_fmod
;

239 
öt32_t
 
	me2fs_bsize
;

240 
öt32_t
 
	me2fs_bshi·
;

241 
öt32_t
 
	me2fs_bmask
;

242 
öt64_t
 
	me2fs_qbmask
;

243 
öt32_t
 
	me2fs_fsbtodb
;

244 
öt32_t
 
	me2fs_ncg
;

245 
öt32_t
 
	me2fs_ngdb
;

246 
öt32_t
 
	me2fs_ùb
;

247 
öt32_t
 
	me2fs_ôpg
;

248 
ext2_gd
 *
	me2fs_gd
;

256 
	#E2FS_MAGIC
 0xef53

	)

257 
	#E2FS_REV0
 0

	)

258 
	#E2FS_REV1
 1

	)

261 
	#EXT2F_COMPAT_PREALLOC
 0x0001

	)

262 
	#EXT2F_COMPAT_AFS
 0x0002

	)

263 
	#EXT2F_COMPAT_HASJOURNAL
 0x0004

	)

264 
	#EXT2F_COMPAT_EXTATTR
 0x0008

	)

265 
	#EXT2F_COMPAT_RESIZE
 0x0010

	)

266 
	#EXT2F_COMPAT_DIRHASHINDEX
 0x0020

	)

267 
	#EXT2F_COMPAT_BITS
 \

274 "\01COMPAT_PREALLOC"

	)

276 
	#EXT2F_ROCOMPAT_SPARSESUPER
 0x0001

	)

277 
	#EXT2F_ROCOMPAT_LARGEFILE
 0x0002

	)

278 
	#EXT2F_ROCOMPAT_BTREE_DIR
 0x0004

	)

279 
	#EXT2F_ROCOMPAT_HUGE_FILE
 0x0008

	)

280 
	#EXT2F_ROCOMPAT_GDT_CSUM
 0x0010

	)

281 
	#EXT2F_ROCOMPAT_DIR_NLINK
 0x0020

	)

282 
	#EXT2F_ROCOMPAT_EXTRA_ISIZE
 0x0040

	)

283 
	#EXT2F_ROCOMPAT_BITS
 \

291 "\01ROCOMPAT_SPARSESUPER"

	)

293 
	#EXT2F_INCOMPAT_COMP
 0x0001

	)

294 
	#EXT2F_INCOMPAT_FTYPE
 0x0002

	)

295 
	#EXT2F_INCOMPAT_REPLAY_JOURNAL
 0x0004

	)

296 
	#EXT2F_INCOMPAT_USES_JOURNAL
 0x0008

	)

297 
	#EXT2F_INCOMPAT_META_BG
 0x0010

	)

298 
	#EXT2F_INCOMPAT_EXTENTS
 0x0040

	)

299 
	#EXT2F_INCOMPAT_64BIT
 0x0080

	)

300 
	#EXT2F_INCOMPAT_MMP
 0x0100

	)

301 
	#EXT2F_INCOMPAT_FLEX_BG
 0x0200

	)

302 
	#EXT2F_INCOMPAT_BITS
 \

312 "\01INCOMPAT_COMP"

	)

327 
	#EXT2F_COMPAT_SUPP
 0x0000

	)

328 
	#EXT2F_ROCOMPAT_SUPP
 (
EXT2F_ROCOMPAT_SPARSESUPER
 \

329 | 
EXT2F_ROCOMPAT_LARGEFILE
 \

330 | 
EXT2F_ROCOMPAT_HUGE_FILE
)

	)

333 
	#EXT2F_INCOMPAT_SUPP
 (
EXT2F_INCOMPAT_FTYPE
 | 
EXT2F_INCOMPAT_EXTENTS
 )

	)

340 
	#E2FS_BEH_CONTINUE
 1

	)

341 
	#E2FS_BEH_READONLY
 2

	)

342 
	#E2FS_BEH_PANIC
 3

	)

343 
	#E2FS_BEH_DEFAULT
 
E2FS_BEH_CONTINUE


	)

348 
	#E2FS_OS_LINUX
 0

	)

349 
	#E2FS_OS_HURD
 1

	)

350 
	#E2FS_OS_MASIX
 2

	)

351 
	#E2FS_OS_FREEBSD
 3

	)

352 
	#E2FS_OS_LITES
 4

	)

357 
	#E2FS_ISCLEAN
 0x01

	)

358 
	#E2FS_ERRORS
 0x02

	)

362 
	sext2_gd
 {

363 
uöt32_t
 
	mext2bgd_b_bôm≠
;

364 
uöt32_t
 
	mext2bgd_i_bôm≠
;

365 
uöt32_t
 
	mext2bgd_i_èbÀs
;

366 
uöt16_t
 
	mext2bgd_nb‰ì
;

367 
uöt16_t
 
	mext2bgd_ni‰ì
;

368 
uöt16_t
 
	mext2bgd_ndús
;

369 
uöt16_t
 
	mª£rved
;

370 
uöt32_t
 
	mª£rved2
[3];

380 
__ölöe
 
	$cg_has_sb
(Ë
__unu£d
;

381 
__ölöe
 

382 
	$cg_has_sb
(
i
)

384 
a3
, 
a5
, 
a7
;

386 i‡(
i
 == 0 || i == 1)

388 
a3
 = 3, 
a5
 = 5, 
a7
 = 7;

389 
a3
 <
i
 || 
a5
 <ò|| 
a7
 <= i;

390 
a3
 *3, 
a5
 *5, 
a7
 *= 7)

391 i‡(
i
 =
a3
 || i =
a5
 || i =
a7
)

394 
	}
}

400 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


401 
	#h2fs16
(
x
Ë(x)

	)

402 
	#h2fs32
(
x
Ë(x)

	)

403 
	#h2fs64
(
x
Ë(x)

	)

404 
	#fs2h16
(
x
Ë(x)

	)

405 
	#fs2h32
(
x
Ë(x)

	)

406 
	#fs2h64
(
x
Ë(x)

	)

407 
	#e2fs_sblﬂd
(
ﬁd
, 
√w
Ë
	`mem˝y
(“ew), (ﬁd), 
SBSIZE
);

	)

408 
	#e2fs_cglﬂd
(
ﬁd
, 
√w
, 
size
Ë
	`mem˝y
(“ew), (ﬁd), (size));

	)

409 
	#e2fs_sbßve
(
ﬁd
, 
√w
Ë
	`mem˝y
(“ew), (ﬁd), 
SBSIZE
);

	)

410 
	#e2fs_cgßve
(
ﬁd
, 
√w
, 
size
Ë
	`mem˝y
(“ew), (ﬁd), (size));

	)

412 
e2fs_sb_bsw≠
(
ext2fs
 *, ext2fs *);

413 
e2fs_cg_bsw≠
(
ext2_gd
 *, ext2_gd *, );

414 
	#h2fs16
(
x
Ë
	`bsw≠16
(x)

	)

415 
	#h2fs32
(
x
Ë
	`bsw≠32
(x)

	)

416 
	#h2fs64
(
x
Ë
	`bsw≠64
(x)

	)

417 
	#fs2h16
(
x
Ë
	`bsw≠16
(x)

	)

418 
	#fs2h32
(
x
Ë
	`bsw≠32
(x)

	)

419 
	#fs2h64
(
x
Ë
	`bsw≠64
(x)

	)

420 
	#e2fs_sblﬂd
(
ﬁd
, 
√w
Ë
	`e2fs_sb_bsw≠
((ﬁd), (√w))

	)

421 
	#e2fs_cglﬂd
(
ﬁd
, 
√w
, 
size
Ë
	`e2fs_cg_bsw≠
((ﬁd), (√w), (size));

	)

422 
	#e2fs_sbßve
(
ﬁd
, 
√w
Ë
	`e2fs_sb_bsw≠
((ﬁd), (√w))

	)

423 
	#e2fs_cgßve
(
ﬁd
, 
√w
, 
size
Ë
	`e2fs_cg_bsw≠
((ﬁd), (√w), (size));

	)

430 
	#EXT2_FSBTODB
(
fs
, 
b
Ë((bË<< (fs)->
e2fs_fsbtodb
)

	)

431 
	#EXT2_DBTOFSB
(
fs
, 
b
Ë((bË>> (fs)->
e2fs_fsbtodb
)

	)

439 
	#öo_to_cg
(
fs
, 
x
Ë(((xË- 1Ë/ (fs)->
e2fs
.
e2fs_ùg
)

	)

440 
	#öo_to_fsba
(
fs
, 
x
) \

441 ((
fs
)->
e2fs_gd
[
	`öo_to_cg
((fs), (
x
))].
ext2bgd_i_èbÀs
 + \

442 (((
x
Ë- 1Ë% (
fs
)->
e2fs
.
e2fs_ùg
Ë/ (fs)->
e2fs_ùb
)

	)

443 
	#öo_to_fsbo
(
fs
, 
x
Ë(((xË- 1Ë% (fs)->
e2fs_ùb
)

	)

449 
	#dtog
(
fs
, 
d
Ë(((dË- (fs)->
e2fs
.
e2fs_fú°_dblock
Ë/ (fs)->e2fs.
e2fs_Âg
)

	)

450 
	#dtogd
(
fs
, 
d
) \

451 (((
d
Ë- (
fs
)->
e2fs
.
e2fs_fú°_dblock
Ë% (fs)->e2fs.
e2fs_Âg
)

	)

458 
	#ext2_blkoff
(
fs
, 
loc
) \

459 ((
loc
Ë& (
fs
)->
e2fs_qbmask
)

	)

460 
	#ext2_lblktosize
(
fs
, 
blk
) \

461 ((
blk
Ë<< (
fs
)->
e2fs_bshi·
)

	)

462 
	#ext2_lblkno
(
fs
, 
loc
) \

463 ((
loc
Ë>> (
fs
)->
e2fs_bshi·
)

	)

464 
	#ext2_blkroundup
(
fs
, 
size
) \

465 (((
size
Ë+ (
fs
)->
e2fs_qbmask
Ë& (fs)->
e2fs_bmask
)

	)

466 
	#ext2_‰agroundup
(
fs
, 
size
) \

467 (((
size
Ë+ (
fs
)->
e2fs_qbmask
Ë& (fs)->
e2fs_bmask
)

	)

472 
	#‰ì•a˚
(
fs
) \

473 ((
fs
)->
e2fs
.
e2fs_fbcou¡
 - (fs)->e2fs.
e2fs_rbcou¡
)

	)

478 
	#EXT2_NINDIR
(
fs
Ë((fs)->
e2fs_bsize
 / (
uöt32_t
))

	)

	@ext2fs_alloc.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_alloc.c,v 1.46 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/buf.h
>

68 
	~<sys/¥oc.h
>

69 
	~<sys/vnode.h
>

70 
	~<sys/mou¡.h
>

71 
	~<sys/kî√l.h
>

72 
	~<sys/sy¶og.h
>

73 
	~<sys/kauth.h
>

75 
	~<ufs/ufs/öode.h
>

76 
	~<ufs/ufs/ufs_exã∫.h
>

77 
	~<ufs/ufs/ufsmou¡.h
>

79 
	~<ufs/ext2fs/ext2fs.h
>

80 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

82 
u_l⁄g
 
	gext2gínumbî
;

84 
daddr_t
 
ext2fs_Æloccg
(
öode
 *, , daddr_t, );

85 
u_l⁄g
 
ext2fs_dú¥ef
(
m_ext2fs
 *);

86 
ext2fs_f£º
(
m_ext2fs
 *, 
u_öt
, const *);

87 
u_l⁄g
 
ext2fs_hashÆloc
(
öode
 *, , , ,

88 
	$daddr_t
 (*)(
öode
 *, , 
daddr_t
, ));

89 
daddr_t
 
	`ext2fs_nodóŒoccg
(
öode
 *, , daddr_t, );

90 
daddr_t
 
	`ext2fs_m≠£¨ch
(
m_ext2fs
 *, *, daddr_t);

110 
	$ext2fs_Æloc
(
öode
 *
ù
, 
daddr_t
 
lbn
, daddr_à
b¥ef
,

111 
kauth_¸ed_t
 
¸ed
, 
daddr_t
 *
b≈
)

113 
m_ext2fs
 *
fs
;

114 
daddr_t
 
bno
;

115 
cg
;

117 *
b≈
 = 0;

118 
fs
 = 
ù
->
i_e2fs
;

119 #ifde‡
DIAGNOSTIC


120 i‡(
¸ed
 =
NOCRED
)

121 
	`∑nic
("ext2fs_alloc: missing credential");

123 i‡(
fs
->
e2fs
.
e2fs_fbcou¡
 == 0)

124 
no•a˚
;

125 i‡(
	`kauth_auth‹ize_sy°em
(
¸ed
, 
KAUTH_SYSTEM_FS_RESERVEDSPACE
, 0, 
NULL
,

126 
NULL
, NULL) != 0 &&

127 
	`‰ì•a˚
(
fs
) <= 0)

128 
no•a˚
;

129 i‡(
b¥ef
 >
fs
->
e2fs
.
e2fs_bcou¡
)

130 
b¥ef
 = 0;

131 i‡(
b¥ef
 == 0)

132 
cg
 = 
	`öo_to_cg
(
fs
, 
ù
->
i_numbî
);

134 
cg
 = 
	`dtog
(
fs
, 
b¥ef
);

135 
bno
 = (
daddr_t
)
	`ext2fs_hashÆloc
(
ù
, 
cg
, 
b¥ef
, 
fs
->
e2fs_bsize
,

136 
ext2fs_Æloccg
);

137 i‡(
bno
 > 0) {

138 
	`ext2fs_£äblock
(
ù
, 
	`ext2fs_nblock
(ùË+ 
	`btodb
(
fs
->
e2fs_bsize
));

139 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

140 *
b≈
 = 
bno
;

143 
no•a˚
:

144 
	`ext2fs_f£º
(
fs
, 
	`kauth_¸ed_gëeuid
(
¸ed
), "file system full");

145 
	`u¥ötf
("\n%s: wrôêÁûed, fûêsy°em i†fuŒ\n", 
fs
->
e2fs_fsm¡
);

146  (
ENOSPC
);

147 
	}
}

165 
	$ext2fs_vÆloc
(
vnode
 *
pvp
, 
mode
, 
kauth_¸ed_t
 
¸ed
,

166 
vnode
 **
vµ
)

168 
öode
 *
pù
;

169 
m_ext2fs
 *
fs
;

170 
öode
 *
ù
;

171 
öo_t
 
öo
, 
ùªf
;

172 
cg
, 
îr‹
;

174 *
vµ
 = 
NULL
;

175 
pù
 = 
	`VTOI
(
pvp
);

176 
fs
 = 
pù
->
i_e2fs
;

177 i‡(
fs
->
e2fs
.
e2fs_ficou¡
 == 0)

178 
noöodes
;

180 i‡((
mode
 & 
IFMT
Ë=
IFDIR
)

181 
cg
 = 
	`ext2fs_dú¥ef
(
fs
);

183 
cg
 = 
	`öo_to_cg
(
fs
, 
pù
->
i_numbî
);

184 
ùªf
 = 
cg
 * 
fs
->
e2fs
.
e2fs_ùg
 + 1;

185 
öo
 = (
öo_t
)
	`ext2fs_hashÆloc
(
pù
, 
cg
, ()
ùªf
, 
mode
, 
ext2fs_nodóŒoccg
);

186 i‡(
öo
 == 0)

187 
noöodes
;

188 
îr‹
 = 
	`VFS_VGET
(
pvp
->
v_mou¡
, 
öo
, 
vµ
);

189 i‡(
îr‹
) {

190 
	`ext2fs_v‰ì
(
pvp
, 
öo
, 
mode
);

191  (
îr‹
);

193 
ù
 = 
	`VTOI
(*
vµ
);

194 i‡(
ù
->
i_e2fs_mode
 && ip->
i_e2fs_∆ök
 != 0) {

195 
	`¥ötf
("mode = 0%o,Çlinks %d, inum = %llu, fs = %s\n",

196 
ù
->
i_e2fs_mode
, ip->
i_e2fs_∆ök
,

197 ()
ù
->
i_numbî
, 
fs
->
e2fs_fsm¡
);

198 
	`∑nic
("ext2fs_valloc: dupálloc");

201 
	`mem£t
(
ù
->
i_dö
.
e2fs_dö
, 0, (
ext2fs_döode
));

206 i‡(++
ext2gínumbî
 < 
time_£c⁄d
)

207 
ext2gínumbî
 = 
time_£c⁄d
;

208 
ù
->
i_e2fs_gí
 = 
ext2gínumbî
;

210 
noöodes
:

211 
	`ext2fs_f£º
(
fs
, 
	`kauth_¸ed_gëeuid
(
¸ed
), "out of inodes");

212 
	`u¥ötf
("\n%s: cª©e/symlök faûed,Çÿöode†‰ì\n", 
fs
->
e2fs_fsm¡
);

213  (
ENOSPC
);

214 
	}
}

223 
u_l⁄g


224 
	$ext2fs_dú¥ef
(
m_ext2fs
 *
fs
)

226 
cg
, 
max•a˚
, 
möcg
, 
avgi‰ì
;

228 
avgi‰ì
 = 
fs
->
e2fs
.
e2fs_ficou¡
 / fs->
e2fs_ncg
;

229 
max•a˚
 = 0;

230 
möcg
 = -1;

231 
cg
 = 0; cg < 
fs
->
e2fs_ncg
; cg++)

232 i‡–
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
 >
avgi‰ì
) {

233 i‡(
möcg
 =-1 || 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
 > 
max•a˚
) {

234 
möcg
 = 
cg
;

235 
max•a˚
 = 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
;

238  
möcg
;

239 
	}
}

252 
daddr_t


253 
	$ext2fs_blk¥ef
(
öode
 *
ù
, 
daddr_t
 
lbn
, 
ödx
,

254 
öt32_t
 *
b≠
 )

256 
m_ext2fs
 *
fs
;

257 
cg
, 
i
;

259 
fs
 = 
ù
->
i_e2fs
;

265 i‡–
ù
->
i_e2fs_œ°_blk
 && 
lbn
 =ù->
i_e2fs_œ°_lblk
 + 1) {

266  
ù
->
i_e2fs_œ°_blk
 + 1;

274 i‡(
b≠
) {

275 
i
 = 
ödx
; i >= 0 ; i--) {

276 i‡(
b≠
[
i
]) {

277  
	`fs2h32
(
b≠
[
i
]) + 1;

284 
cg
 = 
	`öo_to_cg
(
fs
, 
ù
->
i_numbî
);

285  
fs
->
e2fs
.
e2fs_bpg
 * 
cg
 + fs->e2fs.
e2fs_fú°_dblock
 + 1;

286 
	}
}

296 
u_l⁄g


297 
	$ext2fs_hashÆloc
(
öode
 *
ù
, 
cg
, 
¥ef
, 
size
,

298 
	$daddr_t
 (*
Æloˇt‹
)(
öode
 *, , 
daddr_t
, ))

300 
m_ext2fs
 *
fs
;

301 
ªsu…
;

302 
i
, 
icg
 = 
cg
;

304 
fs
 = 
ù
->
i_e2fs
;

308 
ªsu…
 = (*
Æloˇt‹
)(
ù
, 
cg
, 
¥ef
, 
size
);

309 i‡(
ªsu…
)

310  (
ªsu…
);

314 
i
 = 1; i < 
fs
->
e2fs_ncg
; i *= 2) {

315 
cg
 +
i
;

316 i‡(
cg
 >
fs
->
e2fs_ncg
)

317 
cg
 -
fs
->
e2fs_ncg
;

318 
ªsu…
 = (*
Æloˇt‹
)(
ù
, 
cg
, 0, 
size
);

319 i‡(
ªsu…
)

320  (
ªsu…
);

327 
cg
 = (
icg
 + 2Ë% 
fs
->
e2fs_ncg
;

328 
i
 = 2; i < 
fs
->
e2fs_ncg
; i++) {

329 
ªsu…
 = (*
Æloˇt‹
)(
ù
, 
cg
, 0, 
size
);

330 i‡(
ªsu…
)

331  (
ªsu…
);

332 
cg
++;

333 i‡(
cg
 =
fs
->
e2fs_ncg
)

334 
cg
 = 0;

337 
	}
}

346 
daddr_t


347 
	$ext2fs_Æloccg
(
öode
 *
ù
, 
cg
, 
daddr_t
 
b¥ef
, 
size
)

349 
m_ext2fs
 *
fs
;

350 *
bbp
;

351 
buf
 *
bp
;

353 
îr‹
, 
bno
, 
°¨t
, 
íd
, 
loc
;

355 
fs
 = 
ù
->
i_e2fs
;

356 i‡(
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
 == 0)

358 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
, 
	`EXT2_FSBTODB
(
fs
,

359 
fs
->
e2fs_gd
[
cg
].
ext2bgd_b_bôm≠
),

360 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

361 i‡(
îr‹
) {

364 
bbp
 = (*)
bp
->
b_d©a
;

366 i‡(
	`dtog
(
fs
, 
b¥ef
Ë!
cg
)

367 
b¥ef
 = 0;

368 i‡(
b¥ef
 != 0) {

369 
b¥ef
 = 
	`dtogd
(
fs
, bpref);

373 i‡(
	`is˛r
(
bbp
, 
b¥ef
)) {

374 
bno
 = 
b¥ef
;

375 
gŸô
;

384 i‡(
b¥ef
)

385 
°¨t
 = 
	`dtogd
(
fs
, 
b¥ef
Ë/ 
NBBY
;

387 
°¨t
 = 0;

388 
íd
 = 
	`howm™y
(
fs
->
e2fs
.
e2fs_Âg
, 
NBBY
Ë- 
°¨t
;

389 
loc
 = 
°¨t
;Üo¯< 
íd
;Üoc++) {

390 i‡(
bbp
[
loc
] == 0) {

391 
bno
 = 
loc
 * 
NBBY
;

392 
gŸô
;

395 
loc
 = 0;Üo¯< 
°¨t
;Üoc++) {

396 i‡(
bbp
[
loc
] == 0) {

397 
bno
 = 
loc
 * 
NBBY
;

398 
gŸô
;

402 
bno
 = 
	`ext2fs_m≠£¨ch
(
fs
, 
bbp
, 
b¥ef
);

403 i‡(
bno
 < 0)

405 
gŸô
:

406 #ifde‡
DIAGNOSTIC


407 i‡(
	`is£t
(
bbp
, (
daddr_t
)
bno
)) {

408 
	`¥ötf
("ext2fs_alloccgblk: cg=%d bno=%d fs=%s\n",

409 
cg
, 
bno
, 
fs
->
e2fs_fsm¡
);

410 
	`∑nic
("ext2fs_alloccg: dupálloc");

413 
	`£tbô
(
bbp
, (
daddr_t
)
bno
);

414 
fs
->
e2fs
.
e2fs_fbcou¡
--;

415 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
--;

416 
fs
->
e2fs_fmod
 = 1;

417 
	`bdwrôe
(
bp
);

418  (
cg
 * 
fs
->
e2fs
.
e2fs_Âg
 + fs->e2fs.
e2fs_fú°_dblock
 + 
bno
);

419 
	}
}

430 
daddr_t


431 
	$ext2fs_nodóŒoccg
(
öode
 *
ù
, 
cg
, 
daddr_t
 
ùªf
, 
mode
)

433 
m_ext2fs
 *
fs
;

434 *
ibp
;

435 
buf
 *
bp
;

436 
îr‹
, 
°¨t
, 
Àn
, 
loc
, 
m≠
, 
i
;

438 
ùªf
--;

439 i‡(
ùªf
 == -1)

440 
ùªf
 = 0;

441 
fs
 = 
ù
->
i_e2fs
;

442 i‡(
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
 == 0)

444 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
, 
	`EXT2_FSBTODB
(
fs
,

445 
fs
->
e2fs_gd
[
cg
].
ext2bgd_i_bôm≠
),

446 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

447 i‡(
îr‹
) {

450 
ibp
 = (*)
bp
->
b_d©a
;

451 i‡(
ùªf
) {

452 
ùªf
 %
fs
->
e2fs
.
e2fs_ùg
;

453 i‡(
	`is˛r
(
ibp
, 
ùªf
))

454 
gŸô
;

456 
°¨t
 = 
ùªf
 / 
NBBY
;

457 
Àn
 = 
	`howm™y
(
fs
->
e2fs
.
e2fs_ùg
 - 
ùªf
, 
NBBY
);

458 
loc
 = 
	`skpc
(0xff, 
Àn
, &
ibp
[
°¨t
]);

459 i‡(
loc
 == 0) {

460 
Àn
 = 
°¨t
 + 1;

461 
°¨t
 = 0;

462 
loc
 = 
	`skpc
(0xff, 
Àn
, &
ibp
[0]);

463 i‡(
loc
 == 0) {

464 
	`¥ötf
("cg = %d, ipref = %lld, fs = %s\n",

465 
cg
, ()
ùªf
, 
fs
->
e2fs_fsm¡
);

466 
	`∑nic
("ext2fs_nodealloccg: map corrupted");

470 
i
 = 
°¨t
 + 
Àn
 - 
loc
;

471 
m≠
 = 
ibp
[
i
] ^ 0xff;

472 i‡(
m≠
 == 0) {

473 
	`¥ötf
("f†%s\n", 
fs
->
e2fs_fsm¡
);

474 
	`∑nic
("ext2fs_nodealloccg: blockÇot in map");

476 
ùªf
 = 
i
 * 
NBBY
 + 
	`ffs
(
m≠
) - 1;

477 
gŸô
:

478 
	`£tbô
(
ibp
, 
ùªf
);

479 
fs
->
e2fs
.
e2fs_ficou¡
--;

480 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
--;

481 
fs
->
e2fs_fmod
 = 1;

482 i‡((
mode
 & 
IFMT
Ë=
IFDIR
) {

483 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ndús
++;

485 
	`bdwrôe
(
bp
);

486  (
cg
 * 
fs
->
e2fs
.
e2fs_ùg
 + 
ùªf
 +1);

487 
	}
}

496 
	$ext2fs_blk‰ì
(
öode
 *
ù
, 
daddr_t
 
bno
)

498 
m_ext2fs
 *
fs
;

499 *
bbp
;

500 
buf
 *
bp
;

501 
îr‹
, 
cg
;

503 
fs
 = 
ù
->
i_e2fs
;

504 
cg
 = 
	`dtog
(
fs
, 
bno
);

505 i‡((
u_öt
)
bno
 >
fs
->
e2fs
.
e2fs_bcou¡
) {

506 
	`¥ötf
("bad block %Œd, inÿ%Œu\n", ()
bno
,

507 ()
ù
->
i_numbî
);

508 
	`ext2fs_f£º
(
fs
, 
ù
->
i_uid
, "bad block");

511 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
,

512 
	`EXT2_FSBTODB
(
fs
, fs->
e2fs_gd
[
cg
].
ext2bgd_b_bôm≠
),

513 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

514 i‡(
îr‹
) {

517 
bbp
 = (*)
bp
->
b_d©a
;

518 
bno
 = 
	`dtogd
(
fs
, bno);

519 i‡(
	`is˛r
(
bbp
, 
bno
)) {

520 
	`¥ötf
("dev = 0x%llx, block = %lld, fs = %s\n",

521 ()
ù
->
i_dev
, ()
bno
,

522 
fs
->
e2fs_fsm¡
);

523 
	`∑nic
("blkfree: freeing free block");

525 
	`˛rbô
(
bbp
, 
bno
);

526 
fs
->
e2fs
.
e2fs_fbcou¡
++;

527 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
++;

529 
fs
->
e2fs_fmod
 = 1;

530 
	`bdwrôe
(
bp
);

531 
	}
}

539 
	$ext2fs_v‰ì
(
vnode
 *
pvp
, 
öo_t
 
öo
, 
mode
)

541 
m_ext2fs
 *
fs
;

542 *
ibp
;

543 
öode
 *
pù
;

544 
buf
 *
bp
;

545 
îr‹
, 
cg
;

547 
pù
 = 
	`VTOI
(
pvp
);

548 
fs
 = 
pù
->
i_e2fs
;

549 i‡((
u_öt
)
öo
 > 
fs
->
e2fs
.
e2fs_icou¡
 || (u_öt)öÿ< 
EXT2_FIRSTINO
)

550 
	`∑nic
("ifree:Ñange: dev = 0x%llx, ino = %llu, fs = %s",

551 ()
pù
->
i_dev
, ()
öo
,

552 
fs
->
e2fs_fsm¡
);

553 
cg
 = 
	`öo_to_cg
(
fs
, 
öo
);

554 
îr‹
 = 
	`bªad
(
pù
->
i_devvp
,

555 
	`EXT2_FSBTODB
(
fs
, fs->
e2fs_gd
[
cg
].
ext2bgd_i_bôm≠
),

556 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

557 i‡(
îr‹
) {

560 
ibp
 = (*)
bp
->
b_d©a
;

561 
öo
 = (öÿ- 1Ë% 
fs
->
e2fs
.
e2fs_ùg
;

562 i‡(
	`is˛r
(
ibp
, 
öo
)) {

563 
	`¥ötf
("dev = 0x%llx, ino = %llu, fs = %s\n",

564 ()
pù
->
i_dev
,

565 ()
öo
, 
fs
->
e2fs_fsm¡
);

566 i‡(
fs
->
e2fs_r⁄ly
 == 0)

567 
	`∑nic
("ifree: freeing free inode");

569 
	`˛rbô
(
ibp
, 
öo
);

570 
fs
->
e2fs
.
e2fs_ficou¡
++;

571 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
++;

572 i‡((
mode
 & 
IFMT
Ë=
IFDIR
) {

573 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ndús
--;

575 
fs
->
e2fs_fmod
 = 1;

576 
	`bdwrôe
(
bp
);

578 
	}
}

587 
daddr_t


588 
	$ext2fs_m≠£¨ch
(
m_ext2fs
 *
fs
, *
bbp
, 
daddr_t
 
b¥ef
)

590 
°¨t
, 
Àn
, 
loc
, 
i
, 
m≠
;

596 i‡(
b¥ef
)

597 
°¨t
 = 
	`dtogd
(
fs
, 
b¥ef
Ë/ 
NBBY
;

599 
°¨t
 = 0;

600 
Àn
 = 
	`howm™y
(
fs
->
e2fs
.
e2fs_Âg
, 
NBBY
Ë- 
°¨t
;

601 
loc
 = 
	`skpc
(0xff, 
Àn
, &
bbp
[
°¨t
]);

602 i‡(
loc
 == 0) {

603 
Àn
 = 
°¨t
 + 1;

604 
°¨t
 = 0;

605 
loc
 = 
	`skpc
(0xff, 
Àn
, &
bbp
[
°¨t
]);

606 i‡(
loc
 == 0) {

607 
	`¥ötf
("start = %d,Üen = %d, fs = %s\n",

608 
°¨t
, 
Àn
, 
fs
->
e2fs_fsm¡
);

609 
	`∑nic
("ext2fs_alloccg: map corrupted");

613 
i
 = 
°¨t
 + 
Àn
 - 
loc
;

614 
m≠
 = 
bbp
[
i
] ^ 0xff;

615 i‡(
m≠
 == 0) {

616 
	`¥ötf
("f†%s\n", 
fs
->
e2fs_fsm¡
);

617 
	`∑nic
("ext2fs_mapsearch: blockÇot in map");

619  
i
 * 
NBBY
 + 
	`ffs
(
m≠
) - 1;

620 
	}
}

629 
	$ext2fs_f£º
(
m_ext2fs
 *
fs
, 
u_öt
 
uid
, c⁄° *
˝
)

632 
	`log
(
LOG_ERR
, "uid %d o¿%s: %s\n", 
uid
, 
fs
->
e2fs_fsm¡
, 
˝
);

633 
	}
}

	@ext2fs_balloc.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_balloc.c,v 1.40 2015/03/28 19:24:04 maxv Exp $");

65 #i‡
deföed
(
_KERNEL_OPT
)

66 
	~"›t_uvmhi°.h
"

69 
	~<sys/∑øm.h
>

70 
	~<sys/sy°m.h
>

71 
	~<sys/buf.h
>

72 
	~<sys/¥oc.h
>

73 
	~<sys/fûe.h
>

74 
	~<sys/vnode.h
>

75 
	~<sys/mou¡.h
>

76 
	~<sys/kauth.h
>

78 
	~<uvm/uvm.h
>

80 
	~<ufs/ufs/öode.h
>

81 
	~<ufs/ufs/ufs_exã∫.h
>

83 
	~<ufs/ext2fs/ext2fs.h
>

84 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

92 
	$ext2fs_bÆloc
(
öode
 *
ù
, 
daddr_t
 
bn
, 
size
,

93 
kauth_¸ed_t
 
¸ed
, 
buf
 **
bµ
, 
Êags
)

95 
m_ext2fs
 *
fs
;

96 
daddr_t
 
nb
;

97 
buf
 *
bp
, *
nbp
;

98 
vnode
 *
vp
 = 
	`ITOV
(
ù
);

99 
ödú
 
ödús
[
EXT2FS_NIADDR
 + 2];

100 
daddr_t
 
√wb
, 
lbn
, 
¥ef
;

101 
öt32_t
 *
b≠
;

102 
num
, 
i
, 
îr‹
;

103 
u_öt
 
dóŒoˇãd
;

104 
daddr_t
 *
blkp
, *
Ælocblk
, 
Ælociblk
[
EXT2FS_NIADDR
 + 1];

105 
öt32_t
 *
Ælocib
;

106 
unwödidx
 = -1;

107 
	`UVMHIST_FUNC
("ext2fs_bÆloc"); 
	`UVMHIST_CALLED
(
ubchi°
);

109 
	`UVMHIST_LOG
(
ubchi°
, "b¿0x%x", 
bn
,0,0,0);

111 i‡(
bµ
 !
NULL
) {

112 *
bµ
 = 
NULL
;

114 i‡(
bn
 < 0)

115  (
EFBIG
);

116 
fs
 = 
ù
->
i_e2fs
;

117 
lbn
 = 
bn
;

122 i‡(
bn
 < 
EXT2FS_NDADDR
) {

124 
nb
 = 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
]);

125 i‡(
nb
 != 0) {

131 i‡(
bµ
 !
NULL
) {

132 
îr‹
 = 
	`bªad
(
vp
, 
bn
, 
fs
->
e2fs_bsize
,

133 
B_MODIFY
, &
bp
);

134 i‡(
îr‹
) {

135  (
îr‹
);

137 *
bµ
 = 
bp
;

146 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
bn
,

147 
	`ext2fs_blk¥ef
(
ù
, 
bn
, bn, &ù->
i_e2fs_blocks
[0]),

148 
¸ed
, &
√wb
);

149 i‡(
îr‹
)

150  (
îr‹
);

151 
ù
->
i_e2fs_œ°_lblk
 = 
lbn
;

152 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

154 
ù
->
i_e2fs_blocks
[
bn
] = 
	`h2fs32
((
öt32_t
)
√wb
);

155 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

156 i‡(
bµ
 !
NULL
) {

157 
bp
 = 
	`gëblk
(
vp
, 
bn
, 
fs
->
e2fs_bsize
, 0, 0);

158 
bp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
√wb
);

159 i‡(
Êags
 & 
B_CLRBUF
)

160 
	`˛rbuf
(
bp
);

161 *
bµ
 = 
bp
;

168 
¥ef
 = 0;

169 i‡((
îr‹
 = 
	`ufs_gëlbns
(
vp
, 
bn
, 
ödús
, &
num
)) != 0)

170 (
îr‹
);

171 #ifde‡
DIAGNOSTIC


172 i‡(
num
 < 1)

173 
	`∑nic
 ("ext2fs_balloc: ufs_getlbnsÑeturned indirect block\n");

178 --
num
;

180 
nb
 = 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
ödús
[0].
ö_off
]);

181 
Ælocib
 = 
NULL
;

182 
Ælocblk
 = 
Ælociblk
;

183 i‡(
nb
 == 0) {

184 
¥ef
 = 
	`ext2fs_blk¥ef
(
ù
, 
lbn
, 0, (
öt32_t
 *)0);

185 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
lbn
, 
¥ef
, 
¸ed
, &
√wb
);

186 i‡(
îr‹
)

187  (
îr‹
);

188 
nb
 = 
√wb
;

189 *
Ælocblk
++ = 
nb
;

190 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

191 
bp
 = 
	`gëblk
(
vp
, 
ödús
[1].
ö_lbn
, 
fs
->
e2fs_bsize
, 0, 0);

192 
bp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
√wb
);

193 
	`˛rbuf
(
bp
);

198 i‡((
îr‹
 = 
	`bwrôe
(
bp
)) != 0)

199 
Áû
;

200 
unwödidx
 = 0;

201 
Ælocib
 = &
ù
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
ödús
[0].
ö_off
];

203 *
Ælocib
 = 
	`h2fs32
((
öt32_t
)
√wb
);

204 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

209 
i
 = 1;;) {

210 
îr‹
 = 
	`bªad
(
vp
,

211 
ödús
[
i
].
ö_lbn
, ()
fs
->
e2fs_bsize
, 0, &
bp
);

212 i‡(
îr‹
) {

213 
Áû
;

215 
b≠
 = (
öt32_t
 *)
bp
->
b_d©a
;

216 
nb
 = 
	`fs2h32
(
b≠
[
ödús
[
i
].
ö_off
]);

217 i‡(
i
 =
num
)

219 
i
++;

220 i‡(
nb
 != 0) {

221 
	`bªl£
(
bp
, 0);

224 
¥ef
 = 
	`ext2fs_blk¥ef
(
ù
, 
lbn
, 0, (
öt32_t
 *)0);

225 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
lbn
, 
¥ef
, 
¸ed
, &
√wb
);

226 i‡(
îr‹
) {

227 
	`bªl£
(
bp
, 0);

228 
Áû
;

230 
nb
 = 
√wb
;

231 *
Ælocblk
++ = 
nb
;

232 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

233 
nbp
 = 
	`gëblk
(
vp
, 
ödús
[
i
].
ö_lbn
, 
fs
->
e2fs_bsize
, 0, 0);

234 
nbp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
nb
);

235 
	`˛rbuf
(
nbp
);

240 i‡((
îr‹
 = 
	`bwrôe
(
nbp
)) != 0) {

241 
	`bªl£
(
bp
, 0);

242 
Áû
;

244 i‡(
unwödidx
 < 0)

245 
unwödidx
 = 
i
 - 1;

247 
b≠
[
ödús
[
i
 - 1].
ö_off
] = 
	`h2fs32
((
öt32_t
)
nb
);

252 i‡(
Êags
 & 
B_SYNC
) {

253 
	`bwrôe
(
bp
);

255 
	`bdwrôe
(
bp
);

261 i‡(
nb
 == 0) {

262 
¥ef
 = 
	`ext2fs_blk¥ef
(
ù
, 
lbn
, 
ödús
[
num
].
ö_off
, &
b≠
[0]);

263 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
lbn
, 
¥ef
, 
¸ed
, &
√wb
);

264 i‡(
îr‹
) {

265 
	`bªl£
(
bp
, 0);

266 
Áû
;

268 
nb
 = 
√wb
;

269 *
Ælocblk
++ = 
nb
;

270 
ù
->
i_e2fs_œ°_lblk
 = 
lbn
;

271 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

273 
b≠
[
ödús
[
num
].
ö_off
] = 
	`h2fs32
((
öt32_t
)
nb
);

278 i‡(
Êags
 & 
B_SYNC
) {

279 
	`bwrôe
(
bp
);

281 
	`bdwrôe
(
bp
);

283 i‡(
bµ
 !
NULL
) {

284 
nbp
 = 
	`gëblk
(
vp
, 
lbn
, 
fs
->
e2fs_bsize
, 0, 0);

285 
nbp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
nb
);

286 i‡(
Êags
 & 
B_CLRBUF
)

287 
	`˛rbuf
(
nbp
);

288 *
bµ
 = 
nbp
;

292 
	`bªl£
(
bp
, 0);

293 i‡(
bµ
 !
NULL
) {

294 i‡(
Êags
 & 
B_CLRBUF
) {

295 
îr‹
 = 
	`bªad
(
vp
, 
lbn
, ()
fs
->
e2fs_bsize
,

296 
B_MODIFY
, &
nbp
);

297 i‡(
îr‹
) {

298 
Áû
;

301 
nbp
 = 
	`gëblk
(
vp
, 
lbn
, 
fs
->
e2fs_bsize
, 0, 0);

302 
nbp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
nb
);

304 *
bµ
 = 
nbp
;

307 
Áû
:

312 
dóŒoˇãd
 = 0, 
blkp
 = 
Ælociblk
; blk∞< 
Ælocblk
; blkp++) {

313 
	`ext2fs_blk‰ì
(
ù
, *
blkp
);

314 
dóŒoˇãd
 +
fs
->
e2fs_bsize
;

316 i‡(
unwödidx
 >= 0) {

317 i‡(
unwödidx
 == 0) {

318 *
Ælocib
 = 0;

320 
r
;

322 
r
 = 
	`bªad
(
vp
, 
ödús
[
unwödidx
].
ö_lbn
,

323 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

324 i‡(
r
) {

325 
	`∑nic
("CouldÇŸ unwöd indúe˘ block,Éº‹ %d", 
r
);

327 
b≠
 = (
öt32_t
 *)
bp
->
b_d©a
;

328 
b≠
[
ödús
[
unwödidx
].
ö_off
] = 0;

329 i‡(
Êags
 & 
B_SYNC
)

330 
	`bwrôe
(
bp
);

332 
	`bdwrôe
(
bp
);

335 
i
 = 
unwödidx
 + 1; i <
num
; i++) {

336 
bp
 = 
	`gëblk
(
vp
, 
ödús
[
i
].
ö_lbn
, ()
fs
->
e2fs_bsize
,

338 
	`bªl£
(
bp
, 
BC_INVAL
);

341 i‡(
dóŒoˇãd
) {

342 
	`ext2fs_£äblock
(
ù
, 
	`ext2fs_nblock
(ùË- 
	`btodb
(
dóŒoˇãd
));

343 
ù
->
i_e2fs_Êags
 |
IN_CHANGE
 | 
IN_UPDATE
;

345  
îr‹
;

346 
	}
}

349 
	$ext2fs_g›_Æloc
(
vnode
 *
vp
, 
off_t
 
off
, off_à
Àn
, 
Êags
,

350 
kauth_¸ed_t
 
¸ed
)

352 
öode
 *
ù
 = 
	`VTOI
(
vp
);

353 
m_ext2fs
 *
fs
 = 
ù
->
i_e2fs
;

354 
îr‹
, 
dñè
, 
bshi·
, 
bsize
;

355 
	`UVMHIST_FUNC
("ext2fs_g›_Æloc"); 
	`UVMHIST_CALLED
(
ubchi°
);

357 
bshi·
 = 
fs
->
e2fs_bshi·
;

358 
bsize
 = 1 << 
bshi·
;

360 
dñè
 = 
off
 & (
bsize
 - 1);

361 
off
 -
dñè
;

362 
Àn
 +
dñè
;

364 
Àn
 > 0) {

365 
bsize
 = 
	`mö
(bsize, 
Àn
);

366 
	`UVMHIST_LOG
(
ubchi°
, "off 0x%xÜen 0x%x bsize 0x%x",

367 
off
, 
Àn
, 
bsize
, 0);

369 
îr‹
 = 
	`ext2fs_bÆloc
(
ù
, 
	`ext2_lblkno
(
fs
, 
off
), 
bsize
, 
¸ed
,

370 
NULL
, 
Êags
);

371 i‡(
îr‹
) {

372 
	`UVMHIST_LOG
(
ubchi°
, "îr‹ %d", 
îr‹
, 0,0,0);

373  
îr‹
;

381 i‡(
	`ext2fs_size
(
ù
Ë< 
off
 + 
bsize
) {

382 
	`UVMHIST_LOG
(
ubchi°
, "old 0x%lx%8lxÇew 0x%lx%8lx",

384 
	`ext2fs_size
(
ù
) >> 32,

385 
	`ext2fs_size
(
ù
) & 0xffffffff,

386 (
off
 + 
bsize
) >> 32,

387 (
off
 + 
bsize
) & 0xffffffff);

388 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
off
 + 
bsize
);

389 i‡(
îr‹
) {

390 
	`UVMHIST_LOG
(
ubchi°
, "îr‹ %d", 
îr‹
, 0,0,0);

391  
îr‹
;

395 
off
 +
bsize
;

396 
Àn
 -
bsize
;

399 
	}
}

	@ext2fs_bmap.c

67 
	~<sys/cdefs.h
>

68 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_bmap.c,v 1.26 2013/01/22 09:39:15 dholland Exp $");

70 
	~<sys/∑øm.h
>

71 
	~<sys/sy°m.h
>

72 
	~<sys/buf.h
>

73 
	~<sys/¥oc.h
>

74 
	~<sys/vnode.h
>

75 
	~<sys/mou¡.h
>

76 
	~<sys/ªsour˚v¨.h
>

77 
	~<sys/åa˚.h
>

79 
	~<miscfs/•ecfs/•ecdev.h
>

81 
	~<ufs/ufs/öode.h
>

82 
	~<ufs/ufs/ufsmou¡.h
>

83 
	~<ufs/ufs/ufs_exã∫.h
>

84 
	~<ufs/ext2fs/ext2fs.h
>

85 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

88 
ext4_bm≠ext
(
vnode
 *, 
öt32_t
, 
öt64_t
 *, *, *);

90 
ext2fs_bm≠¨øy
(
vnode
 *, 
daddr_t
, daddr_t *,

91 
ödú
 *, *, *);

93 
	#is_£quítül
(
ump
, 
a
, 
b
Ë((bË=◊Ë+ ump->
um_£qöc
)

	)

101 
	$ext2fs_bm≠
(*
v
)

103 
	`¥ötf
("InsideÉxt2fs_bmap\n");

104 
v›_bm≠_¨gs


110  *
≠
 = 
v
;

116 i‡(
≠
->
a_vµ
 !
NULL
)

117 *
≠
->
a_vµ
 = 
	`VTOI
◊p->
a_vp
)->
i_devvp
;

118 i‡(
≠
->
a_b≈
 =
NULL
)

121 i‡(
	`VTOI
(
≠
->
a_vp
)->
i_Êag
 & 
IN_E4EXTENTS
)

122  (
	`ext4_bm≠ext
(
≠
->
a_vp
,áp->
a_bn
,áp->
a_b≈
,

123 
≠
->
a_ru≈
, 
NULL
));

124  (
	`ext2fs_bm≠¨øy
(
≠
->
a_vp
,áp->
a_bn
,áp->
a_b≈
, 
NULL
, NULL,

125 
≠
->
a_ru≈
));

127 
	}
}

135 
	$ext4_bm≠ext
(
vnode
 *
vp
, 
öt32_t
 
bn
, 
öt64_t
 *
b≈
, *
ru≈
, *
runb
)

137 
	`¥ötf
 ("insideÉxt4_bmapext\n");

138 
öode
 *
ù
;

139 
m_ext2fs
 *
fs
;

140 
ext4_exã¡
 *
ï
;

141 
ext4_exã¡_∑th
 
∑th
 = { .
ï_bp
 = 
NULL
 };

142 
daddr_t
 
lbn
;

143 
ªt
 = 0;

145 
ù
 = 
	`VTOI
(
vp
);

146 
fs
 = 
ù
->
i_e2fs
;

147 
lbn
 = 
bn
;

149 i‡(
ru≈
 !
NULL
)

150 *
ru≈
 = 0;

152 i‡(
runb
 !
NULL
)

153 *
runb
 = 0;

155 
	`ext4_ext_föd_exã¡
(
fs
, 
ù
, 
lbn
, &
∑th
);

156 i‡(
∑th
.
ï_is_•¨£
) {

157 *
b≈
 = -1;

158 i‡(
ru≈
 !
NULL
)

159 *
ru≈
 = 
∑th
.
ï_•¨£_ext
.
e_Àn
 -

160 (
lbn
 - 
∑th
.
ï_•¨£_ext
.
e_blk
) - 1;

161 i‡(
runb
 !
NULL
)

162 *
runb
 = 
lbn
 - 
∑th
.
ï_•¨£_ext
.
e_blk
;

164 
ï
 = 
∑th
.
ï_ext
;

165 i‡(
ï
 =
NULL
)

166 
ªt
 = 
EIO
;

168 *
b≈
 = 
	`fsbtodb
(
fs
, 
lbn
 - 
ï
->
e_blk
 +

169 (
ï
->
e_°¨t_lo
 | (
daddr_t
Îp->
e_°¨t_hi
 << 32));

171 i‡(*
b≈
 == 0)

172 *
b≈
 = -1;

174 i‡(
ru≈
 !
NULL
)

175 *
ru≈
 = 
ï
->
e_Àn
 - (
lbn
 -Ép->
e_blk
) - 1;

176 i‡(
runb
 !
NULL
)

177 *
runb
 = 
lbn
 - 
ï
->
e_blk
;

181 i‡(
∑th
.
ï_bp
 !
NULL
) {

182 
	`bªl£
(
∑th
.
ï_bp
,0);

183 
∑th
.
ï_bp
 = 
NULL
;

186  (
ªt
);

187 
	}
}

206 
	$ext2fs_bm≠¨øy
(
vnode
 *
vp
, 
daddr_t
 
bn
, daddr_à*
b≈
, 
ödú
 *
≠
,

207 *
nump
, *
ru≈
)

210 
	`¥ötf
("InsideÉxt2fs_bmaparray\n");

211 
öode
 *
ù
;

212 
buf
 *
bp
, *
cbp
;

213 
ufsmou¡
 *
ump
;

214 
mou¡
 *
mp
;

215 
ödú
 
a
[
EXT2FS_NIADDR
+1], *
x≠
;

216 
daddr_t
 
daddr
;

217 
daddr_t
 
mëÆbn
;

218 
îr‹
, 
maxrun
 = 0, 
num
;

220 
ù
 = 
	`VTOI
(
vp
);

221 
mp
 = 
vp
->
v_mou¡
;

222 
ump
 = 
ù
->
i_ump
;

223 #ifde‡
DIAGNOSTIC


224 i‡((
≠
 !
NULL
 && 
nump
 == NULL) || (ap == NULL &&Çump != NULL))

225 
	`∑nic
("ext2fs_bmaparray: invalidárguments");

228 i‡(
ru≈
) {

235 *
ru≈
 = 0;

236 
maxrun
 = 
MAXBSIZE
 / 
mp
->
m¡_°©
.
f_iosize
 - 1;

239 i‡(
bn
 >0 && b¿< 
EXT2FS_NDADDR
) {

241 *
b≈
 = 
	`blk±πodb
(
ump
, 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
]));

242 i‡(*
b≈
 == 0)

243 *
b≈
 = -1;

244 i‡(
ru≈
)

246 ++
bn
; b¿< 
EXT2FS_NDADDR
 && *
ru≈
 < 
maxrun
 &&

247 
	`is_£quítül
(
ump
, (
daddr_t
)
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
 - 1]),

248 (
daddr_t
)
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
]));

249 ++
bn
, ++*
ru≈
);

253 
x≠
 = 
≠
 =
NULL
 ? 
a
 :áp;

254 i‡(!
nump
)

255 
nump
 = &
num
;

256 i‡((
îr‹
 = 
	`ufs_gëlbns
(
vp
, 
bn
, 
x≠
, 
nump
)) != 0)

257  (
îr‹
);

259 
num
 = *
nump
;

263 
daddr
 = 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
x≠
->
ö_off
]);

265 #ifde‡
DIAGNOSTIC


266 i‡(
num
 > 
EXT2FS_NIADDR
 + 1 ||Çum < 1) {

267 
	`¥ötf
("ext2fs_bm≠¨øy:Çum=%d\n", 
num
);

268 
	`∑nic
("ext2fs_bmaparray:Çum");

271 
bp
 = 
NULL
, ++
x≠
; --
num
; ++xap) {

278 
mëÆbn
 = 
x≠
->
ö_lbn
;

279 i‡(
mëÆbn
 =
bn
)

281 i‡(
daddr
 == 0) {

282 
	`muãx_íãr
(&
bufˇche_lock
);

283 
cbp
 = 
	`öc‹e
(
vp
, 
mëÆbn
);

284 
	`muãx_exô
(&
bufˇche_lock
);

285 i‡(
cbp
 =
NULL
)

292 i‡(
bp
)

293 
	`bªl£
(
bp
, 0);

295 
x≠
->
ö_exi°s
 = 1;

296 
bp
 = 
	`gëblk
(
vp
, 
mëÆbn
, 
mp
->
m¡_°©
.
f_iosize
, 0, 0);

297 i‡(
bp
 =
NULL
) {

305  (
ENOMEM
);

307 i‡(
bp
->
b_oÊags
 & (
BO_DONE
 | 
BO_DELWRI
)) {

308 
	`åa˚
(
TR_BREADHIT
, 
	`∑ck
(
vp
, 
size
), 
mëÆbn
);

310 #ifde‡
DIAGNOSTIC


311 i‡(!
daddr
)

312 
	`∑nic
("ext2fs_bmaparry: indirect blockÇot in cache");

315 
	`åa˚
(
TR_BREADMISS
, 
	`∑ck
(
vp
, 
size
), 
mëÆbn
);

316 
bp
->
b_blkno
 = 
	`blk±πodb
(
ump
, 
daddr
);

317 
bp
->
b_Êags
 |
B_READ
;

318 
	`VOP_STRATEGY
(
vp
, 
bp
);

319 
cuæwp
->
l_ru
.
ru_öblock
++;

320 i‡((
îr‹
 = 
	`biowaô
(
bp
)) != 0) {

321 
	`bªl£
(
bp
, 0);

322  (
îr‹
);

327 
daddr
 = 
	`fs2h32
(((
öt32_t
 *)
bp
->
b_d©a
)[
x≠
->
ö_off
]);

328 i‡(
num
 =1 && 
daddr
 && 
ru≈
)

330 
bn
 = 
x≠
->
ö_off
 + 1;

331 
bn
 < 
	`MNINDIR
(
ump
Ë&& *
ru≈
 < 
maxrun
 &&

332 
	`is_£quítül
(
ump
, ((
öt32_t
 *)
bp
->
b_d©a
)[
bn
 - 1],

333 ((
öt32_t
 *)
bp
->
b_d©a
)[
bn
]);

334 ++
bn
, ++*
ru≈
);

336 i‡(
bp
)

337 
	`bªl£
(
bp
, 0);

339 
daddr
 = 
	`blk±πodb
(
ump
, daddr);

340 *
b≈
 = 
daddr
 == 0 ? -1 : daddr;

342 
	}
}

	@ext2fs_bswap.c

28 
	~<sys/cdefs.h
>

29 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_bswap.c,v 1.19 2013/01/22 09:39:15 dholland Exp $");

31 
	~<sys/ty≥s.h
>

32 
	~<ufs/ext2fs/ext2fs.h
>

33 
	~<ufs/ext2fs/ext2fs_döode.h
>

35 #i‡
deföed
(
_KERNEL
)

36 
	~<sys/sy°m.h
>

38 
	~<°rög.h
>

42 #i‡
BYTE_ORDER
 =
BIG_ENDIAN


44 
	$e2fs_sb_bsw≠
(
ext2fs
 *
ﬁd
, ext2f†*
√w
)

48 
	`mem˝y
(
√w
, 
ﬁd
, (
ext2fs
));

49 
√w
->
e2fs_icou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_icount);

50 
√w
->
e2fs_bcou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_bcount);

51 
√w
->
e2fs_rbcou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_rbcount);

52 
√w
->
e2fs_fbcou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_fbcount);

53 
√w
->
e2fs_ficou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_ficount);

54 
√w
->
e2fs_fú°_dblock
 = 
	`bsw≠32
(
ﬁd
->e2fs_first_dblock);

55 
√w
->
e2fs_log_bsize
 = 
	`bsw≠32
(
ﬁd
->e2fs_log_bsize);

56 
√w
->
e2fs_fsize
 = 
	`bsw≠32
(
ﬁd
->e2fs_fsize);

57 
√w
->
e2fs_bpg
 = 
	`bsw≠32
(
ﬁd
->e2fs_bpg);

58 
√w
->
e2fs_Âg
 = 
	`bsw≠32
(
ﬁd
->e2fs_fpg);

59 
√w
->
e2fs_ùg
 = 
	`bsw≠32
(
ﬁd
->e2fs_ipg);

60 
√w
->
e2fs_mtime
 = 
	`bsw≠32
(
ﬁd
->e2fs_mtime);

61 
√w
->
e2fs_wtime
 = 
	`bsw≠32
(
ﬁd
->e2fs_wtime);

62 
√w
->
e2fs_m¡_cou¡
 = 
	`bsw≠16
(
ﬁd
->e2fs_mnt_count);

63 
√w
->
e2fs_max_m¡_cou¡
 = 
	`bsw≠16
(
ﬁd
->e2fs_max_mnt_count);

64 
√w
->
e2fs_magic
 = 
	`bsw≠16
(
ﬁd
->e2fs_magic);

65 
√w
->
e2fs_°©e
 = 
	`bsw≠16
(
ﬁd
->e2fs_state);

66 
√w
->
e2fs_beh
 = 
	`bsw≠16
(
ﬁd
->e2fs_beh);

67 
√w
->
e2fs_möªv
 = 
	`bsw≠16
(
ﬁd
->e2fs_minrev);

68 
√w
->
e2fs_œ°fsck
 = 
	`bsw≠32
(
ﬁd
->e2fs_lastfsck);

69 
√w
->
e2fs_fsckötv
 = 
	`bsw≠32
(
ﬁd
->e2fs_fsckintv);

70 
√w
->
e2fs_¸ót‹
 = 
	`bsw≠32
(
ﬁd
->e2fs_creator);

71 
√w
->
e2fs_ªv
 = 
	`bsw≠32
(
ﬁd
->e2fs_rev);

72 
√w
->
e2fs_ruid
 = 
	`bsw≠16
(
ﬁd
->e2fs_ruid);

73 
√w
->
e2fs_rgid
 = 
	`bsw≠16
(
ﬁd
->e2fs_rgid);

74 
√w
->
e2fs_fú°_öo
 = 
	`bsw≠32
(
ﬁd
->e2fs_first_ino);

75 
√w
->
e2fs_öode_size
 = 
	`bsw≠16
(
ﬁd
->e2fs_inode_size);

76 
√w
->
e2fs_block_group_ƒ
 = 
	`bsw≠16
(
ﬁd
->e2fs_block_group_nr);

77 
√w
->
e2fs_„©uªs_com∑t
 = 
	`bsw≠32
(
ﬁd
->e2fs_features_compat);

78 
√w
->
e2fs_„©uªs_öcom∑t
 = 
	`bsw≠32
(
ﬁd
->e2fs_features_incompat);

79 
√w
->
e2fs_„©uªs_rocom∑t
 = 
	`bsw≠32
(
ﬁd
->e2fs_features_rocompat);

80 
√w
->
e2fs_Ægo
 = 
	`bsw≠32
(
ﬁd
->e2fs_algo);

81 
√w
->
e2fs_ª£rved_ngdb
 = 
	`bsw≠16
(
ﬁd
->e2fs_reserved_ngdb);

82 
	}
}

84 
	$e2fs_cg_bsw≠
(
ext2_gd
 *
ﬁd
, ext2_gd *
√w
, 
size
)

86 
i
;

88 
i
 = 0; i < (
size
 / ()(
ext2_gd
)); i++) {

89 
√w
[
i
].
ext2bgd_b_bôm≠
 = 
	`bsw≠32
(
ﬁd
[i].ext2bgd_b_bitmap);

90 
√w
[
i
].
ext2bgd_i_bôm≠
 = 
	`bsw≠32
(
ﬁd
[i].ext2bgd_i_bitmap);

91 
√w
[
i
].
ext2bgd_i_èbÀs
 = 
	`bsw≠32
(
ﬁd
[i].ext2bgd_i_tables);

92 
√w
[
i
].
ext2bgd_nb‰ì
 = 
	`bsw≠16
(
ﬁd
[i].ext2bgd_nbfree);

93 
√w
[
i
].
ext2bgd_ni‰ì
 = 
	`bsw≠16
(
ﬁd
[i].ext2bgd_nifree);

94 
√w
[
i
].
ext2bgd_ndús
 = 
	`bsw≠16
(
ﬁd
[i].ext2bgd_ndirs);

96 
	}
}

98 
	$e2fs_i_bsw≠
(
ext2fs_döode
 *
ﬁd
, ext2fs_döodê*
√w
)

101 
√w
->
e2di_mode
 = 
	`bsw≠16
(
ﬁd
->e2di_mode);

102 
√w
->
e2di_uid
 = 
	`bsw≠16
(
ﬁd
->e2di_uid);

103 
√w
->
e2di_gid
 = 
	`bsw≠16
(
ﬁd
->e2di_gid);

104 
√w
->
e2di_∆ök
 = 
	`bsw≠16
(
ﬁd
->e2di_nlink);

105 
√w
->
e2di_size
 = 
	`bsw≠32
(
ﬁd
->e2di_size);

106 
√w
->
e2di_©ime
 = 
	`bsw≠32
(
ﬁd
->e2di_atime);

107 
√w
->
e2di_˘ime
 = 
	`bsw≠32
(
ﬁd
->e2di_ctime);

108 
√w
->
e2di_mtime
 = 
	`bsw≠32
(
ﬁd
->e2di_mtime);

109 
√w
->
e2di_dtime
 = 
	`bsw≠32
(
ﬁd
->e2di_dtime);

110 
√w
->
e2di_nblock
 = 
	`bsw≠32
(
ﬁd
->e2di_nblock);

111 
√w
->
e2di_Êags
 = 
	`bsw≠32
(
ﬁd
->e2di_flags);

112 
√w
->
e2di_vîsi⁄
 = 
	`bsw≠32
(
ﬁd
->e2di_version);

113 
√w
->
e2di_gí
 = 
	`bsw≠32
(
ﬁd
->e2di_gen);

114 
√w
->
e2di_Á˛
 = 
	`bsw≠32
(
ﬁd
->e2di_facl);

115 
√w
->
e2di_da˛
 = 
	`bsw≠32
(
ﬁd
->e2di_dacl);

116 
√w
->
e2di_Áddr
 = 
	`bsw≠32
(
ﬁd
->e2di_faddr);

117 
√w
->
e2di_nblock_high
 = 
	`bsw≠16
(
ﬁd
->e2di_nblock_high);

118 
√w
->
e2di_Á˛_high
 = 
	`bsw≠16
(
ﬁd
->e2di_facl_high);

119 
√w
->
e2di_uid_high
 = 
	`bsw≠16
(
ﬁd
->e2di_uid_high);

120 
√w
->
e2di_gid_high
 = 
	`bsw≠16
(
ﬁd
->e2di_gid_high);

121 
	`mem˝y
(&
√w
->
e2di_blocks
[0], &
ﬁd
->e2di_blocks[0],

122 (
EXT2FS_NDADDR
 + 
EXT2FS_NIADDR
Ë* (
uöt32_t
));

123 
	}
}

	@ext2fs_dinode.h

67 #i‚de‡
_UFS_EXT2FS_EXT2FS_DINODE_H_


68 
	#_UFS_EXT2FS_EXT2FS_DINODE_H_


	)

70 
	~<sys/°©.h
>

78 
	#EXT2_BADBLKINO
 ((
öo_t
)1)

	)

79 
	#EXT2_ROOTINO
 ((
öo_t
)2)

	)

80 
	#EXT2_ACLIDXINO
 ((
öo_t
)3)

	)

81 
	#EXT2_ACLDATAINO
 ((
öo_t
)4)

	)

82 
	#EXT2_BOOTLOADERINO
 ((
öo_t
)5)

	)

83 
	#EXT2_UNDELDIRINO
 ((
öo_t
)6)

	)

84 
	#EXT2_RESIZEINO
 ((
öo_t
)7)

	)

85 
	#EXT2_JOURNALINO
 ((
öo_t
)8)

	)

86 
	#EXT2_FIRSTINO
 ((
öo_t
)11)

	)

100 
	#EXT2FS_NDADDR
 12

	)

101 
	#EXT2FS_NIADDR
 3

	)

103 
	#EXT2_MAXSYMLINKLEN
 ((
EXT2FS_NDADDR
+
EXT2FS_NIADDR
Ë*  (
uöt32_t
))

	)

105 
	sext2fs_döode
 {

106 
uöt16_t
 
	me2di_mode
;

107 
uöt16_t
 
	me2di_uid
;

108 
uöt32_t
 
	me2di_size
;

109 
uöt32_t
 
	me2di_©ime
;

110 
uöt32_t
 
	me2di_˘ime
;

111 
uöt32_t
 
	me2di_mtime
;

112 
uöt32_t
 
	me2di_dtime
;

113 
uöt16_t
 
	me2di_gid
;

114 
uöt16_t
 
	me2di_∆ök
;

115 
uöt32_t
 
	me2di_nblock
;

116 
uöt32_t
 
	me2di_Êags
;

117 
uöt32_t
 
	me2di_vîsi⁄
;

118 
uöt32_t
 
	me2di_blocks
[
EXT2FS_NDADDR
+
EXT2FS_NIADDR
];

120 
uöt32_t
 
	me2di_gí
;

121 
uöt32_t
 
	me2di_Á˛
;

122 
uöt32_t
 
	me2di_da˛
;

123 
uöt32_t
 
	me2di_Áddr
;

124 
uöt16_t
 
	me2di_nblock_high
;

125 
uöt16_t
 
	me2di_Á˛_high
;

126 
uöt16_t
 
	me2di_uid_high
;

127 
uöt16_t
 
	me2di_gid_high
;

128 
uöt32_t
 
	me2di_löux_ª£rved3
;

133 
	#E2MAXSYMLINKLEN
 ((
EXT2FS_NDADDR
 + 
EXT2FS_NIADDR
Ë* (
uöt32_t
))

	)

136 
	#EXT2_IEXEC
 0000100

	)

137 
	#EXT2_IWRITE
 0000200

	)

138 
	#EXT2_IREAD
 0000400

	)

139 
	#EXT2_ISVTX
 0001000

	)

140 
	#EXT2_ISGID
 0002000

	)

141 
	#EXT2_ISUID
 0004000

	)

144 
	#EXT2_IFMT
 0170000

	)

145 
	#EXT2_IFIFO
 0010000

	)

146 
	#EXT2_IFCHR
 0020000

	)

147 
	#EXT2_IFDIR
 0040000

	)

148 
	#EXT2_IFBLK
 0060000

	)

149 
	#EXT2_IFREG
 0100000

	)

150 
	#EXT2_IFLNK
 0120000

	)

151 
	#EXT2_IFSOCK
 0140000

	)

154 
	#EXT2_SECRM
 0x00000001

	)

155 
	#EXT2_UNRM
 0x00000002

	)

156 
	#EXT2_COMPR
 0x00000004

	)

157 
	#EXT2_SYNC
 0x00000008

	)

158 
	#EXT2_IMMUTABLE
 0x00000010

	)

159 
	#EXT2_APPEND
 0x00000020

	)

160 
	#EXT2_NODUMP
 0x00000040

	)

161 
	#EXT2_NOATIME
 0x00000080

	)

162 
	#EXT2_INDEX
 0x00001000

	)

163 
	#EXT2_IMAGIC
 0x00002000

	)

164 
	#EXT2_JOURNAL_DATA
 0x00004000

	)

165 
	#EXT2_NOTAIL
 0x00008000

	)

166 
	#EXT2_DIRSYNC
 0x00010000

	)

167 
	#EXT2_TOPDIR
 0x00020000

	)

168 
	#EXT2_HUGE_FILE
 0x00040000

	)

169 
	#EXT2_EXTENTS
 0x00080000

	)

170 
	#EXT2_EOFBLOCKS
 0x00400000

	)

173 
	#EXT2_REV0_DINODE_SIZE
 (
ext2fs_döode
)

	)

174 
	#EXT2_DINODE_SIZE
(
fs
Ë((fs)->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 ? \

175 (
fs
)->
e2fs
.
e2fs_öode_size
 : \

176 
EXT2_REV0_DINODE_SIZE
)

	)

186 
	#e2di_rdev
 
e2di_blocks
[0]

	)

187 
	#e2di_sh‹éök
 
e2di_blocks


	)

190 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


191 
	#e2fs_ûﬂd
(
ﬁd
, 
√w
) \

192 
	`mem˝y
((
√w
),(
ﬁd
),(
ext2fs_döode
))

	)

193 
	#e2fs_ißve
(
ﬁd
, 
√w
) \

194 
	`mem˝y
((
√w
),(
ﬁd
),(
ext2fs_döode
))

	)

196 
e2fs_i_bsw≠
(
ext2fs_döode
 *, ext2fs_dinode *);

197 
	#e2fs_ûﬂd
(
ﬁd
, 
√w
Ë
	`e2fs_i_bsw≠
((ﬁd), (√w))

	)

198 
	#e2fs_ißve
(
ﬁd
, 
√w
Ë
	`e2fs_i_bsw≠
((ﬁd), (√w))

	)

	@ext2fs_dir.h

67 #i‚de‡
_UFS_EXT2FS_EXT2FS_DIR_H_


68 
	#_UFS_EXT2FS_EXT2FS_DIR_H_


	)

70 
	~<ufs/ext2fs/ext2fs_döode.h
>

77 
	#doff_t
 
öt32_t


	)

78 
	#EXT2FS_MAXDIRSIZE
 
INT32_MAX


	)

107 
	#EXT2FS_MAXNAMLEN
 255

	)

109 
	sext2fs_dúe˘
 {

110 
uöt32_t
 
	me2d_öo
;

111 
uöt16_t
 
	me2d_ª˛í
;

112 
uöt8_t
 
	me2d_«mÀn
;

113 
uöt8_t
 
	me2d_ty≥
;

114 
	me2d_«me
[
EXT2FS_MAXNAMLEN
];

118 
	#EXT2_FT_UNKNOWN
 0

	)

119 
	#EXT2_FT_REG_FILE
 1

	)

120 
	#EXT2_FT_DIR
 2

	)

121 
	#EXT2_FT_CHRDEV
 3

	)

122 
	#EXT2_FT_BLKDEV
 4

	)

123 
	#EXT2_FT_FIFO
 5

	)

124 
	#EXT2_FT_SOCK
 6

	)

125 
	#EXT2_FT_SYMLINK
 7

	)

127 
	#EXT2_FT_MAX
 8

	)

129 
	#E2IFTODT
(
mode
Ë(((modeË& 0170000Ë>> 12)

	)

131 
__ölöe
 
uöt8_t
 
	$öŸ2ext2dt
(
uöt16_t
Ë
__unu£d
;

132 
__ölöe
 
uöt8_t


133 
	$öŸ2ext2dt
(
uöt16_t
 
ty≥
)

136 
ty≥
) {

137 
	`E2IFTODT
(
EXT2_IFIFO
):

138  
EXT2_FT_FIFO
;

139 
	`E2IFTODT
(
EXT2_IFCHR
):

140  
EXT2_FT_CHRDEV
;

141 
	`E2IFTODT
(
EXT2_IFDIR
):

142  
EXT2_FT_DIR
;

143 
	`E2IFTODT
(
EXT2_IFBLK
):

144  
EXT2_FT_BLKDEV
;

145 
	`E2IFTODT
(
EXT2_IFREG
):

146  
EXT2_FT_REG_FILE
;

147 
	`E2IFTODT
(
EXT2_IFLNK
):

148  
EXT2_FT_SYMLINK
;

149 
	`E2IFTODT
(
EXT2_IFSOCK
):

150  
EXT2_FT_SOCK
;

154 
	}
}

163 
	#EXT2FS_DIRSIZ
(
Àn
Ë
	`roundup2
(8 +Üí, 4)

	)

169 
	sext2fs_dúãm∂©e
 {

170 
uöt32_t
 
	mdŸ_öo
;

171 
öt16_t
 
	mdŸ_ª˛í
;

172 
uöt8_t
 
	mdŸ_«mÀn
;

173 
uöt8_t
 
	mdŸ_ty≥
;

174 
	mdŸ_«me
[4];

175 
uöt32_t
 
	mdŸdŸ_öo
;

176 
öt16_t
 
	mdŸdŸ_ª˛í
;

177 
uöt8_t
 
	mdŸdŸ_«mÀn
;

178 
uöt8_t
 
	mdŸdŸ_ty≥
;

179 
	mdŸdŸ_«me
[4];

	@ext2fs_extents.c

1 
	~<sys/∑øm.h
>

2 
	~<sys/sy°m.h
>

3 
	~<sys/ªsour˚v¨.h
>

4 
	~<sys/kî√l.h
>

5 
	~<sys/fûe.h
>

6 
	~<sys/°©.h
>

7 
	~<sys/buf.h
>

8 
	~<sys/¥oc.h
>

9 
	~<sys/mou¡.h
>

10 
	~<sys/vnode.h
>

11 
	~<sys/sig«lv¨.h
>

12 
	~<sys/kauth.h
>

14 
	~<ufs/ufs/öode.h
>

15 
	~<ufs/ufs/ufsmou¡.h
>

16 
	~<ufs/ufs/ufs_exã∫.h
>

19 
	~<ufs/ext2fs/ext2fs.h
>

20 
	~<ufs/ext2fs/ext2fs_exã¡s.h
>

21 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

25 
boﬁ


26 
	$ext4_ext_bö£¨ch_ödex
(
öode
 *
ù
, 
ext4_exã¡_∑th
 *
∑th
,

27 
daddr_t
 
lbn
, daddr_à*
fú°_lbn
, daddr_à*
œ°_lbn
)

29 
	`¥ötf
("ext4_ext_binsearch_index\n");

30 
ext4_exã¡_hódî
 *
ehp
 = 
∑th
->
ï_hódî
;

31 
ext4_exã¡_ödex
 *
fú°
, *
œ°
, *
l
, *
r
, *
m
;

33 
fú°
 = (
ext4_exã¡_ödex
 *)(*)(
ehp
 + 1);

34 
œ°
 = 
fú°
 + 
ehp
->
eh_ecou¡
 - 1;

35 
l
 = 
fú°
;

36 
r
 = 
œ°
;

37 
l
 <
r
) {

38 
m
 = 
l
 + (
r
 -Ü) / 2;

39 i‡(
lbn
 < 
m
->
ei_blk
)

40 
r
 = 
m
 - 1;

42 
l
 = 
m
 + 1;

45 i‡(
l
 =
fú°
) {

46 
∑th
->
ï_•¨£_ext
.
e_blk
 = *
fú°_lbn
;

47 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
fú°
->
ei_blk
 - *
fú°_lbn
;

48 
∑th
->
ï_•¨£_ext
.
e_°¨t_hi
 = 0;

49 
∑th
->
ï_•¨£_ext
.
e_°¨t_lo
 = 0;

50 
∑th
->
ï_is_•¨£
 = 
åue
;

51  (
åue
);

53 
∑th
->
ï_ödex
 = 
l
 - 1;

54 *
fú°_lbn
 = 
∑th
->
ï_ödex
->
ei_blk
;

55 i‡(
∑th
->
ï_ödex
 < 
œ°
)

56 *
œ°_lbn
 = 
l
->
ei_blk
 - 1;

57  (
Ál£
);

58 
	}
}

61 
	$ext4_ext_bö£¨ch
(
öode
 *
ù
, 
ext4_exã¡_∑th
 *
∑th
, 
daddr_t
 
lbn
,

62 
daddr_t
 
fú°_lbn
, daddr_à
œ°_lbn
)

64 
	`¥ötf
("ext4_ext_binsearch\n");

65 
ext4_exã¡_hódî
 *
ehp
 = 
∑th
->
ï_hódî
;

66 
ext4_exã¡
 *
fú°
, *
l
, *
r
, *
m
;

68 i‡(
ehp
->
eh_ecou¡
 == 0)

71 
fú°
 = (
ext4_exã¡
 *)(*)(
ehp
 + 1);

72 
l
 = 
fú°
;

73 
r
 = 
fú°
 + 
ehp
->
eh_ecou¡
 - 1;

74 
l
 <
r
) {

75 
m
 = 
l
 + (
r
 -Ü) / 2;

76 i‡(
lbn
 < 
m
->
e_blk
)

77 
r
 = 
m
 - 1;

79 
l
 = 
m
 + 1;

82 i‡(
l
 =
fú°
) {

83 
∑th
->
ï_•¨£_ext
.
e_blk
 = 
fú°_lbn
;

84 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
fú°
->
e_blk
 - 
fú°_lbn
;

85 
∑th
->
ï_•¨£_ext
.
e_°¨t_hi
 = 0;

86 
∑th
->
ï_•¨£_ext
.
e_°¨t_lo
 = 0;

87 
∑th
->
ï_is_•¨£
 = 
åue
;

90 
∑th
->
ï_ext
 = 
l
 - 1;

91 i‡(
∑th
->
ï_ext
->
e_blk
 +Ö©h->ï_ext->
e_Àn
 <
lbn
) {

92 
∑th
->
ï_•¨£_ext
.
e_blk
 =Ö©h->
ï_ext
->e_blk +

93 
∑th
->
ï_ext
->
e_Àn
;

94 i‡(
l
 <(
fú°
 + 
ehp
->
eh_ecou¡
 - 1))

95 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
l
->
e_blk
 -

96 
∑th
->
ï_•¨£_ext
.
e_blk
;

98 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
œ°_lbn
 -

99 
∑th
->
ï_•¨£_ext
.
e_blk
 + 1;

100 
∑th
->
ï_•¨£_ext
.
e_°¨t_hi
 = 0;

101 
∑th
->
ï_•¨£_ext
.
e_°¨t_lo
 = 0;

102 
∑th
->
ï_is_•¨£
 = 
åue
;

104 
	}
}

110 
	$ext4_ext_ö_ˇche
(
öode
 *
ù
, 
daddr_t
 
lbn
, 
ext4_exã¡
 *
ï
)

112 
	`¥ötf
("ext4_ext_in_cache\n");

113 
ext4_exã¡_ˇche
 *
e˝
;

114 
ªt
 = 
EXT4_EXT_CACHE_NO
;

116 
e˝
 = &
ù
->
öode_ext
.
e2fs
.
i_ext_ˇche
;

119 i‡(
e˝
->
ec_ty≥
 =
EXT4_EXT_CACHE_NO
)

120  (
ªt
);

122 i‡(
lbn
 >
e˝
->
ec_blk
 &&Üb¿<É˝->ec_blk +É˝->
ec_Àn
) {

123 
ï
->
e_blk
 = 
e˝
->
ec_blk
;

124 
ï
->
e_°¨t_lo
 = 
e˝
->
ec_°¨t
 & 0xffffffff;

125 
ï
->
e_°¨t_hi
 = 
e˝
->
ec_°¨t
 >> 32 & 0xffff;

126 
ï
->
e_Àn
 = 
e˝
->
ec_Àn
;

127 
ªt
 = 
e˝
->
ec_ty≥
;

129  (
ªt
);

130 
	}
}

136 
	$ext4_ext_put_ˇche
(
öode
 *
ù
, 
ext4_exã¡
 *
ï
, 
ty≥
)

138 
	`¥ötf
("ext4_ext_put_cache\n");

139 
ext4_exã¡_ˇche
 *
e˝
;

141 
e˝
 = &
ù
->
öode_ext
.
e2fs
.
i_ext_ˇche
;

142 
e˝
->
ec_ty≥
 = 
ty≥
;

143 
e˝
->
ec_blk
 = 
ï
->
e_blk
;

144 
e˝
->
ec_Àn
 = 
ï
->
e_Àn
;

145 
e˝
->
ec_°¨t
 = (
daddr_t
)
ï
->
e_°¨t_hi
 << 32 |Ép->
e_°¨t_lo
;

146 
	}
}

151 
ext4_exã¡_∑th
 *

152 
	$ext4_ext_föd_exã¡
(
m_ext2fs
 *
fs
, 
öode
 *
ù
,

153 
daddr_t
 
lbn
, 
ext4_exã¡_∑th
 *
∑th
)

155 
	`¥ötf
("insideÉxt4_ext_find_extent\n");

156 
ext4_exã¡_hódî
 *
ehp
;

157 
uöt16_t
 
i
;

158 
îr‹
, 
size
;

159 
daddr_t
 
nblk
;

161 
ehp
 = (
ext4_exã¡_hódî
 *)(*)
ù
->
i_dö
.
e2fs_dö
->
e2di_blocks
;

163 i‡(
ehp
->
eh_magic
 !
EXT4_EXT_MAGIC
)

164  (
NULL
);

166 
∑th
->
ï_hódî
 = 
ehp
;

168 
daddr_t
 
fú°_lbn
 = 0;

169 
daddr_t
 
œ°_lbn
 = 
	`lblkno
(
ù
->
i_e2fs
, ip->
i_size
);

171 
i
 = 
ehp
->
eh_dïth
; i != 0; --i) {

172 
∑th
->
ï_dïth
 = 
i
;

173 
∑th
->
ï_ext
 = 
NULL
;

174 i‡(
	`ext4_ext_bö£¨ch_ödex
(
ù
, 
∑th
, 
lbn
, &
fú°_lbn
,

175 &
œ°_lbn
)) {

176  (
∑th
);

179 
nblk
 = (
daddr_t
)
∑th
->
ï_ödex
->
ei_Àaf_hi
 << 32 |

180 
∑th
->
ï_ödex
->
ei_Àaf_lo
;

181 
size
 = 
	`blksize
(
fs
, 
ù
, 
nblk
);

182 i‡(
∑th
->
ï_bp
 !
NULL
) {

183 
	`bªl£
(
∑th
->
ï_bp
,0);

184 
∑th
->
ï_bp
 = 
NULL
;

186 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
, 
	`fsbtodb
(
fs
, 
nblk
), 
size
, 0,

187 &
∑th
->
ï_bp
);

188 i‡(
îr‹
) {

189 
	`bªl£
(
∑th
->
ï_bp
,0);

190 
∑th
->
ï_bp
 = 
NULL
;

191  (
NULL
);

193 
ehp
 = (
ext4_exã¡_hódî
 *)
∑th
->
ï_bp
->
b_d©a
;

194 
∑th
->
ï_hódî
 = 
ehp
;

197 
∑th
->
ï_dïth
 = 
i
;

198 
∑th
->
ï_ext
 = 
NULL
;

199 
∑th
->
ï_ödex
 = 
NULL
;

200 
∑th
->
ï_is_•¨£
 = 
Ál£
;

202 
	`ext4_ext_bö£¨ch
(
ù
, 
∑th
, 
lbn
, 
fú°_lbn
, 
œ°_lbn
);

203  (
∑th
);

204 
	}
}

	@ext2fs_extents.h

1 #i‚de‡
_FS_EXT2FS_EXT2_EXTENTS_H_


2 
	#_FS_EXT2FS_EXT2_EXTENTS_H_


	)

4 
	~<sys/ty≥s.h
>

5 
	~<ufs/ufs/öode.h
>

6 
	#EXT4_EXT_MAGIC
 0xf30a

	)

8 
	#EXT4_EXT_CACHE_NO
 0

	)

9 
	#EXT4_EXT_CACHE_GAP
 1

	)

10 
	#EXT4_EXT_CACHE_IN
 2

	)

15 
	sext4_exã¡
 {

16 
uöt32_t
 
	me_blk
;

17 
uöt16_t
 
	me_Àn
;

18 
uöt16_t
 
	me_°¨t_hi
;

19 
uöt32_t
 
	me_°¨t_lo
;

25 
	sext4_exã¡_ödex
 {

26 
uöt32_t
 
	mei_blk
;

27 
uöt32_t
 
	mei_Àaf_lo
;

29 
uöt16_t
 
	mei_Àaf_hi
;

30 
uöt16_t
 
	mei_unu£d
;

36 
	sext4_exã¡_hódî
 {

37 
uöt16_t
 
	meh_magic
;

38 
uöt16_t
 
	meh_ecou¡
;

39 
uöt16_t
 
	meh_max
;

40 
uöt16_t
 
	meh_dïth
;

41 
uöt32_t
 
	meh_gí
;

47 
	sext4_exã¡_ˇche
 {

48 
daddr_t
 
	mec_°¨t
;

49 
uöt32_t
 
	mec_blk
;

50 
uöt32_t
 
	mec_Àn
;

51 
uöt32_t
 
	mec_ty≥
;

57 
	sext4_exã¡_∑th
 {

58 
uöt16_t
 
	mï_dïth
;

59 
buf
 *
	mï_bp
;

60 
boﬁ
 
	mï_is_•¨£
;

62 
ext4_exã¡
 
	mï_•¨£_ext
;

63 
ext4_exã¡
 *
	mï_ext
;

65 
ext4_exã¡_ödex
 *
	mï_ödex
;

66 
ext4_exã¡_hódî
 *
	mï_hódî
;

69 
	göode
;

70 
	gm_ext2fs
;

71 
ext4_ext_ö_ˇche
(
öode
 *, 
daddr_t
, 
ext4_exã¡
 *);

72 
ext4_ext_put_ˇche
(
öode
 *, 
ext4_exã¡
 *, );

73 
ext4_exã¡_∑th
 *
ext4_ext_föd_exã¡
(
m_ext2fs
 *
fs
,

74 
öode
 *, 
daddr_t
, 
ext4_exã¡_∑th
 *);

	@ext2fs_extern.h

62 #i‚de‡
_UFS_EXT2FS_EXT2FS_EXTERN_H_


63 
	#_UFS_EXT2FS_EXT2FS_EXTERN_H_


	)

65 
	gbuf
;

66 
	gfid
;

67 
	gm_ext2fs
;

68 
	göode
;

69 
	gmou¡
;

70 
	g«meid©a
;

71 
	glwp
;

72 
	g¥oc
;

73 
	g°©vfs
;

74 
	gtimevÆ
;

75 
	gufsmou¡
;

76 
	guio
;

77 
	gvnode
;

78 
	gmbuf
;

79 
	gcomp⁄íäame
;

80 
	gufs_lookup_ªsu…s
;

82 
poﬁ
 
ext2fs_öode_poﬁ
;

83 
poﬁ
 
ext2fs_döode_poﬁ
;

85 
	#EXT2FS_ITIMES
(
ù
, 
acc
, 
mod
, 
¸e
) \

86 (
ù
)->
i_Êag
 & (
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFY
)) \

87 
	`ext2fs_ôimes
(
ù
, 
acc
, 
mod
, 
¸e
)

	)

89 
__BEGIN_DECLS


92 
ext2fs_Æloc
(
öode
 *, 
daddr_t
, daddr_à, 
kauth_¸ed_t
,

93 
daddr_t
 *);

94 
ext2fs_ªÆloccg
(
öode
 *, 
daddr_t
, daddr_t, , ,

95 
kauth_¸ed_t
, 
buf
 **);

96 
ext2fs_vÆloc
(
vnode
 *, , 
kauth_¸ed_t
, vnode **);

98 
daddr_t
 
ext2fs_blk¥ef
(
öode
 *, daddr_t, , 
öt32_t
 *);

99 
ext2fs_blk‰ì
(
öode
 *, 
daddr_t
);

100 
ext2fs_v‰ì
(
vnode
 *, 
öo_t
, );

103 
ext2fs_bÆloc
(
öode
 *, 
daddr_t
, , 
kauth_¸ed_t
,

104 
buf
 **, );

105 
ext2fs_g›_Æloc
(
vnode
 *, 
off_t
, off_t, , 
kauth_¸ed_t
);

108 
ext2fs_bm≠
(*);

111 
uöt64_t
 
ext2fs_size
(
öode
 *);

112 
ext2fs_£tsize
(
öode
 *, 
uöt64_t
);

113 
uöt64_t
 
ext2fs_nblock
(
öode
 *);

114 
ext2fs_£äblock
(
öode
 *, 
uöt64_t
);

115 
ext2fs_upd©e
(
vnode
 *, c⁄° 
time•ec
 *,

116 c⁄° 
time•ec
 *, );

117 
ext2fs_åunˇã
(
vnode
 *, 
off_t
, , 
kauth_¸ed_t
);

118 
ext2fs_öa˘ive
(*);

121 
ext2fs_ªaddú
(*);

122 
ext2fs_lookup
(*);

123 
ext2fs_dúíãr
(
öode
 *, 
vnode
 *,

124 c⁄° 
ufs_lookup_ªsu…s
 *,

125 
comp⁄íäame
 *);

126 
ext2fs_dúªmove
(
vnode
 *, c⁄° 
ufs_lookup_ªsu…s
 *,

127 
comp⁄íäame
 *);

128 
ext2fs_dúªwrôe
(
öode
 *, c⁄° 
ufs_lookup_ªsu…s
 *,

129 
öode
 *, 
comp⁄íäame
 *);

130 
ext2fs_dúem±y
(
öode
 *, 
öo_t
, 
kauth_¸ed_t
);

133 
ext2fs_blk©off
(
vnode
 *, 
off_t
, **, 
buf
 **);

134 
ext2fs_‰agac˘
(
m_ext2fs
 *, , 
öt32_t
[], );

135 
ext2fs_ôimes
(
öode
 *, c⁄° 
time•ec
 *,

136 c⁄° 
time•ec
 *, const timespec *);

139 
VFS_PROTOS
(
ext2fs
);

140 
ext2fs_ªlﬂd
(
mou¡
 *, 
kauth_¸ed_t
, 
lwp
 *);

141 
ext2fs_mou¡fs
(
vnode
 *, 
mou¡
 *);

142 
ext2fs_Êushfûes
(
mou¡
 *, );

143 
ext2fs_sbupd©e
(
ufsmou¡
 *, );

144 
ext2fs_cgupd©e
(
ufsmou¡
 *, );

145 
ext2fs_£t_öode_guid
(
öode
 *);

148 
ext2fs_ªad
(*);

149 
ext2fs_wrôe
(*);

150 
ext2fs_bu‰d
(
vnode
 *, 
uio
 *, , 
kauth_¸ed_t
);

151 
ext2fs_bufwr
(
vnode
 *, 
uio
 *, , 
kauth_¸ed_t
);

154 
ext2fs_¸óã
(*);

155 
ext2fs_mknod
(*);

156 
ext2fs_›í
(*);

157 
ext2fs_ac˚ss
(*);

158 
ext2fs_gë©å
(*);

159 
ext2fs_£èâr
(*);

160 
ext2fs_ªmove
(*);

161 
ext2fs_lök
(*);

162 
ext2fs_ª«me
(*);

163 
ext2fs_mkdú
(*);

164 
ext2fs_rmdú
(*);

165 
ext2fs_symlök
(*);

166 
ext2fs_ªadlök
(*);

167 
ext2fs_advlock
(*);

168 
ext2fs_fsync
(*);

169 
ext2fs_vöô
(
mou¡
 *, (**
•ec›s
)(*),

170 (**
fifo›s
)(*), 
vnode
 **);

171 
	`ext2fs_makeöode
(, 
vnode
 *, vnode **,

172 
comp⁄íäame
 *
˙p
);

173 
	`ext2fs_ª˛aim
(*);

175 
__END_DECLS


177 
	#IS_EXT2_VNODE
(
vp
Ë(vp->
v_èg
 =
VT_EXT2FS
)

	)

179 (**
ext2fs_vnode›_p
)(*);

180 (**
ext2fs_•ec›_p
)(*);

181 (**
ext2fs_fifo›_p
)(*);

	@ext2fs_inode.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_inode.c,v 1.82 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/mou¡.h
>

68 
	~<sys/¥oc.h
>

69 
	~<sys/fûe.h
>

70 
	~<sys/buf.h
>

71 
	~<sys/vnode.h
>

72 
	~<sys/kî√l.h
>

73 
	~<sys/kmem.h
>

74 
	~<sys/åa˚.h
>

75 
	~<sys/ªsour˚v¨.h
>

76 
	~<sys/kauth.h
>

78 
	~<ufs/ufs/öode.h
>

79 
	~<ufs/ufs/ufsmou¡.h
>

80 
	~<ufs/ufs/ufs_exã∫.h
>

82 
	~<ufs/ext2fs/ext2fs.h
>

83 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

85 
¥è˘ive
;

87 
ext2fs_ödúåunc
(
öode
 *, 
daddr_t
, daddr_t,

88 
daddr_t
, , *);

95 
CTASSERT
(
EXT2FS_NDADDR
 =
UFS_NDADDR
);

96 
CTASSERT
(
EXT2FS_NIADDR
 =
UFS_NIADDR
);

101 
uöt64_t


102 
	$ext2fs_size
(
öode
 *
ù
)

104 
uöt64_t
 
size
 = 
ù
->
i_e2fs_size
;

106 i‡((
ù
->
i_e2fs_mode
 & 
IFMT
Ë=
IFREG
)

107 
size
 |(
uöt64_t
)
ù
->
i_e2fs_da˛
 << 32;

108  
size
;

109 
	}
}

112 
	$ext2fs_£tsize
(
öode
 *
ù
, 
uöt64_t
 
size
)

114 i‡((
ù
->
i_e2fs_mode
 & 
IFMT
Ë=
IFREG
 ||

115 
ù
->
i_e2fs_mode
 == 0) {

116 
ù
->
i_e2fs_da˛
 = 
size
 >> 32;

117 i‡(
size
 >= 0x80000000U) {

118 
m_ext2fs
 *
fs
 = 
ù
->
i_e2fs
;

120 i‡(
fs
->
e2fs
.
e2fs_ªv
 <
E2FS_REV0
) {

122  
EFBIG
;

124 i‡(!(
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t


125 & 
EXT2F_ROCOMPAT_LARGEFILE
)) {

126 
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
 |=

127 
EXT2F_ROCOMPAT_LARGEFILE
;

128 
fs
->
e2fs_fmod
 = 1;

131 } i‡(
size
 >= 0x80000000U)

132  
EFBIG
;

134 
ù
->
i_e2fs_size
 = 
size
;

137 
	}
}

139 
uöt64_t


140 
	$ext2fs_nblock
(
öode
 *
ù
)

142 
uöt64_t
 
nblock
 = 
ù
->
i_e2fs_nblock
;

143 
m_ext2fs
 * c⁄° 
fs
 = 
ù
->
i_e2fs
;

145 i‡(
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
 & 
EXT2F_ROCOMPAT_HUGE_FILE
) {

146 
nblock
 |(
uöt64_t
)
ù
->
i_e2fs_nblock_high
 << 32;

148 i‡((
ù
->
i_e2fs_Êags
 & 
EXT2_HUGE_FILE
)) {

149 
nblock
 = 
	`EXT2_FSBTODB
(
fs
,Çblock);

153  
nblock
;

154 
	}
}

157 
	$ext2fs_£äblock
(
öode
 *
ù
, 
uöt64_t
 
nblock
)

159 
m_ext2fs
 * c⁄° 
fs
 = 
ù
->
i_e2fs
;

161 i‡(
nblock
 <= 0xffffffffULL) {

162 
	`CLR
(
ù
->
i_e2fs_Êags
, 
EXT2_HUGE_FILE
);

163 
ù
->
i_e2fs_nblock
 = 
nblock
;

167 i‡(!
	`ISSET
(
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
, 
EXT2F_ROCOMPAT_HUGE_FILE
))

168  
EFBIG
;

170 i‡(
nblock
 <= 0xffffffffffffULL) {

171 
	`CLR
(
ù
->
i_e2fs_Êags
, 
EXT2_HUGE_FILE
);

172 
ù
->
i_e2fs_nblock
 = 
nblock
 & 0xffffffff;

173 
ù
->
i_e2fs_nblock_high
 = (
nblock
 >> 32) & 0xffff;

177 i‡(
	`EXT2_DBTOFSB
(
fs
, 
nblock
) <= 0xffffffffffffULL) {

178 
	`SET
(
ù
->
i_e2fs_Êags
, 
EXT2_HUGE_FILE
);

179 
ù
->
i_e2fs_nblock
 = 
	`EXT2_DBTOFSB
(
fs
, 
nblock
) & 0xffffffff;

180 
ù
->
i_e2fs_nblock_high
 = (
	`EXT2_DBTOFSB
(
fs
, 
nblock
) >> 32) & 0xffff;

184  
EFBIG
;

185 
	}
}

191 
	$ext2fs_öa˘ive
(*
v
)

193 
v›_öa˘ive_¨gs


196  *
≠
 = 
v
;

197 
vnode
 *
vp
 = 
≠
->
a_vp
;

198 
öode
 *
ù
 = 
	`VTOI
(
vp
);

199 
îr‹
 = 0;

201 i‡(
¥è˘ive
 && 
vp
->
v_u£cou¡
 != 0)

202 
	`v¥öt
("ext2fs_öa˘ive:Öushögá˘ive", 
vp
);

204 i‡(
ù
->
i_e2fs_mode
 =0 || ip->
i_e2fs_dtime
 != 0)

205 
out
;

207 
îr‹
 = 0;

208 i‡(
ù
->
i_e2fs_∆ök
 =0 && (
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
) == 0) {

210 i‡(
	`ext2fs_size
(
ù
) != 0) {

211 
îr‹
 = 
	`ext2fs_åunˇã
(
vp
, (
off_t
)0, 0, 
NOCRED
);

213 
ù
->
i_e2fs_dtime
 = 
time_£c⁄d
;

214 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

215 
ù
->
i_omode
 = 1;

217 i‡(
ù
->
i_Êag
 & (
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFIED
)) {

218 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 0);

220 
out
:

225 *
≠
->
a_ªcy˛e
 = (
ù
->
i_e2fs_dtime
 != 0);

226 
	`VOP_UNLOCK
(
vp
);

227  (
îr‹
);

228 
	}
}

241 
	$ext2fs_upd©e
(
vnode
 *
vp
, c⁄° 
time•ec
 *
acc
,

242 c⁄° 
time•ec
 *
mod
, 
updÊags
)

244 
m_ext2fs
 *
fs
;

245 
buf
 *
bp
;

246 
öode
 *
ù
;

247 
îr‹
;

248 *
˝
;

249 
Êags
;

251 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

253 
ù
 = 
	`VTOI
(
vp
);

254 
	`EXT2FS_ITIMES
(
ù
, 
acc
, 
mod
, 
NULL
);

255 i‡(
updÊags
 & 
UPDATE_CLOSE
)

256 
Êags
 = 
ù
->
i_Êag
 & (
IN_MODIFIED
 | 
IN_ACCESSED
);

258 
Êags
 = 
ù
->
i_Êag
 & 
IN_MODIFIED
;

259 i‡(
Êags
 == 0)

261 
fs
 = 
ù
->
i_e2fs
;

263 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
,

264 
	`EXT2_FSBTODB
(
fs
, 
	`öo_to_fsba
(fs, 
ù
->
i_numbî
)),

265 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

266 i‡(
îr‹
) {

267  (
îr‹
);

269 
ù
->
i_Êag
 &~(
IN_MODIFIED
 | 
IN_ACCESSED
);

270 
˝
 = (*)
bp
->
b_d©a
 +

271 (
	`öo_to_fsbo
(
fs
, 
ù
->
i_numbî
Ë* 
	`EXT2_DINODE_SIZE
(fs));

272 
	`e2fs_ißve
(
ù
->
i_dö
.
e2fs_dö
, (
ext2fs_döode
 *)
˝
);

273 i‡((
updÊags
 & (
UPDATE_WAIT
|
UPDATE_DIROP
)) != 0 &&

274 (
Êags
 & 
IN_MODIFIED
) != 0 &&

275 (
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_ASYNC
) == 0)

276  (
	`bwrôe
(
bp
));

278 
	`bdwrôe
(
bp
);

281 
	}
}

283 
	#SINGLE
 0

	)

284 
	#DOUBLE
 1

	)

285 
	#TRIPLE
 2

	)

291 
	$ext2fs_åunˇã
(
vnode
 *
ovp
, 
off_t
 
Àngth
, 
ioÊag
,

292 
kauth_¸ed_t
 
¸ed
)

294 
daddr_t
 
œ°block
;

295 
öode
 *
où
 = 
	`VTOI
(
ovp
);

296 
daddr_t
 
bn
, 
œ°iblock
[
EXT2FS_NIADDR
], 
ödú_lbn
[EXT2FS_NIADDR];

298 
öt32_t
 
ﬁdblks
[
EXT2FS_NDADDR
 + 
EXT2FS_NIADDR
], 
√wblks
[EXT2FS_NDADDR + EXT2FS_NIADDR];

299 
m_ext2fs
 *
fs
;

300 
off£t
, 
size
, 
Àvñ
;

301 
cou¡
, 
block§ñó£d
 = 0;

302 
i
, 
nblocks
;

303 
îr‹
, 
ÆÀº‹
 = 0;

304 
off_t
 
osize
;

305 
sync
;

306 
ufsmou¡
 *
ump
 = 
où
->
i_ump
;

308 i‡(
ovp
->
v_ty≥
 =
VCHR
 || ovp->v_ty≥ =
VBLK
 ||

309 
ovp
->
v_ty≥
 =
VFIFO
 || ovp->v_ty≥ =
VSOCK
) {

313 i‡(
Àngth
 < 0)

314  (
EINVAL
);

316 i‡(
ovp
->
v_ty≥
 =
VLNK
 &&

317 (
	`ext2fs_size
(
où
Ë< 
ump
->
um_maxsymlökÀn
 ||

318 (
ump
->
um_maxsymlökÀn
 =0 && 
	`ext2fs_nblock
(
où
) == 0))) {

319 
	`KDASSERT
(
Àngth
 == 0);

320 
	`mem£t
((*)&
où
->
i_dö
.
e2fs_dö
->
e2di_sh‹éök
, 0,

321 (
u_öt
)
	`ext2fs_size
(
où
));

322 ()
	`ext2fs_£tsize
(
où
, 0);

323 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

324  (
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 0));

326 i‡(
	`ext2fs_size
(
où
Ë=
Àngth
) {

328 
	`uvm_v≈_£tsize
(
ovp
, 
Àngth
);

329 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

330  (
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 0));

332 
fs
 = 
où
->
i_e2fs
;

333 i‡(
Àngth
 > 
ump
->
um_maxfûesize
)

334  (
EFBIG
);

336 
osize
 = 
	`ext2fs_size
(
où
);

343 i‡(
osize
 < 
Àngth
) {

344 
	`uvm_v≈_£twrôesize
(
ovp
, 
Àngth
);

345 
îr‹
 = 
	`ufs_bÆloc_ønge
(
ovp
, 
Àngth
 - 1, 1, 
¸ed
,

346 
ioÊag
 & 
IO_SYNC
 ? 
B_SYNC
 : 0);

347 i‡(
îr‹
) {

348 (Ë
	`ext2fs_åunˇã
(
ovp
, 
osize
, 
ioÊag
 & 
IO_SYNC
,

349 
¸ed
);

350  (
îr‹
);

352 
	`uvm_v≈_£tsize
(
ovp
, 
Àngth
);

353 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

354 
	`KASSERT
(
îr‹
 || 
ovp
->
v_size
 =
	`ext2fs_size
(
où
));

355  (
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 0));

364 
off£t
 = 
	`ext2_blkoff
(
fs
, 
Àngth
);

365 i‡(
off£t
 != 0) {

366 
size
 = 
fs
->
e2fs_bsize
;

369 
	`ubc_zî‹™ge
(&
ovp
->
v_uobj
, 
Àngth
, 
size
 - 
off£t
,

370 
	`UBC_UNMAP_FLAG
(
ovp
));

372 ()
	`ext2fs_£tsize
(
où
, 
Àngth
);

373 
	`uvm_v≈_£tsize
(
ovp
, 
Àngth
);

380 
œ°block
 = 
	`ext2_lblkno
(
fs
, 
Àngth
 + fs->
e2fs_bsize
 - 1) - 1;

381 
œ°iblock
[
SINGLE
] = 
œ°block
 - 
EXT2FS_NDADDR
;

382 
œ°iblock
[
DOUBLE
] =Üa°iblock[
SINGLE
] - 
	`EXT2_NINDIR
(
fs
);

383 
œ°iblock
[
TRIPLE
] =Üa°iblock[
DOUBLE
] - 
	`EXT2_NINDIR
(
fs
) * EXT2_NINDIR(fs);

384 
nblocks
 = 
	`btodb
(
fs
->
e2fs_bsize
);

391 
	`mem˝y
((*)
ﬁdblks
, (*)&
où
->
i_e2fs_blocks
[0],  oldblks);

392 
sync
 = 0;

393 
Àvñ
 = 
TRIPLE
;Üevñ >
SINGLE
;Üevel--) {

394 i‡(
œ°iblock
[
Àvñ
] < 0 && 
ﬁdblks
[
EXT2FS_NDADDR
 +Üevel] != 0) {

395 
sync
 = 1;

396 
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
] = 0;

397 
œ°iblock
[
Àvñ
] = -1;

400 
i
 = 0; i < 
EXT2FS_NDADDR
; i++) {

401 i‡(
i
 > 
œ°block
 && 
ﬁdblks
[i] != 0) {

402 
sync
 = 1;

403 
où
->
i_e2fs_blocks
[
i
] = 0;

406 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

407 i‡(
sync
) {

408 
îr‹
 = 
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 
UPDATE_WAIT
);

409 i‡(
îr‹
 && !
ÆÀº‹
)

410 
ÆÀº‹
 = 
îr‹
;

419 
	`mem˝y
((*)
√wblks
, (*)&
où
->
i_e2fs_blocks
[0], Çewblks);

420 
	`mem˝y
((*)&
où
->
i_e2fs_blocks
[0], (*)
ﬁdblks
,  oldblks);

422 ()
	`ext2fs_£tsize
(
où
, 
osize
);

423 
îr‹
 = 
	`våuncbuf
(
ovp
, 
œ°block
 + 1, 0, 0);

424 i‡(
îr‹
 && !
ÆÀº‹
)

425 
ÆÀº‹
 = 
îr‹
;

430 
ödú_lbn
[
SINGLE
] = -
EXT2FS_NDADDR
;

431 
ödú_lbn
[
DOUBLE
] = indú_lbn[
SINGLE
] - 
	`EXT2_NINDIR
(
fs
) -1;

432 
ödú_lbn
[
TRIPLE
] = indú_lbn[
DOUBLE
] - 
	`EXT2_NINDIR
(
fs
) * EXT2_NINDIR(fs) - 1;

433 
Àvñ
 = 
TRIPLE
;Üevñ >
SINGLE
;Üevel--) {

435 
bn
 = 
	`fs2h32
(
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
]);

436 i‡(
bn
 != 0) {

437 
îr‹
 = 
	`ext2fs_ödúåunc
(
où
, 
ödú_lbn
[
Àvñ
],

438 
	`EXT2_FSBTODB
(
fs
, 
bn
), 
œ°iblock
[
Àvñ
],Üevñ, &
cou¡
);

439 i‡(
îr‹
)

440 
ÆÀº‹
 = 
îr‹
;

441 
block§ñó£d
 +
cou¡
;

442 i‡(
œ°iblock
[
Àvñ
] < 0) {

443 
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
] = 0;

444 
	`ext2fs_blk‰ì
(
où
, 
bn
);

445 
block§ñó£d
 +
nblocks
;

448 i‡(
œ°iblock
[
Àvñ
] >= 0)

449 
d⁄e
;

455 
i
 = 
EXT2FS_NDADDR
 - 1; i > 
œ°block
; i--) {

457 
bn
 = 
	`fs2h32
(
où
->
i_e2fs_blocks
[
i
]);

458 i‡(
bn
 == 0)

460 
où
->
i_e2fs_blocks
[
i
] = 0;

461 
	`ext2fs_blk‰ì
(
où
, 
bn
);

462 
block§ñó£d
 +
	`btodb
(
fs
->
e2fs_bsize
);

465 
d⁄e
:

466 #ifde‡
DIAGNOSTIC


467 
Àvñ
 = 
SINGLE
;Üevñ <
TRIPLE
;Üevel++)

468 i‡(
√wblks
[
EXT2FS_NDADDR
 + 
Àvñ
] !=

469 
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
])

470 
	`∑nic
("ext2fs_truncate1");

471 
i
 = 0; i < 
EXT2FS_NDADDR
; i++)

472 i‡(
√wblks
[
i
] !
où
->
i_e2fs_blocks
[i])

473 
	`∑nic
("ext2fs_truncate2");

474 i‡(
Àngth
 == 0 &&

475 (!
	`LIST_EMPTY
(&
ovp
->
v_˛ónblkhd
) ||

476 !
	`LIST_EMPTY
(&
ovp
->
v_dútyblkhd
)))

477 
	`∑nic
("ext2fs_truncate3");

482 ()
	`ext2fs_£tsize
(
où
, 
Àngth
);

483 
îr‹
 = 
	`ext2fs_£äblock
(
où
, 
	`ext2fs_nblock
(oùË- 
block§ñó£d
);

484 i‡(
îr‹
 != 0)

485 
ÆÀº‹
 = 
îr‹
;

486 
où
->
i_Êag
 |
IN_CHANGE
;

487 
	`KASSERT
(
ovp
->
v_ty≥
 !
VREG
 || ovp->
v_size
 =
	`ext2fs_size
(
où
));

488  (
ÆÀº‹
);

489 
	}
}

501 
	$ext2fs_ödúåunc
(
öode
 *
ù
, 
daddr_t
 
lbn
, daddr_à
dbn
, daddr_à
œ°bn
,

502 
Àvñ
, *
cou¡p
)

504 
i
;

505 
buf
 *
bp
;

506 
m_ext2fs
 *
fs
 = 
ù
->
i_e2fs
;

507 
öt32_t
 *
b≠
;

508 
vnode
 *
vp
;

509 
daddr_t
 
nb
, 
∆bn
, 
œ°
;

510 
öt32_t
 *
c›y
 = 
NULL
;

511 
blkcou¡
, 
Á˘‹
;

512 
nblocks
, 
block§ñó£d
 = 0;

513 
îr‹
 = 0, 
ÆÀº‹
 = 0;

520 
Á˘‹
 = 1;

521 
i
 = 
SINGLE
; i < 
Àvñ
; i++)

522 
Á˘‹
 *
	`EXT2_NINDIR
(
fs
);

523 
œ°
 = 
œ°bn
;

524 i‡(
œ°bn
 > 0)

525 
œ°
 /
Á˘‹
;

526 
nblocks
 = 
	`btodb
(
fs
->
e2fs_bsize
);

535 
vp
 = 
	`ITOV
(
ù
);

536 
bp
 = 
	`gëblk
(
vp
, 
lbn
, ()
fs
->
e2fs_bsize
, 0, 0);

537 i‡(
bp
->
b_oÊags
 & (
BO_DONE
 | 
BO_DELWRI
)) {

539 
	`åa˚
(
TR_BREADHIT
, 
	`∑ck
(
vp
, 
fs
->
e2fs_bsize
), 
lbn
);

541 
	`åa˚
(
TR_BREADMISS
, 
	`∑ck
(
vp
, 
fs
->
e2fs_bsize
), 
lbn
);

542 
cuæwp
->
l_ru
.
ru_öblock
++;

543 
bp
->
b_Êags
 |
B_READ
;

544 i‡(
bp
->
b_bcou¡
 > bp->
b_bufsize
)

545 
	`∑nic
("ext2fs_indirtrunc: bad buffer size");

546 
bp
->
b_blkno
 = 
dbn
;

547 
	`VOP_STRATEGY
(
vp
, 
bp
);

548 
îr‹
 = 
	`biowaô
(
bp
);

550 i‡(
îr‹
) {

551 
	`bªl£
(
bp
, 0);

552 *
cou¡p
 = 0;

553  (
îr‹
);

556 
b≠
 = (
öt32_t
 *)
bp
->
b_d©a
;

557 i‡(
œ°bn
 >= 0) {

559 
c›y
 = 
	`kmem_Æloc
(
fs
->
e2fs_bsize
, 
KM_SLEEP
);

560 
	`mem˝y
((*)
c›y
, (*)
b≠
, (
u_öt
)
fs
->
e2fs_bsize
);

561 
	`mem£t
((*)&
b≠
[
œ°
 + 1], 0,

562 (
u_öt
)(
	`EXT2_NINDIR
(
fs
Ë- (
œ°
 + 1)Ë*  (
uöt32_t
));

563 
îr‹
 = 
	`bwrôe
(
bp
);

564 i‡(
îr‹
)

565 
ÆÀº‹
 = 
îr‹
;

566 
b≠
 = 
c›y
;

572 
i
 = 
	`EXT2_NINDIR
(
fs
) - 1,

573 
∆bn
 = 
lbn
 + 1 - 
i
 * 
Á˘‹
; i > 
œ°
;

574 
i
--, 
∆bn
 +
Á˘‹
) {

576 
nb
 = 
	`fs2h32
(
b≠
[
i
]);

577 i‡(
nb
 == 0)

579 i‡(
Àvñ
 > 
SINGLE
) {

580 
îr‹
 = 
	`ext2fs_ödúåunc
(
ù
, 
∆bn
, 
	`EXT2_FSBTODB
(
fs
, 
nb
),

581 (
daddr_t
)-1, 
Àvñ
 - 1,

582 &
blkcou¡
);

583 i‡(
îr‹
)

584 
ÆÀº‹
 = 
îr‹
;

585 
block§ñó£d
 +
blkcou¡
;

587 
	`ext2fs_blk‰ì
(
ù
, 
nb
);

588 
block§ñó£d
 +
nblocks
;

594 i‡(
Àvñ
 > 
SINGLE
 && 
œ°bn
 >= 0) {

595 
œ°
 = 
œ°bn
 % 
Á˘‹
;

597 
nb
 = 
	`fs2h32
(
b≠
[
i
]);

598 i‡(
nb
 != 0) {

599 
îr‹
 = 
	`ext2fs_ödúåunc
(
ù
, 
∆bn
, 
	`EXT2_FSBTODB
(
fs
, 
nb
),

600 
œ°
, 
Àvñ
 - 1, &
blkcou¡
);

601 i‡(
îr‹
)

602 
ÆÀº‹
 = 
îr‹
;

603 
block§ñó£d
 +
blkcou¡
;

607 i‡(
c›y
 !
NULL
) {

608 
	`kmem_‰ì
(
c›y
, 
fs
->
e2fs_bsize
);

610 
	`bªl£
(
bp
, 
BC_INVAL
);

613 *
cou¡p
 = 
block§ñó£d
;

614  (
ÆÀº‹
);

615 
	}
}

	@ext2fs_lookup.c

50 
	~<sys/cdefs.h
>

51 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_lookup.c,v 1.79 2016/01/12 21:29:29Ñiastradh Exp $");

53 
	~<sys/∑øm.h
>

54 
	~<sys/sy°m.h
>

55 
	~<sys/«mei.h
>

56 
	~<sys/buf.h
>

57 
	~<sys/fûe.h
>

58 
	~<sys/mou¡.h
>

59 
	~<sys/vnode.h
>

60 
	~<sys/kmem.h
>

61 
	~<sys/mÆloc.h
>

62 
	~<sys/dúít.h
>

63 
	~<sys/kauth.h
>

64 
	~<sys/¥oc.h
>

66 
	~<ufs/ufs/öode.h
>

67 
	~<ufs/ufs/ufsmou¡.h
>

68 
	~<ufs/ufs/ufs_exã∫.h
>

70 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

71 
	~<ufs/ext2fs/ext2fs_dú.h
>

72 
	~<ufs/ext2fs/ext2fs.h
>

74 
	~<miscfs/gífs/gífs.h
>

76 
dúchk
;

78 
ext2fs_dúc⁄v2ffs
(
ext2fs_dúe˘
 *
e2dú
,

79 
dúít
 *
ffsdú
);

80 
ext2fs_dúbadíåy
(
vnode
 *
dp
,

81 
ext2fs_dúe˘
 *
de
,

82 
íåyoff£töblock
);

95 
	$ext2fs_dúc⁄v2ffs
(
ext2fs_dúe˘
 *
e2dú
, 
dúít
 *
ffsdú
)

97 
	`mem£t
(
ffsdú
, 0, (
dúít
));

98 
ffsdú
->
d_fûío
 = 
	`fs2h32
(
e2dú
->
e2d_öo
);

99 
ffsdú
->
d_«mÀn
 = 
e2dú
->
e2d_«mÀn
;

101 
ffsdú
->
d_ty≥
 = 
DT_UNKNOWN
;

102 #ifde‡
DIAGNOSTIC


103 #i‡
MAXNAMLEN
 < 
E2FS_MAXNAMLEN


107 i‡(
e2dú
->
e2d_«mÀn
 > 
MAXNAMLEN
)

108 
	`∑nic
("ext2fs:É2dir->e2d_namlen");

111 
	`°∫˝y
(
ffsdú
->
d_«me
, 
e2dú
->
e2d_«me
, ffsdú->
d_«mÀn
);

117 
ffsdú
->
d_ª˛í
 = 
	`_DIRENT_SIZE
(ffsdir);

118 
	}
}

132 
	$ext2fs_ªaddú
(*
v
)

134 
	`¥ötf
("insideÉxt2fs_readdir\n");

135 
v›_ªaddú_¨gs


142  *
≠
 = 
v
;

143 
uio
 *uiÿ
≠
->
a_uio
;

144 
îr‹
;

145 
size_t
 
e2fs_cou¡
, 
ªad˙t
;

146 
vnode
 *
vp
 = 
≠
->
a_vp
;

147 
m_ext2fs
 *
fs
 = 
	`VTOI
(
vp
)->
i_e2fs
;

149 
ext2fs_dúe˘
 *
dp
;

150 
dúít
 *
d°d
;

151 
uio
 
auio
;

152 
iovec
 
aiov
;

153 *
dúbuf
;

154 
off_t
 
off
 = 
uio
->
uio_off£t
;

155 
off_t
 *
cookõs
 = 
NULL
;

156 
nc
 = 0, 
ncookõs
 = 0;

157 
e2d_ª˛í
;

159 i‡(
vp
->
v_ty≥
 !
VDIR
)

160  (
ENOTDIR
);

162 
e2fs_cou¡
 = 
uio
->
uio_ªsid
;

164 
e2fs_cou¡
 -(
uio
->
uio_off£t
 +É2fs_cou¡Ë& (
fs
->
e2fs_bsize
 -1);

165 i‡(
e2fs_cou¡
 <= 0)

166  (
EINVAL
);

168 
auio
 = *
uio
;

169 
auio
.
uio_iov
 = &
aiov
;

170 
auio
.
uio_iov˙t
 = 1;

171 
aiov
.
iov_Àn
 = 
e2fs_cou¡
;

172 
auio
.
uio_ªsid
 = 
e2fs_cou¡
;

173 
	`UIO_SETUP_SYSSPACE
(&
auio
);

174 
dúbuf
 = 
	`kmem_Æloc
(
e2fs_cou¡
, 
KM_SLEEP
);

175 
d°d
 = 
	`kmem_zÆloc
((
dúít
), 
KM_SLEEP
);

176 i‡(
≠
->
a_ncookõs
) {

177 
nc
 = 
e2fs_cou¡
 / 
	`_DIRENT_MINSIZE
((
dúít
 *)0);

178 
ncookõs
 = 
nc
;

179 
cookõs
 = 
	`mÆloc
( (
off_t
Ë* 
ncookõs
, 
M_TEMP
, 
M_WAITOK
);

180 *
≠
->
a_cookõs
 = 
cookõs
;

182 
aiov
.
iov_ba£
 = 
dúbuf
;

184 
îr‹
 = 
	`UFS_BUFRD
(
≠
->
a_vp
, &
auio
, 0,áp->
a_¸ed
);

185 i‡(
îr‹
 == 0) {

186 
ªad˙t
 = 
e2fs_cou¡
 - 
auio
.
uio_ªsid
;

187 
dp
 = (
ext2fs_dúe˘
 *)
dúbuf
;

188 (*)
dp
 < (*)
dúbuf
 + 
ªad˙t
; ) {

189 
e2d_ª˛í
 = 
	`fs2h16
(
dp
->e2d_reclen);

190 i‡(
e2d_ª˛í
 == 0) {

191 
îr‹
 = 
EIO
;

194 
	`ext2fs_dúc⁄v2ffs
(
dp
, 
d°d
);

195 if(
d°d
->
d_ª˛í
 > 
uio
->
uio_ªsid
) {

198 
îr‹
 = 
	`uiomove
(
d°d
, d°d->
d_ª˛í
, 
uio
);

199 i‡(
îr‹
 != 0) {

202 
off
 = of‡+ 
e2d_ª˛í
;

203 i‡(
cookõs
 !
NULL
) {

204 *
cookõs
++ = 
off
;

205 i‡(--
ncookõs
 <= 0){

210 
dp
 = (
ext2fs_dúe˘
 *Ë((*)d∞+ 
e2d_ª˛í
);

213 
uio
->
uio_off£t
 = 
off
;

215 
	`kmem_‰ì
(
dúbuf
, 
e2fs_cou¡
);

216 
	`kmem_‰ì
(
d°d
, (*dstd));

217 *
≠
->
a_eofÊag
 = 
	`ext2fs_size
(
	`VTOI
◊p->
a_vp
)Ë<
uio
->
uio_off£t
;

218 i‡(
≠
->
a_ncookõs
) {

219 i‡(
îr‹
) {

220 
	`‰ì
(*
≠
->
a_cookõs
, 
M_TEMP
);

221 *
≠
->
a_ncookõs
 = 0;

222 *
≠
->
a_cookõs
 = 
NULL
;

224 *
≠
->
a_ncookõs
 = 
nc
 - 
ncookõs
;

226  (
îr‹
);

227 
	}
}

263 
	$ext2fs_lookup
(*
v
)

265 
	`¥ötf
("insideÉxt2fs_lookup\n");

266 
v›_lookup_v2_¨gs


270  *
≠
 = 
v
;

271 
vnode
 *
vdp
 = 
≠
->
a_dvp
;

272 
öode
 *
dp
 = 
	`VTOI
(
vdp
);

273 
buf
 *
bp
;

274 
ext2fs_dúe˘
 *
ï
;

275 
íåyoff£töblock
;

276 íum {
NONE
, 
COMPACT
, 
FOUND
} 
¶Ÿ°©us
;

277 
doff_t
 
¶Ÿoff£t
;

278 
¶Ÿsize
;

279 
¶Ÿ‰ì•a˚
;

280 
¶Ÿ√eded
;

281 
numdú∑s£s
;

282 
doff_t
 
íd£¨ch
;

283 
doff_t
 
¥evoff
;

284 
vnode
 *
tdp
;

285 
doff_t
 
ídu£ful
;

286 
u_l⁄g
 
bmask
;

287 
«mÀn
, 
îr‹
;

288 
vnode
 **
vµ
 = 
≠
->
a_vµ
;

289 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

290 
kauth_¸ed_t
 
¸ed
 = 
˙p
->
˙_¸ed
;

291 
Êags
;

292 
«mei›
 = 
˙p
->
˙_«mei›
;

293 
ufsmou¡
 *
ump
 = 
dp
->
i_ump
;

294 
dúblksiz
 = 
ump
->
um_dúblksiz
;

295 
öo_t
 
foundöo
;

296 
ufs_lookup_ªsu…s
 *
ªsu…s
;

298 
Êags
 = 
˙p
->
˙_Êags
;

300 
bp
 = 
NULL
;

301 
¶Ÿoff£t
 = -1;

302 *
vµ
 = 
NULL
;

309 
ªsu…s
 = &
dp
->
i_¸≠
;

310 
dp
->
i_¸≠cou¡î
++;

315 i‡((
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VEXEC
, 
¸ed
)) != 0)

316  (
îr‹
);

318 i‡((
Êags
 & 
ISLASTCN
Ë&& (
vdp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
) &&

319 (
˙p
->
˙_«mei›
 =
DELETE
 || c≈->˙_«mei› =
RENAME
))

320  (
EROFS
);

329 i‡(
	`ˇche_lookup
(
vdp
, 
˙p
->
˙_«mïå
, c≈->
˙_«mñí
,

330 
˙p
->
˙_«mei›
, c≈->
˙_Êags
, 
NULL
, 
vµ
)) {

331  *
vµ
 =
NULLVP
 ? 
ENOENT
 : 0;

340 
¶Ÿ°©us
 = 
FOUND
;

341 
¶Ÿ‰ì•a˚
 = 
¶Ÿsize
 = 
¶Ÿ√eded
 = 0;

342 i‡((
«mei›
 =
CREATE
 ||Çamei› =
RENAME
) &&

343 (
Êags
 & 
ISLASTCN
)) {

344 
¶Ÿ°©us
 = 
NONE
;

345 
¶Ÿ√eded
 = 
	`EXT2FS_DIRSIZ
(
˙p
->
˙_«mñí
);

359 
bmask
 = 
vdp
->
v_mou¡
->
m¡_°©
.
f_iosize
 - 1;

360 i‡(
«mei›
 !
LOOKUP
 || 
ªsu…s
->
uÃ_dúoff
 == 0 ||

361 
ªsu…s
->
uÃ_dúoff
 >
	`ext2fs_size
(
dp
)) {

362 
íåyoff£töblock
 = 0;

363 
ªsu…s
->
uÃ_off£t
 = 0;

364 
numdú∑s£s
 = 1;

366 
ªsu…s
->
uÃ_off£t
 =Ñesu…s->
uÃ_dúoff
;

367 i‡((
íåyoff£töblock
 = 
ªsu…s
->
uÃ_off£t
 & 
bmask
) &&

368 (
îr‹
 = 
	`ext2fs_blk©off
(
vdp
, (
off_t
)
ªsu…s
->
uÃ_off£t
, 
NULL
, &
bp
)))

369  (
îr‹
);

370 
numdú∑s£s
 = 2;

371 
	`«meˇche_cou¡_2∑s£s
();

373 
¥evoff
 = 
ªsu…s
->
uÃ_off£t
;

374 
íd£¨ch
 = 
	`roundup
(
	`ext2fs_size
(
dp
), 
dúblksiz
);

375 
ídu£ful
 = 0;

377 
£¨chlo›
:

378 
ªsu…s
->
uÃ_off£t
 < 
íd£¨ch
) {

379 i‡(
	`cur˝u
()->
ci_sched°©e
.
•c_Êags
 & 
SPCF_SHOULDYIELD
)

380 
	`¥ìm±
();

384 i‡((
ªsu…s
->
uÃ_off£t
 & 
bmask
) == 0) {

385 i‡(
bp
 !
NULL
)

386 
	`bªl£
(
bp
, 0);

387 
îr‹
 = 
	`ext2fs_blk©off
(
vdp
, (
off_t
)
ªsu…s
->
uÃ_off£t
, 
NULL
,

388 &
bp
);

389 i‡(
îr‹
 != 0)

390  (
îr‹
);

391 
íåyoff£töblock
 = 0;

397 i‡(
¶Ÿ°©us
 =
NONE
 &&

398 (
íåyoff£töblock
 & (
dúblksiz
 - 1)) == 0) {

399 
¶Ÿoff£t
 = -1;

400 
¶Ÿ‰ì•a˚
 = 0;

409 
	`KASSERT
(
bp
 !
NULL
);

410 
ï
 = (
ext2fs_dúe˘
 *)

411 ((*)
bp
->
b_d©a
 + 
íåyoff£töblock
);

412 i‡(
ï
->
e2d_ª˛í
 == 0 ||

413 (
dúchk
 &&

414 
	`ext2fs_dúbadíåy
(
vdp
, 
ï
, 
íåyoff£töblock
))) {

415 
i
;

417 
	`ufs_dúbad
(
dp
, 
ªsu…s
->
uÃ_off£t
, "mangledÉntry");

418 
i
 = 
dúblksiz
 - (
íåyoff£töblock
 & (dirblksiz - 1));

419 
ªsu…s
->
uÃ_off£t
 +
i
;

420 
íåyoff£töblock
 +
i
;

430 i‡(
¶Ÿ°©us
 !
FOUND
) {

431 
size
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

433 i‡(
ï
->
e2d_öo
 != 0)

434 
size
 -
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
);

435 i‡(
size
 > 0) {

436 i‡(
size
 >
¶Ÿ√eded
) {

437 
¶Ÿ°©us
 = 
FOUND
;

438 
¶Ÿoff£t
 = 
ªsu…s
->
uÃ_off£t
;

439 
¶Ÿsize
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

440 } i‡(
¶Ÿ°©us
 =
NONE
) {

441 
¶Ÿ‰ì•a˚
 +
size
;

442 i‡(
¶Ÿoff£t
 == -1)

443 
¶Ÿoff£t
 = 
ªsu…s
->
uÃ_off£t
;

444 i‡(
¶Ÿ‰ì•a˚
 >
¶Ÿ√eded
) {

445 
¶Ÿ°©us
 = 
COMPACT
;

446 
¶Ÿsize
 = 
ªsu…s
->
uÃ_off£t
 +

447 
	`fs2h16
(
ï
->
e2d_ª˛í
) -

448 
¶Ÿoff£t
;

457 i‡(
ï
->
e2d_öo
) {

458 
«mÀn
 = 
ï
->
e2d_«mÀn
;

459 i‡(
«mÀn
 =
˙p
->
˙_«mñí
 &&

460 !
	`memcmp
(
˙p
->
˙_«mïå
, 
ï
->
e2d_«me
,

461 ()
«mÀn
)) {

467 
foundöo
 = 
	`fs2h32
(
ï
->
e2d_öo
);

468 
ªsu…s
->
uÃ_ª˛í
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

469 
found
;

472 
¥evoff
 = 
ªsu…s
->
uÃ_off£t
;

473 
ªsu…s
->
uÃ_off£t
 +
	`fs2h16
(
ï
->
e2d_ª˛í
);

474 
íåyoff£töblock
 +
	`fs2h16
(
ï
->
e2d_ª˛í
);

475 i‡(
ï
->
e2d_öo
)

476 
ídu£ful
 = 
ªsu…s
->
uÃ_off£t
;

483 i‡(
numdú∑s£s
 == 2) {

484 
numdú∑s£s
--;

485 
ªsu…s
->
uÃ_off£t
 = 0;

486 
íd£¨ch
 = 
ªsu…s
->
uÃ_dúoff
;

487 
£¨chlo›
;

489 i‡(
bp
 !
NULL
)

490 
	`bªl£
(
bp
, 0);

496 i‡((
«mei›
 =
CREATE
 ||Çamei› =
RENAME
) &&

497 (
Êags
 & 
ISLASTCN
Ë&& 
dp
->
i_e2fs_∆ök
 != 0) {

502 
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VWRITE
, 
¸ed
);

503 i‡(
îr‹
)

504  (
îr‹
);

514 i‡(
¶Ÿ°©us
 =
NONE
) {

515 
ªsu…s
->
uÃ_off£t
 = 
	`roundup
(
	`ext2fs_size
(
dp
), 
dúblksiz
);

516 
ªsu…s
->
uÃ_cou¡
 = 0;

517 
ídu£ful
 = 
ªsu…s
->
uÃ_off£t
;

519 
ªsu…s
->
uÃ_off£t
 = 
¶Ÿoff£t
;

520 
ªsu…s
->
uÃ_cou¡
 = 
¶Ÿsize
;

521 i‡(
ídu£ful
 < 
¶Ÿoff£t
 + 
¶Ÿsize
)

522 
ídu£ful
 = 
¶Ÿoff£t
 + 
¶Ÿsize
;

524 
ªsu…s
->
uÃ_ídoff
 = 
	`roundup
(
ídu£ful
, 
dúblksiz
);

526 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

539  (
EJUSTRETURN
);

544 i‡(
«mei›
 !
CREATE
) {

545 
	`ˇche_íãr
(
vdp
, *
vµ
, 
˙p
->
˙_«mïå
, c≈->
˙_«mñí
,

546 
˙p
->
˙_Êags
);

548  
ENOENT
;

550 
found
:

551 i‡(
numdú∑s£s
 == 2)

552 
	`«meˇche_cou¡_∑ss2
();

557 i‡(
ªsu…s
->
uÃ_off£t
 + 
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
Ë> 
	`ext2fs_size
(
dp
)) {

558 
	`ufs_dúbad
(
dp
, 
ªsu…s
->
uÃ_off£t
, "i_sizeÅoo small");

559 
îr‹
 = 
	`ext2fs_£tsize
(
dp
,

560 
ªsu…s
->
uÃ_off£t
 + 
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
));

561 i‡(
îr‹
) {

562 
	`bªl£
(
bp
, 0);

563  (
îr‹
);

565 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

566 
	`uvm_v≈_£tsize
(
vdp
, 
	`ext2fs_size
(
dp
));

568 
	`bªl£
(
bp
, 0);

575 i‡((
Êags
 & 
ISLASTCN
Ë&& 
«mei›
 =
LOOKUP
)

576 
ªsu…s
->
uÃ_dúoff
 =Ñesu…s->
uÃ_off£t
 &~ (
dúblksiz
 - 1);

583 i‡(
«mei›
 =
DELETE
 && (
Êags
 & 
ISLASTCN
)) {

590 i‡((
ªsu…s
->
uÃ_off£t
 & (
dúblksiz
 - 1)) == 0)

591 
ªsu…s
->
uÃ_cou¡
 = 0;

593 
ªsu…s
->
uÃ_cou¡
 =Ñesu…s->
uÃ_off£t
 - 
¥evoff
;

594 i‡(
dp
->
i_numbî
 =
foundöo
) {

595 
	`vªf
(
vdp
);

596 
tdp
 = 
vdp
;

598 
îr‹
 = 
	`vˇche_gë
(
vdp
->
v_mou¡
,

599 &
foundöo
, (foundöo), &
tdp
);

600 i‡(
îr‹
)

601  (
îr‹
);

606 i‡((
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VWRITE
, 
¸ed
)) != 0) {

607 
	`vªÀ
(
tdp
);

608  (
îr‹
);

616 i‡(
dp
->
i_e2fs_mode
 & 
ISVTX
) {

617 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_DELETE
,

618 
tdp
, 
vdp
, 
	`gífs_ˇn_°icky
(
¸ed
, 
dp
->
i_uid
,

619 
	`VTOI
(
tdp
)->
i_uid
));

620 i‡(
îr‹
) {

621 
	`vªÀ
(
tdp
);

622  (
EPERM
);

625 *
vµ
 = 
tdp
;

635 i‡(
«mei›
 =
RENAME
 && (
Êags
 & 
ISLASTCN
)) {

636 
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VWRITE
, 
¸ed
);

637 i‡(
îr‹
)

638  (
îr‹
);

643 i‡(
dp
->
i_numbî
 =
foundöo
)

644  (
EISDIR
);

645 
îr‹
 = 
	`vˇche_gë
(
vdp
->
v_mou¡
,

646 &
foundöo
, (foundöo), &
tdp
);

647 i‡(
îr‹
)

648  (
îr‹
);

649 *
vµ
 = 
tdp
;

653 i‡(
dp
->
i_numbî
 =
foundöo
) {

654 
	`vªf
(
vdp
);

655 *
vµ
 = 
vdp
;

657 
îr‹
 = 
	`vˇche_gë
(
vdp
->
v_mou¡
,

658 &
foundöo
, (foundöo), &
tdp
);

659 i‡(
îr‹
)

660  (
îr‹
);

661 *
vµ
 = 
tdp
;

667 
	`ˇche_íãr
(
vdp
, *
vµ
, 
˙p
->
˙_«mïå
, c≈->
˙_«mñí
, c≈->
˙_Êags
);

669 
	}
}

683 
	$ext2fs_dúbadíåy
(
vnode
 *
dp
, 
ext2fs_dúe˘
 *
de
,

684 
íåyoff£töblock
)

686 
	`¥ötf
("insideÉxt2fs_dirbadentry\n");

687 
ufsmou¡
 *
ump
 = 
	`VFSTOUFS
(
dp
->
v_mou¡
);

688 
dúblksiz
 = 
ump
->
um_dúblksiz
;

690 c⁄° *
îr‹_msg
 = 
NULL
;

691 
ª˛í
 = 
	`fs2h16
(
de
->
e2d_ª˛í
);

692 
«mÀn
 = 
de
->
e2d_«mÀn
;

694 i‡(
ª˛í
 < 
	`EXT2FS_DIRSIZ
(1))

695 
îr‹_msg
 = "rec_len is smallerÅhan minimal";

696 i‡(
ª˛í
 % 4 != 0)

697 
îr‹_msg
 = "rec_len % 4 != 0";

698 i‡(
«mÀn
 > 
EXT2FS_MAXNAMLEN
)

699 
îr‹_msg
 = "namlen > EXT2FS_MAXNAMLEN";

700 i‡(
ª˛í
 < 
	`EXT2FS_DIRSIZ
(
«mÀn
))

701 
îr‹_msg
 = "reclen isÅoo small forÇame_len";

702 i‡(
íåyoff£töblock
 + 
ª˛í
 > 
dúblksiz
)

703 
îr‹_msg
 = "directoryÉntryácross blocks";

704 i‡(
	`fs2h32
(
de
->
e2d_öo
) >

705 
	`VTOI
(
dp
)->
i_e2fs
->
e2fs
.
e2fs_icou¡
)

706 
îr‹_msg
 = "inode out of bounds";

708 i‡(
îr‹_msg
 !
NULL
) {

709 
	`¥ötf
( "bad directoryÉntry: %s\n"

711 
îr‹_msg
, 
íåyoff£töblock
,

712 (Ë
	`fs2h32
(
de
->
e2d_öo
),

713 
ª˛í
, 
«mÀn
);

714 
	`∑nic
("ext2fs_dirbadentry");

716  
îr‹_msg
 =
NULL
 ? 0 : 1;

717 
	}
}

728 
	$ext2fs_dúíãr
(
öode
 *
ù
, 
vnode
 *
dvp
,

729 c⁄° 
ufs_lookup_ªsu…s
 *
uÃ
,

730 
comp⁄íäame
 *
˙p
)

732 
	`¥ötf
("insideÉxt2fs_direnter\n");

733 
ext2fs_dúe˘
 *
ï
, *
√p
;

734 
öode
 *
dp
;

735 
buf
 *
bp
;

736 
ext2fs_dúe˘
 
√wdú
;

737 
iovec
 
aiov
;

738 
uio
 
auio
;

739 
u_öt
 
dsize
;

740 
îr‹
, 
loc
, 
√wíåysize
, 
•a˚‰ì
;

741 *
dúbuf
;

742 
ufsmou¡
 *
ump
 = 
	`VFSTOUFS
(
dvp
->
v_mou¡
);

743 
dúblksiz
 = 
ump
->
um_dúblksiz
;

745 
dp
 = 
	`VTOI
(
dvp
);

747 
√wdú
.
e2d_öo
 = 
	`h2fs32
(
ù
->
i_numbî
);

748 
√wdú
.
e2d_«mÀn
 = 
˙p
->
˙_«mñí
;

749 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

750 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

751 
√wdú
.
e2d_ty≥
 = 
	`öŸ2ext2dt
(
	`IFTODT
(
ù
->
i_e2fs_mode
));

753 
√wdú
.
e2d_ty≥
 = 0;

755 
	`mem˝y
(
√wdú
.
e2d_«me
, 
˙p
->
˙_«mïå
, ()˙p->
˙_«mñí
 + 1);

756 
√wíåysize
 = 
	`EXT2FS_DIRSIZ
(
˙p
->
˙_«mñí
);

757 i‡(
uÃ
->
uÃ_cou¡
 == 0) {

764 i‡(
uÃ
->
uÃ_off£t
 & (
dúblksiz
 - 1))

765 
	`∑nic
("ext2fs_direnter:Çewblk");

766 
auio
.
uio_off£t
 = 
uÃ
->
uÃ_off£t
;

767 
√wdú
.
e2d_ª˛í
 = 
	`h2fs16
(
dúblksiz
);

768 
auio
.
uio_ªsid
 = 
√wíåysize
;

769 
aiov
.
iov_Àn
 = 
√wíåysize
;

770 
aiov
.
iov_ba£
 = (*)&
√wdú
;

771 
auio
.
uio_iov
 = &
aiov
;

772 
auio
.
uio_iov˙t
 = 1;

773 
auio
.
uio_rw
 = 
UIO_WRITE
;

774 
	`UIO_SETUP_SYSSPACE
(&
auio
);

775 
îr‹
 = 
	`ext2fs_bufwr
(
dvp
, &
auio
, 
IO_SYNC
, 
˙p
->
˙_¸ed
);

776 i‡(
dúblksiz
 > 
dvp
->
v_mou¡
->
m¡_°©
.
f_bsize
)

778 
	`∑nic
("ext2fs_direnter: frag size");

779 i‡(!
îr‹
) {

780 
îr‹
 = 
	`ext2fs_£tsize
(
dp
,

781 
	`roundup
(
	`ext2fs_size
(
dp
), 
dúblksiz
));

782 i‡(
îr‹
)

783  (
îr‹
);

784 
dp
->
i_Êag
 |
IN_CHANGE
;

785 
	`uvm_v≈_£tsize
(
dvp
, 
	`ext2fs_size
(
dp
));

787  (
îr‹
);

802 i‡((
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)
uÃ
->
uÃ_off£t
, &
dúbuf
, &
bp
)) != 0)

803  (
îr‹
);

811 
ï
 = (
ext2fs_dúe˘
 *)
dúbuf
;

812 
dsize
 = 
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
);

813 
•a˚‰ì
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
Ë- 
dsize
;

814 
loc
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);Üo¯< 
uÃ
->
uÃ_cou¡
; ) {

815 
√p
 = (
ext2fs_dúe˘
 *)(
dúbuf
 + 
loc
);

816 i‡(
ï
->
e2d_öo
) {

818 
ï
->
e2d_ª˛í
 = 
	`h2fs16
(
dsize
);

819 
ï
 = (
ext2fs_dúe˘
 *)((*Î∞+ 
dsize
);

822 
•a˚‰ì
 +
dsize
;

824 
dsize
 = 
	`EXT2FS_DIRSIZ
(
√p
->
e2d_«mÀn
);

825 
•a˚‰ì
 +
	`fs2h16
(
√p
->
e2d_ª˛í
Ë- 
dsize
;

826 
loc
 +
	`fs2h16
(
√p
->
e2d_ª˛í
);

827 
	`mem˝y
((*)
ï
, (*)
√p
, 
dsize
);

833 i‡(
ï
->
e2d_öo
 == 0) {

834 #ifde‡
DIAGNOSTIC


835 i‡(
•a˚‰ì
 + 
dsize
 < 
√wíåysize
)

836 
	`∑nic
("ext2fs_direnter: compact1");

838 
√wdú
.
e2d_ª˛í
 = 
	`h2fs16
(
•a˚‰ì
 + 
dsize
);

840 #ifde‡
DIAGNOSTIC


841 i‡(
•a˚‰ì
 < 
√wíåysize
) {

842 
	`¥ötf
("ext2fs_direnter: compact2 %u %u",

843 (
u_öt
)
•a˚‰ì
, (u_öt)
√wíåysize
);

844 
	`∑nic
("ext2fs_direnter: compact2");

847 
√wdú
.
e2d_ª˛í
 = 
	`h2fs16
(
•a˚‰ì
);

848 
ï
->
e2d_ª˛í
 = 
	`h2fs16
(
dsize
);

849 
ï
 = (
ext2fs_dúe˘
 *)((*Î∞+ 
dsize
);

851 
	`mem˝y
((*)
ï
, (*)&
√wdú
, (
u_öt
)
√wíåysize
);

852 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

853 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

854 i‡(!
îr‹
 && 
uÃ
->
uÃ_ídoff
 && uÃ->uÃ_ídof‡< 
	`ext2fs_size
(
dp
))

855 
îr‹
 = 
	`ext2fs_åunˇã
(
dvp
, (
off_t
)
uÃ
->
uÃ_ídoff
, 
IO_SYNC
,

856 
˙p
->
˙_¸ed
);

857  (
îr‹
);

858 
	}
}

876 
	$ext2fs_dúªmove
(
vnode
 *
dvp
, c⁄° 
ufs_lookup_ªsu…s
 *
uÃ
,

877 
comp⁄íäame
 *
˙p
)

879 
	`¥ötf
("insideÉxt2fs_dirremove\n");

880 
öode
 *
dp
;

881 
ext2fs_dúe˘
 *
ï
;

882 
buf
 *
bp
;

883 
îr‹
;

885 
dp
 = 
	`VTOI
(
dvp
);

887 i‡(
uÃ
->
uÃ_cou¡
 == 0) {

891 
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)
uÃ
->
uÃ_off£t
,

892 (*)&
ï
, &
bp
);

893 i‡(
îr‹
 != 0)

894  (
îr‹
);

895 
ï
->
e2d_öo
 = 0;

896 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

897 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

898  (
îr‹
);

903 
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)(
uÃ
->
uÃ_off£t
 - uÃ->
uÃ_cou¡
),

904 (*)&
ï
, &
bp
);

905 i‡(
îr‹
 != 0)

906  (
îr‹
);

907 
ï
->
e2d_ª˛í
 = 
	`h2fs16
(
	`fs2h16
”p->e2d_ª˛íË+ 
uÃ
->
uÃ_ª˛í
);

908 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

909 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

910  (
îr‹
);

911 
	}
}

919 
	$ext2fs_dúªwrôe
(
öode
 *
dp
, c⁄° 
ufs_lookup_ªsu…s
 *
uÃ
,

920 
öode
 *
ù
, 
comp⁄íäame
 *
˙p
)

922 
	`¥ötf
("insideÉxt2fs_dirrewrite\n");

923 
buf
 *
bp
;

924 
ext2fs_dúe˘
 *
ï
;

925 
vnode
 *
vdp
 = 
	`ITOV
(
dp
);

926 
îr‹
;

928 
îr‹
 = 
	`ext2fs_blk©off
(
vdp
, (
off_t
)
uÃ
->
uÃ_off£t
, (*)&
ï
, &
bp
);

929 i‡(
îr‹
 != 0)

930  (
îr‹
);

931 
ï
->
e2d_öo
 = 
	`h2fs32
(
ù
->
i_numbî
);

932 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

933 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

934 
ï
->
e2d_ty≥
 = 
	`öŸ2ext2dt
(
	`IFTODT
(
ù
->
i_e2fs_mode
));

936 
ï
->
e2d_ty≥
 = 0;

938 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

939 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

940  (
îr‹
);

941 
	}
}

953 
	$ext2fs_dúem±y
(
öode
 *
ù
, 
öo_t
 
∑ª¡öo
, 
kauth_¸ed_t
 
¸ed
)

955 
	`¥ötf
("insideÉxt2fs_dirempty\n");

956 
off_t
 
off
;

957 
ext2fs_dúãm∂©e
 
dbuf
;

958 
ext2fs_dúe˘
 *
dp
 = (ext2fs_dúe˘ *)&
dbuf
;

959 
îr‹
, 
«mÀn
;

960 
size_t
 
cou¡
;

962 
	#MINDIRSIZ
 ( (
ext2fs_dúãm∂©e
Ë/ 2)

	)

964 
off
 = 0; of‡< 
	`ext2fs_size
(
ù
); of‡+
	`fs2h16
(
dp
->
e2d_ª˛í
)) {

965 
îr‹
 = 
	`ufs_bufio
(
UIO_READ
, 
	`ITOV
(
ù
), (*)
dp
, 
MINDIRSIZ
,

966 
off
, 
IO_NODELOCKED
, 
¸ed
, &
cou¡
, 
NULL
);

971 i‡(
îr‹
 || 
cou¡
 != 0)

974 i‡(
dp
->
e2d_ª˛í
 == 0)

977 i‡(
dp
->
e2d_öo
 == 0)

980 
«mÀn
 = 
dp
->
e2d_«mÀn
;

981 i‡(
«mÀn
 > 2)

983 i‡(
dp
->
e2d_«me
[0] != '.')

990 i‡(
«mÀn
 == 1)

992 i‡(
dp
->
e2d_«me
[1] ='.' && 
	`fs2h32
(dp->
e2d_öo
Ë=
∑ª¡öo
)

997 
	}
}

	@ext2fs_readwrite.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_readwrite.c,v 1.74 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/ªsour˚v¨.h
>

68 
	~<sys/kî√l.h
>

69 
	~<sys/fûe.h
>

70 
	~<sys/°©.h
>

71 
	~<sys/buf.h
>

72 
	~<sys/¥oc.h
>

73 
	~<sys/mou¡.h
>

74 
	~<sys/vnode.h
>

75 
	~<sys/sig«lv¨.h
>

76 
	~<sys/kauth.h
>

78 
	~<ufs/ufs/öode.h
>

79 
	~<ufs/ufs/ufsmou¡.h
>

80 
	~<ufs/ufs/ufs_exã∫.h
>

81 
	~<ufs/ext2fs/ext2fs.h
>

82 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

84 
ext2fs_po°_ªad_upd©e
(
vnode
 *, , );

85 
ext2fs_po°_wrôe_upd©e
(
vnode
 *, 
uio
 *, ,

86 
kauth_¸ed_t
, 
off_t
, , , );

93 
	$ext2fs_ªad
(*
v
)

95 
	`¥ötf
("ex2fs_read\n");

96 
v›_ªad_¨gs


101  *
≠
 = 
v
;

102 
vnode
 *
vp
;

103 
öode
 *
ù
;

104 
uio
 *uio;

105 
ufsmou¡
 *
ump
;

106 
vsize_t
 
byãÀn
;

107 
advi˚
;

108 
îr‹
;

110 
vp
 = 
≠
->
a_vp
;

111 
ù
 = 
	`VTOI
(
vp
);

112 
ump
 = 
ù
->
i_ump
;

113 
uio
 = 
≠
->
a_uio
;

114 
îr‹
 = 0;

116 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_READ
);

117 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
 || vp->v_ty≥ =
VDIR
);

120 i‡(
vp
->
v_ty≥
 =
VDIR
)

121  
	`ext2fs_bu‰d
(
vp
, 
uio
, 
≠
->
a_ioÊag
,áp->
a_¸ed
);

123 i‡((
uöt64_t
)
uio
->
uio_off£t
 > 
ump
->
um_maxfûesize
)

124  (
EFBIG
);

125 i‡(
uio
->
uio_ªsid
 == 0)

127 i‡(
uio
->
uio_off£t
 >
	`ext2fs_size
(
ù
))

128 
out
;

130 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
);

131 
advi˚
 = 
	`IO_ADV_DECODE
(
≠
->
a_ioÊag
);

132 
uio
->
uio_ªsid
 > 0) {

133 
byãÀn
 = 
	`MIN
(
	`ext2fs_size
(
ù
Ë- 
uio
->
uio_off£t
,

134 
uio
->
uio_ªsid
);

135 i‡(
byãÀn
 == 0)

138 
îr‹
 = 
	`ubc_uiomove
(&
vp
->
v_uobj
, 
uio
, 
byãÀn
, 
advi˚
,

139 
UBC_READ
 | 
UBC_PARTIALOK
 | 
	`UBC_UNMAP_FLAG
(
vp
));

140 i‡(
îr‹
)

144 
out
:

145 
îr‹
 = 
	`ext2fs_po°_ªad_upd©e
(
vp
, 
≠
->
a_ioÊag
,Érror);

146  (
îr‹
);

147 
	}
}

153 
	$ext2fs_bu‰d
(
vnode
 *
vp
, 
uio
 *uio, 
ioÊag
, 
kauth_¸ed_t
 
¸ed
)

155 
	`¥ötf
("ext2fs_bufrd\n");

156 
öode
 *
ù
;

157 
ufsmou¡
 *
ump
;

158 
m_ext2fs
 *
fs
;

159 
buf
 *
bp
;

160 
off_t
 
byãsöfûe
;

161 
daddr_t
 
lbn
, 
√xébn
;

162 
size
, 
x„rsize
, 
blkoff£t
;

163 
îr‹
;

165 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_READ
);

166 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
));

167 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
 || vp->v_ty≥ =
VLNK
);

169 
ù
 = 
	`VTOI
(
vp
);

170 
ump
 = 
ù
->
i_ump
;

171 
fs
 = 
ù
->
i_e2fs
;

172 
îr‹
 = 0;

174 
	`KASSERT
(
vp
->
v_ty≥
 !
VLNK
 ||

175 
	`ext2fs_size
(
ù
Ë>
ump
->
um_maxsymlökÀn
);

176 
	`KASSERT
(
vp
->
v_ty≥
 !
VLNK
 || 
ump
->
um_maxsymlökÀn
 != 0 ||

177 
	`ext2fs_nblock
(
ù
) != 0);

179 i‡(
uio
->
uio_off£t
 > 
ump
->
um_maxfûesize
)

180  
EFBIG
;

181 i‡(
uio
->
uio_ªsid
 == 0)

183 i‡(
uio
->
uio_off£t
 >
	`ext2fs_size
(
ù
))

184 
out
;

186 
îr‹
 = 0, 
bp
 = 
NULL
; 
uio
->
uio_ªsid
 > 0; bp = NULL) {

187 
byãsöfûe
 = 
	`ext2fs_size
(
ù
Ë- 
uio
->
uio_off£t
;

188 i‡(
byãsöfûe
 <= 0)

190 
lbn
 = 
	`ext2_lblkno
(
fs
, 
uio
->
uio_off£t
);

191 
√xébn
 = 
lbn
 + 1;

192 
size
 = 
fs
->
e2fs_bsize
;

193 
blkoff£t
 = 
	`ext2_blkoff
(
fs
, 
uio
->
uio_off£t
);

194 
x„rsize
 = 
fs
->
e2fs_bsize
 - 
blkoff£t
;

195 i‡(
uio
->
uio_ªsid
 < 
x„rsize
)

196 
x„rsize
 = 
uio
->
uio_ªsid
;

197 i‡(
byãsöfûe
 < 
x„rsize
)

198 
x„rsize
 = 
byãsöfûe
;

200 i‡(
	`ext2_lblktosize
(
fs
, 
√xébn
Ë>
	`ext2fs_size
(
ù
))

201 
îr‹
 = 
	`bªad
(
vp
, 
lbn
, 
size
, 0, &
bp
);

203 
√xtsize
 = 
fs
->
e2fs_bsize
;

204 
îr‹
 = 
	`bªadn
(
vp
, 
lbn
,

205 
size
, &
√xébn
, &
√xtsize
, 1, 0, &
bp
);

207 i‡(
îr‹
)

217 
size
 -
bp
->
b_ªsid
;

218 i‡(
size
 < 
x„rsize
) {

219 i‡(
size
 == 0)

221 
x„rsize
 = 
size
;

223 
îr‹
 = 
	`uiomove
((*)
bp
->
b_d©a
 + 
blkoff£t
, 
x„rsize
, 
uio
);

224 i‡(
îr‹
)

226 
	`bªl£
(
bp
, 0);

228 i‡(
bp
 !
NULL
)

229 
	`bªl£
(
bp
, 0);

231 
out
:

232 
îr‹
 = 
	`ext2fs_po°_ªad_upd©e
(
vp
, 
ioÊag
,Érror);

233  (
îr‹
);

234 
	}
}

237 
	$ext2fs_po°_ªad_upd©e
(
vnode
 *
vp
, 
ioÊag
, 
€º‹
)

239 
öode
 *
ù
 = 
	`VTOI
(
vp
);

240 
îr‹
 = 
€º‹
;

242 i‡(!(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_NOATIME
)) {

243 
ù
->
i_Êag
 |
IN_ACCESS
;

244 i‡((
ioÊag
 & 
IO_SYNC
) == IO_SYNC)

245 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
UPDATE_WAIT
);

249 i‡(
€º‹
)

250 
îr‹
 = 
€º‹
;

251  
îr‹
;

252 
	}
}

258 
	$ext2fs_wrôe
(*
v
)

260 
v›_wrôe_¨gs


265  *
≠
 = 
v
;

266 
vnode
 *
vp
;

267 
uio
 *uio;

268 
öode
 *
ù
;

269 
m_ext2fs
 *
fs
;

270 
ufsmou¡
 *
ump
;

271 
off_t
 
osize
;

272 
blkoff£t
, 
îr‹
, 
ioÊag
, 
ªsid
;

273 
vsize_t
 
byãÀn
;

274 
off_t
 
ﬁdoff
 = 0;

275 
boﬁ
 
async
;

276 
exãnded
 = 0;

277 
advi˚
;

279 
ioÊag
 = 
≠
->
a_ioÊag
;

280 
advi˚
 = 
	`IO_ADV_DECODE
(
ioÊag
);

281 
uio
 = 
≠
->
a_uio
;

282 
vp
 = 
≠
->
a_vp
;

283 
ù
 = 
	`VTOI
(
vp
);

284 
ump
 = 
ù
->
i_ump
;

285 
îr‹
 = 0;

287 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_WRITE
);

288 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
);

290 i‡(
ioÊag
 & 
IO_APPEND
)

291 
uio
->
uio_off£t
 = 
	`ext2fs_size
(
ù
);

292 i‡((
ù
->
i_e2fs_Êags
 & 
EXT2_APPEND
) &&

293 
uio
->
uio_off£t
 !
	`ext2fs_size
(
ù
))

294  (
EPERM
);

296 
fs
 = 
ù
->
i_e2fs
;

297 i‡(
uio
->
uio_off£t
 < 0 ||

298 (
uöt64_t
)
uio
->
uio_off£t
 + uio->
uio_ªsid
 > 
ump
->
um_maxfûesize
)

299  (
EFBIG
);

300 i‡(
uio
->
uio_ªsid
 == 0)

303 
async
 = 
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_ASYNC
;

304 
ªsid
 = 
uio
->
uio_ªsid
;

305 
osize
 = 
	`ext2fs_size
(
ù
);

307 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
);

308 
uio
->
uio_ªsid
 > 0) {

309 
ﬁdoff
 = 
uio
->
uio_off£t
;

310 
blkoff£t
 = 
	`ext2_blkoff
(
fs
, 
uio
->
uio_off£t
);

311 
byãÀn
 = 
	`MIN
(
fs
->
e2fs_bsize
 - 
blkoff£t
, 
uio
->
uio_ªsid
);

313 i‡(
vp
->
v_size
 < 
ﬁdoff
 + 
byãÀn
) {

314 
	`uvm_v≈_£twrôesize
(
vp
, 
ﬁdoff
 + 
byãÀn
);

316 
îr‹
 = 
	`ufs_bÆloc_ønge
(
vp
, 
uio
->
uio_off£t
, 
byãÀn
,

317 
≠
->
a_¸ed
, 0);

318 i‡(
îr‹
)

320 
îr‹
 = 
	`ubc_uiomove
(&
vp
->
v_uobj
, 
uio
, 
byãÀn
, 
advi˚
,

321 
UBC_WRITE
 | 
	`UBC_UNMAP_FLAG
(
vp
));

322 i‡(
îr‹
)

330 i‡(
vp
->
v_size
 < 
uio
->
uio_off£t
) {

331 
	`uvm_v≈_£tsize
(
vp
, 
uio
->
uio_off£t
);

332 
exãnded
 = 1;

340 i‡(!
async
 && 
ﬁdoff
 >> 16 !
uio
->
uio_off£t
 >> 16) {

341 
	`muãx_íãr
(
vp
->
v_öãæock
);

342 
îr‹
 = 
	`VOP_PUTPAGES
(
vp
, (
ﬁdoff
 >> 16) << 16,

343 (
uio
->
uio_off£t
 >> 16) << 16,

344 
PGO_CLEANIT
 | 
PGO_LAZY
);

347 i‡(
îr‹
 =0 && 
ioÊag
 & 
IO_SYNC
) {

348 
	`muãx_íãr
(
vp
->
v_öãæock
);

349 
îr‹
 = 
	`VOP_PUTPAGES
(
vp
, 
	`åunc_∑ge
(
ﬁdoff
),

350 
	`round_∑ge
(
	`ext2_blkroundup
(
fs
, 
uio
->
uio_off£t
)),

351 
PGO_CLEANIT
 | 
PGO_SYNCIO
);

354 
îr‹
 = 
	`ext2fs_po°_wrôe_upd©e
(
vp
, 
uio
, 
ioÊag
, 
≠
->
a_¸ed
, 
osize
,

355 
ªsid
, 
exãnded
, 
îr‹
);

356  (
îr‹
);

357 
	}
}

363 
	$ext2fs_bufwr
(
vnode
 *
vp
, 
uio
 *uio, 
ioÊag
, 
kauth_¸ed_t
 
¸ed
)

365 
öode
 *
ù
;

366 
ufsmou¡
 *
ump
;

367 
m_ext2fs
 *
fs
;

368 
buf
 *
bp
;

369 
Êags
;

370 
off_t
 
osize
;

371 
daddr_t
 
lbn
;

372 
ªsid
, 
blkoff£t
, 
x„rsize
;

373 
exãnded
 = 0;

374 
îr‹
;

376 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

377 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
 || vp->v_ty≥ =
VLNK
);

378 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
 || 
	`ISSET
(
ioÊag
, 
IO_SYNC
));

379 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_WRITE
);

381 
ù
 = 
	`VTOI
(
vp
);

382 
ump
 = 
ù
->
i_ump
;

383 
fs
 = 
ù
->
i_e2fs
;

384 
îr‹
 = 0;

386 i‡(
uio
->
uio_off£t
 < 0 ||

387 
uio
->
uio_ªsid
 > 
ump
->
um_maxfûesize
 ||

388 
uio
->
uio_off£t
 > (
ump
->
um_maxfûesize
 - uio->
uio_ªsid
))

389  
EFBIG
;

390 i‡(
uio
->
uio_ªsid
 == 0)

393 
Êags
 = 
ioÊag
 & 
IO_SYNC
 ? 
B_SYNC
 : 0;

394 
ªsid
 = 
uio
->
uio_ªsid
;

395 
osize
 = 
	`ext2fs_size
(
ù
);

397 
îr‹
 = 0; 
uio
->
uio_ªsid
 > 0;) {

398 
lbn
 = 
	`ext2_lblkno
(
fs
, 
uio
->
uio_off£t
);

399 
blkoff£t
 = 
	`ext2_blkoff
(
fs
, 
uio
->
uio_off£t
);

400 
x„rsize
 = 
	`MIN
(
fs
->
e2fs_bsize
 - 
blkoff£t
, 
uio
->
uio_ªsid
);

401 i‡(
x„rsize
 < 
fs
->
e2fs_bsize
)

402 
Êags
 |
B_CLRBUF
;

404 
Êags
 &~
B_CLRBUF
;

405 
îr‹
 = 
	`ext2fs_bÆloc
(
ù
, 
lbn
, 
blkoff£t
 + 
x„rsize
, 
¸ed
, &
bp
,

406 
Êags
);

407 i‡(
îr‹
)

409 i‡(
	`ext2fs_size
(
ù
Ë< 
uio
->
uio_off£t
 + 
x„rsize
) {

410 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
uio
->
uio_off£t
 + 
x„rsize
);

411 i‡(
îr‹
)

414 
îr‹
 = 
	`uiomove
((*)
bp
->
b_d©a
 + 
blkoff£t
, 
x„rsize
, 
uio
);

421 i‡(
vp
->
v_size
 < 
uio
->
uio_off£t
) {

422 
	`uvm_v≈_£tsize
(
vp
, 
uio
->
uio_off£t
);

423 
exãnded
 = 1;

426 i‡(
ioÊag
 & 
IO_SYNC
)

427 ()
	`bwrôe
(
bp
);

428 i‡(
x„rsize
 + 
blkoff£t
 =
fs
->
e2fs_bsize
)

429 
	`bawrôe
(
bp
);

431 
	`bdwrôe
(
bp
);

432 i‡(
îr‹
 || 
x„rsize
 == 0)

436 
îr‹
 = 
	`ext2fs_po°_wrôe_upd©e
(
vp
, 
uio
, 
ioÊag
, 
¸ed
, 
osize
, 
ªsid
,

437 
exãnded
, 
îr‹
);

438  (
îr‹
);

439 
	}
}

442 
	$ext2fs_po°_wrôe_upd©e
(
vnode
 *
vp
, 
uio
 *uio, 
ioÊag
,

443 
kauth_¸ed_t
 
¸ed
, 
off_t
 
osize
, 
ªsid
, 
exãnded
, 
€º‹
)

445 
öode
 *
ù
 = 
	`VTOI
(
vp
);

446 
îr‹
 = 
€º‹
;

449 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

450 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RELATIME
)

451 
ù
->
i_Êag
 |
IN_ACCESS
;

458 i‡(
ªsid
 > 
uio
->
uio_ªsid
 && 
¸ed
) {

459 i‡(
ù
->
i_e2fs_mode
 & 
ISUID
) {

460 i‡(
	`kauth_auth‹ize_vnode
(
¸ed
,

461 
KAUTH_VNODE_RETAIN_SUID
, 
vp
, 
NULL
, 
EPERM
) != 0)

462 
ù
->
i_e2fs_mode
 &
ISUID
;

465 i‡(
ù
->
i_e2fs_mode
 & 
ISGID
) {

466 i‡(
	`kauth_auth‹ize_vnode
(
¸ed
,

467 
KAUTH_VNODE_RETAIN_SGID
, 
vp
, 
NULL
, 
EPERM
) != 0)

468 
ù
->
i_e2fs_mode
 &~
ISGID
;

473 i‡(
ªsid
 > 
uio
->
uio_ªsid
)

474 
	`VN_KNOTE
(
vp
, 
NOTE_WRITE
 | (
exãnded
 ? 
NOTE_EXTEND
 : 0));

480 i‡(
îr‹
) {

481 (Ë
	`ext2fs_åunˇã
(
vp
, 
osize
, 
ioÊag
 & 
IO_SYNC
, 
¸ed
);

482 
uio
->
uio_off£t
 -
ªsid
 - uio->
uio_ªsid
;

483 
uio
->
uio_ªsid
 = 
ªsid
;

484 } i‡(
ªsid
 > 
uio
->
uio_ªsid
 && (
ioÊag
 & 
IO_SYNC
) == IO_SYNC)

485 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
UPDATE_WAIT
);

488 
	`KASSERT
(
vp
->
v_size
 =
	`ext2fs_size
(
ù
));

491 i‡(
€º‹
)

492 
îr‹
 = 
€º‹
;

493  
îr‹
;

494 
	}
}

	@ext2fs_rename.c

36 
	~<sys/cdefs.h
>

37 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_rename.c,v 1.8 2015/03/27 17:27:56Ñiastradh Exp $");

39 
	~<sys/∑øm.h
>

40 
	~<sys/buf.h
>

41 
	~<sys/î∫o.h
>

42 
	~<sys/kauth.h
>

43 
	~<sys/mou¡.h
>

44 
	~<sys/«mei.h
>

45 
	~<sys/vnode.h
>

46 
	~<sys/vnode_if.h
>

48 
	~<miscfs/gífs/gífs.h
>

50 
	~<ufs/ext2fs/ext2fs.h
>

51 
	~<ufs/ext2fs/ext2fs_dú.h
>

52 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

53 
	~<ufs/ufs/öode.h
>

54 
	~<ufs/ufs/ufs_exã∫.h
>

55 
	~<ufs/ufs/ufsmou¡.h
>

60 
ext2fs_ß√_ª«me
(
vnode
 *, 
comp⁄íäame
 *,

61 
vnode
 *, 
comp⁄íäame
 *,

62 
kauth_¸ed_t
, 
boﬁ
);

63 
boﬁ
 
ext2fs_ª«me_uÃ_ovîœp_p
(c⁄° 
ufs_lookup_ªsu…s
 *,

64 c⁄° 
ufs_lookup_ªsu…s
 *);

65 
ext2fs_ª«me_ªˇlcuœã_fuÃ
(
vnode
 *,

66 
ufs_lookup_ªsu…s
 *, const ufs_lookup_results *,

67 c⁄° 
comp⁄íäame
 *);

68 
boﬁ
 
ext2fs_rmdúed_p
(
vnode
 *);

69 
ext2fs_ªad_dŸdŸ
(
vnode
 *, 
kauth_¸ed_t
, 
öo_t
 *);

70 
ext2fs_ª«me_ª∂a˚_dŸdŸ
(
vnode
 *,

71 
vnode
 *, vnodê*, 
kauth_¸ed_t
);

72 
ext2fs_gro_lock_dúe˘‹y
(
mou¡
 *, 
vnode
 *);

74 c⁄° 
gífs_ª«me_›s
 
	gext2fs_gífs_ª«me_›s
;

91 
	$ext2fs_ß√_ª«me
(

92 
vnode
 *
fdvp
, 
comp⁄íäame
 *
f˙p
,

93 
vnode
 *
tdvp
, 
comp⁄íäame
 *
t˙p
,

94 
kauth_¸ed_t
 
¸ed
, 
boﬁ
 
posixly_c‹ª˘
)

96 
ufs_lookup_ªsu…s
 
fuÃ
, 
tuÃ
;

98  
	`gífs_ß√_ª«me
(&
ext2fs_gífs_ª«me_›s
,

99 
fdvp
, 
f˙p
, &
fuÃ
, 
tdvp
, 
t˙p
, &
tuÃ
,

100 
¸ed
, 
posixly_c‹ª˘
);

101 
	}
}

108 
	$ext2fs_ª«me
(*
v
)

111  
	`gífs_öß√_ª«me
(
v
, &
ext2fs_ß√_ª«me
);

112 
	}
}

120 
boﬁ


121 
	$ext2fs_gro_dúe˘‹y_em±y_p
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

122 
vnode
 *
vp
, vnodê*
dvp
)

125 ()
mp
;

126 
	`KASSERT
(
mp
 !
NULL
);

127 
	`KASSERT
(
vp
 !
NULL
);

128 
	`KASSERT
(
dvp
 !
NULL
);

129 
	`KASSERT
(
vp
 !
dvp
);

130 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

131 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

132 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

133 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

135  
	`ext2fs_dúem±y
(
	`VTOI
(
vp
), VTOI(
dvp
)->
i_numbî
, 
¸ed
);

136 
	}
}

143 
	$ext2fs_gro_ª«me_check_possibÀ
(
mou¡
 *
mp
,

144 
vnode
 *
fdvp
, vnodê*
fvp
,

145 
vnode
 *
tdvp
, vnodê*
tvp
)

148 ()
mp
;

149 
	`KASSERT
(
mp
 !
NULL
);

150 
	`KASSERT
(
fdvp
 !
NULL
);

151 
	`KASSERT
(
fvp
 !
NULL
);

152 
	`KASSERT
(
tdvp
 !
NULL
);

153 
	`KASSERT
(
fdvp
 !
fvp
);

154 
	`KASSERT
(
fdvp
 !
tvp
);

155 
	`KASSERT
(
tdvp
 !
fvp
);

156 
	`KASSERT
(
tdvp
 !
tvp
);

157 
	`KASSERT
(
fvp
 !
tvp
);

158 
	`KASSERT
(
fdvp
->
v_ty≥
 =
VDIR
);

159 
	`KASSERT
(
tdvp
->
v_ty≥
 =
VDIR
);

160 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

161 
	`KASSERT
(
fvp
->
v_mou¡
 =
mp
);

162 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

163 
	`KASSERT
((
tvp
 =
NULL
Ë|| (tvp->
v_mou¡
 =
mp
));

164 
	`KASSERT
(
	`VOP_ISLOCKED
(
fdvp
Ë=
LK_EXCLUSIVE
);

165 
	`KASSERT
(
	`VOP_ISLOCKED
(
fvp
Ë=
LK_EXCLUSIVE
);

166 
	`KASSERT
(
	`VOP_ISLOCKED
(
tdvp
Ë=
LK_EXCLUSIVE
);

167 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
	`VOP_ISLOCKED
—vpË=
LK_EXCLUSIVE
));

169  
	`gífs_uf¶ike_ª«me_check_possibÀ
(

170 
	`VTOI
(
fdvp
)->
i_e2fs_Êags
, VTOI(
fvp
)->i_e2fs_flags,

171 
	`VTOI
(
tdvp
)->
i_e2fs_Êags
, (
tvp
? VTOI(tvp)->i_e2fs_flags : 0),

172 (
tvp
 !
NULL
),

173 
EXT2_IMMUTABLE
, 
EXT2_APPEND
);

174 
	}
}

181 
	$ext2fs_gro_ª«me_check_≥rmôãd
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

182 
vnode
 *
fdvp
, vnodê*
fvp
,

183 
vnode
 *
tdvp
, vnodê*
tvp
)

186 ()
mp
;

187 
	`KASSERT
(
mp
 !
NULL
);

188 
	`KASSERT
(
fdvp
 !
NULL
);

189 
	`KASSERT
(
fvp
 !
NULL
);

190 
	`KASSERT
(
tdvp
 !
NULL
);

191 
	`KASSERT
(
fdvp
 !
fvp
);

192 
	`KASSERT
(
fdvp
 !
tvp
);

193 
	`KASSERT
(
tdvp
 !
fvp
);

194 
	`KASSERT
(
tdvp
 !
tvp
);

195 
	`KASSERT
(
fvp
 !
tvp
);

196 
	`KASSERT
(
fdvp
->
v_ty≥
 =
VDIR
);

197 
	`KASSERT
(
tdvp
->
v_ty≥
 =
VDIR
);

198 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

199 
	`KASSERT
(
fvp
->
v_mou¡
 =
mp
);

200 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

201 
	`KASSERT
((
tvp
 =
NULL
Ë|| (tvp->
v_mou¡
 =
mp
));

202 
	`KASSERT
(
	`VOP_ISLOCKED
(
fdvp
Ë=
LK_EXCLUSIVE
);

203 
	`KASSERT
(
	`VOP_ISLOCKED
(
fvp
Ë=
LK_EXCLUSIVE
);

204 
	`KASSERT
(
	`VOP_ISLOCKED
(
tdvp
Ë=
LK_EXCLUSIVE
);

205 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
	`VOP_ISLOCKED
—vpË=
LK_EXCLUSIVE
));

207  
	`gífs_uf¶ike_ª«me_check_≥rmôãd
(
¸ed
,

208 
fdvp
, 
	`VTOI
(fdvp)->
i_e2fs_mode
, VTOI(fdvp)->
i_uid
,

209 
fvp
, 
	`VTOI
(fvp)->
i_uid
,

210 
tdvp
, 
	`VTOI
—dvp)->
i_e2fs_mode
, VTOI—dvp)->
i_uid
,

211 
tvp
, (tvp? 
	`VTOI
—vp)->
i_uid
 : 0));

212 
	}
}

219 
	$ext2fs_gro_ªmove_check_possibÀ
(
mou¡
 *
mp
,

220 
vnode
 *
dvp
, vnodê*
vp
)

223 ()
mp
;

224 
	`KASSERT
(
mp
 !
NULL
);

225 
	`KASSERT
(
dvp
 !
NULL
);

226 
	`KASSERT
(
vp
 !
NULL
);

227 
	`KASSERT
(
dvp
 !
vp
);

228 
	`KASSERT
(
dvp
->
v_ty≥
 =
VDIR
);

229 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

230 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

231 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

232 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

233 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

235  
	`gífs_uf¶ike_ªmove_check_possibÀ
(

236 
	`VTOI
(
dvp
)->
i_e2fs_Êags
, VTOI(
vp
)->i_e2fs_flags,

237 
EXT2_IMMUTABLE
, 
EXT2_APPEND
);

238 
	}
}

245 
	$ext2fs_gro_ªmove_check_≥rmôãd
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

246 
vnode
 *
dvp
, vnodê*
vp
)

249 ()
mp
;

250 
	`KASSERT
(
mp
 !
NULL
);

251 
	`KASSERT
(
dvp
 !
NULL
);

252 
	`KASSERT
(
vp
 !
NULL
);

253 
	`KASSERT
(
dvp
 !
vp
);

254 
	`KASSERT
(
dvp
->
v_ty≥
 =
VDIR
);

255 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

256 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

257 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

258 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

259 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

261  
	`gífs_uf¶ike_ªmove_check_≥rmôãd
(
¸ed
,

262 
dvp
, 
	`VTOI
(dvp)->
i_e2fs_mode
, VTOI(dvp)->
i_uid
,

263 
vp
, 
	`VTOI
(vp)->
i_uid
);

264 
	}
}

270 
	$ext2fs_gro_ª«me
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

271 
vnode
 *
fdvp
, 
comp⁄íäame
 *
f˙p
,

272 *
fde
, 
vnode
 *
fvp
,

273 
vnode
 *
tdvp
, 
comp⁄íäame
 *
t˙p
,

274 *
tde
, 
vnode
 *
tvp
)

276 
ufs_lookup_ªsu…s
 *
fuÃ
 = 
fde
;

277 
ufs_lookup_ªsu…s
 *
tuÃ
 = 
tde
;

278 
boﬁ
 
dúe˘‹y_p
, 
ª∑ª¡_p
;

279 
îr‹
;

281 ()
mp
;

282 
	`KASSERT
(
mp
 !
NULL
);

283 
	`KASSERT
(
fdvp
 !
NULL
);

284 
	`KASSERT
(
f˙p
 !
NULL
);

285 
	`KASSERT
(
fuÃ
 !
NULL
);

286 
	`KASSERT
(
fvp
 !
NULL
);

287 
	`KASSERT
(
tdvp
 !
NULL
);

288 
	`KASSERT
(
t˙p
 !
NULL
);

289 
	`KASSERT
(
tuÃ
 !
NULL
);

290 
	`KASSERT
(
fuÃ
 !
tuÃ
);

291 
	`KASSERT
(
fdvp
 !
fvp
);

292 
	`KASSERT
(
fdvp
 !
tvp
);

293 
	`KASSERT
(
tdvp
 !
fvp
);

294 
	`KASSERT
(
tdvp
 !
tvp
);

295 
	`KASSERT
(
fvp
 !
tvp
);

296 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

297 
	`KASSERT
(
fvp
->
v_mou¡
 =
mp
);

298 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

299 
	`KASSERT
((
tvp
 =
NULL
Ë|| (tvp->
v_mou¡
 =
mp
));

300 
	`KASSERT
(
	`VOP_ISLOCKED
(
fdvp
Ë=
LK_EXCLUSIVE
);

301 
	`KASSERT
(
	`VOP_ISLOCKED
(
fvp
Ë=
LK_EXCLUSIVE
);

302 
	`KASSERT
(
	`VOP_ISLOCKED
(
tdvp
Ë=
LK_EXCLUSIVE
);

303 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
	`VOP_ISLOCKED
—vpË=
LK_EXCLUSIVE
));

309 i‡((
∆ök_t
)
	`VTOI
(
fvp
)->
i_e2fs_∆ök
 >
LINK_MAX
)

310  
EMLINK
;

312 
dúe˘‹y_p
 = (
fvp
->
v_ty≥
 =
VDIR
);

313 
	`KASSERT
(
dúe˘‹y_p
 =((
	`VTOI
(
fvp
)->
i_e2fs_mode
 & 
IFMT
Ë=
IFDIR
));

314 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
dúe˘‹y_p
 =—vp->
v_ty≥
 =
VDIR
)));

315 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
dúe˘‹y_p
 ==

316 ((
	`VTOI
(
tvp
)->
i_e2fs_mode
 & 
IFMT
Ë=
IFDIR
)));

318 
ª∑ª¡_p
 = (
fdvp
 !
tdvp
);

319 
	`KASSERT
(
ª∑ª¡_p
 =(
	`VTOI
(
fdvp
)->
i_numbî
 !VTOI(
tdvp
)->i_number));

332 
	`KASSERT
((
∆ök_t
)
	`VTOI
(
fvp
)->
i_e2fs_∆ök
 < 
LINK_MAX
);

333 
	`VTOI
(
fvp
)->
i_e2fs_∆ök
++;

334 
	`VTOI
(
fvp
)->
i_Êag
 |
IN_CHANGE
;

335 
îr‹
 = 
	`ext2fs_upd©e
(
fvp
, 
NULL
, NULL, 
UPDATE_WAIT
);

336 i‡(
îr‹
)

337 
whymu°ôhuπsomuch
;

347 i‡(
tvp
 =
NULL
) {

353 i‡(
dúe˘‹y_p
 && 
ª∑ª¡_p
) {

354 i‡((
∆ök_t
)
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
 >
LINK_MAX
) {

355 
îr‹
 = 
EMLINK
;

356 
whymu°ôhuπsomuch
;

358 
	`KASSERT
((
∆ök_t
)
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
 < 
LINK_MAX
);

359 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
++;

360 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

361 
îr‹
 = 
	`ext2fs_upd©e
(
tdvp
, 
NULL
, NULL, 
UPDATE_WAIT
);

362 i‡(
îr‹
) {

367 
	`KASSERT
(0 < 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
);

368 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
--;

369 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

370 
whymu°ôhuπsomuch
;

374 
îr‹
 = 
	`ext2fs_dúíãr
(
	`VTOI
(
fvp
), 
tdvp
, 
tuÃ
, 
t˙p
);

375 i‡(
îr‹
) {

376 i‡(
dúe˘‹y_p
 && 
ª∑ª¡_p
) {

383 
	`KASSERT
(0 < 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
);

384 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
--;

385 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

386 ()
	`ext2fs_upd©e
(
tdvp
, 
NULL
, NULL,

387 
UPDATE_WAIT
);

389 
whymu°ôhuπsomuch
;

392 i‡(
dúe˘‹y_p
)

394 
	`ˇche_purge
(
tdvp
);

400 
îr‹
 = 
	`ext2fs_dúªwrôe
(
	`VTOI
(
tdvp
), 
tuÃ
, VTOI(
fvp
), 
t˙p
);

401 i‡(
îr‹
)

402 
whymu°ôhuπsomuch
;

411 i‡(
dúe˘‹y_p
 && !
ª∑ª¡_p
) {

412 
	`KASSERT
(
fdvp
 =
tdvp
);

414 
	`KASSERT
(0 < 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
);

415 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
--;

416 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

430 
	`KASSERT
(0 < 
	`VTOI
(
tvp
)->
i_e2fs_∆ök
);

431 
	`VTOI
(
tvp
)->
i_e2fs_∆ök
--;

432 i‡(
dúe˘‹y_p
) {

437 i‡(
	`VTOI
(
tvp
)->
i_e2fs_∆ök
 != 1)

438 
	`ufs_dúbad
(
	`VTOI
(
tvp
), (
doff_t
)0,

440 
	`VTOI
(
tvp
)->
i_e2fs_∆ök
 = 0;

441 
îr‹
 = 
	`ext2fs_åunˇã
(
tvp
, (
off_t
)0, 
IO_SYNC
, 
¸ed
);

443 i‡(
îr‹
)

444 
whymu°ôhuπsomuch
;

451 
	`VTOI
(
tvp
)->
i_Êag
 |
IN_CHANGE
;

459 i‡(
dúe˘‹y_p
 && 
ª∑ª¡_p
) {

460 
îr‹
 = 
	`ext2fs_ª«me_ª∂a˚_dŸdŸ
(
fvp
, 
fdvp
, 
tdvp
, 
¸ed
);

461 i‡(
îr‹
)

462 
whymu°ôhuπsomuch
;

465 
	`ˇche_purge
(
fdvp
);

478 i‡(!
ª∑ª¡_p
 && (
tvp
 =
NULL
) &&

479 
	`ext2fs_ª«me_uÃ_ovîœp_p
(
fuÃ
, 
tuÃ
)) {

480 
îr‹
 = 
	`ext2fs_ª«me_ªˇlcuœã_fuÃ
(
fdvp
, 
fuÃ
, 
tuÃ
, 
f˙p
);

482 i‡(
îr‹
)

483 
whymu°ôhuπsomuch
;

487 
îr‹
 = 
	`ext2fs_dúªmove
(
fdvp
, 
fuÃ
, 
f˙p
);

488 i‡(
îr‹
)

489 
whymu°ôhuπsomuch
;

496 
	`gífs_ª«me_knŸe
(
fdvp
, 
fvp
, 
tdvp
, 
tvp
,

497 ((
tvp
 !
NULL
Ë&& (
	`VTOI
—vp)->
i_e2fs_∆ök
 == 0)));

499 
	`gífs_ª«me_ˇche_purge
(
fdvp
, 
fvp
, 
tdvp
, 
tvp
);

502 
whymu°ôhuπsomuch
:

503 
	`KASSERT
(0 < 
	`VTOI
(
fvp
)->
i_e2fs_∆ök
);

504 
	`VTOI
(
fvp
)->
i_e2fs_∆ök
--;

505 
	`VTOI
(
fvp
)->
i_Êag
 |
IN_CHANGE
;

506  
îr‹
;

507 
	}
}

513 
boﬁ


514 
	$ext2fs_ª«me_uÃ_ovîœp_p
(c⁄° 
ufs_lookup_ªsu…s
 *
fuÃ
,

515 c⁄° 
ufs_lookup_ªsu…s
 *
tuÃ
)

517 
doff_t
 
‰om_¥ev_°¨t
, 
‰om_¥ev_íd
, 
to_°¨t
, 
to_íd
;

519 
	`KASSERT
(
fuÃ
 !
NULL
);

520 
	`KASSERT
(
tuÃ
 !
NULL
);

521 
	`KASSERT
(
fuÃ
 !
tuÃ
);

527 
‰om_¥ev_íd
 = 
fuÃ
->
uÃ_off£t
;

528 
	`KASSERT
(
fuÃ
->
uÃ_cou¡
 <
‰om_¥ev_íd
);

529 
‰om_¥ev_°¨t
 = (
‰om_¥ev_íd
 - 
fuÃ
->
uÃ_cou¡
);

535 
to_°¨t
 = 
tuÃ
->
uÃ_off£t
;

536 
	`KASSERT
(
tuÃ
->
uÃ_cou¡
 < (
EXT2FS_MAXDIRSIZE
 - 
to_°¨t
));

537 
to_íd
 = (
to_°¨t
 + 
tuÃ
->
uÃ_cou¡
);

540 (((
to_°¨t
 <
‰om_¥ev_°¨t
Ë&& (‰om_¥ev_°¨à< 
to_íd
)) ||

541 ((
to_°¨t
 <
‰om_¥ev_íd
Ë&& (‰om_¥ev_íd < 
to_íd
)));

542 
	}
}

551 
	$ext2fs_ª«me_ªˇlcuœã_fuÃ
(
vnode
 *
dvp
,

552 
ufs_lookup_ªsu…s
 *
fuÃ
, c⁄° ufs_lookup_ªsu…†*
tuÃ
,

553 c⁄° 
comp⁄íäame
 *
f˙p
)

555 
mou¡
 *
mp
;

556 
ufsmou¡
 *
ump
;

558 
dúblksiz
;

559 
doff_t
 
£¨ch_°¨t
, 
£¨ch_íd
;

560 
doff_t
 
off£t
;

561 
buf
 *
bp
;

562 *
dúbuf
;

563 
ext2fs_dúe˘
 *
ï
;

566 
uöt32_t
 
ª˛í
;

567 
uöt32_t
 
¥ev_ª˛í
;

568 
îr‹
;

570 
	`KASSERT
(
dvp
 !
NULL
);

571 
	`KASSERT
(
dvp
->
v_mou¡
 !
NULL
);

572 
	`KASSERT
(
	`VTOI
(
dvp
Ë!
NULL
);

573 
	`KASSERT
(
fuÃ
 !
NULL
);

574 
	`KASSERT
(
tuÃ
 !
NULL
);

575 
	`KASSERT
(
fuÃ
 !
tuÃ
);

576 
	`KASSERT
(
	`ext2fs_ª«me_uÃ_ovîœp_p
(
fuÃ
, 
tuÃ
));

578 
mp
 = 
dvp
->
v_mou¡
;

579 
ump
 = 
	`VFSTOUFS
(
mp
);

580 
	`KASSERT
(
ump
 !
NULL
);

581 
	`KASSERT
(
ump
 =
	`VTOI
(
dvp
)->
i_ump
);

583 
dúblksiz
 = 
ump
->
um_dúblksiz
;

584 
	`KASSERT
(0 < 
dúblksiz
);

585 
	`KASSERT
((
dúblksiz
 & (dirblksiz - 1)) == 0);

588 
	`KASSERT
(
dúblksiz
 <
mp
->
m¡_°©
.
f_iosize
);

591 
£¨ch_°¨t
 = 
tuÃ
->
uÃ_off£t
;

592 
	`KASSERT
(
fuÃ
->
uÃ_ª˛í
 < (
EXT2FS_MAXDIRSIZE
 - fuÃ->
uÃ_off£t
));

593 
£¨ch_íd
 = (
fuÃ
->
uÃ_off£t
 + fuÃ->
uÃ_ª˛í
);

596 
	`KASSERT
(
£¨ch_°¨t
 <
£¨ch_íd
);

597 
	`KASSERT
((
£¨ch_íd
 - (
£¨ch_°¨t
 &~ (
dúblksiz
 - 1))) <= dirblksiz);

599 
dúbuf
 = 
NULL
;

600 
bp
 = 
NULL
;

601 
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)
£¨ch_°¨t
, &
dúbuf
, &
bp
);

602 i‡(
îr‹
)

603  
îr‹
;

604 
	`KASSERT
(
dúbuf
 !
NULL
);

605 
	`KASSERT
(
bp
 !
NULL
);

612 
	`KASSERT
((
£¨ch_íd
 - 
£¨ch_°¨t
) <=

613 (
bp
->
b_bcou¡
 - (
£¨ch_°¨t
 & (
mp
->
m¡_°©
.
f_iosize
 - 1))));

615 
¥ev_ª˛í
 = 
fuÃ
->
uÃ_cou¡
;

616 
off£t
 = 
£¨ch_°¨t
;

624 
	`KASSERT
(
£¨ch_°¨t
 <
off£t
);

625 
	`KASSERT
(
off£t
 < 
£¨ch_íd
);

630 
ï
 = (
ext2fs_dúe˘
 *)

631 (
dúbuf
 + (
off£t
 - 
£¨ch_°¨t
));

632 
ª˛í
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

634 i‡(
ï
->
e2d_öo
 == 0)

635 
√xt
;

637 i‡(
	`fs2h32
(
ï
->
e2d_öo
Ë=
UFS_WINO
)

638 
√xt
;

640 i‡(
f˙p
->
˙_«mñí
 !
ï
->
e2d_«mÀn
)

641 
√xt
;

643 i‡(
	`memcmp
(
ï
->
e2d_«me
, 
f˙p
->
˙_«mïå
, f˙p->
˙_«mñí
))

644 
√xt
;

649 
√xt
:

650 i‡(! ((
ª˛í
 < 
£¨ch_íd
) &&

651 (
off£t
 < (
£¨ch_íd
 - 
ª˛í
)))) {

652 
	`bªl£
(
bp
, 0);

653  
EIO
;

657 
	`KASSERT
(
ª˛í
 < 
£¨ch_íd
);

658 
	`KASSERT
(
off£t
 < (
£¨ch_íd
 - 
ª˛í
));

664 
	`KASSERT
((
off£t
 &~ (
dúblksiz
 - 1)) ==

665 ((
off£t
 + 
ª˛í
Ë&~ (
dúblksiz
 - 1)));

667 
¥ev_ª˛í
 = 
ª˛í
;

668 
off£t
 +
ª˛í
;

674 
fuÃ
->
uÃ_off£t
 = 
off£t
;

675 
fuÃ
->
uÃ_ª˛í
 = 
ª˛í
;

681 
fuÃ
->
uÃ_cou¡
 = ((
off£t
 & (
dúblksiz
 - 1))? 
¥ev_ª˛í
 : 0);

683 
	`bªl£
(
bp
, 0);

685 
	}
}

692 
	$ext2fs_gro_ªmove
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

693 
vnode
 *
dvp
, 
comp⁄íäame
 *
˙p
, *
de
, vnodê*
vp
)

695 
ufs_lookup_ªsu…s
 *
uÃ
 = 
de
;

696 
îr‹
;

698 ()
mp
;

699 
	`KASSERT
(
mp
 !
NULL
);

700 
	`KASSERT
(
dvp
 !
NULL
);

701 
	`KASSERT
(
˙p
 !
NULL
);

702 
	`KASSERT
(
uÃ
 !
NULL
);

703 
	`KASSERT
(
vp
 !
NULL
);

704 
	`KASSERT
(
dvp
 !
vp
);

705 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

706 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

707 
	`KASSERT
(
dvp
->
v_ty≥
 =
VDIR
);

708 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

709 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

710 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

712 
îr‹
 = 
	`ext2fs_dúªmove
(
dvp
, 
uÃ
, 
˙p
);

713 i‡(
îr‹
)

714  
îr‹
;

716 
	`KASSERT
(0 < 
	`VTOI
(
vp
)->
i_e2fs_∆ök
);

717 
	`VTOI
(
vp
)->
i_e2fs_∆ök
--;

718 
	`VTOI
(
vp
)->
i_Êag
 |
IN_CHANGE
;

720 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
);

721 
	`VN_KNOTE
(
vp
, (
	`VTOI
(vp)->
i_e2fs_∆ök
? 
NOTE_LINK
 : 
NOTE_DELETE
));

724 
	}
}

730 
	$ext2fs_gro_lookup
(
mou¡
 *
mp
, 
vnode
 *
dvp
,

731 
comp⁄íäame
 *
˙p
, *
de_ªt
, 
vnode
 **
vp_ªt
)

733 
ufs_lookup_ªsu…s
 *
uÃ_ªt
 = 
de_ªt
;

734 
vnode
 *
vp
;

735 
îr‹
;

737 ()
mp
;

738 
	`KASSERT
(
mp
 !
NULL
);

739 
	`KASSERT
(
dvp
 !
NULL
);

740 
	`KASSERT
(
˙p
 !
NULL
);

741 
	`KASSERT
(
uÃ_ªt
 !
NULL
);

742 
	`KASSERT
(
vp_ªt
 !
NULL
);

743 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

746 
˙p
->
˙_Êags
 &=~ 
MODMASK
;

747 
˙p
->
˙_Êags
 |(
LOCKPARENT
 | 
LOCKLEAF
);

749 
îr‹
 = 
	`ªlookup
(
dvp
, &
vp
, 
˙p
, 0 );

750 i‡((
îr‹
 =0Ë&& (
vp
 =
NULL
)) {

751 
îr‹
 = 
ENOENT
;

752 
out
;

753 } i‡(
îr‹
) {

754  
îr‹
;

761 
	`KASSERT
(
vp
 !
NULL
);

762 
	`VOP_UNLOCK
(
vp
);

764 
out
: *
uÃ_ªt
 = 
	`VTOI
(
dvp
)->
i_¸≠
;

765 *
vp_ªt
 = 
vp
;

766  
îr‹
;

767 
	}
}

774 
boﬁ


775 
	$ext2fs_rmdúed_p
(
vnode
 *
vp
)

778 
	`KASSERT
(
vp
 !
NULL
);

779 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

780 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
);

783  (
	`ext2fs_size
(
	`VTOI
(
vp
)) == 0);

784 
	}
}

791 
	$ext2fs_gro_gíólogy
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

792 
vnode
 *
fdvp
, vnodê*
tdvp
,

793 
vnode
 **
öãrmedüã_node_ªt
)

795 
vnode
 *
vp
, *
dvp
;

796 
öo_t
 
dŸdŸ_öo
 = -1;

797 
îr‹
;

799 
	`KASSERT
(
mp
 !
NULL
);

800 
	`KASSERT
(
fdvp
 !
NULL
);

801 
	`KASSERT
(
tdvp
 !
NULL
);

802 
	`KASSERT
(
fdvp
 !
tdvp
);

803 
	`KASSERT
(
öãrmedüã_node_ªt
 !
NULL
);

804 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

805 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

806 
	`KASSERT
(
fdvp
->
v_ty≥
 =
VDIR
);

807 
	`KASSERT
(
tdvp
->
v_ty≥
 =
VDIR
);

813 
îr‹
 = 
	`ext2fs_gro_lock_dúe˘‹y
(
mp
, 
tdvp
);

814 i‡(
îr‹
)

815  
îr‹
;

817 
vp
 = 
tdvp
;

818 
	`vªf
(
vp
);

821 
	`KASSERT
(
vp
 !
NULL
);

822 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

823 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

824 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
);

825 
	`KASSERT
(!
	`ext2fs_rmdúed_p
(
vp
));

828 i‡(
	`VTOI
(
vp
)->
i_numbî
 =
UFS_ROOTINO
) {

829 
	`vput
(
vp
);

830 *
öãrmedüã_node_ªt
 = 
NULL
;

834 
îr‹
 = 
	`ext2fs_ªad_dŸdŸ
(
vp
, 
¸ed
, &
dŸdŸ_öo
);

835 i‡(
îr‹
) {

836 
	`vput
(
vp
);

837  
îr‹
;

841 i‡(
	`VTOI
(
fdvp
)->
i_numbî
 =
dŸdŸ_öo
) {

843 
	`VOP_UNLOCK
(
vp
);

844 *
öãrmedüã_node_ªt
 = 
vp
;

849 
îr‹
 = 
	`vˇche_gë
(
mp
, &
dŸdŸ_öo
, (dŸdŸ_öo), &
dvp
);

850 
	`vput
(
vp
);

851 i‡(
îr‹
)

852  
îr‹
;

853 
îr‹
 = 
	`vn_lock
(
dvp
, 
LK_EXCLUSIVE
);

854 i‡(
îr‹
) {

855 
	`vªÀ
(
dvp
);

856  
îr‹
;

859 
	`KASSERT
(
dvp
 !
NULL
);

860 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

861 
vp
 = 
dvp
;

863 i‡(
vp
->
v_ty≥
 !
VDIR
) {

870 
	`vput
(
vp
);

871  
ENOTDIR
;

874 i‡(
	`ext2fs_rmdúed_p
(
vp
)) {

875 
	`vput
(
vp
);

876  
ENOENT
;

879 
	}
}

886 
	$ext2fs_ªad_dŸdŸ
(
vnode
 *
vp
, 
kauth_¸ed_t
 
¸ed
, 
öo_t
 *
öo_ªt
)

888 
ext2fs_dúãm∂©e
 
dúbuf
;

889 
îr‹
;

891 
	`KASSERT
(
vp
 !
NULL
);

892 
	`KASSERT
(
öo_ªt
 !
NULL
);

893 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
);

895 
îr‹
 = 
	`ufs_bufio
(
UIO_READ
, 
vp
, &
dúbuf
,  dúbuf, (
off_t
)0,

896 
IO_NODELOCKED
, 
¸ed
, 
NULL
, NULL);

897 i‡(
îr‹
)

898  
îr‹
;

900 i‡(
dúbuf
.
dŸdŸ_«mÀn
 != 2 ||

901 
dúbuf
.
dŸdŸ_«me
[0] != '.' ||

902 
dúbuf
.
dŸdŸ_«me
[1] != '.')

904  
ENOTDIR
;

906 *
öo_ªt
 = 
	`fs2h32
(
dúbuf
.
dŸdŸ_öo
);

908 
	}
}

915 
	$ext2fs_ª«me_ª∂a˚_dŸdŸ
(
vnode
 *
vp
,

916 
vnode
 *
fdvp
, vnodê*
tdvp
,

917 
kauth_¸ed_t
 
¸ed
)

919 
ext2fs_dúãm∂©e
 
dúbuf
;

920 
îr‹
;

923 
	`KASSERT
(0 < 
	`VTOI
(
fdvp
)->
i_e2fs_∆ök
);

924 
	`VTOI
(
fdvp
)->
i_e2fs_∆ök
--;

925 
	`VTOI
(
fdvp
)->
i_Êag
 |
IN_CHANGE
;

927 
îr‹
 = 
	`ufs_bufio
(
UIO_READ
, 
vp
, &
dúbuf
,  dúbuf, (
off_t
)0,

928 
IO_NODELOCKED
, 
¸ed
, 
NULL
, NULL);

929 i‡(
îr‹
)

930  
îr‹
;

932 i‡(
dúbuf
.
dŸdŸ_«mÀn
 != 2 ||

933 
dúbuf
.
dŸdŸ_«me
[0] != '.' ||

934 
dúbuf
.
dŸdŸ_«me
[1] != '.') {

935 
	`ufs_dúbad
(
	`VTOI
(
vp
), (
doff_t
)12, "bad `..'Éntry");

939 i‡(
	`fs2h32
(
dúbuf
.
dŸdŸ_öo
Ë!
	`VTOI
(
fdvp
)->
i_numbî
) {

940 
	`ufs_dúbad
(
	`VTOI
(
vp
), (
doff_t
)12,

945 
dúbuf
.
dŸdŸ_öo
 = 
	`h2fs32
(
	`VTOI
(
tdvp
)->
i_numbî
);

947 ()
	`ufs_bufio
(
UIO_WRITE
, 
vp
, &
dúbuf
,  dúbuf, (
off_t
)0,

948 (
IO_NODELOCKED
 | 
IO_SYNC
), 
¸ed
, 
NULL
, NULL);

951 
	}
}

958 
	$ext2fs_gro_lock_dúe˘‹y
(
mou¡
 *
mp
, 
vnode
 *
vp
)

961 ()
mp
;

962 
	`KASSERT
(
mp
 !
NULL
);

963 
	`KASSERT
(
vp
 !
NULL
);

964 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

966 
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

968 i‡(
	`ext2fs_rmdúed_p
(
vp
)) {

969 
	`VOP_UNLOCK
(
vp
);

970  
ENOENT
;

974 
	}
}

976 c⁄° 
gífs_ª«me_›s
 
	gext2fs_gífs_ª«me_›s
 = {

977 .
gro_dúe˘‹y_em±y_p
 = 
ext2fs_gro_dúe˘‹y_em±y_p
,

978 .
	ggro_ª«me_check_possibÀ
 = 
ext2fs_gro_ª«me_check_possibÀ
,

979 .
	ggro_ª«me_check_≥rmôãd
 = 
ext2fs_gro_ª«me_check_≥rmôãd
,

980 .
	ggro_ªmove_check_possibÀ
 = 
ext2fs_gro_ªmove_check_possibÀ
,

981 .
	ggro_ªmove_check_≥rmôãd
 = 
ext2fs_gro_ªmove_check_≥rmôãd
,

982 .
	ggro_ª«me
 = 
ext2fs_gro_ª«me
,

983 .
	ggro_ªmove
 = 
ext2fs_gro_ªmove
,

984 .
	ggro_lookup
 = 
ext2fs_gro_lookup
,

985 .
	ggro_gíólogy
 = 
ext2fs_gro_gíólogy
,

986 .
	ggro_lock_dúe˘‹y
 = 
ext2fs_gro_lock_dúe˘‹y
,

	@ext2fs_subr.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_subr.c,v 1.31 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/vnode.h
>

68 
	~<sys/buf.h
>

69 
	~<sys/öây≥s.h
>

70 
	~<sys/kauth.h
>

72 
	~<ufs/ufs/öode.h
>

73 
	~<ufs/ext2fs/ext2fs.h
>

74 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

82 
	$ext2fs_blk©off
(
vnode
 *
vp
, 
off_t
 
off£t
, **
ªs
, 
buf
 **
bµ
)

84 
öode
 *
ù
;

85 
m_ext2fs
 *
fs
;

86 
buf
 *
bp
;

87 
daddr_t
 
lbn
;

88 
îr‹
;

90 
ù
 = 
	`VTOI
(
vp
);

91 
fs
 = 
ù
->
i_e2fs
;

92 
lbn
 = 
	`ext2_lblkno
(
fs
, 
off£t
);

94 *
bµ
 = 
NULL
;

95 i‡((
îr‹
 = 
	`bªad
(
vp
, 
lbn
, 
fs
->
e2fs_bsize
, 0, &
bp
)) != 0) {

96  (
îr‹
);

98 i‡(
ªs
)

99 *
ªs
 = (*)
bp
->
b_d©a
 + 
	`ext2_blkoff
(
fs
, 
off£t
);

100 *
bµ
 = 
bp
;

102 
	}
}

105 
	$ext2fs_ôimes
(
öode
 *
ù
, c⁄° 
time•ec
 *
acc
,

106 c⁄° 
time•ec
 *
mod
, c⁄° time•e¯*
¸e
)

108 
time•ec
 
now
;

110 i‡(!(
ù
->
i_Êag
 & (
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFY
))) {

114 
	`vfs_time°amp
(&
now
);

115 i‡(
ù
->
i_Êag
 & 
IN_ACCESS
) {

116 i‡(
acc
 =
NULL
)

117 
acc
 = &
now
;

118 
ù
->
i_e2fs_©ime
 = 
acc
->
tv_£c
;

120 i‡(
ù
->
i_Êag
 & (
IN_UPDATE
 | 
IN_MODIFY
)) {

121 i‡(
mod
 =
NULL
)

122 
mod
 = &
now
;

123 
ù
->
i_e2fs_mtime
 = 
mod
->
tv_£c
;

124 
ù
->
i_modªv
++;

126 i‡(
ù
->
i_Êag
 & (
IN_CHANGE
 | 
IN_MODIFY
)) {

127 i‡(
¸e
 =
NULL
)

128 
¸e
 = &
now
;

129 
ù
->
i_e2fs_˘ime
 = 
¸e
->
tv_£c
;

131 i‡(
ù
->
i_Êag
 & (
IN_ACCESS
 | 
IN_MODIFY
))

132 
ù
->
i_Êag
 |
IN_ACCESSED
;

133 i‡(
ù
->
i_Êag
 & (
IN_UPDATE
 | 
IN_CHANGE
))

134 
ù
->
i_Êag
 |
IN_MODIFIED
;

135 
ù
->
i_Êag
 &~(
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFY
);

136 
	}
}

	@ext2fs_vfsops.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_vfsops.c,v 1.193 2015/03/28 19:24:04 maxv Exp $");

65 #i‡
deföed
(
_KERNEL_OPT
)

66 
	~"›t_com∑t_√tbsd.h
"

69 
	~<sys/∑øm.h
>

70 
	~<sys/sy°m.h
>

71 
	~<sys/sys˘l.h
>

72 
	~<sys/«mei.h
>

73 
	~<sys/¥oc.h
>

74 
	~<sys/kî√l.h
>

75 
	~<sys/vnode.h
>

76 
	~<sys/sockë.h
>

77 
	~<sys/mou¡.h
>

78 
	~<sys/buf.h
>

79 
	~<sys/devi˚.h
>

80 
	~<sys/mbuf.h
>

81 
	~<sys/fûe.h
>

82 
	~<sys/diskœbñ.h
>

83 
	~<sys/io˘l.h
>

84 
	~<sys/î∫o.h
>

85 
	~<sys/poﬁ.h
>

86 
	~<sys/lock.h
>

87 
	~<sys/c⁄f.h
>

88 
	~<sys/kauth.h
>

89 
	~<sys/moduÀ.h
>

91 
	~<miscfs/gífs/gífs.h
>

92 
	~<miscfs/•ecfs/•ecdev.h
>

94 
	~<ufs/ufs/quŸa.h
>

95 
	~<ufs/ufs/ufsmou¡.h
>

96 
	~<ufs/ufs/öode.h
>

97 
	~<ufs/ufs/dú.h
>

98 
	~<ufs/ufs/ufs_exã∫.h
>

100 
	~<ufs/ext2fs/ext2fs.h
>

101 
	~<ufs/ext2fs/ext2fs_dú.h
>

102 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

104 
MODULE
(
MODULE_CLASS_VFS
, 
ext2fs
, "ffs");

106 
ext2fs_sbupd©e
(
ufsmou¡
 *, );

107 
ext2fs_sbfûl
(
m_ext2fs
 *, );

109 
sys˘Œog
 *
	gext2fs_sys˘l_log
;

111 c⁄° 
vnode›v_desc
 
ext2fs_vnode›_›v_desc
;

112 c⁄° 
vnode›v_desc
 
ext2fs_•ec›_›v_desc
;

113 c⁄° 
vnode›v_desc
 
ext2fs_fifo›_›v_desc
;

115 c⁄° 
vnode›v_desc
 * c⁄° 
	gext2fs_vnode›v_descs
[] = {

116 &
ext2fs_vnode›_›v_desc
,

117 &
ext2fs_•ec›_›v_desc
,

118 &
ext2fs_fifo›_›v_desc
,

119 
NULL
,

122 
vfs›s
 
	gext2fs_vfs›s
 = {

123 .
vfs_«me
 = 
MOUNT_EXT2FS
,

124 .
	gvfs_mö_mou¡_d©a
 =  (
ufs_¨gs
),

125 .
	gvfs_mou¡
 = 
ext2fs_mou¡
,

126 .
	gvfs_°¨t
 = 
ufs_°¨t
,

127 .
	gvfs_unmou¡
 = 
ext2fs_unmou¡
,

128 .
	gvfs_roŸ
 = 
ufs_roŸ
,

129 .
	gvfs_quŸa˘l
 = 
ufs_quŸa˘l
,

130 .
	gvfs_°©vfs
 = 
ext2fs_°©vfs
,

131 .
	gvfs_sync
 = 
ext2fs_sync
,

132 .
	gvfs_vgë
 = 
ufs_vgë
,

133 .
	gvfs_lﬂdvnode
 = 
ext2fs_lﬂdvnode
,

134 .
	gvfs_fhtovp
 = 
ext2fs_fhtovp
,

135 .
	gvfs_v±ofh
 = 
ext2fs_v±ofh
,

136 .
	gvfs_öô
 = 
ext2fs_öô
,

137 .
	gvfs_ªöô
 = 
ext2fs_ªöô
,

138 .
	gvfs_d⁄e
 = 
ext2fs_d⁄e
,

139 .
	gvfs_mou¡roŸ
 = 
ext2fs_mou¡roŸ
,

140 .
	gvfs_¢≠shŸ
 = (*)
e›nŸsuµ
,

141 .
	gvfs_exèâr˘l
 = 
vfs_°dexèâr˘l
,

142 .
	gvfs_su•íd˘l
 = (*)
e›nŸsuµ
,

143 .
	gvfs_ª«mñock_íãr
 = 
gífs_ª«mñock_íãr
,

144 .
	gvfs_ª«mñock_exô
 = 
gífs_ª«mñock_exô
,

145 .
	gvfs_fsync
 = (*)
e›nŸsuµ
,

146 .
	gvfs_›v_descs
 = 
ext2fs_vnode›v_descs


149 c⁄° 
gífs_›s
 
	gext2fs_gífs›s
 = {

150 .
g›_size
 = 
gífs_size
,

151 .
	gg›_Æloc
 = 
ext2fs_g›_Æloc
,

152 .
	gg›_wrôe
 = 
gífs_g›_wrôe
,

153 .
	gg›_m¨kupd©e
 = 
ufs_g›_m¨kupd©e
,

156 c⁄° 
ufs_›s
 
	gext2fs_ufs›s
 = {

157 .
uo_ôimes
 = 
ext2fs_ôimes
,

158 .
	guo_upd©e
 = 
ext2fs_upd©e
,

159 .
	guo_bu‰d
 = 
ext2fs_bu‰d
,

160 .
	guo_bufwr
 = 
ext2fs_bufwr
,

165 
	$ext2fs_£t_öode_guid
(
öode
 *
ù
)

168 
ù
->
i_gid
 = ip->
i_e2fs_gid
;

169 
ù
->
i_uid
 = ip->
i_e2fs_uid
;

170 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

171 
ù
->
i_gid
 |ù->
i_e2fs_gid_high
 << 16;

172 
ù
->
i_uid
 |ù->
i_e2fs_uid_high
 << 16;

174 
	}
}

177 
	$ext2fs_modcmd
(
modcmd_t
 
cmd
, *
¨g
)

179 
îr‹
;

181 
cmd
) {

182 
MODULE_CMD_INIT
:

183 
îr‹
 = 
	`vfs_©èch
(&
ext2fs_vfs›s
);

184 i‡(
îr‹
 != 0)

186 
	`sys˘l_¸óãv
(&
ext2fs_sys˘l_log
, 0, 
NULL
, NULL,

187 
CTLFLAG_PERMANENT
,

188 
CTLTYPE_NODE
, "ext2fs",

189 
	`SYSCTL_DESCR
("Linux EXT2FS file system"),

190 
NULL
, 0, NULL, 0,

191 
CTL_VFS
, 17, 
CTL_EOL
);

198 
MODULE_CMD_FINI
:

199 
îr‹
 = 
	`vfs_dëach
(&
ext2fs_vfs›s
);

200 i‡(
îr‹
 != 0)

202 
	`sys˘l_ã¨down
(&
ext2fs_sys˘l_log
);

205 
îr‹
 = 
ENOTTY
;

209  (
îr‹
);

210 
	}
}

215 
poﬁ
 
	gext2fs_öode_poﬁ
;

216 
poﬁ
 
	gext2fs_döode_poﬁ
;

218 
u_l⁄g
 
ext2gínumbî
;

221 
	$ext2fs_öô
()

223 
	`¥ötf
("insideÉxt2fs_init\n");

224 
	`poﬁ_öô
(&
ext2fs_öode_poﬁ
, (
öode
), 0, 0, 0,

225 "ext2fsö›l", &
poﬁ_Æloˇt‹_noöå
, 
IPL_NONE
);

226 
	`poﬁ_öô
(&
ext2fs_döode_poﬁ
, (
ext2fs_döode
), 0, 0, 0,

227 "ext2dö›l", &
poﬁ_Æloˇt‹_noöå
, 
IPL_NONE
);

228 
	`ufs_öô
();

229 
	}
}

232 
	$ext2fs_ªöô
()

234 
	`ufs_ªöô
();

235 
	}
}

238 
	$ext2fs_d⁄e
()

241 
	`ufs_d⁄e
();

242 
	`poﬁ_de°roy
(&
ext2fs_öode_poﬁ
);

243 
	`poﬁ_de°roy
(&
ext2fs_döode_poﬁ
);

244 
	}
}

253 
	$ext2fs_mou¡roŸ
()

255 
	`¥ötf
("ext2fs_mountroot\n");

256 
vnode
 *
roŸvp
;

257 
m_ext2fs
 *
fs
;

258 
mou¡
 *
mp
;

259 
ufsmou¡
 *
ump
;

260 
îr‹
;

262 i‡(
	`devi˚_˛ass
(
roŸ_devi˚
Ë!
DV_DISK
)

263  (
ENODEV
);

265 i‡((
îr‹
 = 
	`vfs_roŸmou¡Æloc
(
MOUNT_EXT2FS
, "roŸ_devi˚", &
mp
))) {

266 
	`vªÀ
(
roŸvp
);

267  (
îr‹
);

270 i‡((
îr‹
 = 
	`ext2fs_mou¡fs
(
roŸvp
, 
mp
)) != 0) {

271 
	`vfs_unbusy
(
mp
, 
Ál£
, 
NULL
);

272 
	`vfs_de°roy
(
mp
);

273  (
îr‹
);

275 
	`mou¡li°_≠≥nd
(
mp
);

276 
ump
 = 
	`VFSTOUFS
(
mp
);

277 
fs
 = 
ump
->
um_e2fs
;

278 
	`mem£t
(
fs
->
e2fs_fsm¡
, 0, (fs->e2fs_fsmnt));

279 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs_fsm¡
,

280 (
fs
->
e2fs_fsm¡
) - 1, 0);

281 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

282 
	`mem£t
(
fs
->
e2fs
.
e2fs_fsm¡
, 0, (fs->e2fs.e2fs_fsmnt));

283 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs
.
e2fs_fsm¡
,

284 (
fs
->
e2fs
.
e2fs_fsm¡
) - 1, 0);

286 ()
	`ext2fs_°©vfs
(
mp
, &mp->
m¡_°©
);

287 
	`vfs_unbusy
(
mp
, 
Ál£
, 
NULL
);

288 
	`£åoŸf°ime
((
time_t
)
fs
->
e2fs
.
e2fs_wtime
);

290 
	}
}

298 
	$ext2fs_mou¡
(
mou¡
 *
mp
, c⁄° *
∑th
, *
d©a
, 
size_t
 *
d©a_Àn
)

300 
	`¥ötf
("hello world\n");

301 
lwp
 *
l
 = 
cuæwp
;

302 
vnode
 *
devvp
;

303 
ufs_¨gs
 *
¨gs
 = 
d©a
;

304 
ufsmou¡
 *
ump
 = 
NULL
;

305 
m_ext2fs
 *
fs
;

306 
size_t
 
size
;

307 
îr‹
 = 0, 
Êags
, 
upd©e
;

308 
mode_t
 
ac˚ssmode
;

310 i‡(
¨gs
 =
NULL
)

311  
EINVAL
;

312 i‡(*
d©a_Àn
 <  *
¨gs
)

313  
EINVAL
;

315 i‡(
mp
->
m¡_Êag
 & 
MNT_GETARGS
) {

316 
ump
 = 
	`VFSTOUFS
(
mp
);

317 i‡(
ump
 =
NULL
)

318  
EIO
;

319 
	`mem£t
(
¨gs
, 0,  *args);

320 
¨gs
->
f•ec
 = 
NULL
;

321 *
d©a_Àn
 =  *
¨gs
;

325 
upd©e
 = 
mp
->
m¡_Êag
 & 
MNT_UPDATE
;

328 i‡(
¨gs
->
f•ec
 !
NULL
) {

332 
îr‹
 = 
	`«mei_sim∂e_u£r
(
¨gs
->
f•ec
,

333 
NSM_FOLLOW_NOEMULROOT
, &
devvp
);

334 i‡(
îr‹
 != 0)

335  (
îr‹
);

337 i‡(!
upd©e
) {

341 i‡(
devvp
->
v_ty≥
 !
VBLK
)

342 
îr‹
 = 
ENOTBLK
;

343 i‡(
	`bdevsw_lookup
(
devvp
->
v_rdev
Ë=
NULL
)

344 
îr‹
 = 
ENXIO
;

350 
ump
 = 
	`VFSTOUFS
(
mp
);

351 i‡(
devvp
 !
ump
->
um_devvp
) {

352 i‡(
devvp
->
v_rdev
 !
ump
->
um_devvp
->v_rdev)

353 
îr‹
 = 
EINVAL
;

355 
	`vªÀ
(
devvp
);

356 
devvp
 = 
ump
->
um_devvp
;

357 
	`vªf
(
devvp
);

362 i‡(!
upd©e
) {

364  (
EINVAL
);

366 
ump
 = 
	`VFSTOUFS
(
mp
);

367 
devvp
 = 
ump
->
um_devvp
;

368 
	`vªf
(
devvp
);

380 i‡(
îr‹
 == 0) {

381 
ac˚ssmode
 = 
VREAD
;

382 i‡(
upd©e
 ?

383 (
mp
->
m¡_iÊag
 & 
IMNT_WANTRDWR
) != 0 :

384 (
mp
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

385 
ac˚ssmode
 |
VWRITE
;

386 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

387 
îr‹
 = 
	`kauth_auth‹ize_sy°em
(
l
->
l_¸ed
, 
KAUTH_SYSTEM_MOUNT
,

388 
KAUTH_REQ_SYSTEM_MOUNT_DEVICE
, 
mp
, 
devvp
,

389 
	`KAUTH_ARG
(
ac˚ssmode
));

390 
	`VOP_UNLOCK
(
devvp
);

393 i‡(
îr‹
) {

394 
	`vªÀ
(
devvp
);

395  (
îr‹
);

398 i‡(!
upd©e
) {

399 
xÊags
;

401 i‡(
mp
->
m¡_Êag
 & 
MNT_RDONLY
)

402 
xÊags
 = 
FREAD
;

404 
xÊags
 = 
FREAD
|
FWRITE
;

405 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

406 
îr‹
 = 
	`VOP_OPEN
(
devvp
, 
xÊags
, 
FSCRED
);

407 
	`VOP_UNLOCK
(
devvp
);

408 i‡(
îr‹
)

409 
Áû
;

410 
îr‹
 = 
	`ext2fs_mou¡fs
(
devvp
, 
mp
);

411 i‡(
îr‹
) {

412 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

413 ()
	`VOP_CLOSE
(
devvp
, 
xÊags
, 
NOCRED
);

414 
	`VOP_UNLOCK
(
devvp
);

415 
Áû
;

418 
ump
 = 
	`VFSTOUFS
(
mp
);

419 
fs
 = 
ump
->
um_e2fs
;

430 
	`vªÀ
(
devvp
);

432 
ump
 = 
	`VFSTOUFS
(
mp
);

433 
fs
 = 
ump
->
um_e2fs
;

434 i‡(
fs
->
e2fs_r⁄ly
 =0 && (
mp
->
m¡_Êag
 & 
MNT_RDONLY
)) {

438 
Êags
 = 
WRITECLOSE
;

439 i‡(
mp
->
m¡_Êag
 & 
MNT_FORCE
)

440 
Êags
 |
FORCECLOSE
;

441 
îr‹
 = 
	`ext2fs_Êushfûes
(
mp
, 
Êags
);

442 i‡(
îr‹
 == 0 &&

443 
	`ext2fs_cgupd©e
(
ump
, 
MNT_WAIT
) == 0 &&

444 (
fs
->
e2fs
.
e2fs_°©e
 & 
E2FS_ERRORS
) == 0) {

445 
fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ISCLEAN
;

446 (Ë
	`ext2fs_sbupd©e
(
ump
, 
MNT_WAIT
);

448 i‡(
îr‹
)

449  (
îr‹
);

450 
fs
->
e2fs_r⁄ly
 = 1;

453 i‡(
mp
->
m¡_Êag
 & 
MNT_RELOAD
) {

454 
îr‹
 = 
	`ext2fs_ªlﬂd
(
mp
, 
l
->
l_¸ed
,Ü);

455 i‡(
îr‹
)

456  (
îr‹
);

459 i‡(
fs
->
e2fs_r⁄ly
 && (
mp
->
m¡_iÊag
 & 
IMNT_WANTRDWR
)) {

463 
fs
->
e2fs_r⁄ly
 = 0;

464 i‡(
fs
->
e2fs
.
e2fs_°©e
 =
E2FS_ISCLEAN
)

465 
fs
->
e2fs
.
e2fs_°©e
 = 0;

467 
fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ERRORS
;

468 
fs
->
e2fs_fmod
 = 1;

470 i‡(
¨gs
->
f•ec
 =
NULL
)

474 
îr‹
 = 
	`£t_°©vfs_öfo
(
∑th
, 
UIO_USERSPACE
, 
¨gs
->
f•ec
,

475 
UIO_USERSPACE
, 
mp
->
m¡_›
->
vfs_«me
, mp, 
l
);

476 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs_fsm¡
,

477 (
fs
->
e2fs_fsm¡
Ë- 1, &
size
);

478 
	`mem£t
(
fs
->
e2fs_fsm¡
 + 
size
, 0, (fs->e2fs_fsmnt) - size);

479 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

480 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs
.
e2fs_fsm¡
,

481 (
fs
->
e2fs
.
e2fs_fsm¡
Ë- 1, &
size
);

482 
	`mem£t
(
fs
->
e2fs
.
e2fs_fsm¡
, 0,

483 (
fs
->
e2fs
.
e2fs_fsm¡
Ë- 
size
);

485 i‡(
fs
->
e2fs_fmod
 != 0) {

486 
fs
->
e2fs_fmod
 = 0;

487 i‡(
fs
->
e2fs
.
e2fs_°©e
 == 0)

488 
fs
->
e2fs
.
e2fs_wtime
 = 
time_£c⁄d
;

490 
	`¥ötf
("%s: file systemÇot clean;Ölease fsck(8)\n",

491 
mp
->
m¡_°©
.
f_m¡‰om«me
);

492 (Ë
	`ext2fs_cgupd©e
(
ump
, 
MNT_WAIT
);

494  (
îr‹
);

496 
Áû
:

497 
	`vªÀ
(
devvp
);

498  (
îr‹
);

499 
	}
}

515 
	$ext2fs_ªlﬂd
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
, 
lwp
 *
l
)

517 
	`¥ötf
 ("ext2fs_reload\n");

518 
vnode
 *
vp
, *
devvp
;

519 
öode
 *
ù
;

520 
buf
 *
bp
;

521 
m_ext2fs
 *
fs
;

522 
ext2fs
 *
√wfs
;

523 
i
, 
îr‹
;

524 *
˝
;

525 
ufsmou¡
 *
ump
;

526 
vnode_ôî©‹
 *
m¨kî
;

528 i‡((
mp
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

529  (
EINVAL
);

531 
ump
 = 
	`VFSTOUFS
(
mp
);

535 
devvp
 = 
ump
->
um_devvp
;

536 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

537 
îr‹
 = 
	`vövÆbuf
(
devvp
, 0, 
¸ed
, 
l
, 0, 0);

538 
	`VOP_UNLOCK
(
devvp
);

539 i‡(
îr‹
)

540 
	`∑nic
("ext2fs_reload: dirty1");

542 
fs
 = 
ump
->
um_e2fs
;

547 
îr‹
 = 
	`bªad
(
devvp
, 
SBLOCK
, 
SBSIZE
, 0, &
bp
);

548 i‡(
îr‹
)

549  
îr‹
;

550 
√wfs
 = (
ext2fs
 *)
bp
->
b_d©a
;

551 
	`e2fs_sblﬂd
(
√wfs
, &
fs
->
e2fs
);

553 
	`bªl£
(
bp
, 0);

555 
îr‹
 = 
	`ext2fs_sbfûl
(
fs
, (
mp
->
m¡_Êag
 & 
MNT_RDONLY
) != 0);

556 i‡(
îr‹
)

557  
îr‹
;

562 
i
 = 0; i < 
fs
->
e2fs_ngdb
; i++) {

563 
îr‹
 = 
	`bªad
(
devvp
 ,

564 
	`EXT2_FSBTODB
(
fs
, fs->
e2fs
.
e2fs_fú°_dblock
 +

565 1 + 
i
),

566 
fs
->
e2fs_bsize
, 0, &
bp
);

567 i‡(
îr‹
) {

568  (
îr‹
);

570 
	`e2fs_cglﬂd
((
ext2_gd
 *)
bp
->
b_d©a
,

571 &
fs
->
e2fs_gd
[
i
 * fs->
e2fs_bsize
 / (
ext2_gd
)],

572 
fs
->
e2fs_bsize
);

573 
	`bªl£
(
bp
, 0);

576 
	`vfs_vnode_ôî©‹_öô
(
mp
, &
m¨kî
);

577 (
vp
 = 
	`vfs_vnode_ôî©‹_√xt
(
m¨kî
, 
NULL
, NULL))) {

581 i‡(
	`vªcy˛e
(
vp
))

586 i‡(
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
)) {

587 
	`vªÀ
(
vp
);

590 i‡(
	`vövÆbuf
(
vp
, 0, 
¸ed
, 
l
, 0, 0))

591 
	`∑nic
("ext2fs_reload: dirty2");

595 
ù
 = 
	`VTOI
(
vp
);

596 
îr‹
 = 
	`bªad
(
devvp
, 
	`EXT2_FSBTODB
(
fs
, 
	`öo_to_fsba
(fs, 
ù
->
i_numbî
)),

597 ()
fs
->
e2fs_bsize
, 0, &
bp
);

598 i‡(
îr‹
) {

599 
	`vput
(
vp
);

602 
˝
 = (*)
bp
->
b_d©a
 +

603 (
	`öo_to_fsbo
(
fs
, 
ù
->
i_numbî
Ë* 
	`EXT2_DINODE_SIZE
(fs));

604 
	`e2fs_ûﬂd
((
ext2fs_döode
 *)
˝
, 
ù
->
i_dö
.
e2fs_dö
);

605 
	`ext2fs_£t_öode_guid
(
ù
);

606 
	`bªl£
(
bp
, 0);

607 
	`vput
(
vp
);

609 
	`vfs_vnode_ôî©‹_de°roy
(
m¨kî
);

610  (
îr‹
);

611 
	}
}

617 
	$ext2fs_mou¡fs
(
vnode
 *
devvp
, 
mou¡
 *
mp
)

619 
	`¥ötf
 ("inside mountfs\n");

620 
lwp
 *
l
 = 
cuæwp
;

621 
ufsmou¡
 *
ump
;

622 
buf
 *
bp
;

623 
ext2fs
 *
fs
;

624 
m_ext2fs
 *
m_fs
;

625 
dev_t
 
dev
;

626 
îr‹
, 
i
, 
r⁄ly
;

627 
kauth_¸ed_t
 
¸ed
;

629 
dev
 = 
devvp
->
v_rdev
;

630 
¸ed
 = 
l
->
l_¸ed
;

633 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

634 
îr‹
 = 
	`vövÆbuf
(
devvp
, 
V_SAVE
, 
¸ed
, 
l
, 0, 0);

635 
	`VOP_UNLOCK
(
devvp
);

636 i‡(
îr‹
)

637  (
îr‹
);

639 
r⁄ly
 = (
mp
->
m¡_Êag
 & 
MNT_RDONLY
) != 0;

641 
bp
 = 
NULL
;

642 
ump
 = 
NULL
;

645 
îr‹
 = 
	`bªad
(
devvp
, 
SBLOCK
, 
SBSIZE
, 0, &
bp
);

646 i‡(
îr‹
)

647 
out
;

648 
fs
 = (
ext2fs
 *)
bp
->
b_d©a
;

649 
m_fs
 = 
	`kmem_zÆloc
((
m_ext2fs
), 
KM_SLEEP
);

650 
	`e2fs_sblﬂd
(
fs
, &
m_fs
->
e2fs
);

652 
	`bªl£
(
bp
, 0);

653 
bp
 = 
NULL
;

656 
îr‹
 = 
	`ext2fs_sbfûl
(
m_fs
, 
r⁄ly
);

657 i‡(
îr‹
) {

658 
	`kmem_‰ì
(
m_fs
, (
m_ext2fs
));

659 
out
;

661 
m_fs
->
e2fs_r⁄ly
 = 
r⁄ly
;

663 
ump
 = 
	`kmem_zÆloc
((*ump), 
KM_SLEEP
);

664 
ump
->
um_f°y≥
 = 
UFS1
;

665 
ump
->
um_›s
 = &
ext2fs_ufs›s
;

666 
ump
->
um_e2fs
 = 
m_fs
;

668 i‡(
r⁄ly
 == 0) {

669 i‡(
m_fs
->
e2fs
.
e2fs_°©e
 =
E2FS_ISCLEAN
)

670 
m_fs
->
e2fs
.
e2fs_°©e
 = 0;

672 
m_fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ERRORS
;

673 
m_fs
->
e2fs_fmod
 = 1;

677 
m_fs
->
e2fs_gd
 = 
	`kmem_Æloc
(m_fs->
e2fs_ngdb
 * m_fs->
e2fs_bsize
, 
KM_SLEEP
);

678 
i
 = 0; i < 
m_fs
->
e2fs_ngdb
; i++) {

679 
îr‹
 = 
	`bªad
(
devvp
,

680 
	`EXT2_FSBTODB
(
m_fs
, m_fs->
e2fs
.
e2fs_fú°_dblock
 +

681 1 + 
i
),

682 
m_fs
->
e2fs_bsize
, 0, &
bp
);

683 i‡(
îr‹
) {

684 
	`kmem_‰ì
(
m_fs
->
e2fs_gd
,

685 
m_fs
->
e2fs_ngdb
 * m_fs->
e2fs_bsize
);

686 
out
;

688 
	`e2fs_cglﬂd
((
ext2_gd
 *)
bp
->
b_d©a
,

689 &
m_fs
->
e2fs_gd
[

690 
i
 * 
m_fs
->
e2fs_bsize
 / (
ext2_gd
)],

691 
m_fs
->
e2fs_bsize
);

692 
	`bªl£
(
bp
, 0);

693 
bp
 = 
NULL
;

696 
mp
->
m¡_d©a
 = 
ump
;

697 
mp
->
m¡_°©
.
f_fsidx
.
__fsid_vÆ
[0] = ()
dev
;

698 
mp
->
m¡_°©
.
f_fsidx
.
__fsid_vÆ
[1] = 
	`makef°y≥
(
MOUNT_EXT2FS
);

699 
mp
->
m¡_°©
.
f_fsid
 = mp->m¡_°©.
f_fsidx
.
__fsid_vÆ
[0];

700 
mp
->
m¡_°©
.
f_«memax
 = 
EXT2FS_MAXNAMLEN
;

701 
mp
->
m¡_Êag
 |
MNT_LOCAL
;

702 
mp
->
m¡_dev_bshi·
 = 
DEV_BSHIFT
;

703 
mp
->
m¡_fs_bshi·
 = 
m_fs
->
e2fs_bshi·
;

704 
mp
->
m¡_iÊag
 |
IMNT_DTYPE
;

705 
ump
->
um_Êags
 = 0;

706 
ump
->
um_mou¡p
 = 
mp
;

707 
ump
->
um_dev
 = 
dev
;

708 
ump
->
um_devvp
 = 
devvp
;

709 
ump
->
um_nödú
 = 
	`EXT2_NINDIR
(
m_fs
);

710 
ump
->
um_lognödú
 = 
	`ffs
(
	`EXT2_NINDIR
(
m_fs
)) - 1;

711 
ump
->
um_b±πodb
 = 
m_fs
->
e2fs_fsbtodb
;

712 
ump
->
um_£qöc
 = 1;

713 
ump
->
um_maxsymlökÀn
 = 
EXT2_MAXSYMLINKLEN
;

714 
ump
->
um_dúblksiz
 = 
m_fs
->
e2fs_bsize
;

715 
ump
->
um_maxfûesize
 = ((
uöt64_t
)0x80000000 * 
m_fs
->
e2fs_bsize
 - 1);

716 
	`•ec_node_£tmou¡edfs
(
devvp
, 
mp
);

719 
out
:

720 i‡(
bp
 !
NULL
)

721 
	`bªl£
(
bp
, 0);

722 i‡(
ump
) {

723 
	`kmem_‰ì
(
ump
->
um_e2fs
, (
m_ext2fs
));

724 
	`kmem_‰ì
(
ump
, (*ump));

725 
mp
->
m¡_d©a
 = 
NULL
;

727  (
îr‹
);

728 
	}
}

734 
	$ext2fs_unmou¡
(
mou¡
 *
mp
, 
m¡Êags
)

736 
ufsmou¡
 *
ump
;

737 
m_ext2fs
 *
fs
;

738 
îr‹
, 
Êags
;

740 
Êags
 = 0;

741 i‡(
m¡Êags
 & 
MNT_FORCE
)

742 
Êags
 |
FORCECLOSE
;

743 i‡((
îr‹
 = 
	`ext2fs_Êushfûes
(
mp
, 
Êags
)) != 0)

744  (
îr‹
);

745 
ump
 = 
	`VFSTOUFS
(
mp
);

746 
fs
 = 
ump
->
um_e2fs
;

747 i‡(
fs
->
e2fs_r⁄ly
 == 0 &&

748 
	`ext2fs_cgupd©e
(
ump
, 
MNT_WAIT
) == 0 &&

749 (
fs
->
e2fs
.
e2fs_°©e
 & 
E2FS_ERRORS
) == 0) {

750 
fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ISCLEAN
;

751 (Ë
	`ext2fs_sbupd©e
(
ump
, 
MNT_WAIT
);

753 i‡(
ump
->
um_devvp
->
v_ty≥
 !
VBAD
)

754 
	`•ec_node_£tmou¡edfs
(
ump
->
um_devvp
, 
NULL
);

755 
	`vn_lock
(
ump
->
um_devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

756 
îr‹
 = 
	`VOP_CLOSE
(
ump
->
um_devvp
, 
fs
->
e2fs_r⁄ly
 ? 
FREAD
 : FREAD|
FWRITE
,

757 
NOCRED
);

758 
	`vput
(
ump
->
um_devvp
);

759 
	`kmem_‰ì
(
fs
->
e2fs_gd
, fs->
e2fs_ngdb
 * fs->
e2fs_bsize
);

760 
	`kmem_‰ì
(
fs
, (*fs));

761 
	`kmem_‰ì
(
ump
, (*ump));

762 
mp
->
m¡_d©a
 = 
NULL
;

763 
mp
->
m¡_Êag
 &~
MNT_LOCAL
;

764  (
îr‹
);

765 
	}
}

771 
	$ext2fs_Êushfûes
(
mou¡
 *
mp
, 
Êags
)

773 
dof‹˚
;

774 
îr‹
;

776 i‡(!
dof‹˚
)

777 
Êags
 &~
FORCECLOSE
;

778 
îr‹
 = 
	`vÊush
(
mp
, 
NULLVP
, 
Êags
);

779  (
îr‹
);

780 
	}
}

786 
	$ext2fs_°©vfs
(
mou¡
 *
mp
, 
°©vfs
 *
sbp
)

788 
ufsmou¡
 *
ump
;

789 
m_ext2fs
 *
fs
;

790 
uöt32_t
 
ovîhód
, 
ovîhód_≥r_group
, 
ngdb
;

791 
i
, 
ngroups
;

793 
ump
 = 
	`VFSTOUFS
(
mp
);

794 
fs
 = 
ump
->
um_e2fs
;

795 i‡(
fs
->
e2fs
.
e2fs_magic
 !
E2FS_MAGIC
)

796 
	`∑nic
("ext2fs_statvfs");

801 
ovîhód_≥r_group
 =

804 
fs
->
e2fs_ôpg
;

805 
ovîhód
 = 
fs
->
e2fs
.
e2fs_fú°_dblock
 +

806 
fs
->
e2fs_ncg
 * 
ovîhód_≥r_group
;

807 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

808 
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
 & 
EXT2F_ROCOMPAT_SPARSESUPER
) {

809 
i
 = 0, 
ngroups
 = 0; i < 
fs
->
e2fs_ncg
; i++) {

810 i‡(
	`cg_has_sb
(
i
))

811 
ngroups
++;

814 
ngroups
 = 
fs
->
e2fs_ncg
;

816 
ngdb
 = 
fs
->
e2fs_ngdb
;

817 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

818 
fs
->
e2fs
.
e2fs_„©uªs_com∑t
 & 
EXT2F_COMPAT_RESIZE
)

819 
ngdb
 +
fs
->
e2fs
.
e2fs_ª£rved_ngdb
;

820 
ovîhód
 +
ngroups
 * (1 + 
ngdb
);

822 
sbp
->
f_bsize
 = 
fs
->
e2fs_bsize
;

823 
sbp
->
f_‰size
 = 
MINBSIZE
 << 
fs
->
e2fs
.
e2fs_fsize
;

824 
sbp
->
f_iosize
 = 
fs
->
e2fs_bsize
;

825 
sbp
->
f_blocks
 = 
fs
->
e2fs
.
e2fs_bcou¡
 - 
ovîhód
;

826 
sbp
->
f_b‰ì
 = 
fs
->
e2fs
.
e2fs_fbcou¡
;

827 
sbp
->
f_bªsvd
 = 
fs
->
e2fs
.
e2fs_rbcou¡
;

828 i‡(
sbp
->
f_b‰ì
 > sbp->
f_bªsvd
)

829 
sbp
->
f_bavaû
 = sbp->
f_b‰ì
 - sbp->
f_bªsvd
;

831 
sbp
->
f_bavaû
 = 0;

832 
sbp
->
f_fûes
 = 
fs
->
e2fs
.
e2fs_icou¡
;

833 
sbp
->
f_f‰ì
 = 
fs
->
e2fs
.
e2fs_ficou¡
;

834 
sbp
->
f_Ávaû
 = 
fs
->
e2fs
.
e2fs_ficou¡
;

835 
sbp
->
f_‰esvd
 = 0;

836 
	`c›y_°©vfs_öfo
(
sbp
, 
mp
);

838 
	}
}

840 
boﬁ


841 
	$ext2fs_sync_£À˘‹
(*
˛
, 
vnode
 *
vp
)

843 
öode
 *
ù
;

845 
ù
 = 
	`VTOI
(
vp
);

849 i‡(
ù
 =
NULL
 || 
vp
->
v_ty≥
 =
VNON
)

850  
Ál£
;

852 i‡(((
ù
->
i_Êag
 &

853 (
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFIED
)) == 0 &&

854 
	`LIST_EMPTY
(&
vp
->
v_dútyblkhd
) &&

855 
	`UVM_OBJ_IS_CLEAN
(&
vp
->
v_uobj
)))

856  
Ál£
;

857  
åue
;

858 
	}
}

868 
	$ext2fs_sync
(
mou¡
 *
mp
, 
waôf‹
, 
kauth_¸ed_t
 
¸ed
)

870 
vnode
 *
vp
;

871 
ufsmou¡
 *
ump
 = 
	`VFSTOUFS
(
mp
);

872 
m_ext2fs
 *
fs
;

873 
vnode_ôî©‹
 *
m¨kî
;

874 
îr‹
, 
ÆÀº‹
 = 0;

876 
fs
 = 
ump
->
um_e2fs
;

877 i‡(
fs
->
e2fs_fmod
 !0 && fs->
e2fs_r⁄ly
 != 0) {

878 
	`¥ötf
("f†%s\n", 
fs
->
e2fs_fsm¡
);

879 
	`∑nic
("update:Ñofs mod");

885 
	`vfs_vnode_ôî©‹_öô
(
mp
, &
m¨kî
);

886 (
vp
 = 
	`vfs_vnode_ôî©‹_√xt
(
m¨kî
, 
ext2fs_sync_£À˘‹
,

887 
NULL
)))

889 
îr‹
 = 
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
);

890 i‡(
îr‹
) {

891 
	`vªÀ
(
vp
);

894 i‡(
vp
->
v_ty≥
 =
VREG
 && 
waôf‹
 =
MNT_LAZY
)

895 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 0);

897 
îr‹
 = 
	`VOP_FSYNC
(
vp
, 
¸ed
,

898 
waôf‹
 =
MNT_WAIT
 ? 
FSYNC_WAIT
 : 0, 0, 0);

899 i‡(
îr‹
)

900 
ÆÀº‹
 = 
îr‹
;

901 
	`vput
(
vp
);

903 
	`vfs_vnode_ôî©‹_de°roy
(
m¨kî
);

907 i‡(
waôf‹
 !
MNT_LAZY
) {

908 
	`vn_lock
(
ump
->
um_devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

909 i‡((
îr‹
 = 
	`VOP_FSYNC
(
ump
->
um_devvp
, 
¸ed
,

910 
waôf‹
 =
MNT_WAIT
 ? 
FSYNC_WAIT
 : 0, 0, 0)) != 0)

911 
ÆÀº‹
 = 
îr‹
;

912 
	`VOP_UNLOCK
(
ump
->
um_devvp
);

917 i‡(
fs
->
e2fs_fmod
 != 0) {

918 
fs
->
e2fs_fmod
 = 0;

919 
fs
->
e2fs
.
e2fs_wtime
 = 
time_£c⁄d
;

920 i‡((
îr‹
 = 
	`ext2fs_cgupd©e
(
ump
, 
waôf‹
)))

921 
ÆÀº‹
 = 
îr‹
;

923  (
ÆÀº‹
);

924 
	}
}

931 
	$ext2fs_lﬂdvnode
(
mou¡
 *
mp
, 
vnode
 *
vp
,

932 c⁄° *
key
, 
size_t
 
key_Àn
, c⁄° **
√w_key
)

934 
öo_t
 
öo
;

935 
m_ext2fs
 *
fs
;

936 
öode
 *
ù
;

937 
ufsmou¡
 *
ump
;

938 
buf
 *
bp
;

939 
dev_t
 
dev
;

940 
îr‹
;

941 *
˝
;

943 
	`KASSERT
(
key_Àn
 =(
öo
));

944 
	`mem˝y
(&
öo
, 
key
, 
key_Àn
);

945 
ump
 = 
	`VFSTOUFS
(
mp
);

946 
dev
 = 
ump
->
um_dev
;

947 
fs
 = 
ump
->
um_e2fs
;

950 
îr‹
 = 
	`bªad
(
ump
->
um_devvp
, 
	`EXT2_FSBTODB
(
fs
, 
	`öo_to_fsba
(fs, 
öo
)),

951 ()
fs
->
e2fs_bsize
, 0, &
bp
);

952 i‡(
îr‹
)

953  
îr‹
;

956 
ù
 = 
	`poﬁ_gë
(&
ext2fs_öode_poﬁ
, 
PR_WAITOK
);

957 
	`mem£t
(
ù
, 0, (
öode
));

958 
vp
->
v_èg
 = 
VT_EXT2FS
;

959 
vp
->
v_›
 = 
ext2fs_vnode›_p
;

960 
vp
->
v_vÊag
 |
VV_LOCKSWORK
;

961 
vp
->
v_d©a
 = 
ù
;

962 
ù
->
i_vnode
 = 
vp
;

963 
ù
->
i_ump
 = 
ump
;

964 
ù
->
i_e2fs
 = 
fs
;

965 
ù
->
i_dev
 = 
dev
;

966 
ù
->
i_numbî
 = 
öo
;

967 
ù
->
i_e2fs_œ°_lblk
 = 0;

968 
ù
->
i_e2fs_œ°_blk
 = 0;

971 
	`gífs_node_öô
(
vp
, &
ext2fs_gífs›s
);

973 
˝
 = (*)
bp
->
b_d©a
 + (
	`öo_to_fsbo
(
fs
, 
öo
Ë* 
	`EXT2_DINODE_SIZE
(fs));

974 
ù
->
i_dö
.
e2fs_dö
 = 
	`poﬁ_gë
(&
ext2fs_döode_poﬁ
, 
PR_WAITOK
);

975 
	`e2fs_ûﬂd
((
ext2fs_döode
 *)
˝
, 
ù
->
i_dö
.
e2fs_dö
);

976 
	`ext2fs_£t_öode_guid
(
ù
);

977 
	`bªl£
(
bp
, 0);

980 i‡(
ù
->
i_e2fs_dtime
 != 0) {

981 
ù
->
i_e2fs_mode
 = 0;

982 ()
	`ext2fs_£tsize
(
ù
, 0);

983 ()
	`ext2fs_£äblock
(
ù
, 0);

984 
	`mem£t
(
ù
->
i_e2fs_blocks
, 0, (ip->i_e2fs_blocks));

988 
	`ext2fs_vöô
(
mp
, 
ext2fs_•ec›_p
, 
ext2fs_fifo›_p
, &
vp
);

991 
ù
->
i_devvp
 = 
ump
->
um_devvp
;

992 
	`vªf
(
ù
->
i_devvp
);

999 i‡(
ù
->
i_e2fs_gí
 == 0) {

1000 i‡(++
ext2gínumbî
 < (
u_l⁄g
)
time_£c⁄d
)

1001 
ext2gínumbî
 = 
time_£c⁄d
;

1002 
ù
->
i_e2fs_gí
 = 
ext2gínumbî
;

1003 i‡((
mp
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

1004 
ù
->
i_Êag
 |
IN_MODIFIED
;

1006 
	`uvm_v≈_£tsize
(
vp
, 
	`ext2fs_size
(
ù
));

1007 *
√w_key
 = &
ù
->
i_numbî
;

1009 
	}
}

1020 
	$ext2fs_fhtovp
(
mou¡
 *
mp
, 
fid
 *
fhp
, 
vnode
 **
vµ
)

1022 
öode
 *
ù
;

1023 
vnode
 *
nvp
;

1024 
îr‹
;

1025 
ufid
 
ufh
;

1026 
m_ext2fs
 *
fs
;

1028 i‡(
fhp
->
fid_Àn
 !(
ufid
))

1029  
EINVAL
;

1031 
	`mem˝y
(&
ufh
, 
fhp
, (
ufid
));

1032 
fs
 = 
	`VFSTOUFS
(
mp
)->
um_e2fs
;

1033 i‡((
ufh
.
ufid_öo
 < 
EXT2_FIRSTINO
 && ufh.ufid_öÿ!
EXT2_ROOTINO
) ||

1034 
ufh
.
ufid_öo
 >
fs
->
e2fs_ncg
 * fs->
e2fs
.
e2fs_ùg
)

1035  (
ESTALE
);

1037 i‡((
îr‹
 = 
	`VFS_VGET
(
mp
, 
ufh
.
ufid_öo
, &
nvp
)) != 0) {

1038 *
vµ
 = 
NULLVP
;

1039  (
îr‹
);

1041 
ù
 = 
	`VTOI
(
nvp
);

1042 i‡(
ù
->
i_e2fs_mode
 =0 || ip->
i_e2fs_dtime
 != 0 ||

1043 
ù
->
i_e2fs_gí
 !
ufh
.
ufid_gí
) {

1044 
	`vput
(
nvp
);

1045 *
vµ
 = 
NULLVP
;

1046  (
ESTALE
);

1048 *
vµ
 = 
nvp
;

1050 
	}
}

1057 
	$ext2fs_v±ofh
(
vnode
 *
vp
, 
fid
 *
fhp
, 
size_t
 *
fh_size
)

1059 
öode
 *
ù
;

1060 
ufid
 
ufh
;

1062 i‡(*
fh_size
 < (
ufid
)) {

1063 *
fh_size
 = (
ufid
);

1064  
E2BIG
;

1066 *
fh_size
 = (
ufid
);

1068 
ù
 = 
	`VTOI
(
vp
);

1069 
	`mem£t
(&
ufh
, 0, (ufh));

1070 
ufh
.
ufid_Àn
 = (
ufid
);

1071 
ufh
.
ufid_öo
 = 
ù
->
i_numbî
;

1072 
ufh
.
ufid_gí
 = 
ù
->
i_e2fs_gí
;

1073 
	`mem˝y
(
fhp
, &
ufh
, (ufh));

1075 
	}
}

1081 
	$ext2fs_sbupd©e
(
ufsmou¡
 *
mp
, 
waôf‹
)

1083 
m_ext2fs
 *
fs
 = 
mp
->
um_e2fs
;

1084 
buf
 *
bp
;

1085 
îr‹
 = 0;

1087 
bp
 = 
	`gëblk
(
mp
->
um_devvp
, 
SBLOCK
, 
SBSIZE
, 0, 0);

1088 
	`e2fs_sbßve
(&
fs
->
e2fs
, (
ext2fs
*)
bp
->
b_d©a
);

1089 i‡(
waôf‹
 =
MNT_WAIT
)

1090 
îr‹
 = 
	`bwrôe
(
bp
);

1092 
	`bawrôe
(
bp
);

1093  (
îr‹
);

1094 
	}
}

1097 
	$ext2fs_cgupd©e
(
ufsmou¡
 *
mp
, 
waôf‹
)

1099 
m_ext2fs
 *
fs
 = 
mp
->
um_e2fs
;

1100 
buf
 *
bp
;

1101 
i
, 
îr‹
 = 0, 
ÆÀº‹
 = 0;

1103 
ÆÀº‹
 = 
	`ext2fs_sbupd©e
(
mp
, 
waôf‹
);

1104 
i
 = 0; i < 
fs
->
e2fs_ngdb
; i++) {

1105 
bp
 = 
	`gëblk
(
mp
->
um_devvp
, 
	`EXT2_FSBTODB
(
fs
,

1106 
fs
->
e2fs
.
e2fs_fú°_dblock
 +

1107 1 + 
i
), 
fs
->
e2fs_bsize
, 0, 0);

1108 
	`e2fs_cgßve
(&
fs
->
e2fs_gd
[

1109 
i
 * 
fs
->
e2fs_bsize
 / (
ext2_gd
)],

1110 (
ext2_gd
 *)
bp
->
b_d©a
, 
fs
->
e2fs_bsize
);

1111 i‡(
waôf‹
 =
MNT_WAIT
)

1112 
îr‹
 = 
	`bwrôe
(
bp
);

1114 
	`bawrôe
(
bp
);

1117 i‡(!
ÆÀº‹
 && 
îr‹
)

1118 
ÆÀº‹
 = 
îr‹
;

1119  (
ÆÀº‹
);

1120 
	}
}

1127 
	$ext2fs_sbfûl
(
m_ext2fs
 *
m_fs
, 
r⁄ly
)

1129 
	`¥ötf
("ext2fs_sbfill\n");

1130 
uöt32_t
 
u32
;

1131 
ext2fs
 *
fs
 = &
m_fs
->
e2fs
;

1136 i‡(
fs
->
e2fs_magic
 !
E2FS_MAGIC
)

1137  
EINVAL
;

1138 i‡(
fs
->
e2fs_ªv
 > 
E2FS_REV1
) {

1139 
	`¥ötf
("ext2fs: unsuµ‹ãdÑevisi⁄Çumbî: %x\n", 
fs
->
e2fs_ªv
);

1140  
EINVAL
;

1142 i‡(
fs
->
e2fs_log_bsize
 > 2) {

1144 
	`¥ötf
("ext2fs: bad block size: %d\n", 
fs
->
e2fs_log_bsize
);

1145  
EINVAL
;

1147 i‡(
fs
->
e2fs_bpg
 == 0) {

1148 
	`¥ötf
("ext2fs: zero blocksÖer group\n");

1149  
EINVAL
;

1151 i‡(
fs
->
e2fs_ùg
 == 0) {

1152 
	`¥ötf
("ext2fs: zero inodesÖer group\n");

1153  
EINVAL
;

1156 i‡(
fs
->
e2fs_fú°_dblock
 >fs->
e2fs_bcou¡
) {

1157 
	`¥ötf
("ext2fs: invalid first data block\n");

1158  
EINVAL
;

1160 i‡(
fs
->
e2fs_rbcou¡
 > fs->
e2fs_bcou¡
 ||

1161 
fs
->
e2fs_fbcou¡
 > fs->
e2fs_bcou¡
) {

1162 
	`¥ötf
("ext2fs: invalid block count\n");

1163  
EINVAL
;

1169 i‡(
fs
->
e2fs_ªv
 > 
E2FS_REV0
) {

1170 
buf
[256];

1171 i‡(
fs
->
e2fs_fú°_öo
 !
EXT2_FIRSTINO
) {

1172 
	`¥ötf
("ext2fs: unsupported first inodeÖosition\n");

1173  
EINVAL
;

1175 
u32
 = 
fs
->
e2fs_„©uªs_öcom∑t
 & ~(
EXT2F_INCOMPAT_SUPP
);

1176 i‡(
u32
) {

1178 
	`¢¥ötb
(
buf
, (buf), 
EXT2F_INCOMPAT_BITS
, 
u32
);

1179 
	`¥ötf
("ext2fs: unsuµ‹ãd incom∑à„©uªs: %s\n", 
buf
);

1180  
EINVAL
;

1182 
u32
 = 
fs
->
e2fs_„©uªs_rocom∑t
 & ~
EXT2F_ROCOMPAT_SUPP
;

1183 i‡(!
r⁄ly
 && 
u32
) {

1184 
	`¢¥ötb
(
buf
, (buf), 
EXT2F_ROCOMPAT_BITS
, 
u32
);

1185 
	`¥ötf
("ext2fs: unsupportedÑo-incompat features: %s\n",

1186 
buf
);

1187  
EROFS
;

1189 i‡(
fs
->
e2fs_öode_size
 =0 || !
	`powîof2
(fs->e2fs_inode_size)) {

1190 
	`¥ötf
("ext2fs: bad inode size\n");

1191  
EINVAL
;

1198 
u32
 = 
fs
->
e2fs_bcou¡
 - fs->
e2fs_fú°_dblock
;

1199 
m_fs
->
e2fs_ncg
 = 
	`howm™y
(
u32
, 
fs
->
e2fs_bpg
);

1200 i‡(
m_fs
->
e2fs_ncg
 == 0) {

1201 
	`¥ötf
("ext2fs: invalidÇumber of cylinder groups\n");

1202  
EINVAL
;

1205 
m_fs
->
e2fs_fsbtodb
 = 
fs
->
e2fs_log_bsize
 + 
LOG_MINBSIZE
 - 
DEV_BSHIFT
;

1206 
m_fs
->
e2fs_bsize
 = 
MINBSIZE
 << 
fs
->
e2fs_log_bsize
;

1207 
m_fs
->
e2fs_bshi·
 = 
LOG_MINBSIZE
 + 
fs
->
e2fs_log_bsize
;

1208 
m_fs
->
e2fs_qbmask
 = m_fs->
e2fs_bsize
 - 1;

1209 
m_fs
->
e2fs_bmask
 = ~m_fs->
e2fs_qbmask
;

1211 i‡((
u32
 = 
m_fs
->
e2fs_bsize
 / (
ext2_gd
)) == 0) {

1213 
	`¥ötf
("ext2fs: invalid block size\n");

1214  
EINVAL
;

1216 
m_fs
->
e2fs_ngdb
 = 
	`howm™y
(m_fs->
e2fs_ncg
, 
u32
);

1217 i‡(
m_fs
->
e2fs_ngdb
 == 0) {

1218 
	`¥ötf
("ext2fs: invalidÇumber of group descriptor blocks\n");

1219  
EINVAL
;

1222 i‡(
m_fs
->
e2fs_bsize
 < 
	`EXT2_DINODE_SIZE
(m_fs)) {

1223 
	`¥ötf
("ext2fs: invalid inode size\n");

1224  
EINVAL
;

1226 
m_fs
->
e2fs_ùb
 = m_fs->
e2fs_bsize
 / 
	`EXT2_DINODE_SIZE
(m_fs);

1228 
m_fs
->
e2fs_ôpg
 = 
fs
->
e2fs_ùg
 / m_fs->
e2fs_ùb
;

1231 
	}
}

	@ext2fs_vnops.c

67 
	~<sys/cdefs.h
>

68 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_vnops.c,v 1.117 2015/04/20 23:03:09Ñiastradh Exp $");

70 
	~<sys/∑øm.h
>

71 
	~<sys/sy°m.h
>

72 
	~<sys/ªsour˚v¨.h
>

73 
	~<sys/kî√l.h
>

74 
	~<sys/fûe.h
>

75 
	~<sys/°©.h
>

76 
	~<sys/buf.h
>

77 
	~<sys/¥oc.h
>

78 
	~<sys/mou¡.h
>

79 
	~<sys/«mei.h
>

80 
	~<sys/vnode.h
>

81 
	~<sys/lockf.h
>

82 
	~<sys/poﬁ.h
>

83 
	~<sys/sig«lv¨.h
>

84 
	~<sys/kauth.h
>

86 
	~<miscfs/fifofs/fifo.h
>

87 
	~<miscfs/gífs/gífs.h
>

88 
	~<miscfs/•ecfs/•ecdev.h
>

90 
	~<ufs/ufs/öode.h
>

91 
	~<ufs/ufs/ufs_exã∫.h
>

92 
	~<ufs/ufs/ufsmou¡.h
>

94 
	~<ufs/ext2fs/ext2fs.h
>

95 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

96 
	~<ufs/ext2fs/ext2fs_dú.h
>

98 
¥è˘ive
;

100 
ext2fs_chmod
(
vnode
 *, , 
kauth_¸ed_t
, 
lwp
 *);

101 
ext2fs_chown
(
vnode
 *, 
uid_t
, 
gid_t
, 
kauth_¸ed_t
,

102 
lwp
 *);

104 
	u_qcvt
 {

105 
öt64_t
 
	mqcvt
;

106 
öt32_t
 
	mvÆ
[2];

109 
	#SETHIGH
(
q
, 
h
) { \

110 
_qcvt
 
tmp
; \

111 
tmp
.
qcvt
 = (
q
); \

112 
tmp
.
vÆ
[
_QUAD_HIGHWORD
] = (
h
); \

113 (
q
Ë
tmp
.
qcvt
; \

114 }

	)

115 
	#SETLOW
(
q
, 
l
) { \

116 
_qcvt
 
tmp
; \

117 
tmp
.
qcvt
 = (
q
); \

118 
tmp
.
vÆ
[
_QUAD_LOWWORD
] = (
l
); \

119 (
q
Ë
tmp
.
qcvt
; \

120 }

	)

126 
	$ext2fs_¸óã
(*
v
)

128 
v›_¸óã_v3_¨gs


133  *
≠
 = 
v
;

134 
îr‹
;

136 
îr‹
 =

137 
	`ext2fs_makeöode
(
	`MAKEIMODE
(
≠
->
a_v≠
->
va_ty≥
,áp->a_v≠->
va_mode
),

138 
≠
->
a_dvp
,áp->
a_vµ
,áp->
a_˙p
);

140 i‡(
îr‹
)

141  (
îr‹
);

142 
	`VN_KNOTE
(
≠
->
a_dvp
, 
NOTE_WRITE
);

143 
	`VOP_UNLOCK
(*
≠
->
a_vµ
);

145 
	}
}

152 
	$ext2fs_mknod
(*
v
)

154 
v›_mknod_v3_¨gs


159  *
≠
 = 
v
;

160 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

161 
vnode
 **
vµ
 = 
≠
->
a_vµ
;

162 
öode
 *
ù
;

163 
îr‹
;

164 
mou¡
 *
mp
;

165 
öo_t
 
öo
;

167 i‡((
îr‹
 = 
	`ext2fs_makeöode
(
	`MAKEIMODE
(
v≠
->
va_ty≥
, v≠->
va_mode
),

168 
≠
->
a_dvp
, 
vµ
,áp->
a_˙p
)) != 0)

169  (
îr‹
);

170 
	`VN_KNOTE
(
≠
->
a_dvp
, 
NOTE_WRITE
);

171 
ù
 = 
	`VTOI
(*
vµ
);

172 
mp
 = (*
vµ
)->
v_mou¡
;

173 
öo
 = 
ù
->
i_numbî
;

174 
ù
->
i_Êag
 |
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
;

175 i‡(
v≠
->
va_rdev
 !
VNOVAL
) {

180 
ù
->
i_dö
.
e2fs_dö
->
e2di_rdev
 = 
	`h2fs32
(
v≠
->
va_rdev
);

187 (*
vµ
)->
v_ty≥
 = 
VNON
;

188 
	`VOP_UNLOCK
(*
vµ
);

189 
	`vg⁄e
(*
vµ
);

190 
îr‹
 = 
	`vˇche_gë
(
mp
, &
öo
, (öo), 
vµ
);

191 i‡(
îr‹
 != 0) {

192 *
vµ
 = 
NULL
;

193  (
îr‹
);

196 
	}
}

205 
	$ext2fs_›í
(*
v
)

207 
v›_›í_¨gs


211  *
≠
 = 
v
;

216 i‡((
	`VTOI
(
≠
->
a_vp
)->
i_e2fs_Êags
 & 
EXT2_APPEND
) &&

217 (
≠
->
a_mode
 & (
FWRITE
 | 
O_APPEND
)) == FWRITE)

218  (
EPERM
);

220 
	}
}

223 
	$ext2fs_check_possibÀ
(
vnode
 *
vp
, 
öode
 *
ù
, 
mode_t
 
mode
)

231 i‡(
mode
 & 
VWRITE
) {

232 
vp
->
v_ty≥
) {

233 
VDIR
:

234 
VLNK
:

235 
VREG
:

236 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

237  (
EROFS
);

245 i‡((
mode
 & 
VWRITE
Ë&& (
ù
->
i_e2fs_Êags
 & 
EXT2_IMMUTABLE
))

246  (
EPERM
);

249 
	}
}

252 
	$ext2fs_check_≥rmôãd
(
vnode
 *
vp
, 
öode
 *
ù
, 
mode_t
 
mode
,

253 
kauth_¸ed_t
 
¸ed
)

256  
	`kauth_auth‹ize_vnode
(
¸ed
, 
	`KAUTH_ACCESS_ACTION
(
mode
, 
vp
->
v_ty≥
,

257 
ù
->
i_e2fs_mode
 & 
ALLPERMS
), 
vp
, 
NULL
, 
	`gífs_ˇn_ac˚ss
(vp->
v_ty≥
,

258 
ù
->
i_e2fs_mode
 & 
ALLPERMS
, ip->
i_uid
, ip->
i_gid
, 
mode
, 
¸ed
));

259 
	}
}

262 
	$ext2fs_ac˚ss
(*
v
)

264 
	`¥ötf
("insideÉx2fs_access\n");

265 
v›_ac˚ss_¨gs


269  *
≠
 = 
v
;

270 
vnode
 *
vp
 = 
≠
->
a_vp
;

271 
öode
 *
ù
 = 
	`VTOI
(
vp
);

272 
mode_t
 
mode
 = 
≠
->
a_mode
;

273 
îr‹
;

275 
îr‹
 = 
	`ext2fs_check_possibÀ
(
vp
, 
ù
, 
mode
);

276 i‡(
îr‹
)

277  
îr‹
;

279 
îr‹
 = 
	`ext2fs_check_≥rmôãd
(
vp
, 
ù
, 
mode
, 
≠
->
a_¸ed
);

281  
îr‹
;

282 
	}
}

286 
	$ext2fs_gë©å
(*
v
)

288 
v›_gë©å_¨gs


292  *
≠
 = 
v
;

293 
vnode
 *
vp
 = 
≠
->
a_vp
;

294 
öode
 *
ù
 = 
	`VTOI
(
vp
);

295 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

297 
	`EXT2FS_ITIMES
(
ù
, 
NULL
, NULL, NULL);

301 
v≠
->
va_fsid
 = 
ù
->
i_dev
;

302 
v≠
->
va_fûeid
 = 
ù
->
i_numbî
;

303 
v≠
->
va_mode
 = 
ù
->
i_e2fs_mode
 & 
ALLPERMS
;

304 
v≠
->
va_∆ök
 = 
ù
->
i_e2fs_∆ök
;

305 
v≠
->
va_uid
 = 
ù
->
i_uid
;

306 
v≠
->
va_gid
 = 
ù
->
i_gid
;

307 
v≠
->
va_rdev
 = (
dev_t
)
	`fs2h32
(
ù
->
i_dö
.
e2fs_dö
->
e2di_rdev
);

308 
v≠
->
va_size
 = 
vp
->
v_size
;

309 
v≠
->
va_©ime
.
tv_£c
 = 
ù
->
i_e2fs_©ime
;

310 
v≠
->
va_©ime
.
tv_n£c
 = 0;

311 
v≠
->
va_mtime
.
tv_£c
 = 
ù
->
i_e2fs_mtime
;

312 
v≠
->
va_mtime
.
tv_n£c
 = 0;

313 
v≠
->
va_˘ime
.
tv_£c
 = 
ù
->
i_e2fs_˘ime
;

314 
v≠
->
va_˘ime
.
tv_n£c
 = 0;

315 #ifde‡
EXT2FS_SYSTEM_FLAGS


316 
v≠
->
va_Êags
 = (
ù
->
i_e2fs_Êags
 & 
EXT2_APPEND
Ë? 
SF_APPEND
 : 0;

317 
v≠
->
va_Êags
 |(
ù
->
i_e2fs_Êags
 & 
EXT2_IMMUTABLE
Ë? 
SF_IMMUTABLE
 : 0;

319 
v≠
->
va_Êags
 = (
ù
->
i_e2fs_Êags
 & 
EXT2_APPEND
Ë? 
UF_APPEND
 : 0;

320 
v≠
->
va_Êags
 |(
ù
->
i_e2fs_Êags
 & 
EXT2_IMMUTABLE
Ë? 
UF_IMMUTABLE
 : 0;

322 
v≠
->
va_gí
 = 
ù
->
i_e2fs_gí
;

324 i‡(
vp
->
v_ty≥
 =
VBLK
)

325 
v≠
->
va_blocksize
 = 
BLKDEV_IOSIZE
;

326 i‡(
vp
->
v_ty≥
 =
VCHR
)

327 
v≠
->
va_blocksize
 = 
MAXBSIZE
;

329 
v≠
->
va_blocksize
 = 
vp
->
v_mou¡
->
m¡_°©
.
f_iosize
;

330 
v≠
->
va_byãs
 = 
	`dbtob
(
	`ext2fs_nblock
(
ù
));

331 
v≠
->
va_ty≥
 = 
vp
->
v_ty≥
;

332 
v≠
->
va_fûîev
 = 
ù
->
i_modªv
;

334 
	}
}

340 
	$ext2fs_£èâr
(*
v
)

342 
v›_£èâr_¨gs


346  *
≠
 = 
v
;

347 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

348 
vnode
 *
vp
 = 
≠
->
a_vp
;

349 
öode
 *
ù
 = 
	`VTOI
(
vp
);

350 
kauth_¸ed_t
 
¸ed
 = 
≠
->
a_¸ed
;

351 
lwp
 *
l
 = 
cuæwp
;

352 
îr‹
;

353 
kauth_a˘i⁄_t
 
a˘i⁄
 = 
KAUTH_VNODE_WRITE_FLAGS
;

354 
boﬁ
 
ch™gög_sysÊags
 = 
Ál£
;

359 i‡((
v≠
->
va_ty≥
 !
VNON
Ë|| (v≠->
va_∆ök
 !(
∆ök_t
)
VNOVAL
) ||

360 (
v≠
->
va_fsid
 !
VNOVAL
Ë|| (v≠->
va_fûeid
 != VNOVAL) ||

361 (
v≠
->
va_blocksize
 !
VNOVAL
Ë|| (v≠->
va_rdev
 != VNOVAL) ||

362 (()
v≠
->
va_byãs
 !
VNOVAL
Ë|| (v≠->
va_gí
 != VNOVAL)) {

363  (
EINVAL
);

365 i‡(
v≠
->
va_Êags
 !
VNOVAL
) {

366 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

367  (
EROFS
);

375 #ifde‡
EXT2FS_SYSTEM_FLAGS


377 i‡((
v≠
->
va_Êags
 & 
SF_APPEND
) ||

378 (
v≠
->
va_Êags
 & 
SF_IMMUTABLE
)) {

379 
a˘i⁄
 |
KAUTH_VNODE_WRITE_SYSFLAGS
;

380 
ch™gög_sysÊags
 = 
åue
;

384 i‡(
ù
->
i_e2fs_Êags
 & (
EXT2_APPEND
 | 
EXT2_IMMUTABLE
)) {

385 
a˘i⁄
 |
KAUTH_VNODE_HAS_SYSFLAGS
;

389 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
a˘i⁄
, 
vp
, 
NULL
,

390 
	`gífs_ˇn_chÊags
(
¸ed
, 
vp
->
v_ty≥
, 
ù
->
i_uid
,

391 
ch™gög_sysÊags
));

392 i‡(
îr‹
)

393  (
îr‹
);

395 #ifde‡
EXT2FS_SYSTEM_FLAGS


396 
ù
->
i_e2fs_Êags
 &~(
EXT2_APPEND
 | 
EXT2_IMMUTABLE
);

397 
ù
->
i_e2fs_Êags
 |=

398 (
v≠
->
va_Êags
 & 
SF_APPEND
Ë? 
EXT2_APPEND
 : 0 |

399 (
v≠
->
va_Êags
 & 
SF_IMMUTABLE
Ë? 
EXT2_IMMUTABLE
 : 0;

401 
ù
->
i_e2fs_Êags
 &~(
EXT2_APPEND
 | 
EXT2_IMMUTABLE
);

402 
ù
->
i_e2fs_Êags
 |=

403 (
v≠
->
va_Êags
 & 
UF_APPEND
Ë? 
EXT2_APPEND
 : 0 |

404 (
v≠
->
va_Êags
 & 
UF_IMMUTABLE
Ë? 
EXT2_IMMUTABLE
 : 0;

406 
ù
->
i_Êag
 |
IN_CHANGE
;

407 i‡(
v≠
->
va_Êags
 & (
IMMUTABLE
 | 
APPEND
))

410 i‡(
ù
->
i_e2fs_Êags
 & (
EXT2_APPEND
 | 
EXT2_IMMUTABLE
))

411  (
EPERM
);

415 i‡(
v≠
->
va_uid
 !(
uid_t
)
VNOVAL
 || v≠->
va_gid
 !(
gid_t
)VNOVAL) {

416 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

417  (
EROFS
);

418 
îr‹
 = 
	`ext2fs_chown
(
vp
, 
v≠
->
va_uid
, v≠->
va_gid
, 
¸ed
, 
l
);

419 i‡(
îr‹
)

420  (
îr‹
);

422 i‡(
v≠
->
va_size
 !
VNOVAL
) {

428 
vp
->
v_ty≥
) {

429 
VDIR
:

430  (
EISDIR
);

431 
VLNK
:

432 
VREG
:

433 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

434  (
EROFS
);

438 
îr‹
 = 
	`ext2fs_åunˇã
(
vp
, 
v≠
->
va_size
, 0, 
¸ed
);

439 i‡(
îr‹
)

440  (
îr‹
);

442 
ù
 = 
	`VTOI
(
vp
);

443 i‡(
v≠
->
va_©ime
.
tv_£c
 !
VNOVAL
 || v≠->
va_mtime
.tv_sec != VNOVAL) {

444 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

445  (
EROFS
);

446 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_WRITE_TIMES
, 
vp
,

447 
NULL
, 
	`gífs_ˇn_chtimes
(
vp
, 
v≠
->
va_vaÊags
, 
ù
->
i_uid
,

448 
¸ed
));

449 i‡(
îr‹
)

450  (
îr‹
);

451 i‡(
v≠
->
va_©ime
.
tv_£c
 !
VNOVAL
)

452 i‡(!(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_NOATIME
))

453 
ù
->
i_Êag
 |
IN_ACCESS
;

454 i‡(
v≠
->
va_mtime
.
tv_£c
 !
VNOVAL
) {

455 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

456 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RELATIME
)

457 
ù
->
i_Êag
 |
IN_ACCESS
;

459 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, &
v≠
->
va_©ime
, &v≠->
va_mtime
,

460 
UPDATE_WAIT
);

461 i‡(
îr‹
)

462  (
îr‹
);

464 
îr‹
 = 0;

465 i‡(
v≠
->
va_mode
 !(
mode_t
)
VNOVAL
) {

466 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

467  (
EROFS
);

468 
îr‹
 = 
	`ext2fs_chmod
(
vp
, ()
v≠
->
va_mode
, 
¸ed
, 
l
);

470 
	`VN_KNOTE
(
vp
, 
NOTE_ATTRIB
);

471  (
îr‹
);

472 
	}
}

479 
	$ext2fs_chmod
(
vnode
 *
vp
, 
mode
, 
kauth_¸ed_t
 
¸ed
, 
lwp
 *
l
)

481 
öode
 *
ù
 = 
	`VTOI
(
vp
);

482 
îr‹
;

484 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_WRITE_SECURITY
, 
vp
,

485 
NULL
, 
	`gífs_ˇn_chmod
(
vp
->
v_ty≥
, 
¸ed
, 
ù
->
i_uid
, ip->
i_gid
,

486 
mode
));

487 i‡(
îr‹
)

488  (
îr‹
);

490 
ù
->
i_e2fs_mode
 &~
ALLPERMS
;

491 
ù
->
i_e2fs_mode
 |(
mode
 & 
ALLPERMS
);

492 
ù
->
i_Êag
 |
IN_CHANGE
;

494 
	}
}

501 
	$ext2fs_chown
(
vnode
 *
vp
, 
uid_t
 
uid
, 
gid_t
 
gid
, 
kauth_¸ed_t
 
¸ed
,

502 
lwp
 *
l
)

504 
öode
 *
ù
 = 
	`VTOI
(
vp
);

505 
uid_t
 
ouid
;

506 
gid_t
 
ogid
;

507 
îr‹
;

509 i‡(
uid
 =(
uid_t
)
VNOVAL
)

510 
uid
 = 
ù
->
i_uid
;

511 i‡(
gid
 =(
gid_t
)
VNOVAL
)

512 
gid
 = 
ù
->
i_gid
;

514 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_CHANGE_OWNERSHIP
, 
vp
,

515 
NULL
, 
	`gífs_ˇn_chown
(
¸ed
, 
ù
->
i_uid
, ip->
i_gid
, 
uid
, 
gid
));

516 i‡(
îr‹
)

517  (
îr‹
);

519 
ogid
 = 
ù
->
i_gid
;

520 
ouid
 = 
ù
->
i_uid
;

522 
ù
->
i_e2fs_gid
 = 
gid
 & 0xffff;

523 
ù
->
i_e2fs_uid
 = 
uid
 & 0xffff;

524 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

525 
ù
->
i_e2fs_gid_high
 = (
gid
 >> 16) & 0xffff;

526 
ù
->
i_e2fs_uid_high
 = (
uid
 >> 16) & 0xffff;

528 
ù
->
i_e2fs_gid_high
 = 0;

529 
ù
->
i_e2fs_uid_high
 = 0;

531 i‡(
ouid
 !
uid
 || 
ogid
 !
gid
) {

532 
	`ext2fs_£t_öode_guid
(
ù
);

533 
ù
->
i_Êag
 |
IN_CHANGE
;

535 i‡(
ouid
 !
uid
 && (
ù
->
i_e2fs_mode
 & 
ISUID
) &&

536 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_RETAIN_SUID
,

537 
vp
, 
NULL
, 
EPERM
) != 0)

538 
ù
->
i_e2fs_mode
 &~
ISUID
;

539 i‡(
ogid
 !
gid
 && (
ù
->
i_e2fs_mode
 & 
ISGID
) &&

540 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_RETAIN_SGID
,

541 
vp
, 
NULL
, 
EPERM
) != 0)

542 
ù
->
i_e2fs_mode
 &~
ISGID
;

544 
	}
}

547 
	$ext2fs_ªmove
(*
v
)

549 
v›_ªmove_¨gs


553  *
≠
 = 
v
;

554 
öode
 *
ù
;

555 
vnode
 *
vp
 = 
≠
->
a_vp
;

556 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

557 
ufs_lookup_ªsu…s
 *
uÃ
;

558 
îr‹
;

561 
uÃ
 = &
	`VTOI
(
dvp
)->
i_¸≠
;

562 
	`UFS_CHECK_CRAPCOUNTER
(
	`VTOI
(
dvp
));

564 
ù
 = 
	`VTOI
(
vp
);

565 i‡(
vp
->
v_ty≥
 =
VDIR
 ||

566 (
ù
->
i_e2fs_Êags
 & (
EXT2_IMMUTABLE
 | 
EXT2_APPEND
)) ||

567 (
	`VTOI
(
dvp
)->
i_e2fs_Êags
 & 
EXT2_APPEND
)) {

568 
îr‹
 = 
EPERM
;

570 
îr‹
 = 
	`ext2fs_dúªmove
(
dvp
, 
uÃ
, 
≠
->
a_˙p
);

571 i‡(
îr‹
 == 0) {

572 
ù
->
i_e2fs_∆ök
--;

573 
ù
->
i_Êag
 |
IN_CHANGE
;

577 
	`VN_KNOTE
(
vp
, 
NOTE_DELETE
);

578 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
);

579 i‡(
dvp
 =
vp
)

580 
	`vªÀ
(
vp
);

582 
	`vput
(
vp
);

583 
	`vput
(
dvp
);

584  (
îr‹
);

585 
	}
}

591 
	$ext2fs_lök
(*
v
)

593 
v›_lök_v2_¨gs


597  *
≠
 = 
v
;

598 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

599 
vnode
 *
vp
 = 
≠
->
a_vp
;

600 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

601 
öode
 *
ù
;

602 
îr‹
;

603 
ufs_lookup_ªsu…s
 *
uÃ
;

605 
	`KASSERT
(
dvp
 !
vp
);

606 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

607 
	`KASSERT
(
dvp
->
v_mou¡
 =
vp
->v_mount);

610 
uÃ
 = &
	`VTOI
(
dvp
)->
i_¸≠
;

611 
	`UFS_CHECK_CRAPCOUNTER
(
	`VTOI
(
dvp
));

613 
îr‹
 = 
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
);

614 i‡(
îr‹
) {

615 
	`VOP_ABORTOP
(
dvp
, 
˙p
);

616 
out2
;

618 
ù
 = 
	`VTOI
(
vp
);

619 i‡((
∆ök_t
)
ù
->
i_e2fs_∆ök
 >
LINK_MAX
) {

620 
	`VOP_ABORTOP
(
dvp
, 
˙p
);

621 
îr‹
 = 
EMLINK
;

622 
out1
;

624 i‡(
ù
->
i_e2fs_Êags
 & (
EXT2_IMMUTABLE
 | 
EXT2_APPEND
)) {

625 
	`VOP_ABORTOP
(
dvp
, 
˙p
);

626 
îr‹
 = 
EPERM
;

627 
out1
;

629 
ù
->
i_e2fs_∆ök
++;

630 
ù
->
i_Êag
 |
IN_CHANGE
;

631 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
UPDATE_WAIT
);

632 i‡(!
îr‹
)

633 
îr‹
 = 
	`ext2fs_dúíãr
(
ù
, 
dvp
, 
uÃ
, 
˙p
);

634 i‡(
îr‹
) {

635 
ù
->
i_e2fs_∆ök
--;

636 
ù
->
i_Êag
 |
IN_CHANGE
;

638 
out1
:

639 
	`VOP_UNLOCK
(
vp
);

640 
out2
:

641 
	`VN_KNOTE
(
vp
, 
NOTE_LINK
);

642 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
);

643  (
îr‹
);

644 
	}
}

650 
	$ext2fs_mkdú
(*
v
)

652 
v›_mkdú_v3_¨gs


657  *
≠
 = 
v
;

658 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

659 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

660 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

661 
öode
 *
ù
, *
dp
 = 
	`VTOI
(
dvp
);

662 
vnode
 *
tvp
;

663 
ext2fs_dúãm∂©e
 
dúãm∂©e
;

664 
îr‹
, 
dmode
;

665 
ufs_lookup_ªsu…s
 *
uÃ
;

668 
uÃ
 = &
	`VTOI
(
dvp
)->
i_¸≠
;

669 
	`UFS_CHECK_CRAPCOUNTER
(
	`VTOI
(
dvp
));

671 i‡((
∆ök_t
)
dp
->
i_e2fs_∆ök
 >
LINK_MAX
) {

672 
îr‹
 = 
EMLINK
;

673 
out
;

675 
dmode
 = 
v≠
->
va_mode
 & 
ACCESSPERMS
;

676 
dmode
 |
IFDIR
;

682 i‡((
îr‹
 = 
	`ext2fs_vÆloc
(
dvp
, 
dmode
, 
˙p
->
˙_¸ed
, &
tvp
)) != 0)

683 
out
;

684 
ù
 = 
	`VTOI
(
tvp
);

685 
ù
->
i_uid
 = 
	`kauth_¸ed_gëeuid
(
˙p
->
˙_¸ed
);

686 
ù
->
i_e2fs_uid
 = ip->
i_uid
 & 0xffff;

687 
ù
->
i_e2fs_gid
 = 
dp
->i_e2fs_gid;

688 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

689 
ù
->
i_e2fs_uid_high
 = (ù->
i_uid
 >> 16) & 0xffff;

690 
ù
->
i_e2fs_gid_high
 = 
dp
->i_e2fs_gid_high;

692 
ù
->
i_e2fs_uid_high
 = 0;

693 
ù
->
i_e2fs_gid_high
 = 0;

695 
ù
->
i_gid
 = ip->
i_e2fs_gid
 | (ù->
i_e2fs_gid_high
 << 16);

696 
ù
->
i_Êag
 |
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
;

697 
ù
->
i_e2fs_mode
 = 
dmode
;

698 
tvp
->
v_ty≥
 = 
VDIR
;

699 
ù
->
i_e2fs_∆ök
 = 2;

707 
dp
->
i_e2fs_∆ök
++;

708 
dp
->
i_Êag
 |
IN_CHANGE
;

709 i‡((
îr‹
 = 
	`ext2fs_upd©e
(
dvp
, 
NULL
, NULL, 
UPDATE_DIROP
)) != 0)

710 
bad
;

713 
	`mem£t
(&
dúãm∂©e
, 0, (dirtemplate));

714 
dúãm∂©e
.
dŸ_öo
 = 
	`h2fs32
(
ù
->
i_numbî
);

715 
dúãm∂©e
.
dŸ_ª˛í
 = 
	`h2fs16
(12);

716 
dúãm∂©e
.
dŸ_«mÀn
 = 1;

717 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

718 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

719 
dúãm∂©e
.
dŸ_ty≥
 = 
EXT2_FT_DIR
;

721 
dúãm∂©e
.
dŸ_«me
[0] = '.';

722 
dúãm∂©e
.
dŸdŸ_öo
 = 
	`h2fs32
(
dp
->
i_numbî
);

723 
dúãm∂©e
.
dŸdŸ_ª˛í
 = 
	`h2fs16
(
	`VTOI
(
dvp
)->
i_e2fs
->
e2fs_bsize
 - 12);

724 
dúãm∂©e
.
dŸdŸ_«mÀn
 = 2;

725 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

726 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

727 
dúãm∂©e
.
dŸdŸ_ty≥
 = 
EXT2_FT_DIR
;

729 
dúãm∂©e
.
dŸdŸ_«me
[0] = dirtemplate.dotdot_name[1] = '.';

730 
îr‹
 = 
	`ufs_bufio
(
UIO_WRITE
, 
tvp
, (*)&
dúãm∂©e
,

731  (
dúãm∂©e
), (
off_t
)0, 
IO_NODELOCKED
|
IO_SYNC
,

732 
˙p
->
˙_¸ed
, (
size_t
 *)0, 
NULL
);

733 i‡(
îr‹
) {

734 
dp
->
i_e2fs_∆ök
--;

735 
dp
->
i_Êag
 |
IN_CHANGE
;

736 
bad
;

738 i‡(
	`VTOI
(
dvp
)->
i_e2fs
->
e2fs_bsize
 > dvp->
v_mou¡
->
m¡_°©
.
f_bsize
)

739 
	`∑nic
("ext2fs_mkdir: blksize");

741 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
	`VTOI
(
dvp
)->
i_e2fs
->
e2fs_bsize
);

742 i‡(
îr‹
) {

743 
dp
->
i_e2fs_∆ök
--;

744 
dp
->
i_Êag
 |
IN_CHANGE
;

745 
bad
;

747 
ù
->
i_Êag
 |
IN_CHANGE
;

748 
	`uvm_v≈_£tsize
(
tvp
, 
	`ext2fs_size
(
ù
));

752 
îr‹
 = 
	`ext2fs_dúíãr
(
ù
, 
dvp
, 
uÃ
, 
˙p
);

753 i‡(
îr‹
 != 0) {

754 
dp
->
i_e2fs_∆ök
--;

755 
dp
->
i_Êag
 |
IN_CHANGE
;

757 
bad
:

762 i‡(
îr‹
) {

763 
ù
->
i_e2fs_∆ök
 = 0;

764 
ù
->
i_Êag
 |
IN_CHANGE
;

765 
	`vput
(
tvp
);

767 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
 | 
NOTE_LINK
);

768 
	`VOP_UNLOCK
(
tvp
);

769 *
≠
->
a_vµ
 = 
tvp
;

771 
out
:

772  (
îr‹
);

773 
	}
}

779 
	$ext2fs_rmdú
(*
v
)

781 
v›_rmdú_¨gs


785  *
≠
 = 
v
;

786 
vnode
 *
vp
 = 
≠
->
a_vp
;

787 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

788 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

789 
öode
 *
ù
, *
dp
;

790 
îr‹
;

791 
ufs_lookup_ªsu…s
 *
uÃ
;

793 
ù
 = 
	`VTOI
(
vp
);

794 
dp
 = 
	`VTOI
(
dvp
);

797 
uÃ
 = &
dp
->
i_¸≠
;

798 
	`UFS_CHECK_CRAPCOUNTER
(
dp
);

803 i‡(
dp
 =
ù
) {

804 
	`vªÀ
(
dvp
);

805 
	`vput
(
vp
);

806  (
EINVAL
);

815 
îr‹
 = 0;

816 i‡(
ù
->
i_e2fs_∆ök
 != 2 ||

817 !
	`ext2fs_dúem±y
(
ù
, 
dp
->
i_numbî
, 
˙p
->
˙_¸ed
)) {

818 
îr‹
 = 
ENOTEMPTY
;

819 
out
;

821 i‡((
dp
->
i_e2fs_Êags
 & 
EXT2_APPEND
) ||

822 (
ù
->
i_e2fs_Êags
 & (
EXT2_IMMUTABLE
 | 
EXT2_APPEND
))) {

823 
îr‹
 = 
EPERM
;

824 
out
;

831 
îr‹
 = 
	`ext2fs_dúªmove
(
dvp
, 
uÃ
, 
˙p
);

832 i‡(
îr‹
 != 0)

833 
out
;

834 
dp
->
i_e2fs_∆ök
--;

835 
dp
->
i_Êag
 |
IN_CHANGE
;

836 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
 | 
NOTE_LINK
);

837 
	`ˇche_purge
(
dvp
);

838 
	`vput
(
dvp
);

839 
dvp
 = 
NULL
;

851 
ù
->
i_e2fs_∆ök
 -= 2;

852 
îr‹
 = 
	`ext2fs_åunˇã
(
vp
, (
off_t
)0, 
IO_SYNC
, 
˙p
->
˙_¸ed
);

853 
	`ˇche_purge
(
	`ITOV
(
ù
));

854 
out
:

855 
	`VN_KNOTE
(
vp
, 
NOTE_DELETE
);

856 i‡(
dvp
)

857 
	`vput
(
dvp
);

858 
	`vput
(
vp
);

859  (
îr‹
);

860 
	}
}

866 
	$ext2fs_symlök
(*
v
)

868 
v›_symlök_v3_¨gs


874  *
≠
 = 
v
;

875 
vnode
 *
vp
, **
vµ
;

876 
öode
 *
ù
;

877 
Àn
, 
îr‹
;

879 
vµ
 = 
≠
->
a_vµ
;

880 
îr‹
 = 
	`ext2fs_makeöode
(
IFLNK
 | 
≠
->
a_v≠
->
va_mode
,áp->
a_dvp
,

881 
vµ
, 
≠
->
a_˙p
);

882 i‡(
îr‹
)

883  (
îr‹
);

884 
	`VN_KNOTE
(
≠
->
a_dvp
, 
NOTE_WRITE
);

885 
vp
 = *
vµ
;

886 
Àn
 = 
	`°æí
(
≠
->
a_èrgë
);

887 
ù
 = 
	`VTOI
(
vp
);

888 i‡(
Àn
 < 
ù
->
i_ump
->
um_maxsymlökÀn
) {

889 
	`mem˝y
((*)
ù
->
i_dö
.
e2fs_dö
->
e2di_sh‹éök
, 
≠
->
a_èrgë
, 
Àn
);

890 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
Àn
);

891 i‡(
îr‹
)

892 
bad
;

893 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

894 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RELATIME
)

895 
ù
->
i_Êag
 |
IN_ACCESS
;

896 
	`uvm_v≈_£tsize
(
vp
, 
Àn
);

898 
îr‹
 = 
	`ufs_bufio
(
UIO_WRITE
, 
vp
, 
≠
->
a_èrgë
, 
Àn
, (
off_t
)0,

899 
IO_NODELOCKED
, 
≠
->
a_˙p
->
˙_¸ed
, (
size_t
 *)0, 
NULL
);

900 
bad
:

901 
	`VOP_UNLOCK
(
vp
);

902 i‡(
îr‹
)

903 
	`vªÀ
(
vp
);

904  (
îr‹
);

905 
	}
}

911 
	$ext2fs_ªadlök
(*
v
)

913 
v›_ªadlök_¨gs


917  *
≠
 = 
v
;

918 
vnode
 *
vp
 = 
≠
->
a_vp
;

919 
öode
 *
ù
 = 
	`VTOI
(
vp
);

920 
ufsmou¡
 *
ump
 = 
ù
->
i_ump
;

921 
isize
;

923 
isize
 = 
	`ext2fs_size
(
ù
);

924 i‡(
isize
 < 
ump
->
um_maxsymlökÀn
 ||

925 (
ump
->
um_maxsymlökÀn
 =0 && 
	`ext2fs_nblock
(
ù
) == 0)) {

926 
	`uiomove
((*)
ù
->
i_dö
.
e2fs_dö
->
e2di_sh‹éök
, 
isize
, 
≠
->
a_uio
);

929  (
	`UFS_BUFRD
(
vp
, 
≠
->
a_uio
, 0,áp->
a_¸ed
));

930 
	}
}

936 
	$ext2fs_advlock
(*
v
)

938 
v›_advlock_¨gs


944  *
≠
 = 
v
;

945 
öode
 *
ù
 = 
	`VTOI
(
≠
->
a_vp
);

947  
	`lf_advlock
(
≠
, &
ù
->
i_lockf
, 
	`ext2fs_size
(ip));

948 
	}
}

951 
	$ext2fs_fsync
(*
v
)

953 
v›_fsync_¨gs


960  *
≠
 = 
v
;

961 
vnode
 *
vp
 = 
≠
->
a_vp
;

962 
waô
;

963 
îr‹
;

965 
waô
 = (
≠
->
a_Êags
 & 
FSYNC_WAIT
) != 0;

967 i‡(
vp
->
v_ty≥
 =
VBLK
)

968 
îr‹
 = 
	`•ec_fsync
(
v
);

970 
îr‹
 = 
	`vÊushbuf
(
vp
, 
≠
->
a_Êags
);

971 i‡(
îr‹
 =0 && (
≠
->
a_Êags
 & 
FSYNC_DATAONLY
) == 0)

972 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
waô
 ? 
UPDATE_WAIT
 : 0);

974 i‡(
îr‹
 =0 && 
≠
->
a_Êags
 & 
FSYNC_CACHE
) {

975 
l
 = 0;

976 
îr‹
 = 
	`VOP_IOCTL
(
	`VTOI
(
vp
)->
i_devvp
, 
DIOCCACHESYNC
, &
l
, 
FWRITE
,

977 
cuæwp
->
l_¸ed
);

980  
îr‹
;

981 
	}
}

988 
ext2fs_vöô
(
mou¡
 *
m¡p
, (**
•ec›s
)(*),

989 (**
fifo›s
)(*), 
vnode
 **
vµ
)

991 
timevÆ
 
tv
;

992 
öode
 *
ù
;

993 
vnode
 *
vp
;

995 
vp
 = *
vµ
;

996 
ù
 = 
	`VTOI
(
vp
);

997 
vp
->
v_ty≥
 = 
	`IFTOVT
(
ù
->
i_e2fs_mode
)) {

998 
VCHR
:

999 
VBLK
:

1000 
vp
->
v_›
 = 
•ec›s
;

1001 
	`•ec_node_öô
(
vp
, 
	`fs2h32
(
ù
->
i_dö
.
e2fs_dö
->
e2di_rdev
));

1003 
VFIFO
:

1004 
vp
->
v_›
 = 
fifo›s
;

1006 
VNON
:

1007 
VBAD
:

1008 
VSOCK
:

1009 
VLNK
:

1010 
VDIR
:

1011 
VREG
:

1014 i‡(
ù
->
i_numbî
 =
UFS_ROOTINO
)

1015 
vp
->
v_vÊag
 |
VV_ROOT
;

1019 
	`gëmi¸ou±ime
(&
tv
);

1020 
	`SETHIGH
(
ù
->
i_modªv
, 
tv
.
tv_£c
);

1021 
	`SETLOW
(
ù
->
i_modªv
, 
tv
.
tv_u£c
 * 4294);

1022 *
vµ
 = 
vp
;

1024 
	}
}

1030 
	$ext2fs_makeöode
(
mode
, 
vnode
 *
dvp
, vnodê**
vµ
,

1031 
comp⁄íäame
 *
˙p
)

1033 
öode
 *
ù
, *
pdú
;

1034 
vnode
 *
tvp
;

1035 
îr‹
;

1036 
ufs_lookup_ªsu…s
 *
uÃ
;

1038 
pdú
 = 
	`VTOI
(
dvp
);

1041 
uÃ
 = &
pdú
->
i_¸≠
;

1042 
	`UFS_CHECK_CRAPCOUNTER
(
pdú
);

1044 *
vµ
 = 
NULL
;

1045 i‡((
mode
 & 
IFMT
) == 0)

1046 
mode
 |
IFREG
;

1048 i‡((
îr‹
 = 
	`ext2fs_vÆloc
(
dvp
, 
mode
, 
˙p
->
˙_¸ed
, &
tvp
)) != 0) {

1049  (
îr‹
);

1051 
ù
 = 
	`VTOI
(
tvp
);

1052 
ù
->
i_uid
 = 
	`kauth_¸ed_gëeuid
(
˙p
->
˙_¸ed
);

1053 
ù
->
i_e2fs_uid
 = ip->
i_uid
 & 0xffff;

1054 
ù
->
i_e2fs_gid
 = 
pdú
->i_e2fs_gid;

1055 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

1056 
ù
->
i_e2fs_uid_high
 = (ù->
i_uid
 >> 16) & 0xffff;

1057 
ù
->
i_e2fs_gid_high
 = 
pdú
->i_e2fs_gid_high;

1059 
ù
->
i_e2fs_uid_high
 = 0;

1060 
ù
->
i_e2fs_gid_high
 = 0;

1062 
ù
->
i_gid
 = ip->
i_e2fs_gid
 | (ù->
i_e2fs_gid_high
 << 16);

1063 
ù
->
i_Êag
 |
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
;

1064 
ù
->
i_e2fs_mode
 = 
mode
;

1065 
tvp
->
v_ty≥
 = 
	`IFTOVT
(
mode
);

1066 
ù
->
i_e2fs_∆ök
 = 1;

1069 i‡(
ù
->
i_e2fs_mode
 & 
ISGID
) {

1070 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
˙p
->
˙_¸ed
, 
KAUTH_VNODE_WRITE_SECURITY
,

1071 
tvp
, 
NULL
, 
	`gífs_ˇn_chmod
—vp->
v_ty≥
, 
˙p
->
˙_¸ed
, 
ù
->
i_uid
,

1072 
ù
->
i_gid
, 
mode
));

1073 i‡(
îr‹
)

1074 
ù
->
i_e2fs_mode
 &~
ISGID
;

1080 i‡((
îr‹
 = 
	`ext2fs_upd©e
(
tvp
, 
NULL
, NULL, 
UPDATE_WAIT
)) != 0)

1081 
bad
;

1082 
îr‹
 = 
	`ext2fs_dúíãr
(
ù
, 
dvp
, 
uÃ
, 
˙p
);

1083 i‡(
îr‹
 != 0)

1084 
bad
;

1085 *
vµ
 = 
tvp
;

1088 
bad
:

1093 
tvp
->
v_ty≥
 = 
VNON
;

1094 
ù
->
i_e2fs_∆ök
 = 0;

1095 
ù
->
i_Êag
 |
IN_CHANGE
;

1096 
	`vput
(
tvp
);

1097  (
îr‹
);

1098 
	}
}

1104 
	$ext2fs_ª˛aim
(*
v
)

1106 
v›_ª˛aim_¨gs


1108  *
≠
 = 
v
;

1109 
vnode
 *
vp
 = 
≠
->
a_vp
;

1110 
öode
 *
ù
 = 
	`VTOI
(
vp
);

1111 
îr‹
;

1118 i‡(
ù
->
i_omode
 =1 && (
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

1119 
	`ext2fs_v‰ì
(
vp
, 
ù
->
i_numbî
, ip->
i_e2fs_mode
);

1120 i‡((
îr‹
 = 
	`ufs_ª˛aim
(
vp
)) != 0)

1121  (
îr‹
);

1122 i‡(
ù
->
i_dö
.
e2fs_dö
 !
NULL
)

1123 
	`poﬁ_put
(&
ext2fs_döode_poﬁ
, 
ù
->
i_dö
.
e2fs_dö
);

1124 
	`gífs_node_de°roy
(
vp
);

1125 
	`poﬁ_put
(&
ext2fs_öode_poﬁ
, 
vp
->
v_d©a
);

1126 
vp
->
v_d©a
 = 
NULL
;

1128 
	}
}

1131 (**
ext2fs_vnode›_p
)(*);

1132 c⁄° 
vnode›v_íåy_desc
 
ext2fs_vnode›_íåõs
[] = {

1133 { &
v›_deÁu…_desc
, 
vn_deÁu…_îr‹
 },

1134 { &
v›_lookup_desc
, 
ext2fs_lookup
 },

1135 { &
v›_¸óã_desc
, 
ext2fs_¸óã
 },

1136 { &
v›_mknod_desc
, 
ext2fs_mknod
 },

1137 { &
v›_›í_desc
, 
ext2fs_›í
 },

1138 { &
v›_˛o£_desc
, 
ufs_˛o£
 },

1139 { &
v›_ac˚ss_desc
, 
ext2fs_ac˚ss
 },

1140 { &
v›_gë©å_desc
, 
ext2fs_gë©å
 },

1141 { &
v›_£èâr_desc
, 
ext2fs_£èâr
 },

1142 { &
v›_ªad_desc
, 
ext2fs_ªad
 },

1143 { &
v›_wrôe_desc
, 
ext2fs_wrôe
 },

1144 { &
v›_ÁŒoˇã_desc
, 
gífs_e›nŸsuµ
 },

1145 { &
v›_fdisˇrd_desc
, 
gífs_e›nŸsuµ
 },

1146 { &
v›_io˘l_desc
, 
ufs_io˘l
 },

1147 { &
v›_f˙é_desc
, 
ufs_f˙é
 },

1148 { &
v›_pﬁl_desc
, 
ufs_pﬁl
 },

1149 { &
v›_kqfûãr_desc
, 
gífs_kqfûãr
 },

1150 { &
v›_ªvoke_desc
, 
ufs_ªvoke
 },

1151 { &
v›_mm≠_desc
, 
ufs_mm≠
 },

1152 { &
v›_fsync_desc
, 
ext2fs_fsync
 },

1153 { &
v›_£ek_desc
, 
ufs_£ek
 },

1154 { &
v›_ªmove_desc
, 
ext2fs_ªmove
 },

1155 { &
v›_lök_desc
, 
ext2fs_lök
 },

1156 { &
v›_ª«me_desc
, 
ext2fs_ª«me
 },

1157 { &
v›_mkdú_desc
, 
ext2fs_mkdú
 },

1158 { &
v›_rmdú_desc
, 
ext2fs_rmdú
 },

1159 { &
v›_symlök_desc
, 
ext2fs_symlök
 },

1160 { &
v›_ªaddú_desc
, 
ext2fs_ªaddú
 },

1161 { &
v›_ªadlök_desc
, 
ext2fs_ªadlök
 },

1162 { &
v›_ab‹t›_desc
, 
ufs_ab‹t›
 },

1163 { &
v›_öa˘ive_desc
, 
ext2fs_öa˘ive
 },

1164 { &
v›_ª˛aim_desc
, 
ext2fs_ª˛aim
 },

1165 { &
v›_lock_desc
, 
ufs_lock
 },

1166 { &
v›_u∆ock_desc
, 
ufs_u∆ock
 },

1167 { &
v›_bm≠_desc
, 
ext2fs_bm≠
 },

1168 { &
v›_°øãgy_desc
, 
ufs_°øãgy
 },

1169 { &
v›_¥öt_desc
, 
ufs_¥öt
 },

1170 { &
v›_i¶ocked_desc
, 
ufs_i¶ocked
 },

1171 { &
v›_∑thc⁄f_desc
, 
ufs_∑thc⁄f
 },

1172 { &
v›_advlock_desc
, 
ext2fs_advlock
 },

1173 { &
v›_bwrôe_desc
, 
vn_bwrôe
 },

1174 { &
v›_gë∑ges_desc
, 
gífs_gë∑ges
 },

1175 { &
v›_puçages_desc
, 
gífs_puçages
 },

1176 { 
NULL
, NULL }

1177 
	}
};

1178 c⁄° 
vnode›v_desc
 
	gext2fs_vnode›_›v_desc
 =

1179 { &
ext2fs_vnode›_p
, 
ext2fs_vnode›_íåõs
 };

1181 (**
ext2fs_•ec›_p
)(*);

1182 c⁄° 
vnode›v_íåy_desc
 
ext2fs_•ec›_íåõs
[] = {

1183 { &
v›_deÁu…_desc
, 
vn_deÁu…_îr‹
 },

1184 { &
v›_lookup_desc
, 
•ec_lookup
 },

1185 { &
v›_¸óã_desc
, 
•ec_¸óã
 },

1186 { &
v›_mknod_desc
, 
•ec_mknod
 },

1187 { &
v›_›í_desc
, 
•ec_›í
 },

1188 { &
v›_˛o£_desc
, 
ufs•ec_˛o£
 },

1189 { &
v›_ac˚ss_desc
, 
ext2fs_ac˚ss
 },

1190 { &
v›_gë©å_desc
, 
ext2fs_gë©å
 },

1191 { &
v›_£èâr_desc
, 
ext2fs_£èâr
 },

1192 { &
v›_ªad_desc
, 
ufs•ec_ªad
 },

1193 { &
v›_wrôe_desc
, 
ufs•ec_wrôe
 },

1194 { &
v›_ÁŒoˇã_desc
, 
•ec_ÁŒoˇã
 },

1195 { &
v›_fdisˇrd_desc
, 
•ec_fdisˇrd
 },

1196 { &
v›_io˘l_desc
, 
•ec_io˘l
 },

1197 { &
v›_f˙é_desc
, 
ufs_f˙é
 },

1198 { &
v›_pﬁl_desc
, 
•ec_pﬁl
 },

1199 { &
v›_kqfûãr_desc
, 
•ec_kqfûãr
 },

1200 { &
v›_ªvoke_desc
, 
•ec_ªvoke
 },

1201 { &
v›_mm≠_desc
, 
•ec_mm≠
 },

1202 { &
v›_fsync_desc
, 
ext2fs_fsync
 },

1203 { &
v›_£ek_desc
, 
•ec_£ek
 },

1204 { &
v›_ªmove_desc
, 
•ec_ªmove
 },

1205 { &
v›_lök_desc
, 
•ec_lök
 },

1206 { &
v›_ª«me_desc
, 
•ec_ª«me
 },

1207 { &
v›_mkdú_desc
, 
•ec_mkdú
 },

1208 { &
v›_rmdú_desc
, 
•ec_rmdú
 },

1209 { &
v›_symlök_desc
, 
•ec_symlök
 },

1210 { &
v›_ªaddú_desc
, 
•ec_ªaddú
 },

1211 { &
v›_ªadlök_desc
, 
•ec_ªadlök
 },

1212 { &
v›_ab‹t›_desc
, 
•ec_ab‹t›
 },

1213 { &
v›_öa˘ive_desc
, 
ext2fs_öa˘ive
 },

1214 { &
v›_ª˛aim_desc
, 
ext2fs_ª˛aim
 },

1215 { &
v›_lock_desc
, 
ufs_lock
 },

1216 { &
v›_u∆ock_desc
, 
ufs_u∆ock
 },

1217 { &
v›_bm≠_desc
, 
•ec_bm≠
 },

1218 { &
v›_°øãgy_desc
, 
•ec_°øãgy
 },

1219 { &
v›_¥öt_desc
, 
ufs_¥öt
 },

1220 { &
v›_i¶ocked_desc
, 
ufs_i¶ocked
 },

1221 { &
v›_∑thc⁄f_desc
, 
•ec_∑thc⁄f
 },

1222 { &
v›_advlock_desc
, 
•ec_advlock
 },

1223 { &
v›_bwrôe_desc
, 
vn_bwrôe
 },

1224 { &
v›_gë∑ges_desc
, 
•ec_gë∑ges
 },

1225 { &
v›_puçages_desc
, 
•ec_puçages
 },

1226 { 
NULL
, NULL }

1227 
	}
};

1228 c⁄° 
vnode›v_desc
 
	gext2fs_•ec›_›v_desc
 =

1229 { &
ext2fs_•ec›_p
, 
ext2fs_•ec›_íåõs
 };

1231 (**
ext2fs_fifo›_p
)(*);

1232 c⁄° 
vnode›v_íåy_desc
 
ext2fs_fifo›_íåõs
[] = {

1233 { &
v›_deÁu…_desc
, 
vn_deÁu…_îr‹
 },

1234 { &
v›_lookup_desc
, 
vn_fifo_by∑ss
 },

1235 { &
v›_¸óã_desc
, 
vn_fifo_by∑ss
 },

1236 { &
v›_mknod_desc
, 
vn_fifo_by∑ss
 },

1237 { &
v›_›í_desc
, 
vn_fifo_by∑ss
 },

1238 { &
v›_˛o£_desc
, 
ufsfifo_˛o£
 },

1239 { &
v›_ac˚ss_desc
, 
ext2fs_ac˚ss
 },

1240 { &
v›_gë©å_desc
, 
ext2fs_gë©å
 },

1241 { &
v›_£èâr_desc
, 
ext2fs_£èâr
 },

1242 { &
v›_ªad_desc
, 
ufsfifo_ªad
 },

1243 { &
v›_wrôe_desc
, 
ufsfifo_wrôe
 },

1244 { &
v›_ÁŒoˇã_desc
, 
vn_fifo_by∑ss
 },

1245 { &
v›_fdisˇrd_desc
, 
vn_fifo_by∑ss
 },

1246 { &
v›_io˘l_desc
, 
vn_fifo_by∑ss
 },

1247 { &
v›_f˙é_desc
, 
ufs_f˙é
 },

1248 { &
v›_pﬁl_desc
, 
vn_fifo_by∑ss
 },

1249 { &
v›_kqfûãr_desc
, 
vn_fifo_by∑ss
 },

1250 { &
v›_ªvoke_desc
, 
vn_fifo_by∑ss
 },

1251 { &
v›_mm≠_desc
, 
vn_fifo_by∑ss
 },

1252 { &
v›_fsync_desc
, 
ext2fs_fsync
 },

1253 { &
v›_£ek_desc
, 
vn_fifo_by∑ss
 },

1254 { &
v›_ªmove_desc
, 
vn_fifo_by∑ss
 },

1255 { &
v›_lök_desc
, 
vn_fifo_by∑ss
 },

1256 { &
v›_ª«me_desc
, 
vn_fifo_by∑ss
 },

1257 { &
v›_mkdú_desc
, 
vn_fifo_by∑ss
 },

1258 { &
v›_rmdú_desc
, 
vn_fifo_by∑ss
 },

1259 { &
v›_symlök_desc
, 
vn_fifo_by∑ss
 },

1260 { &
v›_ªaddú_desc
, 
vn_fifo_by∑ss
 },

1261 { &
v›_ªadlök_desc
, 
vn_fifo_by∑ss
 },

1262 { &
v›_ab‹t›_desc
, 
vn_fifo_by∑ss
 },

1263 { &
v›_öa˘ive_desc
, 
ext2fs_öa˘ive
 },

1264 { &
v›_ª˛aim_desc
, 
ext2fs_ª˛aim
 },

1265 { &
v›_lock_desc
, 
ufs_lock
 },

1266 { &
v›_u∆ock_desc
, 
ufs_u∆ock
 },

1267 { &
v›_bm≠_desc
, 
vn_fifo_by∑ss
 },

1268 { &
v›_°øãgy_desc
, 
vn_fifo_by∑ss
 },

1269 { &
v›_¥öt_desc
, 
ufs_¥öt
 },

1270 { &
v›_i¶ocked_desc
, 
ufs_i¶ocked
 },

1271 { &
v›_∑thc⁄f_desc
, 
vn_fifo_by∑ss
 },

1272 { &
v›_advlock_desc
, 
vn_fifo_by∑ss
 },

1273 { &
v›_bwrôe_desc
, 
vn_bwrôe
 },

1274 { &
v›_puçages_desc
, 
vn_fifo_by∑ss
 },

1275 { 
NULL
, NULL }

1276 
	}
};

1277 c⁄° 
vnode›v_desc
 
	gext2fs_fifo›_›v_desc
 =

1278 { &
ext2fs_fifo›_p
, 
ext2fs_fifo›_íåõs
 };

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


30 
	#__√ed_size_t


	)

31 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

35 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

43 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

46 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

47 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

65 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

69 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

74 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

77 #ifde‡
__OPTIMIZE__


78 
__exã∫_Æways_ölöe
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


81  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

84 
__exã∫_Æways_ölöe
 const *

85 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


87  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifde‡
__USE_GNU


100 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

103 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

106 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

107 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

114 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

117 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

126 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

128 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

129 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

133 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

134 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

136 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

137 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

140 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

141 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

143 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

150 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

151 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

152 
__THROW
 
	`__n⁄nuŒ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifde‡
__USE_XOPEN2K8


159 
	~<xloˇÀ.h
>

162 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

163 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

165 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

166 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

169 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8


171 *
	$°rdup
 (c⁄° *
__s
)

172 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

178 #i‡
deföed
 
__USE_XOPEN2K8


179 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

180 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

183 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


185 
	#°rdu∑
(
s
) \

186 (
__exãnsi⁄__
 \

188 c⁄° *
__ﬁd
 = (
s
); \

189 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

190 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

191 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

192 
	}
}))

	)

195 
	#°∫du∑
(
s
, 
n
) \

196 (
__exãnsi⁄__
 \

198 c⁄° *
__ﬁd
 = (
s
); \

199 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

200 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

201 
__√w
[
__Àn
] = '\0'; \

202 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
°rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

213 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

216 #ifde‡
__OPTIMIZE__


217 
__exã∫_Æways_ölöe
 *

218 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


220  
__buûtö_°rchr
 (
__s
, 
__c
);

223 
__exã∫_Æways_ölöe
 const *

224 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


226  
__buûtö_°rchr
 (
__s
, 
__c
);

231 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

232 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

235 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`°ºchr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

240 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

243 #ifde‡
__OPTIMIZE__


244 
__exã∫_Æways_ölöe
 *

245 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


247  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

250 
__exã∫_Æways_ölöe
 const *

251 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


253  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

259 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifde‡
__USE_GNU


266 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

269 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

272 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

273 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

281 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

284 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

285 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

287 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

291 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

292 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

293 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

295 #ifde‡
__OPTIMIZE__


296 
__exã∫_Æways_ölöe
 *

297 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


299  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

302 
__exã∫_Æways_ölöe
 const *

303 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


305  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

308 
	}
}

310 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

311 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

314 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

318 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

319 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

320 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

322 #ifde‡
__OPTIMIZE__


323 
__exã∫_Æways_ölöe
 *

324 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


326  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

329 
__exã∫_Æways_ölöe
 const *

330 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


332  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

335 
	}
}

337 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

338 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

343 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

344 
__THROW
 
	`__n⁄nuŒ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

350 c⁄° *
__ª°ri˘
 
__dñim
,

351 **
__ª°ri˘
 
__ßve_±r
)

352 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

353 #ifde‡
__USE_POSIX


354 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

355 **
__ª°ri˘
 
__ßve_±r
)

356 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

359 #ifde‡
__USE_GNU


361 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

363 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

364 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

365 c⁄° *
__√edÀ
)

366 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

368 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

369 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

373 #ifde‡
__USE_GNU


377 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

378 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

379 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

383 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

384 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

385 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

386 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

387 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

388 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$°æí
 (c⁄° *
__s
)

395 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

402 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifde‡
__USE_XOPEN2K


418 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


421 #ifde‡
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

423 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

424 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

426 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

427 
__THROW
 
	`__n⁄nuŒ
 ((2));

428 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

433 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

434 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

438 #ifde‡
__USE_XOPEN2K8


440 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

446 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

448 #ifde‡
__USE_MISC


450 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

451 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

454 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

457 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

461 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`ödex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

466 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

469 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__exã∫_Æways_ölöe
 *

471 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


473  
	`__buûtö_ödex
 (
__s
, 
__c
);

476 
__exã∫_Æways_ölöe
 const *

477 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


479  
	`__buûtö_ödex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$ödex
 (c⁄° *
__s
, 
__c
)

485 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

489 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`rödex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

494 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

497 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__exã∫_Æways_ölöe
 *

499 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


501  
	`__buûtö_rödex
 (
__s
, 
__c
);

504 
__exã∫_Æways_ölöe
 const *

505 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


507  
	`__buûtö_rödex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$rödex
 (c⁄° *
__s
, 
__c
)

513 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

518 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

522 #ifdef 
__USE_GNU


523 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

524 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

525 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

529 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

530 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

533 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

541 
__loˇÀ_t
 
__loc
)

542 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

544 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

545 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

546 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

553 c⁄° *
__ª°ri˘
 
__dñim
)

554 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

562 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

563 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

564 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

565 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

569 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

570 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

571 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

572 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

573 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

574 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

580 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

583 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

586 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

588 #i‚de‡
ba£«me


593 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£«me
 (*
__fûíame
)

595 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

596 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

597 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

599 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

605 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

606 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

607 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


627 
	~<bôs/°rög.h
>

630 
	~<bôs/°rög2.h
>

633 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


635 
	~<bôs/°rög3.h
>

639 #i‡
deföed
 
__USE_GNU
 && deföed 
__OPTIMIZE__
 \

640 && 
deföed
 
__exã∫_Æways_ölöe
 && 
	$__GNUC_PREREQ
 (3,2)

641 #i‡!
deföed
 
_FORCE_INLINES
 && !deföed 
_HAVE_STRING_ARCH_memp˝y


643 #unde‡
memp˝y


644 #unde‡
__memp˝y


645 
	#memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

646 
	#__memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

648 
__exã∫_Æways_ölöe
 *

649 
	$__memp˝y_ölöe
 (*
__ª°ri˘
 
__de°
,

650 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

652  (*Ë
	`mem˝y
 (
__de°
, 
__§c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #unde‡
__USE_ISOC11


98 #unde‡
__USE_ISOC99


99 #unde‡
__USE_ISOC95


100 #unde‡
__USE_ISOCXX11


101 #unde‡
__USE_POSIX


102 #unde‡
__USE_POSIX2


103 #unde‡
__USE_POSIX199309


104 #unde‡
__USE_POSIX199506


105 #unde‡
__USE_XOPEN


106 #unde‡
__USE_XOPEN_EXTENDED


107 #unde‡
__USE_UNIX98


108 #unde‡
__USE_XOPEN2K


109 #unde‡
__USE_XOPEN2KXSI


110 #unde‡
__USE_XOPEN2K8


111 #unde‡
__USE_XOPEN2K8XSI


112 #unde‡
__USE_LARGEFILE


113 #unde‡
__USE_LARGEFILE64


114 #unde‡
__USE_FILE_OFFSET64


115 #unde‡
__USE_MISC


116 #unde‡
__USE_ATFILE


117 #unde‡
__USE_GNU


118 #unde‡
__USE_REENTRANT


119 #unde‡
__USE_FORTIFY_LEVEL


120 #unde‡
__KERNEL_STRICT_NAMES


124 #i‚de‡
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

137 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

146 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

147 && !
deföed
 
	g_DEFAULT_SOURCE


152 #unde‡
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifde‡
_GNU_SOURCE


158 #unde‡
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #unde‡
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #unde‡
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #unde‡
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #unde‡
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #unde‡
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #unde‡
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #unde‡
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #unde‡
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #unde‡
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

183 || (!
deföed
 
	g__STRICT_ANSI__
 \

184 && !
deföed
 
	g_ISOC99_SOURCE
 \

185 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

186 && !
deföed
 
	g_XOPEN_SOURCE
))

187 #unde‡
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #i‡(
deföed
 
_ISOC11_SOURCE
 \

193 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

199 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

205 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

214 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifde‡
_DEFAULT_SOURCE


222 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #unde‡
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #unde‡
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #i‡((!
deföed
 
__STRICT_ANSI__
 \

231 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #i‡(
deföed
 
_POSIX_SOURCE
 \

247 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
deföed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #unde‡
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #unde‡
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #unde‡
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #unde‡
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

286 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #unde‡
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #unde‡
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifde‡
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifde‡
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifde‡
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #i‡
deföed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #i‡
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #i‡
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<°dc-¥edef.h
>

353 #unde‡
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

362 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

365 #i‚de‡
__ASSEMBLER__


366 #i‚de‡
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

381 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

382 && 
deföed
 
	g__exã∫_ölöe


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/°ubs.h
>

	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
21
355
ext2fs.h
ext2fs_alloc.c
ext2fs_balloc.c
ext2fs_bmap.c
ext2fs_bswap.c
ext2fs_dinode.h
ext2fs_dir.h
ext2fs_extents.c
ext2fs_extents.h
ext2fs_extern.h
ext2fs_inode.c
ext2fs_lookup.c
ext2fs_readwrite.c
ext2fs_rename.c
ext2fs_subr.c
ext2fs_vfsops.c
ext2fs_vnops.c
/usr/include/string.h
/usr/include/features.h
/usr/include/xlocale.h
/usr/include/stdc-predef.h

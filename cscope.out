cscope 15 $HOME/netbsd/src/sys/ufs/ext2fs               0000199750
	@ext2fs.h

62 
	#fsbtodb
(
fs
, 
b
Ë((
daddr_t
)(bË<< (fs)->
e2fs_fsbtodb
)

	)

63 
	#lblkno
(
fs
, 
loc
) \

64 ((
loc
Ë>> (
fs
->
e2fs_bshi·
))

	)

65 
	#blksize
(
fs
, 
ù
, 
lbn
Ë((fs)->
e2fs_bsize
)

	)

67 #i‚de‡
_UFS_EXT2FS_EXT2FS_H_


68 
	#_UFS_EXT2FS_EXT2FS_H_


	)

70 
	~<sys/bsw≠.h
>

87 
	#BBSIZE
 1024

	)

88 
	#SBSIZE
 1024

	)

89 
	#BBOFF
 ((
off_t
)(0))

	)

90 
	#SBOFF
 ((
off_t
)(
BBOFF
 + 
BBSIZE
))

	)

91 
	#BBLOCK
 ((
daddr_t
)(0))

	)

92 
	#SBLOCK
 ((
daddr_t
)(
BBLOCK
 + 
BBSIZE
 / 
DEV_BSIZE
))

	)

106 
	#LOG_MINBSIZE
 10

	)

107 
	#MINBSIZE
 (1 << 
LOG_MINBSIZE
)

	)

114 
	#MAXMNTLEN
 512

	)

128 
	#MINFREE
 5

	)

133 
	sext2fs
 {

134 
uöt32_t
 
	me2fs_icou¡
;

135 
uöt32_t
 
	me2fs_bcou¡
;

136 
uöt32_t
 
	me2fs_rbcou¡
;

137 
uöt32_t
 
	me2fs_fbcou¡
;

138 
uöt32_t
 
	me2fs_ficou¡
;

139 
uöt32_t
 
	me2fs_fú°_dblock
;

140 
uöt32_t
 
	me2fs_log_bsize
;

141 
uöt32_t
 
	me2fs_fsize
;

142 
uöt32_t
 
	me2fs_bpg
;

143 
uöt32_t
 
	me2fs_Âg
;

144 
uöt32_t
 
	me2fs_ùg
;

145 
uöt32_t
 
	me2fs_mtime
;

146 
uöt32_t
 
	me2fs_wtime
;

147 
uöt16_t
 
	me2fs_m¡_cou¡
;

148 
uöt16_t
 
	me2fs_max_m¡_cou¡
;

149 
uöt16_t
 
	me2fs_magic
;

150 
uöt16_t
 
	me2fs_°©e
;

151 
uöt16_t
 
	me2fs_beh
;

152 
uöt16_t
 
	me2fs_möªv
;

153 
uöt32_t
 
	me2fs_œ°fsck
;

154 
uöt32_t
 
	me2fs_fsckötv
;

155 
uöt32_t
 
	me2fs_¸ót‹
;

156 
uöt32_t
 
	me2fs_ªv
;

157 
uöt16_t
 
	me2fs_ruid
;

158 
uöt16_t
 
	me2fs_rgid
;

160 
uöt32_t
 
	me2fs_fú°_öo
;

161 
uöt16_t
 
	me2fs_öode_size
;

162 
uöt16_t
 
	me2fs_block_group_ƒ
;

163 
uöt32_t
 
	me2fs_„©uªs_com∑t
;

164 
uöt32_t
 
	me2fs_„©uªs_öcom∑t
;

165 
uöt32_t
 
	me2fs_„©uªs_rocom∑t
;

166 
uöt8_t
 
	me2fs_uuid
[16];

167 
	me2fs_v«me
[16];

168 
	me2fs_fsm¡
[64];

169 
uöt32_t
 
	me2fs_Ægo
;

170 
uöt8_t
 
	me2fs_¥óŒoc
;

171 
uöt8_t
 
	me2fs_dú_¥óŒoc
;

172 
uöt16_t
 
	me2fs_ª£rved_ngdb
;

176 
	me3fs_jou∫Æ_uuid
[16];

177 
uöt32_t
 
	me3fs_jou∫Æ_öum
;

178 
uöt32_t
 
	me3fs_jou∫Æ_dev
;

179 
uöt32_t
 
	me3fs_œ°_‹ph™
;

180 
uöt32_t
 
	me3fs_hash_£ed
[4];

181 
	me3fs_def_hash_vîsi⁄
;

182 
	me3fs_j∆_backup_ty≥
;

183 
uöt16_t
 
	me3fs_desc_size
;

184 
uöt32_t
 
	me3fs_deÁu…_mou¡_›ts
;

185 
uöt32_t
 
	me3fs_fú°_mëa_bg
;

186 
uöt32_t
 
	me3fs_mkfs_time
;

187 
uöt32_t
 
	me3fs_j∆_blks
[17];

188 
uöt32_t
 
	me4fs_bcou¡_hi
;

189 
uöt32_t
 
	me4fs_rbcou¡_hi
;

190 
uöt32_t
 
	me4fs_fbcou¡_hi
;

191 
uöt16_t
 
	me4fs_mö_exåa_isize
;

192 
uöt16_t
 
	me4fs_w™t_exåa_isize
;

193 
uöt32_t
 
	me4fs_Êags
;

194 
uöt16_t
 
	me4fs_øid_°ride
;

195 
uöt16_t
 
	me4fs_mmpötv
;

196 
uöt64_t
 
	me4fs_mmpblk
;

197 
uöt32_t
 
	me4fs_øid_°rùe_wid
;

198 
uöt8_t
 
	me4fs_log_gpf
;

199 
uöt8_t
 
	me4fs_chksum_ty≥
;

200 
uöt8_t
 
	me4fs_í¸y±
;

201 
uöt8_t
 
	me4fs_ª£rved_∑d
;

202 
uöt64_t
 
	me4fs_kbyãs_wrôãn
;

203 
uöt32_t
 
	me4fs_¢≠öum
;

204 
uöt32_t
 
	me4fs_¢≠id
;

205 
uöt64_t
 
	me4fs_¢≠rbcou¡
;

206 
uöt32_t
 
	me4fs_¢≠li°
;

207 
uöt32_t
 
	me4fs_îrcou¡
;

208 
uöt32_t
 
	me4fs_fú°_îπime
;

209 
uöt32_t
 
	me4fs_fú°_îröo
;

210 
uöt64_t
 
	me4fs_fú°_îrblk
;

211 
uöt8_t
 
	me4fs_fú°_îrfunc
[32];

212 
uöt32_t
 
	me4fs_fú°_îæöe
;

213 
uöt32_t
 
	me4fs_œ°_îπime
;

214 
uöt32_t
 
	me4fs_œ°_îröo
;

215 
uöt32_t
 
	me4fs_œ°_îæöe
;

216 
uöt64_t
 
	me4fs_œ°_îrblk
;

217 
uöt8_t
 
	me4fs_œ°_îrfunc
[32];

218 
uöt8_t
 
	me4fs_mou¡_›ts
[64];

219 
uöt32_t
 
	me4fs_u§quŸa_öum
;

220 
uöt32_t
 
	me4fs_gΩquŸa_öum
;

221 
uöt32_t
 
	me4fs_ovîhód_˛u°îs
;

222 
uöt32_t
 
	me4fs_backup_bgs
[2];

223 
uöt8_t
 
	me4fs_í¸y±_Ægos
[4];

224 
uöt8_t
 
	me4fs_í¸y±_pw_ß…
[16];

225 
uöt32_t
 
	me4fs_Õf_öo
;

226 
uöt32_t
 
	me4fs_¥oj_quŸa_öum
;

227 
uöt32_t
 
	me4fs_chksum_£ed
;

228 
uöt32_t
 
	me4fs_ª£rved
[98];

229 
uöt32_t
 
	me4fs_sbchksum
;

234 
	sm_ext2fs
 {

235 
ext2fs
 
	me2fs
;

236 
u_ch¨
 
	me2fs_fsm¡
[
MAXMNTLEN
];

237 
öt8_t
 
	me2fs_r⁄ly
;

238 
öt8_t
 
	me2fs_fmod
;

239 
öt32_t
 
	me2fs_bsize
;

240 
öt32_t
 
	me2fs_bshi·
;

241 
öt32_t
 
	me2fs_bmask
;

242 
öt64_t
 
	me2fs_qbmask
;

243 
öt32_t
 
	me2fs_fsbtodb
;

244 
öt32_t
 
	me2fs_ncg
;

245 
öt32_t
 
	me2fs_ngdb
;

246 
öt32_t
 
	me2fs_ùb
;

247 
öt32_t
 
	me2fs_ôpg
;

248 
ext2_gd
 *
	me2fs_gd
;

256 
	#E2FS_MAGIC
 0xef53

	)

257 
	#E2FS_REV0
 0

	)

258 
	#E2FS_REV1
 1

	)

261 
	#EXT2F_COMPAT_PREALLOC
 0x0001

	)

262 
	#EXT2F_COMPAT_AFS
 0x0002

	)

263 
	#EXT2F_COMPAT_HASJOURNAL
 0x0004

	)

264 
	#EXT2F_COMPAT_EXTATTR
 0x0008

	)

265 
	#EXT2F_COMPAT_RESIZE
 0x0010

	)

266 
	#EXT2F_COMPAT_DIRHASHINDEX
 0x0020

	)

267 
	#EXT2F_COMPAT_BITS
 \

274 "\01COMPAT_PREALLOC"

	)

276 
	#EXT2F_ROCOMPAT_SPARSESUPER
 0x0001

	)

277 
	#EXT2F_ROCOMPAT_LARGEFILE
 0x0002

	)

278 
	#EXT2F_ROCOMPAT_BTREE_DIR
 0x0004

	)

279 
	#EXT2F_ROCOMPAT_HUGE_FILE
 0x0008

	)

280 
	#EXT2F_ROCOMPAT_GDT_CSUM
 0x0010

	)

281 
	#EXT2F_ROCOMPAT_DIR_NLINK
 0x0020

	)

282 
	#EXT2F_ROCOMPAT_EXTRA_ISIZE
 0x0040

	)

283 
	#EXT2F_ROCOMPAT_BITS
 \

291 "\01ROCOMPAT_SPARSESUPER"

	)

293 
	#EXT2F_INCOMPAT_COMP
 0x0001

	)

294 
	#EXT2F_INCOMPAT_FTYPE
 0x0002

	)

295 
	#EXT2F_INCOMPAT_REPLAY_JOURNAL
 0x0004

	)

296 
	#EXT2F_INCOMPAT_USES_JOURNAL
 0x0008

	)

297 
	#EXT2F_INCOMPAT_META_BG
 0x0010

	)

298 
	#EXT2F_INCOMPAT_EXTENTS
 0x0040

	)

299 
	#EXT2F_INCOMPAT_64BIT
 0x0080

	)

300 
	#EXT2F_INCOMPAT_MMP
 0x0100

	)

301 
	#EXT2F_INCOMPAT_FLEX_BG
 0x0200

	)

302 
	#EXT2F_INCOMPAT_BITS
 \

312 "\01INCOMPAT_COMP"

	)

327 
	#EXT2F_COMPAT_SUPP
 0x0000

	)

328 
	#EXT2F_ROCOMPAT_SUPP
 (
EXT2F_ROCOMPAT_SPARSESUPER
 \

329 | 
EXT2F_ROCOMPAT_LARGEFILE
 \

330 | 
EXT2F_ROCOMPAT_HUGE_FILE
)

	)

333 
	#EXT2F_INCOMPAT_SUPP
 (
EXT2F_INCOMPAT_FTYPE
 | 
EXT2F_INCOMPAT_EXTENTS
 )

	)

340 
	#E2FS_BEH_CONTINUE
 1

	)

341 
	#E2FS_BEH_READONLY
 2

	)

342 
	#E2FS_BEH_PANIC
 3

	)

343 
	#E2FS_BEH_DEFAULT
 
E2FS_BEH_CONTINUE


	)

348 
	#E2FS_OS_LINUX
 0

	)

349 
	#E2FS_OS_HURD
 1

	)

350 
	#E2FS_OS_MASIX
 2

	)

351 
	#E2FS_OS_FREEBSD
 3

	)

352 
	#E2FS_OS_LITES
 4

	)

357 
	#E2FS_ISCLEAN
 0x01

	)

358 
	#E2FS_ERRORS
 0x02

	)

362 
	sext2_gd
 {

363 
uöt32_t
 
	mext2bgd_b_bôm≠
;

364 
uöt32_t
 
	mext2bgd_i_bôm≠
;

365 
uöt32_t
 
	mext2bgd_i_èbÀs
;

366 
uöt16_t
 
	mext2bgd_nb‰ì
;

367 
uöt16_t
 
	mext2bgd_ni‰ì
;

368 
uöt16_t
 
	mext2bgd_ndús
;

369 
uöt16_t
 
	mª£rved
;

370 
uöt32_t
 
	mª£rved2
[3];

380 
__ölöe
 
	$cg_has_sb
(Ë
__unu£d
;

381 
__ölöe
 

382 
	$cg_has_sb
(
i
)

384 
a3
, 
a5
, 
a7
;

386 i‡(
i
 == 0 || i == 1)

388 
a3
 = 3, 
a5
 = 5, 
a7
 = 7;

389 
a3
 <
i
 || 
a5
 <ò|| 
a7
 <= i;

390 
a3
 *3, 
a5
 *5, 
a7
 *= 7)

391 i‡(
i
 =
a3
 || i =
a5
 || i =
a7
)

394 
	}
}

400 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


401 
	#h2fs16
(
x
Ë(x)

	)

402 
	#h2fs32
(
x
Ë(x)

	)

403 
	#h2fs64
(
x
Ë(x)

	)

404 
	#fs2h16
(
x
Ë(x)

	)

405 
	#fs2h32
(
x
Ë(x)

	)

406 
	#fs2h64
(
x
Ë(x)

	)

407 
	#e2fs_sblﬂd
(
ﬁd
, 
√w
Ë
	`mem˝y
(“ew), (ﬁd), 
SBSIZE
);

	)

408 
	#e2fs_cglﬂd
(
ﬁd
, 
√w
, 
size
Ë
	`mem˝y
(“ew), (ﬁd), (size));

	)

409 
	#e2fs_sbßve
(
ﬁd
, 
√w
Ë
	`mem˝y
(“ew), (ﬁd), 
SBSIZE
);

	)

410 
	#e2fs_cgßve
(
ﬁd
, 
√w
, 
size
Ë
	`mem˝y
(“ew), (ﬁd), (size));

	)

412 
e2fs_sb_bsw≠
(
ext2fs
 *, ext2fs *);

413 
e2fs_cg_bsw≠
(
ext2_gd
 *, ext2_gd *, );

414 
	#h2fs16
(
x
Ë
	`bsw≠16
(x)

	)

415 
	#h2fs32
(
x
Ë
	`bsw≠32
(x)

	)

416 
	#h2fs64
(
x
Ë
	`bsw≠64
(x)

	)

417 
	#fs2h16
(
x
Ë
	`bsw≠16
(x)

	)

418 
	#fs2h32
(
x
Ë
	`bsw≠32
(x)

	)

419 
	#fs2h64
(
x
Ë
	`bsw≠64
(x)

	)

420 
	#e2fs_sblﬂd
(
ﬁd
, 
√w
Ë
	`e2fs_sb_bsw≠
((ﬁd), (√w))

	)

421 
	#e2fs_cglﬂd
(
ﬁd
, 
√w
, 
size
Ë
	`e2fs_cg_bsw≠
((ﬁd), (√w), (size));

	)

422 
	#e2fs_sbßve
(
ﬁd
, 
√w
Ë
	`e2fs_sb_bsw≠
((ﬁd), (√w))

	)

423 
	#e2fs_cgßve
(
ﬁd
, 
√w
, 
size
Ë
	`e2fs_cg_bsw≠
((ﬁd), (√w), (size));

	)

430 
	#EXT2_FSBTODB
(
fs
, 
b
Ë((bË<< (fs)->
e2fs_fsbtodb
)

	)

431 
	#EXT2_DBTOFSB
(
fs
, 
b
Ë((bË>> (fs)->
e2fs_fsbtodb
)

	)

439 
	#öo_to_cg
(
fs
, 
x
Ë(((xË- 1Ë/ (fs)->
e2fs
.
e2fs_ùg
)

	)

440 
	#öo_to_fsba
(
fs
, 
x
) \

441 ((
fs
)->
e2fs_gd
[
	`öo_to_cg
((fs), (
x
))].
ext2bgd_i_èbÀs
 + \

442 (((
x
Ë- 1Ë% (
fs
)->
e2fs
.
e2fs_ùg
Ë/ (fs)->
e2fs_ùb
)

	)

443 
	#öo_to_fsbo
(
fs
, 
x
Ë(((xË- 1Ë% (fs)->
e2fs_ùb
)

	)

449 
	#dtog
(
fs
, 
d
Ë(((dË- (fs)->
e2fs
.
e2fs_fú°_dblock
Ë/ (fs)->e2fs.
e2fs_Âg
)

	)

450 
	#dtogd
(
fs
, 
d
) \

451 (((
d
Ë- (
fs
)->
e2fs
.
e2fs_fú°_dblock
Ë% (fs)->e2fs.
e2fs_Âg
)

	)

458 
	#ext2_blkoff
(
fs
, 
loc
) \

459 ((
loc
Ë& (
fs
)->
e2fs_qbmask
)

	)

460 
	#ext2_lblktosize
(
fs
, 
blk
) \

461 ((
blk
Ë<< (
fs
)->
e2fs_bshi·
)

	)

462 
	#ext2_lblkno
(
fs
, 
loc
) \

463 ((
loc
Ë>> (
fs
)->
e2fs_bshi·
)

	)

464 
	#ext2_blkroundup
(
fs
, 
size
) \

465 (((
size
Ë+ (
fs
)->
e2fs_qbmask
Ë& (fs)->
e2fs_bmask
)

	)

466 
	#ext2_‰agroundup
(
fs
, 
size
) \

467 (((
size
Ë+ (
fs
)->
e2fs_qbmask
Ë& (fs)->
e2fs_bmask
)

	)

472 
	#‰ì•a˚
(
fs
) \

473 ((
fs
)->
e2fs
.
e2fs_fbcou¡
 - (fs)->e2fs.
e2fs_rbcou¡
)

	)

478 
	#EXT2_NINDIR
(
fs
Ë((fs)->
e2fs_bsize
 / (
uöt32_t
))

	)

	@ext2fs_alloc.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_alloc.c,v 1.46 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/buf.h
>

68 
	~<sys/¥oc.h
>

69 
	~<sys/vnode.h
>

70 
	~<sys/mou¡.h
>

71 
	~<sys/kî√l.h
>

72 
	~<sys/sy¶og.h
>

73 
	~<sys/kauth.h
>

75 
	~<ufs/ufs/öode.h
>

76 
	~<ufs/ufs/ufs_exã∫.h
>

77 
	~<ufs/ufs/ufsmou¡.h
>

79 
	~<ufs/ext2fs/ext2fs.h
>

80 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

82 
u_l⁄g
 
	gext2gínumbî
;

84 
daddr_t
 
ext2fs_Æloccg
(
öode
 *, , daddr_t, );

85 
u_l⁄g
 
ext2fs_dú¥ef
(
m_ext2fs
 *);

86 
ext2fs_f£º
(
m_ext2fs
 *, 
u_öt
, const *);

87 
u_l⁄g
 
ext2fs_hashÆloc
(
öode
 *, , , ,

88 
	$daddr_t
 (*)(
öode
 *, , 
daddr_t
, ));

89 
daddr_t
 
	`ext2fs_nodóŒoccg
(
öode
 *, , daddr_t, );

90 
daddr_t
 
	`ext2fs_m≠£¨ch
(
m_ext2fs
 *, *, daddr_t);

110 
	$ext2fs_Æloc
(
öode
 *
ù
, 
daddr_t
 
lbn
, daddr_à
b¥ef
,

111 
kauth_¸ed_t
 
¸ed
, 
daddr_t
 *
b≈
)

113 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

114 
m_ext2fs
 *
fs
;

115 
daddr_t
 
bno
;

116 
cg
;

118 *
b≈
 = 0;

119 
fs
 = 
ù
->
i_e2fs
;

120 #ifde‡
DIAGNOSTIC


121 i‡(
¸ed
 =
NOCRED
)

122 
	`∑nic
("ext2fs_alloc: missing credential");

124 i‡(
fs
->
e2fs
.
e2fs_fbcou¡
 == 0)

125 
no•a˚
;

126 i‡(
	`kauth_auth‹ize_sy°em
(
¸ed
, 
KAUTH_SYSTEM_FS_RESERVEDSPACE
, 0, 
NULL
,

127 
NULL
, NULL) != 0 &&

128 
	`‰ì•a˚
(
fs
) <= 0)

129 
no•a˚
;

130 i‡(
b¥ef
 >
fs
->
e2fs
.
e2fs_bcou¡
)

131 
b¥ef
 = 0;

132 i‡(
b¥ef
 == 0)

133 
cg
 = 
	`öo_to_cg
(
fs
, 
ù
->
i_numbî
);

135 
cg
 = 
	`dtog
(
fs
, 
b¥ef
);

136 
bno
 = (
daddr_t
)
	`ext2fs_hashÆloc
(
ù
, 
cg
, 
b¥ef
, 
fs
->
e2fs_bsize
,

137 
ext2fs_Æloccg
);

138 i‡(
bno
 > 0) {

139 
	`ext2fs_£äblock
(
ù
, 
	`ext2fs_nblock
(ùË+ 
	`btodb
(
fs
->
e2fs_bsize
));

140 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

141 *
b≈
 = 
bno
;

144 
no•a˚
:

145 
	`ext2fs_f£º
(
fs
, 
	`kauth_¸ed_gëeuid
(
¸ed
), "file system full");

146 
	`u¥ötf
("\n%s: wrôêÁûed, fûêsy°em i†fuŒ\n", 
fs
->
e2fs_fsm¡
);

147  (
ENOSPC
);

148 
	}
}

166 
	$ext2fs_vÆloc
(
vnode
 *
pvp
, 
mode
, 
kauth_¸ed_t
 
¸ed
,

167 
vnode
 **
vµ
)

169 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

170 
öode
 *
pù
;

171 
m_ext2fs
 *
fs
;

172 
öode
 *
ù
;

173 
öo_t
 
öo
, 
ùªf
;

174 
cg
, 
îr‹
;

176 *
vµ
 = 
NULL
;

177 
pù
 = 
	`VTOI
(
pvp
);

178 
fs
 = 
pù
->
i_e2fs
;

179 i‡(
fs
->
e2fs
.
e2fs_ficou¡
 == 0)

180 
noöodes
;

182 i‡((
mode
 & 
IFMT
Ë=
IFDIR
)

183 
cg
 = 
	`ext2fs_dú¥ef
(
fs
);

185 
cg
 = 
	`öo_to_cg
(
fs
, 
pù
->
i_numbî
);

186 
ùªf
 = 
cg
 * 
fs
->
e2fs
.
e2fs_ùg
 + 1;

187 
öo
 = (
öo_t
)
	`ext2fs_hashÆloc
(
pù
, 
cg
, ()
ùªf
, 
mode
, 
ext2fs_nodóŒoccg
);

188 i‡(
öo
 == 0)

189 
noöodes
;

190 
îr‹
 = 
	`VFS_VGET
(
pvp
->
v_mou¡
, 
öo
, 
vµ
);

191 i‡(
îr‹
) {

192 
	`ext2fs_v‰ì
(
pvp
, 
öo
, 
mode
);

193  (
îr‹
);

195 
ù
 = 
	`VTOI
(*
vµ
);

196 i‡(
ù
->
i_e2fs_mode
 && ip->
i_e2fs_∆ök
 != 0) {

197 
	`¥ötf
("mode = 0%o,Çlinks %d, inum = %llu, fs = %s\n",

198 
ù
->
i_e2fs_mode
, ip->
i_e2fs_∆ök
,

199 ()
ù
->
i_numbî
, 
fs
->
e2fs_fsm¡
);

200 
	`∑nic
("ext2fs_valloc: dupálloc");

203 
	`mem£t
(
ù
->
i_dö
.
e2fs_dö
, 0, (
ext2fs_döode
));

208 i‡(++
ext2gínumbî
 < 
time_£c⁄d
)

209 
ext2gínumbî
 = 
time_£c⁄d
;

210 
ù
->
i_e2fs_gí
 = 
ext2gínumbî
;

212 
noöodes
:

213 
	`ext2fs_f£º
(
fs
, 
	`kauth_¸ed_gëeuid
(
¸ed
), "out of inodes");

214 
	`u¥ötf
("\n%s: cª©e/symlök faûed,Çÿöode†‰ì\n", 
fs
->
e2fs_fsm¡
);

215  (
ENOSPC
);

216 
	}
}

225 
u_l⁄g


226 
	$ext2fs_dú¥ef
(
m_ext2fs
 *
fs
)

228 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

229 
cg
, 
max•a˚
, 
möcg
, 
avgi‰ì
;

231 
avgi‰ì
 = 
fs
->
e2fs
.
e2fs_ficou¡
 / fs->
e2fs_ncg
;

232 
max•a˚
 = 0;

233 
möcg
 = -1;

234 
cg
 = 0; cg < 
fs
->
e2fs_ncg
; cg++)

235 i‡–
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
 >
avgi‰ì
) {

236 i‡(
möcg
 =-1 || 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
 > 
max•a˚
) {

237 
möcg
 = 
cg
;

238 
max•a˚
 = 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
;

241  
möcg
;

242 
	}
}

255 
daddr_t


256 
	$ext2fs_blk¥ef
(
öode
 *
ù
, 
daddr_t
 
lbn
, 
ödx
,

257 
öt32_t
 *
b≠
 )

259 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

260 
m_ext2fs
 *
fs
;

261 
cg
, 
i
;

263 
fs
 = 
ù
->
i_e2fs
;

269 i‡–
ù
->
i_e2fs_œ°_blk
 && 
lbn
 =ù->
i_e2fs_œ°_lblk
 + 1) {

270  
ù
->
i_e2fs_œ°_blk
 + 1;

278 i‡(
b≠
) {

279 
i
 = 
ödx
; i >= 0 ; i--) {

280 i‡(
b≠
[
i
]) {

281  
	`fs2h32
(
b≠
[
i
]) + 1;

288 
cg
 = 
	`öo_to_cg
(
fs
, 
ù
->
i_numbî
);

289  
fs
->
e2fs
.
e2fs_bpg
 * 
cg
 + fs->e2fs.
e2fs_fú°_dblock
 + 1;

290 
	}
}

300 
u_l⁄g


301 
	$ext2fs_hashÆloc
(
öode
 *
ù
, 
cg
, 
¥ef
, 
size
,

302 
	$daddr_t
 (*
Æloˇt‹
)(
öode
 *, , 
daddr_t
, ))

304 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

305 
m_ext2fs
 *
fs
;

306 
ªsu…
;

307 
i
, 
icg
 = 
cg
;

309 
fs
 = 
ù
->
i_e2fs
;

313 
ªsu…
 = (*
Æloˇt‹
)(
ù
, 
cg
, 
¥ef
, 
size
);

314 i‡(
ªsu…
)

315  (
ªsu…
);

319 
i
 = 1; i < 
fs
->
e2fs_ncg
; i *= 2) {

320 
cg
 +
i
;

321 i‡(
cg
 >
fs
->
e2fs_ncg
)

322 
cg
 -
fs
->
e2fs_ncg
;

323 
ªsu…
 = (*
Æloˇt‹
)(
ù
, 
cg
, 0, 
size
);

324 i‡(
ªsu…
)

325  (
ªsu…
);

332 
cg
 = (
icg
 + 2Ë% 
fs
->
e2fs_ncg
;

333 
i
 = 2; i < 
fs
->
e2fs_ncg
; i++) {

334 
ªsu…
 = (*
Æloˇt‹
)(
ù
, 
cg
, 0, 
size
);

335 i‡(
ªsu…
)

336  (
ªsu…
);

337 
cg
++;

338 i‡(
cg
 =
fs
->
e2fs_ncg
)

339 
cg
 = 0;

342 
	}
}

351 
daddr_t


352 
	$ext2fs_Æloccg
(
öode
 *
ù
, 
cg
, 
daddr_t
 
b¥ef
, 
size
)

354 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

355 
m_ext2fs
 *
fs
;

356 *
bbp
;

357 
buf
 *
bp
;

359 
îr‹
, 
bno
, 
°¨t
, 
íd
, 
loc
;

361 
fs
 = 
ù
->
i_e2fs
;

362 i‡(
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
 == 0)

364 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
, 
	`EXT2_FSBTODB
(
fs
,

365 
fs
->
e2fs_gd
[
cg
].
ext2bgd_b_bôm≠
),

366 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

367 i‡(
îr‹
) {

370 
bbp
 = (*)
bp
->
b_d©a
;

372 i‡(
	`dtog
(
fs
, 
b¥ef
Ë!
cg
)

373 
b¥ef
 = 0;

374 i‡(
b¥ef
 != 0) {

375 
b¥ef
 = 
	`dtogd
(
fs
, bpref);

379 i‡(
	`is˛r
(
bbp
, 
b¥ef
)) {

380 
bno
 = 
b¥ef
;

381 
gŸô
;

390 i‡(
b¥ef
)

391 
°¨t
 = 
	`dtogd
(
fs
, 
b¥ef
Ë/ 
NBBY
;

393 
°¨t
 = 0;

394 
íd
 = 
	`howm™y
(
fs
->
e2fs
.
e2fs_Âg
, 
NBBY
Ë- 
°¨t
;

395 
loc
 = 
°¨t
;Üo¯< 
íd
;Üoc++) {

396 i‡(
bbp
[
loc
] == 0) {

397 
bno
 = 
loc
 * 
NBBY
;

398 
gŸô
;

401 
loc
 = 0;Üo¯< 
°¨t
;Üoc++) {

402 i‡(
bbp
[
loc
] == 0) {

403 
bno
 = 
loc
 * 
NBBY
;

404 
gŸô
;

408 
bno
 = 
	`ext2fs_m≠£¨ch
(
fs
, 
bbp
, 
b¥ef
);

409 i‡(
bno
 < 0)

411 
gŸô
:

412 #ifde‡
DIAGNOSTIC


413 i‡(
	`is£t
(
bbp
, (
daddr_t
)
bno
)) {

414 
	`¥ötf
("ext2fs_alloccgblk: cg=%d bno=%d fs=%s\n",

415 
cg
, 
bno
, 
fs
->
e2fs_fsm¡
);

416 
	`∑nic
("ext2fs_alloccg: dupálloc");

419 
	`£tbô
(
bbp
, (
daddr_t
)
bno
);

420 
fs
->
e2fs
.
e2fs_fbcou¡
--;

421 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
--;

422 
fs
->
e2fs_fmod
 = 1;

423 
	`bdwrôe
(
bp
);

424  (
cg
 * 
fs
->
e2fs
.
e2fs_Âg
 + fs->e2fs.
e2fs_fú°_dblock
 + 
bno
);

425 
	}
}

436 
daddr_t


437 
	$ext2fs_nodóŒoccg
(
öode
 *
ù
, 
cg
, 
daddr_t
 
ùªf
, 
mode
)

439 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

440 
m_ext2fs
 *
fs
;

441 *
ibp
;

442 
buf
 *
bp
;

443 
îr‹
, 
°¨t
, 
Àn
, 
loc
, 
m≠
, 
i
;

445 
ùªf
--;

446 i‡(
ùªf
 == -1)

447 
ùªf
 = 0;

448 
fs
 = 
ù
->
i_e2fs
;

449 i‡(
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
 == 0)

451 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
, 
	`EXT2_FSBTODB
(
fs
,

452 
fs
->
e2fs_gd
[
cg
].
ext2bgd_i_bôm≠
),

453 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

454 i‡(
îr‹
) {

457 
ibp
 = (*)
bp
->
b_d©a
;

458 i‡(
ùªf
) {

459 
ùªf
 %
fs
->
e2fs
.
e2fs_ùg
;

460 i‡(
	`is˛r
(
ibp
, 
ùªf
))

461 
gŸô
;

463 
°¨t
 = 
ùªf
 / 
NBBY
;

464 
Àn
 = 
	`howm™y
(
fs
->
e2fs
.
e2fs_ùg
 - 
ùªf
, 
NBBY
);

465 
loc
 = 
	`skpc
(0xff, 
Àn
, &
ibp
[
°¨t
]);

466 i‡(
loc
 == 0) {

467 
Àn
 = 
°¨t
 + 1;

468 
°¨t
 = 0;

469 
loc
 = 
	`skpc
(0xff, 
Àn
, &
ibp
[0]);

470 i‡(
loc
 == 0) {

471 
	`¥ötf
("cg = %d, ipref = %lld, fs = %s\n",

472 
cg
, ()
ùªf
, 
fs
->
e2fs_fsm¡
);

473 
	`∑nic
("ext2fs_nodealloccg: map corrupted");

477 
i
 = 
°¨t
 + 
Àn
 - 
loc
;

478 
m≠
 = 
ibp
[
i
] ^ 0xff;

479 i‡(
m≠
 == 0) {

480 
	`¥ötf
("f†%s\n", 
fs
->
e2fs_fsm¡
);

481 
	`∑nic
("ext2fs_nodealloccg: blockÇot in map");

483 
ùªf
 = 
i
 * 
NBBY
 + 
	`ffs
(
m≠
) - 1;

484 
gŸô
:

485 
	`£tbô
(
ibp
, 
ùªf
);

486 
fs
->
e2fs
.
e2fs_ficou¡
--;

487 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
--;

488 
fs
->
e2fs_fmod
 = 1;

489 i‡((
mode
 & 
IFMT
Ë=
IFDIR
) {

490 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ndús
++;

492 
	`bdwrôe
(
bp
);

493  (
cg
 * 
fs
->
e2fs
.
e2fs_ùg
 + 
ùªf
 +1);

494 
	}
}

503 
	$ext2fs_blk‰ì
(
öode
 *
ù
, 
daddr_t
 
bno
)

505 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

506 
m_ext2fs
 *
fs
;

507 *
bbp
;

508 
buf
 *
bp
;

509 
îr‹
, 
cg
;

511 
fs
 = 
ù
->
i_e2fs
;

512 
cg
 = 
	`dtog
(
fs
, 
bno
);

513 i‡((
u_öt
)
bno
 >
fs
->
e2fs
.
e2fs_bcou¡
) {

514 
	`¥ötf
("bad block %Œd, inÿ%Œu\n", ()
bno
,

515 ()
ù
->
i_numbî
);

516 
	`ext2fs_f£º
(
fs
, 
ù
->
i_uid
, "bad block");

519 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
,

520 
	`EXT2_FSBTODB
(
fs
, fs->
e2fs_gd
[
cg
].
ext2bgd_b_bôm≠
),

521 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

522 i‡(
îr‹
) {

525 
bbp
 = (*)
bp
->
b_d©a
;

526 
bno
 = 
	`dtogd
(
fs
, bno);

527 i‡(
	`is˛r
(
bbp
, 
bno
)) {

528 
	`¥ötf
("dev = 0x%llx, block = %lld, fs = %s\n",

529 ()
ù
->
i_dev
, ()
bno
,

530 
fs
->
e2fs_fsm¡
);

531 
	`∑nic
("blkfree: freeing free block");

533 
	`˛rbô
(
bbp
, 
bno
);

534 
fs
->
e2fs
.
e2fs_fbcou¡
++;

535 
fs
->
e2fs_gd
[
cg
].
ext2bgd_nb‰ì
++;

537 
fs
->
e2fs_fmod
 = 1;

538 
	`bdwrôe
(
bp
);

539 
	}
}

547 
	$ext2fs_v‰ì
(
vnode
 *
pvp
, 
öo_t
 
öo
, 
mode
)

549 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

550 
m_ext2fs
 *
fs
;

551 *
ibp
;

552 
öode
 *
pù
;

553 
buf
 *
bp
;

554 
îr‹
, 
cg
;

556 
pù
 = 
	`VTOI
(
pvp
);

557 
fs
 = 
pù
->
i_e2fs
;

558 i‡((
u_öt
)
öo
 > 
fs
->
e2fs
.
e2fs_icou¡
 || (u_öt)öÿ< 
EXT2_FIRSTINO
)

559 
	`∑nic
("ifree:Ñange: dev = 0x%llx, ino = %llu, fs = %s",

560 ()
pù
->
i_dev
, ()
öo
,

561 
fs
->
e2fs_fsm¡
);

562 
cg
 = 
	`öo_to_cg
(
fs
, 
öo
);

563 
îr‹
 = 
	`bªad
(
pù
->
i_devvp
,

564 
	`EXT2_FSBTODB
(
fs
, fs->
e2fs_gd
[
cg
].
ext2bgd_i_bôm≠
),

565 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

566 i‡(
îr‹
) {

569 
ibp
 = (*)
bp
->
b_d©a
;

570 
öo
 = (öÿ- 1Ë% 
fs
->
e2fs
.
e2fs_ùg
;

571 i‡(
	`is˛r
(
ibp
, 
öo
)) {

572 
	`¥ötf
("dev = 0x%llx, ino = %llu, fs = %s\n",

573 ()
pù
->
i_dev
,

574 ()
öo
, 
fs
->
e2fs_fsm¡
);

575 i‡(
fs
->
e2fs_r⁄ly
 == 0)

576 
	`∑nic
("ifree: freeing free inode");

578 
	`˛rbô
(
ibp
, 
öo
);

579 
fs
->
e2fs
.
e2fs_ficou¡
++;

580 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ni‰ì
++;

581 i‡((
mode
 & 
IFMT
Ë=
IFDIR
) {

582 
fs
->
e2fs_gd
[
cg
].
ext2bgd_ndús
--;

584 
fs
->
e2fs_fmod
 = 1;

585 
	`bdwrôe
(
bp
);

587 
	}
}

596 
daddr_t


597 
	$ext2fs_m≠£¨ch
(
m_ext2fs
 *
fs
, *
bbp
, 
daddr_t
 
b¥ef
)

599 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

600 
°¨t
, 
Àn
, 
loc
, 
i
, 
m≠
;

606 i‡(
b¥ef
)

607 
°¨t
 = 
	`dtogd
(
fs
, 
b¥ef
Ë/ 
NBBY
;

609 
°¨t
 = 0;

610 
Àn
 = 
	`howm™y
(
fs
->
e2fs
.
e2fs_Âg
, 
NBBY
Ë- 
°¨t
;

611 
loc
 = 
	`skpc
(0xff, 
Àn
, &
bbp
[
°¨t
]);

612 i‡(
loc
 == 0) {

613 
Àn
 = 
°¨t
 + 1;

614 
°¨t
 = 0;

615 
loc
 = 
	`skpc
(0xff, 
Àn
, &
bbp
[
°¨t
]);

616 i‡(
loc
 == 0) {

617 
	`¥ötf
("start = %d,Üen = %d, fs = %s\n",

618 
°¨t
, 
Àn
, 
fs
->
e2fs_fsm¡
);

619 
	`∑nic
("ext2fs_alloccg: map corrupted");

623 
i
 = 
°¨t
 + 
Àn
 - 
loc
;

624 
m≠
 = 
bbp
[
i
] ^ 0xff;

625 i‡(
m≠
 == 0) {

626 
	`¥ötf
("f†%s\n", 
fs
->
e2fs_fsm¡
);

627 
	`∑nic
("ext2fs_mapsearch: blockÇot in map");

629  
i
 * 
NBBY
 + 
	`ffs
(
m≠
) - 1;

630 
	}
}

639 
	$ext2fs_f£º
(
m_ext2fs
 *
fs
, 
u_öt
 
uid
, c⁄° *
˝
)

641 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

643 
	`log
(
LOG_ERR
, "uid %d o¿%s: %s\n", 
uid
, 
fs
->
e2fs_fsm¡
, 
˝
);

644 
	}
}

	@ext2fs_balloc.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_balloc.c,v 1.40 2015/03/28 19:24:04 maxv Exp $");

65 #i‡
deföed
(
_KERNEL_OPT
)

66 
	~"›t_uvmhi°.h
"

69 
	~<sys/∑øm.h
>

70 
	~<sys/sy°m.h
>

71 
	~<sys/buf.h
>

72 
	~<sys/¥oc.h
>

73 
	~<sys/fûe.h
>

74 
	~<sys/vnode.h
>

75 
	~<sys/mou¡.h
>

76 
	~<sys/kauth.h
>

78 
	~<uvm/uvm.h
>

80 
	~<ufs/ufs/öode.h
>

81 
	~<ufs/ufs/ufs_exã∫.h
>

83 
	~<ufs/ext2fs/ext2fs.h
>

84 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

92 
	$ext2fs_bÆloc
(
öode
 *
ù
, 
daddr_t
 
bn
, 
size
,

93 
kauth_¸ed_t
 
¸ed
, 
buf
 **
bµ
, 
Êags
)

95 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

96 
m_ext2fs
 *
fs
;

97 
daddr_t
 
nb
;

98 
buf
 *
bp
, *
nbp
;

99 
vnode
 *
vp
 = 
	`ITOV
(
ù
);

100 
ödú
 
ödús
[
EXT2FS_NIADDR
 + 2];

101 
daddr_t
 
√wb
, 
lbn
, 
¥ef
;

102 
öt32_t
 *
b≠
;

103 
num
, 
i
, 
îr‹
;

104 
u_öt
 
dóŒoˇãd
;

105 
daddr_t
 *
blkp
, *
Ælocblk
, 
Ælociblk
[
EXT2FS_NIADDR
 + 1];

106 
öt32_t
 *
Ælocib
;

107 
unwödidx
 = -1;

108 
	`UVMHIST_FUNC
("ext2fs_bÆloc"); 
	`UVMHIST_CALLED
(
ubchi°
);

110 
	`UVMHIST_LOG
(
ubchi°
, "b¿0x%x", 
bn
,0,0,0);

112 i‡(
bµ
 !
NULL
) {

113 *
bµ
 = 
NULL
;

115 i‡(
bn
 < 0)

116  (
EFBIG
);

117 
fs
 = 
ù
->
i_e2fs
;

118 
lbn
 = 
bn
;

123 i‡(
bn
 < 
EXT2FS_NDADDR
) {

125 
nb
 = 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
]);

126 i‡(
nb
 != 0) {

132 i‡(
bµ
 !
NULL
) {

133 
îr‹
 = 
	`bªad
(
vp
, 
bn
, 
fs
->
e2fs_bsize
,

134 
B_MODIFY
, &
bp
);

135 i‡(
îr‹
) {

136  (
îr‹
);

138 *
bµ
 = 
bp
;

147 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
bn
,

148 
	`ext2fs_blk¥ef
(
ù
, 
bn
, bn, &ù->
i_e2fs_blocks
[0]),

149 
¸ed
, &
√wb
);

150 i‡(
îr‹
)

151  (
îr‹
);

152 
ù
->
i_e2fs_œ°_lblk
 = 
lbn
;

153 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

155 
ù
->
i_e2fs_blocks
[
bn
] = 
	`h2fs32
((
öt32_t
)
√wb
);

156 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

157 i‡(
bµ
 !
NULL
) {

158 
bp
 = 
	`gëblk
(
vp
, 
bn
, 
fs
->
e2fs_bsize
, 0, 0);

159 
bp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
√wb
);

160 i‡(
Êags
 & 
B_CLRBUF
)

161 
	`˛rbuf
(
bp
);

162 *
bµ
 = 
bp
;

169 
¥ef
 = 0;

170 i‡((
îr‹
 = 
	`ufs_gëlbns
(
vp
, 
bn
, 
ödús
, &
num
)) != 0)

171 (
îr‹
);

172 #ifde‡
DIAGNOSTIC


173 i‡(
num
 < 1)

174 
	`∑nic
 ("ext2fs_balloc: ufs_getlbnsÑeturned indirect block\n");

179 --
num
;

181 
nb
 = 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
ödús
[0].
ö_off
]);

182 
Ælocib
 = 
NULL
;

183 
Ælocblk
 = 
Ælociblk
;

184 i‡(
nb
 == 0) {

185 
¥ef
 = 
	`ext2fs_blk¥ef
(
ù
, 
lbn
, 0, (
öt32_t
 *)0);

186 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
lbn
, 
¥ef
, 
¸ed
, &
√wb
);

187 i‡(
îr‹
)

188  (
îr‹
);

189 
nb
 = 
√wb
;

190 *
Ælocblk
++ = 
nb
;

191 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

192 
bp
 = 
	`gëblk
(
vp
, 
ödús
[1].
ö_lbn
, 
fs
->
e2fs_bsize
, 0, 0);

193 
bp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
√wb
);

194 
	`˛rbuf
(
bp
);

199 i‡((
îr‹
 = 
	`bwrôe
(
bp
)) != 0)

200 
Áû
;

201 
unwödidx
 = 0;

202 
Ælocib
 = &
ù
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
ödús
[0].
ö_off
];

204 *
Ælocib
 = 
	`h2fs32
((
öt32_t
)
√wb
);

205 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

210 
i
 = 1;;) {

211 
îr‹
 = 
	`bªad
(
vp
,

212 
ödús
[
i
].
ö_lbn
, ()
fs
->
e2fs_bsize
, 0, &
bp
);

213 i‡(
îr‹
) {

214 
Áû
;

216 
b≠
 = (
öt32_t
 *)
bp
->
b_d©a
;

217 
nb
 = 
	`fs2h32
(
b≠
[
ödús
[
i
].
ö_off
]);

218 i‡(
i
 =
num
)

220 
i
++;

221 i‡(
nb
 != 0) {

222 
	`bªl£
(
bp
, 0);

225 
¥ef
 = 
	`ext2fs_blk¥ef
(
ù
, 
lbn
, 0, (
öt32_t
 *)0);

226 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
lbn
, 
¥ef
, 
¸ed
, &
√wb
);

227 i‡(
îr‹
) {

228 
	`bªl£
(
bp
, 0);

229 
Áû
;

231 
nb
 = 
√wb
;

232 *
Ælocblk
++ = 
nb
;

233 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

234 
nbp
 = 
	`gëblk
(
vp
, 
ödús
[
i
].
ö_lbn
, 
fs
->
e2fs_bsize
, 0, 0);

235 
nbp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
nb
);

236 
	`˛rbuf
(
nbp
);

241 i‡((
îr‹
 = 
	`bwrôe
(
nbp
)) != 0) {

242 
	`bªl£
(
bp
, 0);

243 
Áû
;

245 i‡(
unwödidx
 < 0)

246 
unwödidx
 = 
i
 - 1;

248 
b≠
[
ödús
[
i
 - 1].
ö_off
] = 
	`h2fs32
((
öt32_t
)
nb
);

253 i‡(
Êags
 & 
B_SYNC
) {

254 
	`bwrôe
(
bp
);

256 
	`bdwrôe
(
bp
);

262 i‡(
nb
 == 0) {

263 
¥ef
 = 
	`ext2fs_blk¥ef
(
ù
, 
lbn
, 
ödús
[
num
].
ö_off
, &
b≠
[0]);

264 
îr‹
 = 
	`ext2fs_Æloc
(
ù
, 
lbn
, 
¥ef
, 
¸ed
, &
√wb
);

265 i‡(
îr‹
) {

266 
	`bªl£
(
bp
, 0);

267 
Áû
;

269 
nb
 = 
√wb
;

270 *
Ælocblk
++ = 
nb
;

271 
ù
->
i_e2fs_œ°_lblk
 = 
lbn
;

272 
ù
->
i_e2fs_œ°_blk
 = 
√wb
;

274 
b≠
[
ödús
[
num
].
ö_off
] = 
	`h2fs32
((
öt32_t
)
nb
);

279 i‡(
Êags
 & 
B_SYNC
) {

280 
	`bwrôe
(
bp
);

282 
	`bdwrôe
(
bp
);

284 i‡(
bµ
 !
NULL
) {

285 
nbp
 = 
	`gëblk
(
vp
, 
lbn
, 
fs
->
e2fs_bsize
, 0, 0);

286 
nbp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
nb
);

287 i‡(
Êags
 & 
B_CLRBUF
)

288 
	`˛rbuf
(
nbp
);

289 *
bµ
 = 
nbp
;

293 
	`bªl£
(
bp
, 0);

294 i‡(
bµ
 !
NULL
) {

295 i‡(
Êags
 & 
B_CLRBUF
) {

296 
îr‹
 = 
	`bªad
(
vp
, 
lbn
, ()
fs
->
e2fs_bsize
,

297 
B_MODIFY
, &
nbp
);

298 i‡(
îr‹
) {

299 
Áû
;

302 
nbp
 = 
	`gëblk
(
vp
, 
lbn
, 
fs
->
e2fs_bsize
, 0, 0);

303 
nbp
->
b_blkno
 = 
	`EXT2_FSBTODB
(
fs
, 
nb
);

305 *
bµ
 = 
nbp
;

308 
Áû
:

313 
dóŒoˇãd
 = 0, 
blkp
 = 
Ælociblk
; blk∞< 
Ælocblk
; blkp++) {

314 
	`ext2fs_blk‰ì
(
ù
, *
blkp
);

315 
dóŒoˇãd
 +
fs
->
e2fs_bsize
;

317 i‡(
unwödidx
 >= 0) {

318 i‡(
unwödidx
 == 0) {

319 *
Ælocib
 = 0;

321 
r
;

323 
r
 = 
	`bªad
(
vp
, 
ödús
[
unwödidx
].
ö_lbn
,

324 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

325 i‡(
r
) {

326 
	`∑nic
("CouldÇŸ unwöd indúe˘ block,Éº‹ %d", 
r
);

328 
b≠
 = (
öt32_t
 *)
bp
->
b_d©a
;

329 
b≠
[
ödús
[
unwödidx
].
ö_off
] = 0;

330 i‡(
Êags
 & 
B_SYNC
)

331 
	`bwrôe
(
bp
);

333 
	`bdwrôe
(
bp
);

336 
i
 = 
unwödidx
 + 1; i <
num
; i++) {

337 
bp
 = 
	`gëblk
(
vp
, 
ödús
[
i
].
ö_lbn
, ()
fs
->
e2fs_bsize
,

339 
	`bªl£
(
bp
, 
BC_INVAL
);

342 i‡(
dóŒoˇãd
) {

343 
	`ext2fs_£äblock
(
ù
, 
	`ext2fs_nblock
(ùË- 
	`btodb
(
dóŒoˇãd
));

344 
ù
->
i_e2fs_Êags
 |
IN_CHANGE
 | 
IN_UPDATE
;

346  
îr‹
;

347 
	}
}

350 
	$ext2fs_g›_Æloc
(
vnode
 *
vp
, 
off_t
 
off
, off_à
Àn
, 
Êags
,

351 
kauth_¸ed_t
 
¸ed
)

353 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

354 
öode
 *
ù
 = 
	`VTOI
(
vp
);

355 
m_ext2fs
 *
fs
 = 
ù
->
i_e2fs
;

356 
îr‹
, 
dñè
, 
bshi·
, 
bsize
;

357 
	`UVMHIST_FUNC
("ext2fs_g›_Æloc"); 
	`UVMHIST_CALLED
(
ubchi°
);

359 
bshi·
 = 
fs
->
e2fs_bshi·
;

360 
bsize
 = 1 << 
bshi·
;

362 
dñè
 = 
off
 & (
bsize
 - 1);

363 
off
 -
dñè
;

364 
Àn
 +
dñè
;

366 
Àn
 > 0) {

367 
bsize
 = 
	`mö
(bsize, 
Àn
);

368 
	`UVMHIST_LOG
(
ubchi°
, "off 0x%xÜen 0x%x bsize 0x%x",

369 
off
, 
Àn
, 
bsize
, 0);

371 
îr‹
 = 
	`ext2fs_bÆloc
(
ù
, 
	`ext2_lblkno
(
fs
, 
off
), 
bsize
, 
¸ed
,

372 
NULL
, 
Êags
);

373 i‡(
îr‹
) {

374 
	`UVMHIST_LOG
(
ubchi°
, "îr‹ %d", 
îr‹
, 0,0,0);

375  
îr‹
;

383 i‡(
	`ext2fs_size
(
ù
Ë< 
off
 + 
bsize
) {

384 
	`UVMHIST_LOG
(
ubchi°
, "old 0x%lx%8lxÇew 0x%lx%8lx",

386 
	`ext2fs_size
(
ù
) >> 32,

387 
	`ext2fs_size
(
ù
) & 0xffffffff,

388 (
off
 + 
bsize
) >> 32,

389 (
off
 + 
bsize
) & 0xffffffff);

390 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
off
 + 
bsize
);

391 i‡(
îr‹
) {

392 
	`UVMHIST_LOG
(
ubchi°
, "îr‹ %d", 
îr‹
, 0,0,0);

393  
îr‹
;

397 
off
 +
bsize
;

398 
Àn
 -
bsize
;

401 
	}
}

	@ext2fs_bmap.c

67 
	~<sys/cdefs.h
>

68 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_bmap.c,v 1.26 2013/01/22 09:39:15 dholland Exp $");

70 
	~<sys/∑øm.h
>

71 
	~<sys/sy°m.h
>

72 
	~<sys/buf.h
>

73 
	~<sys/¥oc.h
>

74 
	~<sys/vnode.h
>

75 
	~<sys/mou¡.h
>

76 
	~<sys/ªsour˚v¨.h
>

77 
	~<sys/åa˚.h
>

79 
	~<miscfs/•ecfs/•ecdev.h
>

81 
	~<ufs/ufs/öode.h
>

82 
	~<ufs/ufs/ufsmou¡.h
>

83 
	~<ufs/ufs/ufs_exã∫.h
>

84 
	~<ufs/ext2fs/ext2fs.h
>

85 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

88 
ext4_bm≠ext
(
vnode
 *, 
öt32_t
, 
öt64_t
 *, *, *);

90 
ext2fs_bm≠¨øy
(
vnode
 *, 
daddr_t
, daddr_t *,

91 
ödú
 *, *, *);

93 
	#is_£quítül
(
ump
, 
a
, 
b
Ë((bË=◊Ë+ ump->
um_£qöc
)

	)

101 
	$ext2fs_bm≠
(*
v
)

103 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

104 
v›_bm≠_¨gs


110  *
≠
 = 
v
;

118 i‡(
≠
->
a_vµ
 !
NULL
)

119 *
≠
->
a_vµ
 = 
	`VTOI
◊p->
a_vp
)->
i_devvp
;

120 i‡(
≠
->
a_b≈
 =
NULL
)

124 
	`¥ötf
("vÆuêo‡i_Êagánd IN_E4EXTENTSáª : %dánd %d \n",
	`VTOI
(
≠
->
a_vp
)->
i_Êag
 , 
IN_E4EXTENTS
);

126  (
	`ext4_bm≠ext
(
≠
->
a_vp
,áp->
a_bn
,áp->
a_b≈
,

127 
≠
->
a_ru≈
, 
NULL
));

129  (
	`ext2fs_bm≠¨øy
(
≠
->
a_vp
,áp->
a_bn
,áp->
a_b≈
, 
NULL
, NULL,

130 
≠
->
a_ru≈
));

133 
	}
}

141 
	$ext4_bm≠ext
(
vnode
 *
vp
, 
öt32_t
 
bn
, 
öt64_t
 *
b≈
, *
ru≈
, *
runb
)

143 
	`¥ötf
 ("insideÉxt4_bmapext\n");

144 
öode
 *
ù
;

145 
m_ext2fs
 *
fs
;

146 
ext4_exã¡
 *
ï
;

147 
ext4_exã¡_∑th
 
∑th
 = { .
ï_bp
 = 
NULL
 };

148 
daddr_t
 
lbn
;

149 
ªt
 = 0;

151 
ù
 = 
	`VTOI
(
vp
);

152 
fs
 = 
ù
->
i_e2fs
;

153 
lbn
 = 
bn
;

155 i‡(
ru≈
 !
NULL
)

156 *
ru≈
 = 0;

158 i‡(
runb
 !
NULL
)

159 *
runb
 = 0;

161 
	`ext4_ext_föd_exã¡
(
fs
, 
ù
, 
lbn
, &
∑th
);

162 i‡(
∑th
.
ï_is_•¨£
) {

163 *
b≈
 = -1;

164 i‡(
ru≈
 !
NULL
)

165 *
ru≈
 = 
∑th
.
ï_•¨£_ext
.
e_Àn
 -

166 (
lbn
 - 
∑th
.
ï_•¨£_ext
.
e_blk
) - 1;

167 i‡(
runb
 !
NULL
)

168 *
runb
 = 
lbn
 - 
∑th
.
ï_•¨£_ext
.
e_blk
;

170 
ï
 = 
∑th
.
ï_ext
;

171 i‡(
ï
 =
NULL
)

172 
ªt
 = 
EIO
;

174 *
b≈
 = 
	`fsbtodb
(
fs
, 
lbn
 - 
ï
->
e_blk
 +

175 (
ï
->
e_°¨t_lo
 | (
daddr_t
Îp->
e_°¨t_hi
 << 32));

177 i‡(*
b≈
 == 0)

178 *
b≈
 = -1;

180 i‡(
ru≈
 !
NULL
)

181 *
ru≈
 = 
ï
->
e_Àn
 - (
lbn
 -Ép->
e_blk
) - 1;

182 i‡(
runb
 !
NULL
)

183 *
runb
 = 
lbn
 - 
ï
->
e_blk
;

187 i‡(
∑th
.
ï_bp
 !
NULL
) {

188 
	`bªl£
(
∑th
.
ï_bp
,0);

189 
∑th
.
ï_bp
 = 
NULL
;

192  (
ªt
);

193 
	}
}

212 
	$ext2fs_bm≠¨øy
(
vnode
 *
vp
, 
daddr_t
 
bn
, daddr_à*
b≈
, 
ödú
 *
≠
,

213 *
nump
, *
ru≈
)

216 
	`¥ötf
("InsideÉxt2fs_bmaparray\n");

217 
öode
 *
ù
;

218 
buf
 *
bp
, *
cbp
;

219 
ufsmou¡
 *
ump
;

220 
mou¡
 *
mp
;

221 
ödú
 
a
[
EXT2FS_NIADDR
+1], *
x≠
;

222 
daddr_t
 
daddr
;

223 
daddr_t
 
mëÆbn
;

224 
îr‹
, 
maxrun
 = 0, 
num
;

226 
ù
 = 
	`VTOI
(
vp
);

227 
mp
 = 
vp
->
v_mou¡
;

228 
ump
 = 
ù
->
i_ump
;

229 #ifde‡
DIAGNOSTIC


230 i‡((
≠
 !
NULL
 && 
nump
 == NULL) || (ap == NULL &&Çump != NULL))

231 
	`∑nic
("ext2fs_bmaparray: invalidárguments");

234 i‡(
ru≈
) {

241 *
ru≈
 = 0;

242 
maxrun
 = 
MAXBSIZE
 / 
mp
->
m¡_°©
.
f_iosize
 - 1;

245 i‡(
bn
 >0 && b¿< 
EXT2FS_NDADDR
) {

247 *
b≈
 = 
	`blk±πodb
(
ump
, 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
]));

248 i‡(*
b≈
 == 0)

249 *
b≈
 = -1;

250 i‡(
ru≈
)

252 ++
bn
; b¿< 
EXT2FS_NDADDR
 && *
ru≈
 < 
maxrun
 &&

253 
	`is_£quítül
(
ump
, (
daddr_t
)
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
 - 1]),

254 (
daddr_t
)
	`fs2h32
(
ù
->
i_e2fs_blocks
[
bn
]));

255 ++
bn
, ++*
ru≈
);

259 
x≠
 = 
≠
 =
NULL
 ? 
a
 :áp;

260 i‡(!
nump
)

261 
nump
 = &
num
;

262 i‡((
îr‹
 = 
	`ufs_gëlbns
(
vp
, 
bn
, 
x≠
, 
nump
)) != 0)

263  (
îr‹
);

265 
num
 = *
nump
;

269 
daddr
 = 
	`fs2h32
(
ù
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
x≠
->
ö_off
]);

271 #ifde‡
DIAGNOSTIC


272 i‡(
num
 > 
EXT2FS_NIADDR
 + 1 ||Çum < 1) {

273 
	`¥ötf
("ext2fs_bm≠¨øy:Çum=%d\n", 
num
);

274 
	`∑nic
("ext2fs_bmaparray:Çum");

277 
bp
 = 
NULL
, ++
x≠
; --
num
; ++xap) {

284 
mëÆbn
 = 
x≠
->
ö_lbn
;

285 i‡(
mëÆbn
 =
bn
)

287 i‡(
daddr
 == 0) {

288 
	`muãx_íãr
(&
bufˇche_lock
);

289 
cbp
 = 
	`öc‹e
(
vp
, 
mëÆbn
);

290 
	`muãx_exô
(&
bufˇche_lock
);

291 i‡(
cbp
 =
NULL
)

298 i‡(
bp
)

299 
	`bªl£
(
bp
, 0);

301 
x≠
->
ö_exi°s
 = 1;

302 
bp
 = 
	`gëblk
(
vp
, 
mëÆbn
, 
mp
->
m¡_°©
.
f_iosize
, 0, 0);

303 i‡(
bp
 =
NULL
) {

311  (
ENOMEM
);

313 i‡(
bp
->
b_oÊags
 & (
BO_DONE
 | 
BO_DELWRI
)) {

314 
	`åa˚
(
TR_BREADHIT
, 
	`∑ck
(
vp
, 
size
), 
mëÆbn
);

316 #ifde‡
DIAGNOSTIC


317 i‡(!
daddr
)

318 
	`∑nic
("ext2fs_bmaparry: indirect blockÇot in cache");

321 
	`åa˚
(
TR_BREADMISS
, 
	`∑ck
(
vp
, 
size
), 
mëÆbn
);

322 
bp
->
b_blkno
 = 
	`blk±πodb
(
ump
, 
daddr
);

323 
bp
->
b_Êags
 |
B_READ
;

324 
	`VOP_STRATEGY
(
vp
, 
bp
);

325 
cuæwp
->
l_ru
.
ru_öblock
++;

326 i‡((
îr‹
 = 
	`biowaô
(
bp
)) != 0) {

327 
	`bªl£
(
bp
, 0);

328  (
îr‹
);

333 
daddr
 = 
	`fs2h32
(((
öt32_t
 *)
bp
->
b_d©a
)[
x≠
->
ö_off
]);

334 i‡(
num
 =1 && 
daddr
 && 
ru≈
)

336 
bn
 = 
x≠
->
ö_off
 + 1;

337 
bn
 < 
	`MNINDIR
(
ump
Ë&& *
ru≈
 < 
maxrun
 &&

338 
	`is_£quítül
(
ump
, ((
öt32_t
 *)
bp
->
b_d©a
)[
bn
 - 1],

339 ((
öt32_t
 *)
bp
->
b_d©a
)[
bn
]);

340 ++
bn
, ++*
ru≈
);

342 i‡(
bp
)

343 
	`bªl£
(
bp
, 0);

345 
daddr
 = 
	`blk±πodb
(
ump
, daddr);

346 *
b≈
 = 
daddr
 == 0 ? -1 : daddr;

348 
	}
}

	@ext2fs_bswap.c

28 
	~<sys/cdefs.h
>

29 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_bswap.c,v 1.19 2013/01/22 09:39:15 dholland Exp $");

31 
	~<sys/ty≥s.h
>

32 
	~<ufs/ext2fs/ext2fs.h
>

33 
	~<ufs/ext2fs/ext2fs_döode.h
>

35 #i‡
deföed
(
_KERNEL
)

36 
	~<sys/sy°m.h
>

38 
	~<°rög.h
>

42 #i‡
BYTE_ORDER
 =
BIG_ENDIAN


44 
	$e2fs_sb_bsw≠
(
ext2fs
 *
ﬁd
, ext2f†*
√w
)

46 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

48 
	`mem˝y
(
√w
, 
ﬁd
, (
ext2fs
));

49 
√w
->
e2fs_icou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_icount);

50 
√w
->
e2fs_bcou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_bcount);

51 
√w
->
e2fs_rbcou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_rbcount);

52 
√w
->
e2fs_fbcou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_fbcount);

53 
√w
->
e2fs_ficou¡
 = 
	`bsw≠32
(
ﬁd
->e2fs_ficount);

54 
√w
->
e2fs_fú°_dblock
 = 
	`bsw≠32
(
ﬁd
->e2fs_first_dblock);

55 
√w
->
e2fs_log_bsize
 = 
	`bsw≠32
(
ﬁd
->e2fs_log_bsize);

56 
√w
->
e2fs_fsize
 = 
	`bsw≠32
(
ﬁd
->e2fs_fsize);

57 
√w
->
e2fs_bpg
 = 
	`bsw≠32
(
ﬁd
->e2fs_bpg);

58 
√w
->
e2fs_Âg
 = 
	`bsw≠32
(
ﬁd
->e2fs_fpg);

59 
√w
->
e2fs_ùg
 = 
	`bsw≠32
(
ﬁd
->e2fs_ipg);

60 
√w
->
e2fs_mtime
 = 
	`bsw≠32
(
ﬁd
->e2fs_mtime);

61 
√w
->
e2fs_wtime
 = 
	`bsw≠32
(
ﬁd
->e2fs_wtime);

62 
√w
->
e2fs_m¡_cou¡
 = 
	`bsw≠16
(
ﬁd
->e2fs_mnt_count);

63 
√w
->
e2fs_max_m¡_cou¡
 = 
	`bsw≠16
(
ﬁd
->e2fs_max_mnt_count);

64 
√w
->
e2fs_magic
 = 
	`bsw≠16
(
ﬁd
->e2fs_magic);

65 
√w
->
e2fs_°©e
 = 
	`bsw≠16
(
ﬁd
->e2fs_state);

66 
√w
->
e2fs_beh
 = 
	`bsw≠16
(
ﬁd
->e2fs_beh);

67 
√w
->
e2fs_möªv
 = 
	`bsw≠16
(
ﬁd
->e2fs_minrev);

68 
√w
->
e2fs_œ°fsck
 = 
	`bsw≠32
(
ﬁd
->e2fs_lastfsck);

69 
√w
->
e2fs_fsckötv
 = 
	`bsw≠32
(
ﬁd
->e2fs_fsckintv);

70 
√w
->
e2fs_¸ót‹
 = 
	`bsw≠32
(
ﬁd
->e2fs_creator);

71 
√w
->
e2fs_ªv
 = 
	`bsw≠32
(
ﬁd
->e2fs_rev);

72 
√w
->
e2fs_ruid
 = 
	`bsw≠16
(
ﬁd
->e2fs_ruid);

73 
√w
->
e2fs_rgid
 = 
	`bsw≠16
(
ﬁd
->e2fs_rgid);

74 
√w
->
e2fs_fú°_öo
 = 
	`bsw≠32
(
ﬁd
->e2fs_first_ino);

75 
√w
->
e2fs_öode_size
 = 
	`bsw≠16
(
ﬁd
->e2fs_inode_size);

76 
√w
->
e2fs_block_group_ƒ
 = 
	`bsw≠16
(
ﬁd
->e2fs_block_group_nr);

77 
√w
->
e2fs_„©uªs_com∑t
 = 
	`bsw≠32
(
ﬁd
->e2fs_features_compat);

78 
√w
->
e2fs_„©uªs_öcom∑t
 = 
	`bsw≠32
(
ﬁd
->e2fs_features_incompat);

79 
√w
->
e2fs_„©uªs_rocom∑t
 = 
	`bsw≠32
(
ﬁd
->e2fs_features_rocompat);

80 
√w
->
e2fs_Ægo
 = 
	`bsw≠32
(
ﬁd
->e2fs_algo);

81 
√w
->
e2fs_ª£rved_ngdb
 = 
	`bsw≠16
(
ﬁd
->e2fs_reserved_ngdb);

82 
	}
}

84 
	$e2fs_cg_bsw≠
(
ext2_gd
 *
ﬁd
, ext2_gd *
√w
, 
size
)

86 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

87 
i
;

89 
i
 = 0; i < (
size
 / ()(
ext2_gd
)); i++) {

90 
√w
[
i
].
ext2bgd_b_bôm≠
 = 
	`bsw≠32
(
ﬁd
[i].ext2bgd_b_bitmap);

91 
√w
[
i
].
ext2bgd_i_bôm≠
 = 
	`bsw≠32
(
ﬁd
[i].ext2bgd_i_bitmap);

92 
√w
[
i
].
ext2bgd_i_èbÀs
 = 
	`bsw≠32
(
ﬁd
[i].ext2bgd_i_tables);

93 
√w
[
i
].
ext2bgd_nb‰ì
 = 
	`bsw≠16
(
ﬁd
[i].ext2bgd_nbfree);

94 
√w
[
i
].
ext2bgd_ni‰ì
 = 
	`bsw≠16
(
ﬁd
[i].ext2bgd_nifree);

95 
√w
[
i
].
ext2bgd_ndús
 = 
	`bsw≠16
(
ﬁd
[i].ext2bgd_ndirs);

97 
	}
}

99 
	$e2fs_i_bsw≠
(
ext2fs_döode
 *
ﬁd
, ext2fs_döodê*
√w
)

101 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

102 
√w
->
e2di_mode
 = 
	`bsw≠16
(
ﬁd
->e2di_mode);

103 
√w
->
e2di_uid
 = 
	`bsw≠16
(
ﬁd
->e2di_uid);

104 
√w
->
e2di_gid
 = 
	`bsw≠16
(
ﬁd
->e2di_gid);

105 
√w
->
e2di_∆ök
 = 
	`bsw≠16
(
ﬁd
->e2di_nlink);

106 
√w
->
e2di_size
 = 
	`bsw≠32
(
ﬁd
->e2di_size);

107 
√w
->
e2di_©ime
 = 
	`bsw≠32
(
ﬁd
->e2di_atime);

108 
√w
->
e2di_˘ime
 = 
	`bsw≠32
(
ﬁd
->e2di_ctime);

109 
√w
->
e2di_mtime
 = 
	`bsw≠32
(
ﬁd
->e2di_mtime);

110 
√w
->
e2di_dtime
 = 
	`bsw≠32
(
ﬁd
->e2di_dtime);

111 
√w
->
e2di_nblock
 = 
	`bsw≠32
(
ﬁd
->e2di_nblock);

112 
√w
->
e2di_Êags
 = 
	`bsw≠32
(
ﬁd
->e2di_flags);

113 
√w
->
e2di_vîsi⁄
 = 
	`bsw≠32
(
ﬁd
->e2di_version);

114 
√w
->
e2di_gí
 = 
	`bsw≠32
(
ﬁd
->e2di_gen);

115 
√w
->
e2di_Á˛
 = 
	`bsw≠32
(
ﬁd
->e2di_facl);

116 
√w
->
e2di_da˛
 = 
	`bsw≠32
(
ﬁd
->e2di_dacl);

117 
√w
->
e2di_Áddr
 = 
	`bsw≠32
(
ﬁd
->e2di_faddr);

118 
√w
->
e2di_nblock_high
 = 
	`bsw≠16
(
ﬁd
->e2di_nblock_high);

119 
√w
->
e2di_Á˛_high
 = 
	`bsw≠16
(
ﬁd
->e2di_facl_high);

120 
√w
->
e2di_uid_high
 = 
	`bsw≠16
(
ﬁd
->e2di_uid_high);

121 
√w
->
e2di_gid_high
 = 
	`bsw≠16
(
ﬁd
->e2di_gid_high);

122 
	`mem˝y
(&
√w
->
e2di_blocks
[0], &
ﬁd
->e2di_blocks[0],

123 (
EXT2FS_NDADDR
 + 
EXT2FS_NIADDR
Ë* (
uöt32_t
));

124 
	}
}

	@ext2fs_dinode.h

67 #i‚de‡
_UFS_EXT2FS_EXT2FS_DINODE_H_


68 
	#_UFS_EXT2FS_EXT2FS_DINODE_H_


	)

70 
	~<sys/°©.h
>

78 
	#EXT2_BADBLKINO
 ((
öo_t
)1)

	)

79 
	#EXT2_ROOTINO
 ((
öo_t
)2)

	)

80 
	#EXT2_ACLIDXINO
 ((
öo_t
)3)

	)

81 
	#EXT2_ACLDATAINO
 ((
öo_t
)4)

	)

82 
	#EXT2_BOOTLOADERINO
 ((
öo_t
)5)

	)

83 
	#EXT2_UNDELDIRINO
 ((
öo_t
)6)

	)

84 
	#EXT2_RESIZEINO
 ((
öo_t
)7)

	)

85 
	#EXT2_JOURNALINO
 ((
öo_t
)8)

	)

86 
	#EXT2_FIRSTINO
 ((
öo_t
)11)

	)

100 
	#EXT2FS_NDADDR
 12

	)

101 
	#EXT2FS_NIADDR
 3

	)

103 
	#EXT2_MAXSYMLINKLEN
 ((
EXT2FS_NDADDR
+
EXT2FS_NIADDR
Ë*  (
uöt32_t
))

	)

105 
	sext2fs_döode
 {

106 
uöt16_t
 
	me2di_mode
;

107 
uöt16_t
 
	me2di_uid
;

108 
uöt32_t
 
	me2di_size
;

109 
uöt32_t
 
	me2di_©ime
;

110 
uöt32_t
 
	me2di_˘ime
;

111 
uöt32_t
 
	me2di_mtime
;

112 
uöt32_t
 
	me2di_dtime
;

113 
uöt16_t
 
	me2di_gid
;

114 
uöt16_t
 
	me2di_∆ök
;

115 
uöt32_t
 
	me2di_nblock
;

116 
uöt32_t
 
	me2di_Êags
;

117 
uöt32_t
 
	me2di_vîsi⁄
;

118 
uöt32_t
 
	me2di_blocks
[
EXT2FS_NDADDR
+
EXT2FS_NIADDR
];

120 
uöt32_t
 
	me2di_gí
;

121 
uöt32_t
 
	me2di_Á˛
;

122 
uöt32_t
 
	me2di_da˛
;

123 
uöt32_t
 
	me2di_Áddr
;

124 
uöt16_t
 
	me2di_nblock_high
;

125 
uöt16_t
 
	me2di_Á˛_high
;

126 
uöt16_t
 
	me2di_uid_high
;

127 
uöt16_t
 
	me2di_gid_high
;

128 
uöt32_t
 
	me2di_löux_ª£rved3
;

133 
	#E2MAXSYMLINKLEN
 ((
EXT2FS_NDADDR
 + 
EXT2FS_NIADDR
Ë* (
uöt32_t
))

	)

136 
	#EXT2_IEXEC
 0000100

	)

137 
	#EXT2_IWRITE
 0000200

	)

138 
	#EXT2_IREAD
 0000400

	)

139 
	#EXT2_ISVTX
 0001000

	)

140 
	#EXT2_ISGID
 0002000

	)

141 
	#EXT2_ISUID
 0004000

	)

144 
	#EXT2_IFMT
 0170000

	)

145 
	#EXT2_IFIFO
 0010000

	)

146 
	#EXT2_IFCHR
 0020000

	)

147 
	#EXT2_IFDIR
 0040000

	)

148 
	#EXT2_IFBLK
 0060000

	)

149 
	#EXT2_IFREG
 0100000

	)

150 
	#EXT2_IFLNK
 0120000

	)

151 
	#EXT2_IFSOCK
 0140000

	)

154 
	#EXT2_SECRM
 0x00000001

	)

155 
	#EXT2_UNRM
 0x00000002

	)

156 
	#EXT2_COMPR
 0x00000004

	)

157 
	#EXT2_SYNC
 0x00000008

	)

158 
	#EXT2_IMMUTABLE
 0x00000010

	)

159 
	#EXT2_APPEND
 0x00000020

	)

160 
	#EXT2_NODUMP
 0x00000040

	)

161 
	#EXT2_NOATIME
 0x00000080

	)

162 
	#EXT2_INDEX
 0x00001000

	)

163 
	#EXT2_IMAGIC
 0x00002000

	)

164 
	#EXT2_JOURNAL_DATA
 0x00004000

	)

165 
	#EXT2_NOTAIL
 0x00008000

	)

166 
	#EXT2_DIRSYNC
 0x00010000

	)

167 
	#EXT2_TOPDIR
 0x00020000

	)

168 
	#EXT2_HUGE_FILE
 0x00040000

	)

169 
	#EXT2_EXTENTS
 0x00080000

	)

170 
	#EXT2_EOFBLOCKS
 0x00400000

	)

173 
	#EXT2_REV0_DINODE_SIZE
 (
ext2fs_döode
)

	)

174 
	#EXT2_DINODE_SIZE
(
fs
Ë((fs)->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 ? \

175 (
fs
)->
e2fs
.
e2fs_öode_size
 : \

176 
EXT2_REV0_DINODE_SIZE
)

	)

186 
	#e2di_rdev
 
e2di_blocks
[0]

	)

187 
	#e2di_sh‹éök
 
e2di_blocks


	)

190 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


191 
	#e2fs_ûﬂd
(
ﬁd
, 
√w
) \

192 
	`mem˝y
((
√w
),(
ﬁd
),(
ext2fs_döode
))

	)

193 
	#e2fs_ißve
(
ﬁd
, 
√w
) \

194 
	`mem˝y
((
√w
),(
ﬁd
),(
ext2fs_döode
))

	)

196 
e2fs_i_bsw≠
(
ext2fs_döode
 *, ext2fs_dinode *);

197 
	#e2fs_ûﬂd
(
ﬁd
, 
√w
Ë
	`e2fs_i_bsw≠
((ﬁd), (√w))

	)

198 
	#e2fs_ißve
(
ﬁd
, 
√w
Ë
	`e2fs_i_bsw≠
((ﬁd), (√w))

	)

	@ext2fs_dir.h

67 #i‚de‡
_UFS_EXT2FS_EXT2FS_DIR_H_


68 
	#_UFS_EXT2FS_EXT2FS_DIR_H_


	)

70 
	~<ufs/ext2fs/ext2fs_döode.h
>

77 
	#doff_t
 
öt32_t


	)

78 
	#EXT2FS_MAXDIRSIZE
 
INT32_MAX


	)

107 
	#EXT2FS_MAXNAMLEN
 255

	)

109 
	sext2fs_dúe˘
 {

110 
uöt32_t
 
	me2d_öo
;

111 
uöt16_t
 
	me2d_ª˛í
;

112 
uöt8_t
 
	me2d_«mÀn
;

113 
uöt8_t
 
	me2d_ty≥
;

114 
	me2d_«me
[
EXT2FS_MAXNAMLEN
];

118 
	#EXT2_FT_UNKNOWN
 0

	)

119 
	#EXT2_FT_REG_FILE
 1

	)

120 
	#EXT2_FT_DIR
 2

	)

121 
	#EXT2_FT_CHRDEV
 3

	)

122 
	#EXT2_FT_BLKDEV
 4

	)

123 
	#EXT2_FT_FIFO
 5

	)

124 
	#EXT2_FT_SOCK
 6

	)

125 
	#EXT2_FT_SYMLINK
 7

	)

127 
	#EXT2_FT_MAX
 8

	)

129 
	#E2IFTODT
(
mode
Ë(((modeË& 0170000Ë>> 12)

	)

131 
__ölöe
 
uöt8_t
 
	$öŸ2ext2dt
(
uöt16_t
Ë
__unu£d
;

132 
__ölöe
 
uöt8_t


133 
	$öŸ2ext2dt
(
uöt16_t
 
ty≥
)

136 
ty≥
) {

137 
	`E2IFTODT
(
EXT2_IFIFO
):

138  
EXT2_FT_FIFO
;

139 
	`E2IFTODT
(
EXT2_IFCHR
):

140  
EXT2_FT_CHRDEV
;

141 
	`E2IFTODT
(
EXT2_IFDIR
):

142  
EXT2_FT_DIR
;

143 
	`E2IFTODT
(
EXT2_IFBLK
):

144  
EXT2_FT_BLKDEV
;

145 
	`E2IFTODT
(
EXT2_IFREG
):

146  
EXT2_FT_REG_FILE
;

147 
	`E2IFTODT
(
EXT2_IFLNK
):

148  
EXT2_FT_SYMLINK
;

149 
	`E2IFTODT
(
EXT2_IFSOCK
):

150  
EXT2_FT_SOCK
;

154 
	}
}

163 
	#EXT2FS_DIRSIZ
(
Àn
Ë
	`roundup2
(8 +Üí, 4)

	)

169 
	sext2fs_dúãm∂©e
 {

170 
uöt32_t
 
	mdŸ_öo
;

171 
öt16_t
 
	mdŸ_ª˛í
;

172 
uöt8_t
 
	mdŸ_«mÀn
;

173 
uöt8_t
 
	mdŸ_ty≥
;

174 
	mdŸ_«me
[4];

175 
uöt32_t
 
	mdŸdŸ_öo
;

176 
öt16_t
 
	mdŸdŸ_ª˛í
;

177 
uöt8_t
 
	mdŸdŸ_«mÀn
;

178 
uöt8_t
 
	mdŸdŸ_ty≥
;

179 
	mdŸdŸ_«me
[4];

	@ext2fs_extents.c

1 
	~<sys/∑øm.h
>

2 
	~<sys/sy°m.h
>

3 
	~<sys/ªsour˚v¨.h
>

4 
	~<sys/kî√l.h
>

5 
	~<sys/fûe.h
>

6 
	~<sys/°©.h
>

7 
	~<sys/buf.h
>

8 
	~<sys/¥oc.h
>

9 
	~<sys/mou¡.h
>

10 
	~<sys/vnode.h
>

11 
	~<sys/sig«lv¨.h
>

12 
	~<sys/kauth.h
>

14 
	~<ufs/ufs/öode.h
>

15 
	~<ufs/ufs/ufsmou¡.h
>

16 
	~<ufs/ufs/ufs_exã∫.h
>

19 
	~<ufs/ext2fs/ext2fs.h
>

20 
	~<ufs/ext2fs/ext2fs_exã¡s.h
>

21 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

25 
boﬁ


26 
	$ext4_ext_bö£¨ch_ödex
(
öode
 *
ù
, 
ext4_exã¡_∑th
 *
∑th
,

27 
daddr_t
 
lbn
, daddr_à*
fú°_lbn
, daddr_à*
œ°_lbn
)

29 
	`¥ötf
("ext4_ext_binsearch_index\n");

30 
ext4_exã¡_hódî
 *
ehp
 = 
∑th
->
ï_hódî
;

31 
ext4_exã¡_ödex
 *
fú°
, *
œ°
, *
l
, *
r
, *
m
;

33 
fú°
 = (
ext4_exã¡_ödex
 *)(*)(
ehp
 + 1);

34 
œ°
 = 
fú°
 + 
ehp
->
eh_ecou¡
 - 1;

35 
l
 = 
fú°
;

36 
r
 = 
œ°
;

37 
l
 <
r
) {

38 
m
 = 
l
 + (
r
 -Ü) / 2;

39 i‡(
lbn
 < 
m
->
ei_blk
)

40 
r
 = 
m
 - 1;

42 
l
 = 
m
 + 1;

45 i‡(
l
 =
fú°
) {

46 
∑th
->
ï_•¨£_ext
.
e_blk
 = *
fú°_lbn
;

47 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
fú°
->
ei_blk
 - *
fú°_lbn
;

48 
∑th
->
ï_•¨£_ext
.
e_°¨t_hi
 = 0;

49 
∑th
->
ï_•¨£_ext
.
e_°¨t_lo
 = 0;

50 
∑th
->
ï_is_•¨£
 = 
åue
;

51  (
åue
);

53 
∑th
->
ï_ödex
 = 
l
 - 1;

54 *
fú°_lbn
 = 
∑th
->
ï_ödex
->
ei_blk
;

55 i‡(
∑th
->
ï_ödex
 < 
œ°
)

56 *
œ°_lbn
 = 
l
->
ei_blk
 - 1;

57  (
Ál£
);

58 
	}
}

61 
	$ext4_ext_bö£¨ch
(
öode
 *
ù
, 
ext4_exã¡_∑th
 *
∑th
, 
daddr_t
 
lbn
,

62 
daddr_t
 
fú°_lbn
, daddr_à
œ°_lbn
)

64 
	`¥ötf
("ext4_ext_binsearch\n");

65 
ext4_exã¡_hódî
 *
ehp
 = 
∑th
->
ï_hódî
;

66 
ext4_exã¡
 *
fú°
, *
l
, *
r
, *
m
;

68 i‡(
ehp
->
eh_ecou¡
 == 0)

71 
fú°
 = (
ext4_exã¡
 *)(*)(
ehp
 + 1);

72 
l
 = 
fú°
;

73 
r
 = 
fú°
 + 
ehp
->
eh_ecou¡
 - 1;

74 
l
 <
r
) {

75 
m
 = 
l
 + (
r
 -Ü) / 2;

76 i‡(
lbn
 < 
m
->
e_blk
)

77 
r
 = 
m
 - 1;

79 
l
 = 
m
 + 1;

82 i‡(
l
 =
fú°
) {

83 
∑th
->
ï_•¨£_ext
.
e_blk
 = 
fú°_lbn
;

84 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
fú°
->
e_blk
 - 
fú°_lbn
;

85 
∑th
->
ï_•¨£_ext
.
e_°¨t_hi
 = 0;

86 
∑th
->
ï_•¨£_ext
.
e_°¨t_lo
 = 0;

87 
∑th
->
ï_is_•¨£
 = 
åue
;

90 
∑th
->
ï_ext
 = 
l
 - 1;

91 i‡(
∑th
->
ï_ext
->
e_blk
 +Ö©h->ï_ext->
e_Àn
 <
lbn
) {

92 
∑th
->
ï_•¨£_ext
.
e_blk
 =Ö©h->
ï_ext
->e_blk +

93 
∑th
->
ï_ext
->
e_Àn
;

94 i‡(
l
 <(
fú°
 + 
ehp
->
eh_ecou¡
 - 1))

95 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
l
->
e_blk
 -

96 
∑th
->
ï_•¨£_ext
.
e_blk
;

98 
∑th
->
ï_•¨£_ext
.
e_Àn
 = 
œ°_lbn
 -

99 
∑th
->
ï_•¨£_ext
.
e_blk
 + 1;

100 
∑th
->
ï_•¨£_ext
.
e_°¨t_hi
 = 0;

101 
∑th
->
ï_•¨£_ext
.
e_°¨t_lo
 = 0;

102 
∑th
->
ï_is_•¨£
 = 
åue
;

104 
	}
}

110 
	$ext4_ext_ö_ˇche
(
öode
 *
ù
, 
daddr_t
 
lbn
, 
ext4_exã¡
 *
ï
)

112 
	`¥ötf
("ext4_ext_in_cache\n");

113 
ext4_exã¡_ˇche
 *
e˝
;

114 
ªt
 = 
EXT4_EXT_CACHE_NO
;

116 
e˝
 = &
ù
->
öode_ext
.
e2fs
.
i_ext_ˇche
;

119 i‡(
e˝
->
ec_ty≥
 =
EXT4_EXT_CACHE_NO
)

120  (
ªt
);

122 i‡(
lbn
 >
e˝
->
ec_blk
 &&Üb¿<É˝->ec_blk +É˝->
ec_Àn
) {

123 
ï
->
e_blk
 = 
e˝
->
ec_blk
;

124 
ï
->
e_°¨t_lo
 = 
e˝
->
ec_°¨t
 & 0xffffffff;

125 
ï
->
e_°¨t_hi
 = 
e˝
->
ec_°¨t
 >> 32 & 0xffff;

126 
ï
->
e_Àn
 = 
e˝
->
ec_Àn
;

127 
ªt
 = 
e˝
->
ec_ty≥
;

129  (
ªt
);

130 
	}
}

136 
	$ext4_ext_put_ˇche
(
öode
 *
ù
, 
ext4_exã¡
 *
ï
, 
ty≥
)

138 
	`¥ötf
("ext4_ext_put_cache\n");

139 
ext4_exã¡_ˇche
 *
e˝
;

141 
e˝
 = &
ù
->
öode_ext
.
e2fs
.
i_ext_ˇche
;

142 
e˝
->
ec_ty≥
 = 
ty≥
;

143 
e˝
->
ec_blk
 = 
ï
->
e_blk
;

144 
e˝
->
ec_Àn
 = 
ï
->
e_Àn
;

145 
e˝
->
ec_°¨t
 = (
daddr_t
)
ï
->
e_°¨t_hi
 << 32 |Ép->
e_°¨t_lo
;

146 
	}
}

151 
ext4_exã¡_∑th
 *

152 
	$ext4_ext_föd_exã¡
(
m_ext2fs
 *
fs
, 
öode
 *
ù
,

153 
daddr_t
 
lbn
, 
ext4_exã¡_∑th
 *
∑th
)

155 
	`¥ötf
("insideÉxt4_ext_find_extent\n");

156 
ext4_exã¡_hódî
 *
ehp
;

157 
uöt16_t
 
i
;

158 
îr‹
, 
size
;

159 
daddr_t
 
nblk
;

161 
ehp
 = (
ext4_exã¡_hódî
 *)(*)
ù
->
i_dö
.
e2fs_dö
->
e2di_blocks
;

163 i‡(
ehp
->
eh_magic
 !
EXT4_EXT_MAGIC
)

164  (
NULL
);

166 
∑th
->
ï_hódî
 = 
ehp
;

168 
daddr_t
 
fú°_lbn
 = 0;

169 
daddr_t
 
œ°_lbn
 = 
	`lblkno
(
ù
->
i_e2fs
, ip->
i_size
);

171 
i
 = 
ehp
->
eh_dïth
; i != 0; --i) {

172 
∑th
->
ï_dïth
 = 
i
;

173 
∑th
->
ï_ext
 = 
NULL
;

174 i‡(
	`ext4_ext_bö£¨ch_ödex
(
ù
, 
∑th
, 
lbn
, &
fú°_lbn
,

175 &
œ°_lbn
)) {

176  (
∑th
);

179 
nblk
 = (
daddr_t
)
∑th
->
ï_ödex
->
ei_Àaf_hi
 << 32 |

180 
∑th
->
ï_ödex
->
ei_Àaf_lo
;

181 
size
 = 
	`blksize
(
fs
, 
ù
, 
nblk
);

182 i‡(
∑th
->
ï_bp
 !
NULL
) {

183 
	`bªl£
(
∑th
->
ï_bp
,0);

184 
∑th
->
ï_bp
 = 
NULL
;

186 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
, 
	`fsbtodb
(
fs
, 
nblk
), 
size
, 0,

187 &
∑th
->
ï_bp
);

188 i‡(
îr‹
) {

189 
	`bªl£
(
∑th
->
ï_bp
,0);

190 
∑th
->
ï_bp
 = 
NULL
;

191  (
NULL
);

193 
ehp
 = (
ext4_exã¡_hódî
 *)
∑th
->
ï_bp
->
b_d©a
;

194 
∑th
->
ï_hódî
 = 
ehp
;

197 
∑th
->
ï_dïth
 = 
i
;

198 
∑th
->
ï_ext
 = 
NULL
;

199 
∑th
->
ï_ödex
 = 
NULL
;

200 
∑th
->
ï_is_•¨£
 = 
Ál£
;

202 
	`ext4_ext_bö£¨ch
(
ù
, 
∑th
, 
lbn
, 
fú°_lbn
, 
œ°_lbn
);

203  (
∑th
);

204 
	}
}

	@ext2fs_extents.h

1 #i‚de‡
_FS_EXT2FS_EXT2_EXTENTS_H_


2 
	#_FS_EXT2FS_EXT2_EXTENTS_H_


	)

4 
	~<sys/ty≥s.h
>

5 
	~<ufs/ufs/öode.h
>

6 
	#EXT4_EXT_MAGIC
 0xf30a

	)

8 
	#EXT4_EXT_CACHE_NO
 0

	)

9 
	#EXT4_EXT_CACHE_GAP
 1

	)

10 
	#EXT4_EXT_CACHE_IN
 2

	)

15 
	sext4_exã¡
 {

16 
uöt32_t
 
	me_blk
;

17 
uöt16_t
 
	me_Àn
;

18 
uöt16_t
 
	me_°¨t_hi
;

19 
uöt32_t
 
	me_°¨t_lo
;

25 
	sext4_exã¡_ödex
 {

26 
uöt32_t
 
	mei_blk
;

27 
uöt32_t
 
	mei_Àaf_lo
;

29 
uöt16_t
 
	mei_Àaf_hi
;

30 
uöt16_t
 
	mei_unu£d
;

36 
	sext4_exã¡_hódî
 {

37 
uöt16_t
 
	meh_magic
;

38 
uöt16_t
 
	meh_ecou¡
;

39 
uöt16_t
 
	meh_max
;

40 
uöt16_t
 
	meh_dïth
;

41 
uöt32_t
 
	meh_gí
;

47 
	sext4_exã¡_ˇche
 {

48 
daddr_t
 
	mec_°¨t
;

49 
uöt32_t
 
	mec_blk
;

50 
uöt32_t
 
	mec_Àn
;

51 
uöt32_t
 
	mec_ty≥
;

57 
	sext4_exã¡_∑th
 {

58 
uöt16_t
 
	mï_dïth
;

59 
buf
 *
	mï_bp
;

60 
boﬁ
 
	mï_is_•¨£
;

62 
ext4_exã¡
 
	mï_•¨£_ext
;

63 
ext4_exã¡
 *
	mï_ext
;

65 
ext4_exã¡_ödex
 *
	mï_ödex
;

66 
ext4_exã¡_hódî
 *
	mï_hódî
;

69 
	göode
;

70 
	gm_ext2fs
;

71 
ext4_ext_ö_ˇche
(
öode
 *, 
daddr_t
, 
ext4_exã¡
 *);

72 
ext4_ext_put_ˇche
(
öode
 *, 
ext4_exã¡
 *, );

73 
ext4_exã¡_∑th
 *
ext4_ext_föd_exã¡
(
m_ext2fs
 *
fs
,

74 
öode
 *, 
daddr_t
, 
ext4_exã¡_∑th
 *);

	@ext2fs_extern.h

62 #i‚de‡
_UFS_EXT2FS_EXT2FS_EXTERN_H_


63 
	#_UFS_EXT2FS_EXT2FS_EXTERN_H_


	)

65 
	gbuf
;

66 
	gfid
;

67 
	gm_ext2fs
;

68 
	göode
;

69 
	gmou¡
;

70 
	g«meid©a
;

71 
	glwp
;

72 
	g¥oc
;

73 
	g°©vfs
;

74 
	gtimevÆ
;

75 
	gufsmou¡
;

76 
	guio
;

77 
	gvnode
;

78 
	gmbuf
;

79 
	gcomp⁄íäame
;

80 
	gufs_lookup_ªsu…s
;

82 
poﬁ
 
ext2fs_öode_poﬁ
;

83 
poﬁ
 
ext2fs_döode_poﬁ
;

85 
	#EXT2FS_ITIMES
(
ù
, 
acc
, 
mod
, 
¸e
) \

86 (
ù
)->
i_Êag
 & (
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFY
)) \

87 
	`ext2fs_ôimes
(
ù
, 
acc
, 
mod
, 
¸e
)

	)

89 
__BEGIN_DECLS


92 
ext2fs_Æloc
(
öode
 *, 
daddr_t
, daddr_à, 
kauth_¸ed_t
,

93 
daddr_t
 *);

94 
ext2fs_ªÆloccg
(
öode
 *, 
daddr_t
, daddr_t, , ,

95 
kauth_¸ed_t
, 
buf
 **);

96 
ext2fs_vÆloc
(
vnode
 *, , 
kauth_¸ed_t
, vnode **);

98 
daddr_t
 
ext2fs_blk¥ef
(
öode
 *, daddr_t, , 
öt32_t
 *);

99 
ext2fs_blk‰ì
(
öode
 *, 
daddr_t
);

100 
ext2fs_v‰ì
(
vnode
 *, 
öo_t
, );

103 
ext2fs_bÆloc
(
öode
 *, 
daddr_t
, , 
kauth_¸ed_t
,

104 
buf
 **, );

105 
ext2fs_g›_Æloc
(
vnode
 *, 
off_t
, off_t, , 
kauth_¸ed_t
);

108 
ext2fs_bm≠
(*);

111 
uöt64_t
 
ext2fs_size
(
öode
 *);

112 
ext2fs_£tsize
(
öode
 *, 
uöt64_t
);

113 
uöt64_t
 
ext2fs_nblock
(
öode
 *);

114 
ext2fs_£äblock
(
öode
 *, 
uöt64_t
);

115 
ext2fs_upd©e
(
vnode
 *, c⁄° 
time•ec
 *,

116 c⁄° 
time•ec
 *, );

117 
ext2fs_åunˇã
(
vnode
 *, 
off_t
, , 
kauth_¸ed_t
);

118 
ext2fs_öa˘ive
(*);

121 
ext2fs_ªaddú
(*);

122 
ext2fs_lookup
(*);

123 
ext2fs_dúíãr
(
öode
 *, 
vnode
 *,

124 c⁄° 
ufs_lookup_ªsu…s
 *,

125 
comp⁄íäame
 *);

126 
ext2fs_dúªmove
(
vnode
 *, c⁄° 
ufs_lookup_ªsu…s
 *,

127 
comp⁄íäame
 *);

128 
ext2fs_dúªwrôe
(
öode
 *, c⁄° 
ufs_lookup_ªsu…s
 *,

129 
öode
 *, 
comp⁄íäame
 *);

130 
ext2fs_dúem±y
(
öode
 *, 
öo_t
, 
kauth_¸ed_t
);

133 
ext2fs_blk©off
(
vnode
 *, 
off_t
, **, 
buf
 **);

134 
ext2fs_‰agac˘
(
m_ext2fs
 *, , 
öt32_t
[], );

135 
ext2fs_ôimes
(
öode
 *, c⁄° 
time•ec
 *,

136 c⁄° 
time•ec
 *, const timespec *);

139 
VFS_PROTOS
(
ext2fs
);

140 
ext2fs_ªlﬂd
(
mou¡
 *, 
kauth_¸ed_t
, 
lwp
 *);

141 
ext2fs_mou¡fs
(
vnode
 *, 
mou¡
 *);

142 
ext2fs_Êushfûes
(
mou¡
 *, );

143 
ext2fs_sbupd©e
(
ufsmou¡
 *, );

144 
ext2fs_cgupd©e
(
ufsmou¡
 *, );

145 
ext2fs_£t_öode_guid
(
öode
 *);

148 
ext2fs_ªad
(*);

149 
ext2fs_wrôe
(*);

150 
ext2fs_bu‰d
(
vnode
 *, 
uio
 *, , 
kauth_¸ed_t
);

151 
ext2fs_bufwr
(
vnode
 *, 
uio
 *, , 
kauth_¸ed_t
);

154 
ext2fs_¸óã
(*);

155 
ext2fs_mknod
(*);

156 
ext2fs_›í
(*);

157 
ext2fs_ac˚ss
(*);

158 
ext2fs_gë©å
(*);

159 
ext2fs_£èâr
(*);

160 
ext2fs_ªmove
(*);

161 
ext2fs_lök
(*);

162 
ext2fs_ª«me
(*);

163 
ext2fs_mkdú
(*);

164 
ext2fs_rmdú
(*);

165 
ext2fs_symlök
(*);

166 
ext2fs_ªadlök
(*);

167 
ext2fs_advlock
(*);

168 
ext2fs_fsync
(*);

169 
ext2fs_vöô
(
mou¡
 *, (**
•ec›s
)(*),

170 (**
fifo›s
)(*), 
vnode
 **);

171 
	`ext2fs_makeöode
(, 
vnode
 *, vnode **,

172 
comp⁄íäame
 *
˙p
);

173 
	`ext2fs_ª˛aim
(*);

175 
__END_DECLS


177 
	#IS_EXT2_VNODE
(
vp
Ë(vp->
v_èg
 =
VT_EXT2FS
)

	)

179 (**
ext2fs_vnode›_p
)(*);

180 (**
ext2fs_•ec›_p
)(*);

181 (**
ext2fs_fifo›_p
)(*);

	@ext2fs_inode.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_inode.c,v 1.82 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/mou¡.h
>

68 
	~<sys/¥oc.h
>

69 
	~<sys/fûe.h
>

70 
	~<sys/buf.h
>

71 
	~<sys/vnode.h
>

72 
	~<sys/kî√l.h
>

73 
	~<sys/kmem.h
>

74 
	~<sys/åa˚.h
>

75 
	~<sys/ªsour˚v¨.h
>

76 
	~<sys/kauth.h
>

78 
	~<ufs/ufs/öode.h
>

79 
	~<ufs/ufs/ufsmou¡.h
>

80 
	~<ufs/ufs/ufs_exã∫.h
>

82 
	~<ufs/ext2fs/ext2fs.h
>

83 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

85 
¥è˘ive
;

87 
ext2fs_ödúåunc
(
öode
 *, 
daddr_t
, daddr_t,

88 
daddr_t
, , *);

95 
CTASSERT
(
EXT2FS_NDADDR
 =
UFS_NDADDR
);

96 
CTASSERT
(
EXT2FS_NIADDR
 =
UFS_NIADDR
);

101 
uöt64_t


102 
	$ext2fs_size
(
öode
 *
ù
)

104 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

105 
uöt64_t
 
size
 = 
ù
->
i_e2fs_size
;

107 i‡((
ù
->
i_e2fs_mode
 & 
IFMT
Ë=
IFREG
)

108 
size
 |(
uöt64_t
)
ù
->
i_e2fs_da˛
 << 32;

109  
size
;

110 
	}
}

113 
	$ext2fs_£tsize
(
öode
 *
ù
, 
uöt64_t
 
size
)

115 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

116 i‡((
ù
->
i_e2fs_mode
 & 
IFMT
Ë=
IFREG
 ||

117 
ù
->
i_e2fs_mode
 == 0) {

118 
ù
->
i_e2fs_da˛
 = 
size
 >> 32;

119 i‡(
size
 >= 0x80000000U) {

120 
m_ext2fs
 *
fs
 = 
ù
->
i_e2fs
;

122 i‡(
fs
->
e2fs
.
e2fs_ªv
 <
E2FS_REV0
) {

124  
EFBIG
;

126 i‡(!(
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t


127 & 
EXT2F_ROCOMPAT_LARGEFILE
)) {

128 
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
 |=

129 
EXT2F_ROCOMPAT_LARGEFILE
;

130 
fs
->
e2fs_fmod
 = 1;

133 } i‡(
size
 >= 0x80000000U)

134  
EFBIG
;

136 
ù
->
i_e2fs_size
 = 
size
;

139 
	}
}

141 
uöt64_t


142 
	$ext2fs_nblock
(
öode
 *
ù
)

144 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

145 
uöt64_t
 
nblock
 = 
ù
->
i_e2fs_nblock
;

146 
m_ext2fs
 * c⁄° 
fs
 = 
ù
->
i_e2fs
;

148 i‡(
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
 & 
EXT2F_ROCOMPAT_HUGE_FILE
) {

149 
nblock
 |(
uöt64_t
)
ù
->
i_e2fs_nblock_high
 << 32;

151 i‡((
ù
->
i_e2fs_Êags
 & 
EXT2_HUGE_FILE
)) {

152 
nblock
 = 
	`EXT2_FSBTODB
(
fs
,Çblock);

156  
nblock
;

157 
	}
}

160 
	$ext2fs_£äblock
(
öode
 *
ù
, 
uöt64_t
 
nblock
)

162 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

163 
m_ext2fs
 * c⁄° 
fs
 = 
ù
->
i_e2fs
;

165 i‡(
nblock
 <= 0xffffffffULL) {

166 
	`CLR
(
ù
->
i_e2fs_Êags
, 
EXT2_HUGE_FILE
);

167 
ù
->
i_e2fs_nblock
 = 
nblock
;

171 i‡(!
	`ISSET
(
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
, 
EXT2F_ROCOMPAT_HUGE_FILE
))

172  
EFBIG
;

174 i‡(
nblock
 <= 0xffffffffffffULL) {

175 
	`CLR
(
ù
->
i_e2fs_Êags
, 
EXT2_HUGE_FILE
);

176 
ù
->
i_e2fs_nblock
 = 
nblock
 & 0xffffffff;

177 
ù
->
i_e2fs_nblock_high
 = (
nblock
 >> 32) & 0xffff;

181 i‡(
	`EXT2_DBTOFSB
(
fs
, 
nblock
) <= 0xffffffffffffULL) {

182 
	`SET
(
ù
->
i_e2fs_Êags
, 
EXT2_HUGE_FILE
);

183 
ù
->
i_e2fs_nblock
 = 
	`EXT2_DBTOFSB
(
fs
, 
nblock
) & 0xffffffff;

184 
ù
->
i_e2fs_nblock_high
 = (
	`EXT2_DBTOFSB
(
fs
, 
nblock
) >> 32) & 0xffff;

188  
EFBIG
;

189 
	}
}

195 
	$ext2fs_öa˘ive
(*
v
)

197 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

198 
v›_öa˘ive_¨gs


201  *
≠
 = 
v
;

202 
vnode
 *
vp
 = 
≠
->
a_vp
;

203 
öode
 *
ù
 = 
	`VTOI
(
vp
);

204 
îr‹
 = 0;

206 i‡(
¥è˘ive
 && 
vp
->
v_u£cou¡
 != 0)

207 
	`v¥öt
("ext2fs_öa˘ive:Öushögá˘ive", 
vp
);

209 i‡(
ù
->
i_e2fs_mode
 =0 || ip->
i_e2fs_dtime
 != 0)

210 
out
;

212 
îr‹
 = 0;

213 i‡(
ù
->
i_e2fs_∆ök
 =0 && (
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
) == 0) {

215 i‡(
	`ext2fs_size
(
ù
) != 0) {

216 
îr‹
 = 
	`ext2fs_åunˇã
(
vp
, (
off_t
)0, 0, 
NOCRED
);

218 
ù
->
i_e2fs_dtime
 = 
time_£c⁄d
;

219 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

220 
ù
->
i_omode
 = 1;

222 i‡(
ù
->
i_Êag
 & (
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFIED
)) {

223 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 0);

225 
out
:

230 *
≠
->
a_ªcy˛e
 = (
ù
->
i_e2fs_dtime
 != 0);

231 
	`VOP_UNLOCK
(
vp
);

232  (
îr‹
);

233 
	}
}

246 
	$ext2fs_upd©e
(
vnode
 *
vp
, c⁄° 
time•ec
 *
acc
,

247 c⁄° 
time•ec
 *
mod
, 
updÊags
)

249 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

250 
m_ext2fs
 *
fs
;

251 
buf
 *
bp
;

252 
öode
 *
ù
;

253 
îr‹
;

254 *
˝
;

255 
Êags
;

257 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

259 
ù
 = 
	`VTOI
(
vp
);

260 
	`EXT2FS_ITIMES
(
ù
, 
acc
, 
mod
, 
NULL
);

261 i‡(
updÊags
 & 
UPDATE_CLOSE
)

262 
Êags
 = 
ù
->
i_Êag
 & (
IN_MODIFIED
 | 
IN_ACCESSED
);

264 
Êags
 = 
ù
->
i_Êag
 & 
IN_MODIFIED
;

265 i‡(
Êags
 == 0)

267 
fs
 = 
ù
->
i_e2fs
;

269 
îr‹
 = 
	`bªad
(
ù
->
i_devvp
,

270 
	`EXT2_FSBTODB
(
fs
, 
	`öo_to_fsba
(fs, 
ù
->
i_numbî
)),

271 ()
fs
->
e2fs_bsize
, 
B_MODIFY
, &
bp
);

272 i‡(
îr‹
) {

273  (
îr‹
);

275 
ù
->
i_Êag
 &~(
IN_MODIFIED
 | 
IN_ACCESSED
);

276 
˝
 = (*)
bp
->
b_d©a
 +

277 (
	`öo_to_fsbo
(
fs
, 
ù
->
i_numbî
Ë* 
	`EXT2_DINODE_SIZE
(fs));

278 
	`e2fs_ißve
(
ù
->
i_dö
.
e2fs_dö
, (
ext2fs_döode
 *)
˝
);

279 i‡((
updÊags
 & (
UPDATE_WAIT
|
UPDATE_DIROP
)) != 0 &&

280 (
Êags
 & 
IN_MODIFIED
) != 0 &&

281 (
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_ASYNC
) == 0)

282  (
	`bwrôe
(
bp
));

284 
	`bdwrôe
(
bp
);

287 
	}
}

289 
	#SINGLE
 0

	)

290 
	#DOUBLE
 1

	)

291 
	#TRIPLE
 2

	)

297 
	$ext2fs_åunˇã
(
vnode
 *
ovp
, 
off_t
 
Àngth
, 
ioÊag
,

298 
kauth_¸ed_t
 
¸ed
)

300 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

301 
daddr_t
 
œ°block
;

302 
öode
 *
où
 = 
	`VTOI
(
ovp
);

303 
daddr_t
 
bn
, 
œ°iblock
[
EXT2FS_NIADDR
], 
ödú_lbn
[EXT2FS_NIADDR];

305 
öt32_t
 
ﬁdblks
[
EXT2FS_NDADDR
 + 
EXT2FS_NIADDR
], 
√wblks
[EXT2FS_NDADDR + EXT2FS_NIADDR];

306 
m_ext2fs
 *
fs
;

307 
off£t
, 
size
, 
Àvñ
;

308 
cou¡
, 
block§ñó£d
 = 0;

309 
i
, 
nblocks
;

310 
îr‹
, 
ÆÀº‹
 = 0;

311 
off_t
 
osize
;

312 
sync
;

313 
ufsmou¡
 *
ump
 = 
où
->
i_ump
;

315 i‡(
ovp
->
v_ty≥
 =
VCHR
 || ovp->v_ty≥ =
VBLK
 ||

316 
ovp
->
v_ty≥
 =
VFIFO
 || ovp->v_ty≥ =
VSOCK
) {

320 i‡(
Àngth
 < 0)

321  (
EINVAL
);

323 i‡(
ovp
->
v_ty≥
 =
VLNK
 &&

324 (
	`ext2fs_size
(
où
Ë< 
ump
->
um_maxsymlökÀn
 ||

325 (
ump
->
um_maxsymlökÀn
 =0 && 
	`ext2fs_nblock
(
où
) == 0))) {

326 
	`KDASSERT
(
Àngth
 == 0);

327 
	`mem£t
((*)&
où
->
i_dö
.
e2fs_dö
->
e2di_sh‹éök
, 0,

328 (
u_öt
)
	`ext2fs_size
(
où
));

329 ()
	`ext2fs_£tsize
(
où
, 0);

330 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

331  (
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 0));

333 i‡(
	`ext2fs_size
(
où
Ë=
Àngth
) {

335 
	`uvm_v≈_£tsize
(
ovp
, 
Àngth
);

336 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

337  (
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 0));

339 
fs
 = 
où
->
i_e2fs
;

340 i‡(
Àngth
 > 
ump
->
um_maxfûesize
)

341  (
EFBIG
);

343 
osize
 = 
	`ext2fs_size
(
où
);

350 i‡(
osize
 < 
Àngth
) {

351 
	`uvm_v≈_£twrôesize
(
ovp
, 
Àngth
);

352 
îr‹
 = 
	`ufs_bÆloc_ønge
(
ovp
, 
Àngth
 - 1, 1, 
¸ed
,

353 
ioÊag
 & 
IO_SYNC
 ? 
B_SYNC
 : 0);

354 i‡(
îr‹
) {

355 (Ë
	`ext2fs_åunˇã
(
ovp
, 
osize
, 
ioÊag
 & 
IO_SYNC
,

356 
¸ed
);

357  (
îr‹
);

359 
	`uvm_v≈_£tsize
(
ovp
, 
Àngth
);

360 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

361 
	`KASSERT
(
îr‹
 || 
ovp
->
v_size
 =
	`ext2fs_size
(
où
));

362  (
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 0));

371 
off£t
 = 
	`ext2_blkoff
(
fs
, 
Àngth
);

372 i‡(
off£t
 != 0) {

373 
size
 = 
fs
->
e2fs_bsize
;

376 
	`ubc_zî‹™ge
(&
ovp
->
v_uobj
, 
Àngth
, 
size
 - 
off£t
,

377 
	`UBC_UNMAP_FLAG
(
ovp
));

379 ()
	`ext2fs_£tsize
(
où
, 
Àngth
);

380 
	`uvm_v≈_£tsize
(
ovp
, 
Àngth
);

387 
œ°block
 = 
	`ext2_lblkno
(
fs
, 
Àngth
 + fs->
e2fs_bsize
 - 1) - 1;

388 
œ°iblock
[
SINGLE
] = 
œ°block
 - 
EXT2FS_NDADDR
;

389 
œ°iblock
[
DOUBLE
] =Üa°iblock[
SINGLE
] - 
	`EXT2_NINDIR
(
fs
);

390 
œ°iblock
[
TRIPLE
] =Üa°iblock[
DOUBLE
] - 
	`EXT2_NINDIR
(
fs
) * EXT2_NINDIR(fs);

391 
nblocks
 = 
	`btodb
(
fs
->
e2fs_bsize
);

398 
	`mem˝y
((*)
ﬁdblks
, (*)&
où
->
i_e2fs_blocks
[0],  oldblks);

399 
sync
 = 0;

400 
Àvñ
 = 
TRIPLE
;Üevñ >
SINGLE
;Üevel--) {

401 i‡(
œ°iblock
[
Àvñ
] < 0 && 
ﬁdblks
[
EXT2FS_NDADDR
 +Üevel] != 0) {

402 
sync
 = 1;

403 
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
] = 0;

404 
œ°iblock
[
Àvñ
] = -1;

407 
i
 = 0; i < 
EXT2FS_NDADDR
; i++) {

408 i‡(
i
 > 
œ°block
 && 
ﬁdblks
[i] != 0) {

409 
sync
 = 1;

410 
où
->
i_e2fs_blocks
[
i
] = 0;

413 
où
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

414 i‡(
sync
) {

415 
îr‹
 = 
	`ext2fs_upd©e
(
ovp
, 
NULL
, NULL, 
UPDATE_WAIT
);

416 i‡(
îr‹
 && !
ÆÀº‹
)

417 
ÆÀº‹
 = 
îr‹
;

426 
	`mem˝y
((*)
√wblks
, (*)&
où
->
i_e2fs_blocks
[0], Çewblks);

427 
	`mem˝y
((*)&
où
->
i_e2fs_blocks
[0], (*)
ﬁdblks
,  oldblks);

429 ()
	`ext2fs_£tsize
(
où
, 
osize
);

430 
îr‹
 = 
	`våuncbuf
(
ovp
, 
œ°block
 + 1, 0, 0);

431 i‡(
îr‹
 && !
ÆÀº‹
)

432 
ÆÀº‹
 = 
îr‹
;

437 
ödú_lbn
[
SINGLE
] = -
EXT2FS_NDADDR
;

438 
ödú_lbn
[
DOUBLE
] = indú_lbn[
SINGLE
] - 
	`EXT2_NINDIR
(
fs
) -1;

439 
ödú_lbn
[
TRIPLE
] = indú_lbn[
DOUBLE
] - 
	`EXT2_NINDIR
(
fs
) * EXT2_NINDIR(fs) - 1;

440 
Àvñ
 = 
TRIPLE
;Üevñ >
SINGLE
;Üevel--) {

442 
bn
 = 
	`fs2h32
(
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
]);

443 i‡(
bn
 != 0) {

444 
îr‹
 = 
	`ext2fs_ödúåunc
(
où
, 
ödú_lbn
[
Àvñ
],

445 
	`EXT2_FSBTODB
(
fs
, 
bn
), 
œ°iblock
[
Àvñ
],Üevñ, &
cou¡
);

446 i‡(
îr‹
)

447 
ÆÀº‹
 = 
îr‹
;

448 
block§ñó£d
 +
cou¡
;

449 i‡(
œ°iblock
[
Àvñ
] < 0) {

450 
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
] = 0;

451 
	`ext2fs_blk‰ì
(
où
, 
bn
);

452 
block§ñó£d
 +
nblocks
;

455 i‡(
œ°iblock
[
Àvñ
] >= 0)

456 
d⁄e
;

462 
i
 = 
EXT2FS_NDADDR
 - 1; i > 
œ°block
; i--) {

464 
bn
 = 
	`fs2h32
(
où
->
i_e2fs_blocks
[
i
]);

465 i‡(
bn
 == 0)

467 
où
->
i_e2fs_blocks
[
i
] = 0;

468 
	`ext2fs_blk‰ì
(
où
, 
bn
);

469 
block§ñó£d
 +
	`btodb
(
fs
->
e2fs_bsize
);

472 
d⁄e
:

473 #ifde‡
DIAGNOSTIC


474 
Àvñ
 = 
SINGLE
;Üevñ <
TRIPLE
;Üevel++)

475 i‡(
√wblks
[
EXT2FS_NDADDR
 + 
Àvñ
] !=

476 
où
->
i_e2fs_blocks
[
EXT2FS_NDADDR
 + 
Àvñ
])

477 
	`∑nic
("ext2fs_truncate1");

478 
i
 = 0; i < 
EXT2FS_NDADDR
; i++)

479 i‡(
√wblks
[
i
] !
où
->
i_e2fs_blocks
[i])

480 
	`∑nic
("ext2fs_truncate2");

481 i‡(
Àngth
 == 0 &&

482 (!
	`LIST_EMPTY
(&
ovp
->
v_˛ónblkhd
) ||

483 !
	`LIST_EMPTY
(&
ovp
->
v_dútyblkhd
)))

484 
	`∑nic
("ext2fs_truncate3");

489 ()
	`ext2fs_£tsize
(
où
, 
Àngth
);

490 
îr‹
 = 
	`ext2fs_£äblock
(
où
, 
	`ext2fs_nblock
(oùË- 
block§ñó£d
);

491 i‡(
îr‹
 != 0)

492 
ÆÀº‹
 = 
îr‹
;

493 
où
->
i_Êag
 |
IN_CHANGE
;

494 
	`KASSERT
(
ovp
->
v_ty≥
 !
VREG
 || ovp->
v_size
 =
	`ext2fs_size
(
où
));

495  (
ÆÀº‹
);

496 
	}
}

508 
	$ext2fs_ödúåunc
(
öode
 *
ù
, 
daddr_t
 
lbn
, daddr_à
dbn
, daddr_à
œ°bn
,

509 
Àvñ
, *
cou¡p
)

511 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

512 
i
;

513 
buf
 *
bp
;

514 
m_ext2fs
 *
fs
 = 
ù
->
i_e2fs
;

515 
öt32_t
 *
b≠
;

516 
vnode
 *
vp
;

517 
daddr_t
 
nb
, 
∆bn
, 
œ°
;

518 
öt32_t
 *
c›y
 = 
NULL
;

519 
blkcou¡
, 
Á˘‹
;

520 
nblocks
, 
block§ñó£d
 = 0;

521 
îr‹
 = 0, 
ÆÀº‹
 = 0;

528 
Á˘‹
 = 1;

529 
i
 = 
SINGLE
; i < 
Àvñ
; i++)

530 
Á˘‹
 *
	`EXT2_NINDIR
(
fs
);

531 
œ°
 = 
œ°bn
;

532 i‡(
œ°bn
 > 0)

533 
œ°
 /
Á˘‹
;

534 
nblocks
 = 
	`btodb
(
fs
->
e2fs_bsize
);

543 
vp
 = 
	`ITOV
(
ù
);

544 
bp
 = 
	`gëblk
(
vp
, 
lbn
, ()
fs
->
e2fs_bsize
, 0, 0);

545 i‡(
bp
->
b_oÊags
 & (
BO_DONE
 | 
BO_DELWRI
)) {

547 
	`åa˚
(
TR_BREADHIT
, 
	`∑ck
(
vp
, 
fs
->
e2fs_bsize
), 
lbn
);

549 
	`åa˚
(
TR_BREADMISS
, 
	`∑ck
(
vp
, 
fs
->
e2fs_bsize
), 
lbn
);

550 
cuæwp
->
l_ru
.
ru_öblock
++;

551 
bp
->
b_Êags
 |
B_READ
;

552 i‡(
bp
->
b_bcou¡
 > bp->
b_bufsize
)

553 
	`∑nic
("ext2fs_indirtrunc: bad buffer size");

554 
bp
->
b_blkno
 = 
dbn
;

555 
	`VOP_STRATEGY
(
vp
, 
bp
);

556 
îr‹
 = 
	`biowaô
(
bp
);

558 i‡(
îr‹
) {

559 
	`bªl£
(
bp
, 0);

560 *
cou¡p
 = 0;

561  (
îr‹
);

564 
b≠
 = (
öt32_t
 *)
bp
->
b_d©a
;

565 i‡(
œ°bn
 >= 0) {

567 
c›y
 = 
	`kmem_Æloc
(
fs
->
e2fs_bsize
, 
KM_SLEEP
);

568 
	`mem˝y
((*)
c›y
, (*)
b≠
, (
u_öt
)
fs
->
e2fs_bsize
);

569 
	`mem£t
((*)&
b≠
[
œ°
 + 1], 0,

570 (
u_öt
)(
	`EXT2_NINDIR
(
fs
Ë- (
œ°
 + 1)Ë*  (
uöt32_t
));

571 
îr‹
 = 
	`bwrôe
(
bp
);

572 i‡(
îr‹
)

573 
ÆÀº‹
 = 
îr‹
;

574 
b≠
 = 
c›y
;

580 
i
 = 
	`EXT2_NINDIR
(
fs
) - 1,

581 
∆bn
 = 
lbn
 + 1 - 
i
 * 
Á˘‹
; i > 
œ°
;

582 
i
--, 
∆bn
 +
Á˘‹
) {

584 
nb
 = 
	`fs2h32
(
b≠
[
i
]);

585 i‡(
nb
 == 0)

587 i‡(
Àvñ
 > 
SINGLE
) {

588 
îr‹
 = 
	`ext2fs_ödúåunc
(
ù
, 
∆bn
, 
	`EXT2_FSBTODB
(
fs
, 
nb
),

589 (
daddr_t
)-1, 
Àvñ
 - 1,

590 &
blkcou¡
);

591 i‡(
îr‹
)

592 
ÆÀº‹
 = 
îr‹
;

593 
block§ñó£d
 +
blkcou¡
;

595 
	`ext2fs_blk‰ì
(
ù
, 
nb
);

596 
block§ñó£d
 +
nblocks
;

602 i‡(
Àvñ
 > 
SINGLE
 && 
œ°bn
 >= 0) {

603 
œ°
 = 
œ°bn
 % 
Á˘‹
;

605 
nb
 = 
	`fs2h32
(
b≠
[
i
]);

606 i‡(
nb
 != 0) {

607 
îr‹
 = 
	`ext2fs_ödúåunc
(
ù
, 
∆bn
, 
	`EXT2_FSBTODB
(
fs
, 
nb
),

608 
œ°
, 
Àvñ
 - 1, &
blkcou¡
);

609 i‡(
îr‹
)

610 
ÆÀº‹
 = 
îr‹
;

611 
block§ñó£d
 +
blkcou¡
;

615 i‡(
c›y
 !
NULL
) {

616 
	`kmem_‰ì
(
c›y
, 
fs
->
e2fs_bsize
);

618 
	`bªl£
(
bp
, 
BC_INVAL
);

621 *
cou¡p
 = 
block§ñó£d
;

622  (
ÆÀº‹
);

623 
	}
}

	@ext2fs_lookup.c

50 
	~<sys/cdefs.h
>

51 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_lookup.c,v 1.79 2016/01/12 21:29:29Ñiastradh Exp $");

53 
	~<sys/∑øm.h
>

54 
	~<sys/sy°m.h
>

55 
	~<sys/«mei.h
>

56 
	~<sys/buf.h
>

57 
	~<sys/fûe.h
>

58 
	~<sys/mou¡.h
>

59 
	~<sys/vnode.h
>

60 
	~<sys/kmem.h
>

61 
	~<sys/mÆloc.h
>

62 
	~<sys/dúít.h
>

63 
	~<sys/kauth.h
>

64 
	~<sys/¥oc.h
>

66 
	~<ufs/ufs/öode.h
>

67 
	~<ufs/ufs/ufsmou¡.h
>

68 
	~<ufs/ufs/ufs_exã∫.h
>

70 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

71 
	~<ufs/ext2fs/ext2fs_dú.h
>

72 
	~<ufs/ext2fs/ext2fs.h
>

74 
	~<miscfs/gífs/gífs.h
>

76 
dúchk
;

78 
ext2fs_dúc⁄v2ffs
(
ext2fs_dúe˘
 *
e2dú
,

79 
dúít
 *
ffsdú
);

80 
ext2fs_dúbadíåy
(
vnode
 *
dp
,

81 
ext2fs_dúe˘
 *
de
,

82 
íåyoff£töblock
);

95 
	$ext2fs_dúc⁄v2ffs
(
ext2fs_dúe˘
 *
e2dú
, 
dúít
 *
ffsdú
)

97 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

98 
	`mem£t
(
ffsdú
, 0, (
dúít
));

99 
ffsdú
->
d_fûío
 = 
	`fs2h32
(
e2dú
->
e2d_öo
);

100 
ffsdú
->
d_«mÀn
 = 
e2dú
->
e2d_«mÀn
;

102 
ffsdú
->
d_ty≥
 = 
DT_UNKNOWN
;

103 #ifde‡
DIAGNOSTIC


104 #i‡
MAXNAMLEN
 < 
E2FS_MAXNAMLEN


108 i‡(
e2dú
->
e2d_«mÀn
 > 
MAXNAMLEN
)

109 
	`∑nic
("ext2fs:É2dir->e2d_namlen");

112 
	`°∫˝y
(
ffsdú
->
d_«me
, 
e2dú
->
e2d_«me
, ffsdú->
d_«mÀn
);

118 
ffsdú
->
d_ª˛í
 = 
	`_DIRENT_SIZE
(ffsdir);

119 
	}
}

133 
	$ext2fs_ªaddú
(*
v
)

135 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

136 
v›_ªaddú_¨gs


143  *
≠
 = 
v
;

144 
uio
 *uiÿ
≠
->
a_uio
;

145 
îr‹
;

146 
size_t
 
e2fs_cou¡
, 
ªad˙t
;

147 
vnode
 *
vp
 = 
≠
->
a_vp
;

148 
m_ext2fs
 *
fs
 = 
	`VTOI
(
vp
)->
i_e2fs
;

150 
ext2fs_dúe˘
 *
dp
;

151 
dúít
 *
d°d
;

152 
uio
 
auio
;

153 
iovec
 
aiov
;

154 *
dúbuf
;

155 
off_t
 
off
 = 
uio
->
uio_off£t
;

156 
off_t
 *
cookõs
 = 
NULL
;

157 
nc
 = 0, 
ncookõs
 = 0;

158 
e2d_ª˛í
;

160 i‡(
vp
->
v_ty≥
 !
VDIR
)

161  (
ENOTDIR
);

163 
e2fs_cou¡
 = 
uio
->
uio_ªsid
;

165 
e2fs_cou¡
 -(
uio
->
uio_off£t
 +É2fs_cou¡Ë& (
fs
->
e2fs_bsize
 -1);

166 i‡(
e2fs_cou¡
 <= 0)

167  (
EINVAL
);

169 
auio
 = *
uio
;

170 
auio
.
uio_iov
 = &
aiov
;

171 
auio
.
uio_iov˙t
 = 1;

172 
aiov
.
iov_Àn
 = 
e2fs_cou¡
;

173 
auio
.
uio_ªsid
 = 
e2fs_cou¡
;

174 
	`UIO_SETUP_SYSSPACE
(&
auio
);

175 
dúbuf
 = 
	`kmem_Æloc
(
e2fs_cou¡
, 
KM_SLEEP
);

176 
d°d
 = 
	`kmem_zÆloc
((
dúít
), 
KM_SLEEP
);

177 i‡(
≠
->
a_ncookõs
) {

178 
nc
 = 
e2fs_cou¡
 / 
	`_DIRENT_MINSIZE
((
dúít
 *)0);

179 
ncookõs
 = 
nc
;

180 
cookõs
 = 
	`mÆloc
( (
off_t
Ë* 
ncookõs
, 
M_TEMP
, 
M_WAITOK
);

181 *
≠
->
a_cookõs
 = 
cookõs
;

183 
aiov
.
iov_ba£
 = 
dúbuf
;

185 
îr‹
 = 
	`UFS_BUFRD
(
≠
->
a_vp
, &
auio
, 0,áp->
a_¸ed
);

186 i‡(
îr‹
 == 0) {

187 
ªad˙t
 = 
e2fs_cou¡
 - 
auio
.
uio_ªsid
;

188 
dp
 = (
ext2fs_dúe˘
 *)
dúbuf
;

189 (*)
dp
 < (*)
dúbuf
 + 
ªad˙t
; ) {

190 
e2d_ª˛í
 = 
	`fs2h16
(
dp
->e2d_reclen);

191 i‡(
e2d_ª˛í
 == 0) {

192 
îr‹
 = 
EIO
;

195 
	`ext2fs_dúc⁄v2ffs
(
dp
, 
d°d
);

196 if(
d°d
->
d_ª˛í
 > 
uio
->
uio_ªsid
) {

199 
îr‹
 = 
	`uiomove
(
d°d
, d°d->
d_ª˛í
, 
uio
);

200 i‡(
îr‹
 != 0) {

203 
off
 = of‡+ 
e2d_ª˛í
;

204 i‡(
cookõs
 !
NULL
) {

205 *
cookõs
++ = 
off
;

206 i‡(--
ncookõs
 <= 0){

211 
dp
 = (
ext2fs_dúe˘
 *Ë((*)d∞+ 
e2d_ª˛í
);

214 
uio
->
uio_off£t
 = 
off
;

216 
	`kmem_‰ì
(
dúbuf
, 
e2fs_cou¡
);

217 
	`kmem_‰ì
(
d°d
, (*dstd));

218 *
≠
->
a_eofÊag
 = 
	`ext2fs_size
(
	`VTOI
◊p->
a_vp
)Ë<
uio
->
uio_off£t
;

219 i‡(
≠
->
a_ncookõs
) {

220 i‡(
îr‹
) {

221 
	`‰ì
(*
≠
->
a_cookõs
, 
M_TEMP
);

222 *
≠
->
a_ncookõs
 = 0;

223 *
≠
->
a_cookõs
 = 
NULL
;

225 *
≠
->
a_ncookõs
 = 
nc
 - 
ncookõs
;

227  (
îr‹
);

228 
	}
}

264 
	$ext2fs_lookup
(*
v
)

266 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

267 
v›_lookup_v2_¨gs


271  *
≠
 = 
v
;

272 
vnode
 *
vdp
 = 
≠
->
a_dvp
;

273 
öode
 *
dp
 = 
	`VTOI
(
vdp
);

274 
buf
 *
bp
;

275 
ext2fs_dúe˘
 *
ï
;

276 
íåyoff£töblock
;

277 íum {
NONE
, 
COMPACT
, 
FOUND
} 
¶Ÿ°©us
;

278 
doff_t
 
¶Ÿoff£t
;

279 
¶Ÿsize
;

280 
¶Ÿ‰ì•a˚
;

281 
¶Ÿ√eded
;

282 
numdú∑s£s
;

283 
doff_t
 
íd£¨ch
;

284 
doff_t
 
¥evoff
;

285 
vnode
 *
tdp
;

286 
doff_t
 
ídu£ful
;

287 
u_l⁄g
 
bmask
;

288 
«mÀn
, 
îr‹
;

289 
vnode
 **
vµ
 = 
≠
->
a_vµ
;

290 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

291 
kauth_¸ed_t
 
¸ed
 = 
˙p
->
˙_¸ed
;

292 
Êags
;

293 
«mei›
 = 
˙p
->
˙_«mei›
;

294 
ufsmou¡
 *
ump
 = 
dp
->
i_ump
;

295 
dúblksiz
 = 
ump
->
um_dúblksiz
;

296 
öo_t
 
foundöo
;

297 
ufs_lookup_ªsu…s
 *
ªsu…s
;

299 
Êags
 = 
˙p
->
˙_Êags
;

301 
bp
 = 
NULL
;

302 
¶Ÿoff£t
 = -1;

303 *
vµ
 = 
NULL
;

310 
ªsu…s
 = &
dp
->
i_¸≠
;

311 
dp
->
i_¸≠cou¡î
++;

316 i‡((
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VEXEC
, 
¸ed
)) != 0)

317  (
îr‹
);

319 i‡((
Êags
 & 
ISLASTCN
Ë&& (
vdp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
) &&

320 (
˙p
->
˙_«mei›
 =
DELETE
 || c≈->˙_«mei› =
RENAME
))

321  (
EROFS
);

330 i‡(
	`ˇche_lookup
(
vdp
, 
˙p
->
˙_«mïå
, c≈->
˙_«mñí
,

331 
˙p
->
˙_«mei›
, c≈->
˙_Êags
, 
NULL
, 
vµ
)) {

332  *
vµ
 =
NULLVP
 ? 
ENOENT
 : 0;

341 
¶Ÿ°©us
 = 
FOUND
;

342 
¶Ÿ‰ì•a˚
 = 
¶Ÿsize
 = 
¶Ÿ√eded
 = 0;

343 i‡((
«mei›
 =
CREATE
 ||Çamei› =
RENAME
) &&

344 (
Êags
 & 
ISLASTCN
)) {

345 
¶Ÿ°©us
 = 
NONE
;

346 
¶Ÿ√eded
 = 
	`EXT2FS_DIRSIZ
(
˙p
->
˙_«mñí
);

360 
bmask
 = 
vdp
->
v_mou¡
->
m¡_°©
.
f_iosize
 - 1;

361 i‡(
«mei›
 !
LOOKUP
 || 
ªsu…s
->
uÃ_dúoff
 == 0 ||

362 
ªsu…s
->
uÃ_dúoff
 >
	`ext2fs_size
(
dp
)) {

363 
íåyoff£töblock
 = 0;

364 
ªsu…s
->
uÃ_off£t
 = 0;

365 
numdú∑s£s
 = 1;

367 
ªsu…s
->
uÃ_off£t
 =Ñesu…s->
uÃ_dúoff
;

368 i‡((
íåyoff£töblock
 = 
ªsu…s
->
uÃ_off£t
 & 
bmask
) &&

369 (
îr‹
 = 
	`ext2fs_blk©off
(
vdp
, (
off_t
)
ªsu…s
->
uÃ_off£t
, 
NULL
, &
bp
)))

370  (
îr‹
);

371 
numdú∑s£s
 = 2;

372 
	`«meˇche_cou¡_2∑s£s
();

374 
¥evoff
 = 
ªsu…s
->
uÃ_off£t
;

375 
íd£¨ch
 = 
	`roundup
(
	`ext2fs_size
(
dp
), 
dúblksiz
);

376 
ídu£ful
 = 0;

378 
£¨chlo›
:

379 
ªsu…s
->
uÃ_off£t
 < 
íd£¨ch
) {

380 i‡(
	`cur˝u
()->
ci_sched°©e
.
•c_Êags
 & 
SPCF_SHOULDYIELD
)

381 
	`¥ìm±
();

385 i‡((
ªsu…s
->
uÃ_off£t
 & 
bmask
) == 0) {

386 i‡(
bp
 !
NULL
)

387 
	`bªl£
(
bp
, 0);

388 
îr‹
 = 
	`ext2fs_blk©off
(
vdp
, (
off_t
)
ªsu…s
->
uÃ_off£t
, 
NULL
,

389 &
bp
);

390 i‡(
îr‹
 != 0)

391  (
îr‹
);

392 
íåyoff£töblock
 = 0;

398 i‡(
¶Ÿ°©us
 =
NONE
 &&

399 (
íåyoff£töblock
 & (
dúblksiz
 - 1)) == 0) {

400 
¶Ÿoff£t
 = -1;

401 
¶Ÿ‰ì•a˚
 = 0;

410 
	`KASSERT
(
bp
 !
NULL
);

411 
ï
 = (
ext2fs_dúe˘
 *)

412 ((*)
bp
->
b_d©a
 + 
íåyoff£töblock
);

413 i‡(
ï
->
e2d_ª˛í
 == 0 ||

414 (
dúchk
 &&

415 
	`ext2fs_dúbadíåy
(
vdp
, 
ï
, 
íåyoff£töblock
))) {

416 
i
;

418 
	`ufs_dúbad
(
dp
, 
ªsu…s
->
uÃ_off£t
, "mangledÉntry");

419 
i
 = 
dúblksiz
 - (
íåyoff£töblock
 & (dirblksiz - 1));

420 
ªsu…s
->
uÃ_off£t
 +
i
;

421 
íåyoff£töblock
 +
i
;

431 i‡(
¶Ÿ°©us
 !
FOUND
) {

432 
size
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

434 i‡(
ï
->
e2d_öo
 != 0)

435 
size
 -
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
);

436 i‡(
size
 > 0) {

437 i‡(
size
 >
¶Ÿ√eded
) {

438 
¶Ÿ°©us
 = 
FOUND
;

439 
¶Ÿoff£t
 = 
ªsu…s
->
uÃ_off£t
;

440 
¶Ÿsize
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

441 } i‡(
¶Ÿ°©us
 =
NONE
) {

442 
¶Ÿ‰ì•a˚
 +
size
;

443 i‡(
¶Ÿoff£t
 == -1)

444 
¶Ÿoff£t
 = 
ªsu…s
->
uÃ_off£t
;

445 i‡(
¶Ÿ‰ì•a˚
 >
¶Ÿ√eded
) {

446 
¶Ÿ°©us
 = 
COMPACT
;

447 
¶Ÿsize
 = 
ªsu…s
->
uÃ_off£t
 +

448 
	`fs2h16
(
ï
->
e2d_ª˛í
) -

449 
¶Ÿoff£t
;

458 i‡(
ï
->
e2d_öo
) {

459 
«mÀn
 = 
ï
->
e2d_«mÀn
;

460 i‡(
«mÀn
 =
˙p
->
˙_«mñí
 &&

461 !
	`memcmp
(
˙p
->
˙_«mïå
, 
ï
->
e2d_«me
,

462 ()
«mÀn
)) {

468 
foundöo
 = 
	`fs2h32
(
ï
->
e2d_öo
);

469 
ªsu…s
->
uÃ_ª˛í
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

470 
found
;

473 
¥evoff
 = 
ªsu…s
->
uÃ_off£t
;

474 
ªsu…s
->
uÃ_off£t
 +
	`fs2h16
(
ï
->
e2d_ª˛í
);

475 
íåyoff£töblock
 +
	`fs2h16
(
ï
->
e2d_ª˛í
);

476 i‡(
ï
->
e2d_öo
)

477 
ídu£ful
 = 
ªsu…s
->
uÃ_off£t
;

484 i‡(
numdú∑s£s
 == 2) {

485 
numdú∑s£s
--;

486 
ªsu…s
->
uÃ_off£t
 = 0;

487 
íd£¨ch
 = 
ªsu…s
->
uÃ_dúoff
;

488 
£¨chlo›
;

490 i‡(
bp
 !
NULL
)

491 
	`bªl£
(
bp
, 0);

497 i‡((
«mei›
 =
CREATE
 ||Çamei› =
RENAME
) &&

498 (
Êags
 & 
ISLASTCN
Ë&& 
dp
->
i_e2fs_∆ök
 != 0) {

503 
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VWRITE
, 
¸ed
);

504 i‡(
îr‹
)

505  (
îr‹
);

515 i‡(
¶Ÿ°©us
 =
NONE
) {

516 
ªsu…s
->
uÃ_off£t
 = 
	`roundup
(
	`ext2fs_size
(
dp
), 
dúblksiz
);

517 
ªsu…s
->
uÃ_cou¡
 = 0;

518 
ídu£ful
 = 
ªsu…s
->
uÃ_off£t
;

520 
ªsu…s
->
uÃ_off£t
 = 
¶Ÿoff£t
;

521 
ªsu…s
->
uÃ_cou¡
 = 
¶Ÿsize
;

522 i‡(
ídu£ful
 < 
¶Ÿoff£t
 + 
¶Ÿsize
)

523 
ídu£ful
 = 
¶Ÿoff£t
 + 
¶Ÿsize
;

525 
ªsu…s
->
uÃ_ídoff
 = 
	`roundup
(
ídu£ful
, 
dúblksiz
);

527 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

540  (
EJUSTRETURN
);

545 i‡(
«mei›
 !
CREATE
) {

546 
	`ˇche_íãr
(
vdp
, *
vµ
, 
˙p
->
˙_«mïå
, c≈->
˙_«mñí
,

547 
˙p
->
˙_Êags
);

549  
ENOENT
;

551 
found
:

552 i‡(
numdú∑s£s
 == 2)

553 
	`«meˇche_cou¡_∑ss2
();

558 i‡(
ªsu…s
->
uÃ_off£t
 + 
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
Ë> 
	`ext2fs_size
(
dp
)) {

559 
	`ufs_dúbad
(
dp
, 
ªsu…s
->
uÃ_off£t
, "i_sizeÅoo small");

560 
îr‹
 = 
	`ext2fs_£tsize
(
dp
,

561 
ªsu…s
->
uÃ_off£t
 + 
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
));

562 i‡(
îr‹
) {

563 
	`bªl£
(
bp
, 0);

564  (
îr‹
);

566 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

567 
	`uvm_v≈_£tsize
(
vdp
, 
	`ext2fs_size
(
dp
));

569 
	`bªl£
(
bp
, 0);

576 i‡((
Êags
 & 
ISLASTCN
Ë&& 
«mei›
 =
LOOKUP
)

577 
ªsu…s
->
uÃ_dúoff
 =Ñesu…s->
uÃ_off£t
 &~ (
dúblksiz
 - 1);

584 i‡(
«mei›
 =
DELETE
 && (
Êags
 & 
ISLASTCN
)) {

591 i‡((
ªsu…s
->
uÃ_off£t
 & (
dúblksiz
 - 1)) == 0)

592 
ªsu…s
->
uÃ_cou¡
 = 0;

594 
ªsu…s
->
uÃ_cou¡
 =Ñesu…s->
uÃ_off£t
 - 
¥evoff
;

595 i‡(
dp
->
i_numbî
 =
foundöo
) {

596 
	`vªf
(
vdp
);

597 
tdp
 = 
vdp
;

599 
îr‹
 = 
	`vˇche_gë
(
vdp
->
v_mou¡
,

600 &
foundöo
, (foundöo), &
tdp
);

601 i‡(
îr‹
)

602  (
îr‹
);

607 i‡((
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VWRITE
, 
¸ed
)) != 0) {

608 
	`vªÀ
(
tdp
);

609  (
îr‹
);

617 i‡(
dp
->
i_e2fs_mode
 & 
ISVTX
) {

618 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_DELETE
,

619 
tdp
, 
vdp
, 
	`gífs_ˇn_°icky
(
¸ed
, 
dp
->
i_uid
,

620 
	`VTOI
(
tdp
)->
i_uid
));

621 i‡(
îr‹
) {

622 
	`vªÀ
(
tdp
);

623  (
EPERM
);

626 *
vµ
 = 
tdp
;

636 i‡(
«mei›
 =
RENAME
 && (
Êags
 & 
ISLASTCN
)) {

637 
îr‹
 = 
	`VOP_ACCESS
(
vdp
, 
VWRITE
, 
¸ed
);

638 i‡(
îr‹
)

639  (
îr‹
);

644 i‡(
dp
->
i_numbî
 =
foundöo
)

645  (
EISDIR
);

646 
îr‹
 = 
	`vˇche_gë
(
vdp
->
v_mou¡
,

647 &
foundöo
, (foundöo), &
tdp
);

648 i‡(
îr‹
)

649  (
îr‹
);

650 *
vµ
 = 
tdp
;

654 i‡(
dp
->
i_numbî
 =
foundöo
) {

655 
	`vªf
(
vdp
);

656 *
vµ
 = 
vdp
;

658 
îr‹
 = 
	`vˇche_gë
(
vdp
->
v_mou¡
,

659 &
foundöo
, (foundöo), &
tdp
);

660 i‡(
îr‹
)

661  (
îr‹
);

662 *
vµ
 = 
tdp
;

668 
	`ˇche_íãr
(
vdp
, *
vµ
, 
˙p
->
˙_«mïå
, c≈->
˙_«mñí
, c≈->
˙_Êags
);

670 
	}
}

684 
	$ext2fs_dúbadíåy
(
vnode
 *
dp
, 
ext2fs_dúe˘
 *
de
,

685 
íåyoff£töblock
)

687 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

688 
ufsmou¡
 *
ump
 = 
	`VFSTOUFS
(
dp
->
v_mou¡
);

689 
dúblksiz
 = 
ump
->
um_dúblksiz
;

691 c⁄° *
îr‹_msg
 = 
NULL
;

692 
ª˛í
 = 
	`fs2h16
(
de
->
e2d_ª˛í
);

693 
«mÀn
 = 
de
->
e2d_«mÀn
;

695 i‡(
ª˛í
 < 
	`EXT2FS_DIRSIZ
(1))

696 
îr‹_msg
 = "rec_len is smallerÅhan minimal";

697 i‡(
ª˛í
 % 4 != 0)

698 
îr‹_msg
 = "rec_len % 4 != 0";

699 i‡(
«mÀn
 > 
EXT2FS_MAXNAMLEN
)

700 
îr‹_msg
 = "namlen > EXT2FS_MAXNAMLEN";

701 i‡(
ª˛í
 < 
	`EXT2FS_DIRSIZ
(
«mÀn
))

702 
îr‹_msg
 = "reclen isÅoo small forÇame_len";

703 i‡(
íåyoff£töblock
 + 
ª˛í
 > 
dúblksiz
)

704 
îr‹_msg
 = "directoryÉntryácross blocks";

705 i‡(
	`fs2h32
(
de
->
e2d_öo
) >

706 
	`VTOI
(
dp
)->
i_e2fs
->
e2fs
.
e2fs_icou¡
)

707 
îr‹_msg
 = "inode out of bounds";

709 i‡(
îr‹_msg
 !
NULL
) {

710 
	`¥ötf
( "bad directoryÉntry: %s\n"

712 
îr‹_msg
, 
íåyoff£töblock
,

713 (Ë
	`fs2h32
(
de
->
e2d_öo
),

714 
ª˛í
, 
«mÀn
);

715 
	`∑nic
("ext2fs_dirbadentry");

717  
îr‹_msg
 =
NULL
 ? 0 : 1;

718 
	}
}

729 
	$ext2fs_dúíãr
(
öode
 *
ù
, 
vnode
 *
dvp
,

730 c⁄° 
ufs_lookup_ªsu…s
 *
uÃ
,

731 
comp⁄íäame
 *
˙p
)

733 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

734 
ext2fs_dúe˘
 *
ï
, *
√p
;

735 
öode
 *
dp
;

736 
buf
 *
bp
;

737 
ext2fs_dúe˘
 
√wdú
;

738 
iovec
 
aiov
;

739 
uio
 
auio
;

740 
u_öt
 
dsize
;

741 
îr‹
, 
loc
, 
√wíåysize
, 
•a˚‰ì
;

742 *
dúbuf
;

743 
ufsmou¡
 *
ump
 = 
	`VFSTOUFS
(
dvp
->
v_mou¡
);

744 
dúblksiz
 = 
ump
->
um_dúblksiz
;

746 
dp
 = 
	`VTOI
(
dvp
);

748 
√wdú
.
e2d_öo
 = 
	`h2fs32
(
ù
->
i_numbî
);

749 
√wdú
.
e2d_«mÀn
 = 
˙p
->
˙_«mñí
;

750 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

751 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

752 
√wdú
.
e2d_ty≥
 = 
	`öŸ2ext2dt
(
	`IFTODT
(
ù
->
i_e2fs_mode
));

754 
√wdú
.
e2d_ty≥
 = 0;

756 
	`mem˝y
(
√wdú
.
e2d_«me
, 
˙p
->
˙_«mïå
, ()˙p->
˙_«mñí
 + 1);

757 
√wíåysize
 = 
	`EXT2FS_DIRSIZ
(
˙p
->
˙_«mñí
);

758 i‡(
uÃ
->
uÃ_cou¡
 == 0) {

765 i‡(
uÃ
->
uÃ_off£t
 & (
dúblksiz
 - 1))

766 
	`∑nic
("ext2fs_direnter:Çewblk");

767 
auio
.
uio_off£t
 = 
uÃ
->
uÃ_off£t
;

768 
√wdú
.
e2d_ª˛í
 = 
	`h2fs16
(
dúblksiz
);

769 
auio
.
uio_ªsid
 = 
√wíåysize
;

770 
aiov
.
iov_Àn
 = 
√wíåysize
;

771 
aiov
.
iov_ba£
 = (*)&
√wdú
;

772 
auio
.
uio_iov
 = &
aiov
;

773 
auio
.
uio_iov˙t
 = 1;

774 
auio
.
uio_rw
 = 
UIO_WRITE
;

775 
	`UIO_SETUP_SYSSPACE
(&
auio
);

776 
îr‹
 = 
	`ext2fs_bufwr
(
dvp
, &
auio
, 
IO_SYNC
, 
˙p
->
˙_¸ed
);

777 i‡(
dúblksiz
 > 
dvp
->
v_mou¡
->
m¡_°©
.
f_bsize
)

779 
	`∑nic
("ext2fs_direnter: frag size");

780 i‡(!
îr‹
) {

781 
îr‹
 = 
	`ext2fs_£tsize
(
dp
,

782 
	`roundup
(
	`ext2fs_size
(
dp
), 
dúblksiz
));

783 i‡(
îr‹
)

784  (
îr‹
);

785 
dp
->
i_Êag
 |
IN_CHANGE
;

786 
	`uvm_v≈_£tsize
(
dvp
, 
	`ext2fs_size
(
dp
));

788  (
îr‹
);

803 i‡((
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)
uÃ
->
uÃ_off£t
, &
dúbuf
, &
bp
)) != 0)

804  (
îr‹
);

812 
ï
 = (
ext2fs_dúe˘
 *)
dúbuf
;

813 
dsize
 = 
	`EXT2FS_DIRSIZ
(
ï
->
e2d_«mÀn
);

814 
•a˚‰ì
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
Ë- 
dsize
;

815 
loc
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);Üo¯< 
uÃ
->
uÃ_cou¡
; ) {

816 
√p
 = (
ext2fs_dúe˘
 *)(
dúbuf
 + 
loc
);

817 i‡(
ï
->
e2d_öo
) {

819 
ï
->
e2d_ª˛í
 = 
	`h2fs16
(
dsize
);

820 
ï
 = (
ext2fs_dúe˘
 *)((*Î∞+ 
dsize
);

823 
•a˚‰ì
 +
dsize
;

825 
dsize
 = 
	`EXT2FS_DIRSIZ
(
√p
->
e2d_«mÀn
);

826 
•a˚‰ì
 +
	`fs2h16
(
√p
->
e2d_ª˛í
Ë- 
dsize
;

827 
loc
 +
	`fs2h16
(
√p
->
e2d_ª˛í
);

828 
	`mem˝y
((*)
ï
, (*)
√p
, 
dsize
);

834 i‡(
ï
->
e2d_öo
 == 0) {

835 #ifde‡
DIAGNOSTIC


836 i‡(
•a˚‰ì
 + 
dsize
 < 
√wíåysize
)

837 
	`∑nic
("ext2fs_direnter: compact1");

839 
√wdú
.
e2d_ª˛í
 = 
	`h2fs16
(
•a˚‰ì
 + 
dsize
);

841 #ifde‡
DIAGNOSTIC


842 i‡(
•a˚‰ì
 < 
√wíåysize
) {

843 
	`¥ötf
("ext2fs_direnter: compact2 %u %u",

844 (
u_öt
)
•a˚‰ì
, (u_öt)
√wíåysize
);

845 
	`∑nic
("ext2fs_direnter: compact2");

848 
√wdú
.
e2d_ª˛í
 = 
	`h2fs16
(
•a˚‰ì
);

849 
ï
->
e2d_ª˛í
 = 
	`h2fs16
(
dsize
);

850 
ï
 = (
ext2fs_dúe˘
 *)((*Î∞+ 
dsize
);

852 
	`mem˝y
((*)
ï
, (*)&
√wdú
, (
u_öt
)
√wíåysize
);

853 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

854 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

855 i‡(!
îr‹
 && 
uÃ
->
uÃ_ídoff
 && uÃ->uÃ_ídof‡< 
	`ext2fs_size
(
dp
))

856 
îr‹
 = 
	`ext2fs_åunˇã
(
dvp
, (
off_t
)
uÃ
->
uÃ_ídoff
, 
IO_SYNC
,

857 
˙p
->
˙_¸ed
);

858  (
îr‹
);

859 
	}
}

877 
	$ext2fs_dúªmove
(
vnode
 *
dvp
, c⁄° 
ufs_lookup_ªsu…s
 *
uÃ
,

878 
comp⁄íäame
 *
˙p
)

880 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

881 
öode
 *
dp
;

882 
ext2fs_dúe˘
 *
ï
;

883 
buf
 *
bp
;

884 
îr‹
;

886 
dp
 = 
	`VTOI
(
dvp
);

888 i‡(
uÃ
->
uÃ_cou¡
 == 0) {

892 
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)
uÃ
->
uÃ_off£t
,

893 (*)&
ï
, &
bp
);

894 i‡(
îr‹
 != 0)

895  (
îr‹
);

896 
ï
->
e2d_öo
 = 0;

897 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

898 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

899  (
îr‹
);

904 
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)(
uÃ
->
uÃ_off£t
 - uÃ->
uÃ_cou¡
),

905 (*)&
ï
, &
bp
);

906 i‡(
îr‹
 != 0)

907  (
îr‹
);

908 
ï
->
e2d_ª˛í
 = 
	`h2fs16
(
	`fs2h16
”p->e2d_ª˛íË+ 
uÃ
->
uÃ_ª˛í
);

909 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

910 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

911  (
îr‹
);

912 
	}
}

920 
	$ext2fs_dúªwrôe
(
öode
 *
dp
, c⁄° 
ufs_lookup_ªsu…s
 *
uÃ
,

921 
öode
 *
ù
, 
comp⁄íäame
 *
˙p
)

923 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

924 
buf
 *
bp
;

925 
ext2fs_dúe˘
 *
ï
;

926 
vnode
 *
vdp
 = 
	`ITOV
(
dp
);

927 
îr‹
;

929 
îr‹
 = 
	`ext2fs_blk©off
(
vdp
, (
off_t
)
uÃ
->
uÃ_off£t
, (*)&
ï
, &
bp
);

930 i‡(
îr‹
 != 0)

931  (
îr‹
);

932 
ï
->
e2d_öo
 = 
	`h2fs32
(
ù
->
i_numbî
);

933 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

934 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

935 
ï
->
e2d_ty≥
 = 
	`öŸ2ext2dt
(
	`IFTODT
(
ù
->
i_e2fs_mode
));

937 
ï
->
e2d_ty≥
 = 0;

939 
îr‹
 = 
	`VOP_BWRITE
(
bp
->
b_vp
, bp);

940 
dp
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

941  (
îr‹
);

942 
	}
}

954 
	$ext2fs_dúem±y
(
öode
 *
ù
, 
öo_t
 
∑ª¡öo
, 
kauth_¸ed_t
 
¸ed
)

956 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

957 
off_t
 
off
;

958 
ext2fs_dúãm∂©e
 
dbuf
;

959 
ext2fs_dúe˘
 *
dp
 = (ext2fs_dúe˘ *)&
dbuf
;

960 
îr‹
, 
«mÀn
;

961 
size_t
 
cou¡
;

963 
	#MINDIRSIZ
 ( (
ext2fs_dúãm∂©e
Ë/ 2)

	)

965 
off
 = 0; of‡< 
	`ext2fs_size
(
ù
); of‡+
	`fs2h16
(
dp
->
e2d_ª˛í
)) {

966 
îr‹
 = 
	`ufs_bufio
(
UIO_READ
, 
	`ITOV
(
ù
), (*)
dp
, 
MINDIRSIZ
,

967 
off
, 
IO_NODELOCKED
, 
¸ed
, &
cou¡
, 
NULL
);

972 i‡(
îr‹
 || 
cou¡
 != 0)

975 i‡(
dp
->
e2d_ª˛í
 == 0)

978 i‡(
dp
->
e2d_öo
 == 0)

981 
«mÀn
 = 
dp
->
e2d_«mÀn
;

982 i‡(
«mÀn
 > 2)

984 i‡(
dp
->
e2d_«me
[0] != '.')

991 i‡(
«mÀn
 == 1)

993 i‡(
dp
->
e2d_«me
[1] ='.' && 
	`fs2h32
(dp->
e2d_öo
Ë=
∑ª¡öo
)

998 
	}
}

	@ext2fs_readwrite.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_readwrite.c,v 1.74 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/ªsour˚v¨.h
>

68 
	~<sys/kî√l.h
>

69 
	~<sys/fûe.h
>

70 
	~<sys/°©.h
>

71 
	~<sys/buf.h
>

72 
	~<sys/¥oc.h
>

73 
	~<sys/mou¡.h
>

74 
	~<sys/vnode.h
>

75 
	~<sys/sig«lv¨.h
>

76 
	~<sys/kauth.h
>

78 
	~<ufs/ufs/öode.h
>

79 
	~<ufs/ufs/ufsmou¡.h
>

80 
	~<ufs/ufs/ufs_exã∫.h
>

81 
	~<ufs/ext2fs/ext2fs.h
>

82 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

84 
ext2fs_po°_ªad_upd©e
(
vnode
 *, , );

85 
ext2fs_po°_wrôe_upd©e
(
vnode
 *, 
uio
 *, ,

86 
kauth_¸ed_t
, 
off_t
, , , );

93 
	$ext2fs_ªad
(*
v
)

95 
	`¥ötf
("ex2fs_read\n");

96 
v›_ªad_¨gs


101  *
≠
 = 
v
;

102 
vnode
 *
vp
;

103 
öode
 *
ù
;

104 
uio
 *uio;

105 
ufsmou¡
 *
ump
;

106 
vsize_t
 
byãÀn
;

107 
advi˚
;

108 
îr‹
;

110 
vp
 = 
≠
->
a_vp
;

111 
ù
 = 
	`VTOI
(
vp
);

112 
ump
 = 
ù
->
i_ump
;

113 
uio
 = 
≠
->
a_uio
;

114 
îr‹
 = 0;

116 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_READ
);

117 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
 || vp->v_ty≥ =
VDIR
);

120 i‡(
vp
->
v_ty≥
 =
VDIR
)

121  
	`ext2fs_bu‰d
(
vp
, 
uio
, 
≠
->
a_ioÊag
,áp->
a_¸ed
);

123 i‡((
uöt64_t
)
uio
->
uio_off£t
 > 
ump
->
um_maxfûesize
)

124  (
EFBIG
);

125 i‡(
uio
->
uio_ªsid
 == 0)

127 i‡(
uio
->
uio_off£t
 >
	`ext2fs_size
(
ù
))

128 
out
;

130 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
);

131 
advi˚
 = 
	`IO_ADV_DECODE
(
≠
->
a_ioÊag
);

132 
uio
->
uio_ªsid
 > 0) {

133 
byãÀn
 = 
	`MIN
(
	`ext2fs_size
(
ù
Ë- 
uio
->
uio_off£t
,

134 
uio
->
uio_ªsid
);

135 i‡(
byãÀn
 == 0)

138 
îr‹
 = 
	`ubc_uiomove
(&
vp
->
v_uobj
, 
uio
, 
byãÀn
, 
advi˚
,

139 
UBC_READ
 | 
UBC_PARTIALOK
 | 
	`UBC_UNMAP_FLAG
(
vp
));

140 i‡(
îr‹
)

144 
out
:

145 
îr‹
 = 
	`ext2fs_po°_ªad_upd©e
(
vp
, 
≠
->
a_ioÊag
,Érror);

146  (
îr‹
);

147 
	}
}

153 
	$ext2fs_bu‰d
(
vnode
 *
vp
, 
uio
 *uio, 
ioÊag
, 
kauth_¸ed_t
 
¸ed
)

155 
	`¥ötf
("ext2fs_bufrd\n");

156 
öode
 *
ù
;

157 
ufsmou¡
 *
ump
;

158 
m_ext2fs
 *
fs
;

159 
buf
 *
bp
;

160 
off_t
 
byãsöfûe
;

161 
daddr_t
 
lbn
, 
√xébn
;

162 
size
, 
x„rsize
, 
blkoff£t
;

163 
îr‹
;

165 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_READ
);

166 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
));

167 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
 || vp->v_ty≥ =
VLNK
);

169 
ù
 = 
	`VTOI
(
vp
);

170 
ump
 = 
ù
->
i_ump
;

171 
fs
 = 
ù
->
i_e2fs
;

172 
îr‹
 = 0;

174 
	`KASSERT
(
vp
->
v_ty≥
 !
VLNK
 ||

175 
	`ext2fs_size
(
ù
Ë>
ump
->
um_maxsymlökÀn
);

176 
	`KASSERT
(
vp
->
v_ty≥
 !
VLNK
 || 
ump
->
um_maxsymlökÀn
 != 0 ||

177 
	`ext2fs_nblock
(
ù
) != 0);

179 i‡(
uio
->
uio_off£t
 > 
ump
->
um_maxfûesize
)

180  
EFBIG
;

181 i‡(
uio
->
uio_ªsid
 == 0)

183 i‡(
uio
->
uio_off£t
 >
	`ext2fs_size
(
ù
))

184 
out
;

186 
îr‹
 = 0, 
bp
 = 
NULL
; 
uio
->
uio_ªsid
 > 0; bp = NULL) {

187 
byãsöfûe
 = 
	`ext2fs_size
(
ù
Ë- 
uio
->
uio_off£t
;

188 i‡(
byãsöfûe
 <= 0)

190 
lbn
 = 
	`ext2_lblkno
(
fs
, 
uio
->
uio_off£t
);

191 
√xébn
 = 
lbn
 + 1;

192 
size
 = 
fs
->
e2fs_bsize
;

193 
blkoff£t
 = 
	`ext2_blkoff
(
fs
, 
uio
->
uio_off£t
);

194 
x„rsize
 = 
fs
->
e2fs_bsize
 - 
blkoff£t
;

195 i‡(
uio
->
uio_ªsid
 < 
x„rsize
)

196 
x„rsize
 = 
uio
->
uio_ªsid
;

197 i‡(
byãsöfûe
 < 
x„rsize
)

198 
x„rsize
 = 
byãsöfûe
;

200 i‡(
	`ext2_lblktosize
(
fs
, 
√xébn
Ë>
	`ext2fs_size
(
ù
)) {

201 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

202 
îr‹
 = 
	`bªad
(
vp
, 
lbn
, 
size
, 0, &
bp
);

203 
	`¥ötf
("bªad(Ëªtu∫†%d\n",
îr‹
);

204 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

207 
√xtsize
 = 
fs
->
e2fs_bsize
;

208 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

209 
îr‹
 = 
	`bªadn
(
vp
, 
lbn
,

210 
size
, &
√xébn
, &
√xtsize
, 1, 0, &
bp
);

211 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

213 i‡(
îr‹
)

223 
size
 -
bp
->
b_ªsid
;

224 i‡(
size
 < 
x„rsize
) {

225 i‡(
size
 == 0)

227 
x„rsize
 = 
size
;

229 
îr‹
 = 
	`uiomove
((*)
bp
->
b_d©a
 + 
blkoff£t
, 
x„rsize
, 
uio
);

230 i‡(
îr‹
)

232 
	`bªl£
(
bp
, 0);

234 i‡(
bp
 !
NULL
)

235 
	`bªl£
(
bp
, 0);

237 
out
:

238 
îr‹
 = 
	`ext2fs_po°_ªad_upd©e
(
vp
, 
ioÊag
,Érror);

239  (
îr‹
);

240 
	}
}

243 
	$ext2fs_po°_ªad_upd©e
(
vnode
 *
vp
, 
ioÊag
, 
€º‹
)

245 
öode
 *
ù
 = 
	`VTOI
(
vp
);

246 
îr‹
 = 
€º‹
;

248 i‡(!(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_NOATIME
)) {

249 
ù
->
i_Êag
 |
IN_ACCESS
;

250 i‡((
ioÊag
 & 
IO_SYNC
) == IO_SYNC)

251 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
UPDATE_WAIT
);

255 i‡(
€º‹
)

256 
îr‹
 = 
€º‹
;

257  
îr‹
;

258 
	}
}

264 
	$ext2fs_wrôe
(*
v
)

266 
v›_wrôe_¨gs


271  *
≠
 = 
v
;

272 
vnode
 *
vp
;

273 
uio
 *uio;

274 
öode
 *
ù
;

275 
m_ext2fs
 *
fs
;

276 
ufsmou¡
 *
ump
;

277 
off_t
 
osize
;

278 
blkoff£t
, 
îr‹
, 
ioÊag
, 
ªsid
;

279 
vsize_t
 
byãÀn
;

280 
off_t
 
ﬁdoff
 = 0;

281 
boﬁ
 
async
;

282 
exãnded
 = 0;

283 
advi˚
;

285 
ioÊag
 = 
≠
->
a_ioÊag
;

286 
advi˚
 = 
	`IO_ADV_DECODE
(
ioÊag
);

287 
uio
 = 
≠
->
a_uio
;

288 
vp
 = 
≠
->
a_vp
;

289 
ù
 = 
	`VTOI
(
vp
);

290 
ump
 = 
ù
->
i_ump
;

291 
îr‹
 = 0;

293 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_WRITE
);

294 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
);

296 i‡(
ioÊag
 & 
IO_APPEND
)

297 
uio
->
uio_off£t
 = 
	`ext2fs_size
(
ù
);

298 i‡((
ù
->
i_e2fs_Êags
 & 
EXT2_APPEND
) &&

299 
uio
->
uio_off£t
 !
	`ext2fs_size
(
ù
))

300  (
EPERM
);

302 
fs
 = 
ù
->
i_e2fs
;

303 i‡(
uio
->
uio_off£t
 < 0 ||

304 (
uöt64_t
)
uio
->
uio_off£t
 + uio->
uio_ªsid
 > 
ump
->
um_maxfûesize
)

305  (
EFBIG
);

306 i‡(
uio
->
uio_ªsid
 == 0)

309 
async
 = 
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_ASYNC
;

310 
ªsid
 = 
uio
->
uio_ªsid
;

311 
osize
 = 
	`ext2fs_size
(
ù
);

313 
	`KASSERT
(
vp
->
v_ty≥
 =
VREG
);

314 
uio
->
uio_ªsid
 > 0) {

315 
ﬁdoff
 = 
uio
->
uio_off£t
;

316 
blkoff£t
 = 
	`ext2_blkoff
(
fs
, 
uio
->
uio_off£t
);

317 
byãÀn
 = 
	`MIN
(
fs
->
e2fs_bsize
 - 
blkoff£t
, 
uio
->
uio_ªsid
);

319 i‡(
vp
->
v_size
 < 
ﬁdoff
 + 
byãÀn
) {

320 
	`uvm_v≈_£twrôesize
(
vp
, 
ﬁdoff
 + 
byãÀn
);

322 
îr‹
 = 
	`ufs_bÆloc_ønge
(
vp
, 
uio
->
uio_off£t
, 
byãÀn
,

323 
≠
->
a_¸ed
, 0);

324 i‡(
îr‹
)

326 
îr‹
 = 
	`ubc_uiomove
(&
vp
->
v_uobj
, 
uio
, 
byãÀn
, 
advi˚
,

327 
UBC_WRITE
 | 
	`UBC_UNMAP_FLAG
(
vp
));

328 i‡(
îr‹
)

336 i‡(
vp
->
v_size
 < 
uio
->
uio_off£t
) {

337 
	`uvm_v≈_£tsize
(
vp
, 
uio
->
uio_off£t
);

338 
exãnded
 = 1;

346 i‡(!
async
 && 
ﬁdoff
 >> 16 !
uio
->
uio_off£t
 >> 16) {

347 
	`muãx_íãr
(
vp
->
v_öãæock
);

348 
îr‹
 = 
	`VOP_PUTPAGES
(
vp
, (
ﬁdoff
 >> 16) << 16,

349 (
uio
->
uio_off£t
 >> 16) << 16,

350 
PGO_CLEANIT
 | 
PGO_LAZY
);

353 i‡(
îr‹
 =0 && 
ioÊag
 & 
IO_SYNC
) {

354 
	`muãx_íãr
(
vp
->
v_öãæock
);

355 
îr‹
 = 
	`VOP_PUTPAGES
(
vp
, 
	`åunc_∑ge
(
ﬁdoff
),

356 
	`round_∑ge
(
	`ext2_blkroundup
(
fs
, 
uio
->
uio_off£t
)),

357 
PGO_CLEANIT
 | 
PGO_SYNCIO
);

360 
îr‹
 = 
	`ext2fs_po°_wrôe_upd©e
(
vp
, 
uio
, 
ioÊag
, 
≠
->
a_¸ed
, 
osize
,

361 
ªsid
, 
exãnded
, 
îr‹
);

362  (
îr‹
);

363 
	}
}

369 
	$ext2fs_bufwr
(
vnode
 *
vp
, 
uio
 *uio, 
ioÊag
, 
kauth_¸ed_t
 
¸ed
)

371 
öode
 *
ù
;

372 
ufsmou¡
 *
ump
;

373 
m_ext2fs
 *
fs
;

374 
buf
 *
bp
;

375 
Êags
;

376 
off_t
 
osize
;

377 
daddr_t
 
lbn
;

378 
ªsid
, 
blkoff£t
, 
x„rsize
;

379 
exãnded
 = 0;

380 
îr‹
;

382 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

383 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
 || vp->v_ty≥ =
VLNK
);

384 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
 || 
	`ISSET
(
ioÊag
, 
IO_SYNC
));

385 
	`KASSERT
(
uio
->
uio_rw
 =
UIO_WRITE
);

387 
ù
 = 
	`VTOI
(
vp
);

388 
ump
 = 
ù
->
i_ump
;

389 
fs
 = 
ù
->
i_e2fs
;

390 
îr‹
 = 0;

392 i‡(
uio
->
uio_off£t
 < 0 ||

393 
uio
->
uio_ªsid
 > 
ump
->
um_maxfûesize
 ||

394 
uio
->
uio_off£t
 > (
ump
->
um_maxfûesize
 - uio->
uio_ªsid
))

395  
EFBIG
;

396 i‡(
uio
->
uio_ªsid
 == 0)

399 
Êags
 = 
ioÊag
 & 
IO_SYNC
 ? 
B_SYNC
 : 0;

400 
ªsid
 = 
uio
->
uio_ªsid
;

401 
osize
 = 
	`ext2fs_size
(
ù
);

403 
îr‹
 = 0; 
uio
->
uio_ªsid
 > 0;) {

404 
lbn
 = 
	`ext2_lblkno
(
fs
, 
uio
->
uio_off£t
);

405 
blkoff£t
 = 
	`ext2_blkoff
(
fs
, 
uio
->
uio_off£t
);

406 
x„rsize
 = 
	`MIN
(
fs
->
e2fs_bsize
 - 
blkoff£t
, 
uio
->
uio_ªsid
);

407 i‡(
x„rsize
 < 
fs
->
e2fs_bsize
)

408 
Êags
 |
B_CLRBUF
;

410 
Êags
 &~
B_CLRBUF
;

411 
îr‹
 = 
	`ext2fs_bÆloc
(
ù
, 
lbn
, 
blkoff£t
 + 
x„rsize
, 
¸ed
, &
bp
,

412 
Êags
);

413 i‡(
îr‹
)

415 i‡(
	`ext2fs_size
(
ù
Ë< 
uio
->
uio_off£t
 + 
x„rsize
) {

416 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
uio
->
uio_off£t
 + 
x„rsize
);

417 i‡(
îr‹
)

420 
îr‹
 = 
	`uiomove
((*)
bp
->
b_d©a
 + 
blkoff£t
, 
x„rsize
, 
uio
);

427 i‡(
vp
->
v_size
 < 
uio
->
uio_off£t
) {

428 
	`uvm_v≈_£tsize
(
vp
, 
uio
->
uio_off£t
);

429 
exãnded
 = 1;

432 i‡(
ioÊag
 & 
IO_SYNC
)

433 ()
	`bwrôe
(
bp
);

434 i‡(
x„rsize
 + 
blkoff£t
 =
fs
->
e2fs_bsize
)

435 
	`bawrôe
(
bp
);

437 
	`bdwrôe
(
bp
);

438 i‡(
îr‹
 || 
x„rsize
 == 0)

442 
îr‹
 = 
	`ext2fs_po°_wrôe_upd©e
(
vp
, 
uio
, 
ioÊag
, 
¸ed
, 
osize
, 
ªsid
,

443 
exãnded
, 
îr‹
);

444  (
îr‹
);

445 
	}
}

448 
	$ext2fs_po°_wrôe_upd©e
(
vnode
 *
vp
, 
uio
 *uio, 
ioÊag
,

449 
kauth_¸ed_t
 
¸ed
, 
off_t
 
osize
, 
ªsid
, 
exãnded
, 
€º‹
)

451 
öode
 *
ù
 = 
	`VTOI
(
vp
);

452 
îr‹
 = 
€º‹
;

455 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

456 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RELATIME
)

457 
ù
->
i_Êag
 |
IN_ACCESS
;

464 i‡(
ªsid
 > 
uio
->
uio_ªsid
 && 
¸ed
) {

465 i‡(
ù
->
i_e2fs_mode
 & 
ISUID
) {

466 i‡(
	`kauth_auth‹ize_vnode
(
¸ed
,

467 
KAUTH_VNODE_RETAIN_SUID
, 
vp
, 
NULL
, 
EPERM
) != 0)

468 
ù
->
i_e2fs_mode
 &
ISUID
;

471 i‡(
ù
->
i_e2fs_mode
 & 
ISGID
) {

472 i‡(
	`kauth_auth‹ize_vnode
(
¸ed
,

473 
KAUTH_VNODE_RETAIN_SGID
, 
vp
, 
NULL
, 
EPERM
) != 0)

474 
ù
->
i_e2fs_mode
 &~
ISGID
;

479 i‡(
ªsid
 > 
uio
->
uio_ªsid
)

480 
	`VN_KNOTE
(
vp
, 
NOTE_WRITE
 | (
exãnded
 ? 
NOTE_EXTEND
 : 0));

486 i‡(
îr‹
) {

487 (Ë
	`ext2fs_åunˇã
(
vp
, 
osize
, 
ioÊag
 & 
IO_SYNC
, 
¸ed
);

488 
uio
->
uio_off£t
 -
ªsid
 - uio->
uio_ªsid
;

489 
uio
->
uio_ªsid
 = 
ªsid
;

490 } i‡(
ªsid
 > 
uio
->
uio_ªsid
 && (
ioÊag
 & 
IO_SYNC
) == IO_SYNC)

491 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
UPDATE_WAIT
);

494 
	`KASSERT
(
vp
->
v_size
 =
	`ext2fs_size
(
ù
));

497 i‡(
€º‹
)

498 
îr‹
 = 
€º‹
;

499  
îr‹
;

500 
	}
}

	@ext2fs_rename.c

36 
	~<sys/cdefs.h
>

37 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_rename.c,v 1.8 2015/03/27 17:27:56Ñiastradh Exp $");

39 
	~<sys/∑øm.h
>

40 
	~<sys/buf.h
>

41 
	~<sys/î∫o.h
>

42 
	~<sys/kauth.h
>

43 
	~<sys/mou¡.h
>

44 
	~<sys/«mei.h
>

45 
	~<sys/vnode.h
>

46 
	~<sys/vnode_if.h
>

48 
	~<miscfs/gífs/gífs.h
>

50 
	~<ufs/ext2fs/ext2fs.h
>

51 
	~<ufs/ext2fs/ext2fs_dú.h
>

52 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

53 
	~<ufs/ufs/öode.h
>

54 
	~<ufs/ufs/ufs_exã∫.h
>

55 
	~<ufs/ufs/ufsmou¡.h
>

60 
ext2fs_ß√_ª«me
(
vnode
 *, 
comp⁄íäame
 *,

61 
vnode
 *, 
comp⁄íäame
 *,

62 
kauth_¸ed_t
, 
boﬁ
);

63 
boﬁ
 
ext2fs_ª«me_uÃ_ovîœp_p
(c⁄° 
ufs_lookup_ªsu…s
 *,

64 c⁄° 
ufs_lookup_ªsu…s
 *);

65 
ext2fs_ª«me_ªˇlcuœã_fuÃ
(
vnode
 *,

66 
ufs_lookup_ªsu…s
 *, const ufs_lookup_results *,

67 c⁄° 
comp⁄íäame
 *);

68 
boﬁ
 
ext2fs_rmdúed_p
(
vnode
 *);

69 
ext2fs_ªad_dŸdŸ
(
vnode
 *, 
kauth_¸ed_t
, 
öo_t
 *);

70 
ext2fs_ª«me_ª∂a˚_dŸdŸ
(
vnode
 *,

71 
vnode
 *, vnodê*, 
kauth_¸ed_t
);

72 
ext2fs_gro_lock_dúe˘‹y
(
mou¡
 *, 
vnode
 *);

74 c⁄° 
gífs_ª«me_›s
 
	gext2fs_gífs_ª«me_›s
;

91 
	$ext2fs_ß√_ª«me
(

92 
vnode
 *
fdvp
, 
comp⁄íäame
 *
f˙p
,

93 
vnode
 *
tdvp
, 
comp⁄íäame
 *
t˙p
,

94 
kauth_¸ed_t
 
¸ed
, 
boﬁ
 
posixly_c‹ª˘
)

96 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

97 
ufs_lookup_ªsu…s
 
fuÃ
, 
tuÃ
;

99  
	`gífs_ß√_ª«me
(&
ext2fs_gífs_ª«me_›s
,

100 
fdvp
, 
f˙p
, &
fuÃ
, 
tdvp
, 
t˙p
, &
tuÃ
,

101 
¸ed
, 
posixly_c‹ª˘
);

102 
	}
}

109 
	$ext2fs_ª«me
(*
v
)

111 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

112  
	`gífs_öß√_ª«me
(
v
, &
ext2fs_ß√_ª«me
);

113 
	}
}

121 
boﬁ


122 
	$ext2fs_gro_dúe˘‹y_em±y_p
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

123 
vnode
 *
vp
, vnodê*
dvp
)

125 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

126 ()
mp
;

127 
	`KASSERT
(
mp
 !
NULL
);

128 
	`KASSERT
(
vp
 !
NULL
);

129 
	`KASSERT
(
dvp
 !
NULL
);

130 
	`KASSERT
(
vp
 !
dvp
);

131 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

132 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

133 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

134 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

136  
	`ext2fs_dúem±y
(
	`VTOI
(
vp
), VTOI(
dvp
)->
i_numbî
, 
¸ed
);

137 
	}
}

144 
	$ext2fs_gro_ª«me_check_possibÀ
(
mou¡
 *
mp
,

145 
vnode
 *
fdvp
, vnodê*
fvp
,

146 
vnode
 *
tdvp
, vnodê*
tvp
)

148 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

149 ()
mp
;

150 
	`KASSERT
(
mp
 !
NULL
);

151 
	`KASSERT
(
fdvp
 !
NULL
);

152 
	`KASSERT
(
fvp
 !
NULL
);

153 
	`KASSERT
(
tdvp
 !
NULL
);

154 
	`KASSERT
(
fdvp
 !
fvp
);

155 
	`KASSERT
(
fdvp
 !
tvp
);

156 
	`KASSERT
(
tdvp
 !
fvp
);

157 
	`KASSERT
(
tdvp
 !
tvp
);

158 
	`KASSERT
(
fvp
 !
tvp
);

159 
	`KASSERT
(
fdvp
->
v_ty≥
 =
VDIR
);

160 
	`KASSERT
(
tdvp
->
v_ty≥
 =
VDIR
);

161 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

162 
	`KASSERT
(
fvp
->
v_mou¡
 =
mp
);

163 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

164 
	`KASSERT
((
tvp
 =
NULL
Ë|| (tvp->
v_mou¡
 =
mp
));

165 
	`KASSERT
(
	`VOP_ISLOCKED
(
fdvp
Ë=
LK_EXCLUSIVE
);

166 
	`KASSERT
(
	`VOP_ISLOCKED
(
fvp
Ë=
LK_EXCLUSIVE
);

167 
	`KASSERT
(
	`VOP_ISLOCKED
(
tdvp
Ë=
LK_EXCLUSIVE
);

168 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
	`VOP_ISLOCKED
—vpË=
LK_EXCLUSIVE
));

170  
	`gífs_uf¶ike_ª«me_check_possibÀ
(

171 
	`VTOI
(
fdvp
)->
i_e2fs_Êags
, VTOI(
fvp
)->i_e2fs_flags,

172 
	`VTOI
(
tdvp
)->
i_e2fs_Êags
, (
tvp
? VTOI(tvp)->i_e2fs_flags : 0),

173 (
tvp
 !
NULL
),

174 
EXT2_IMMUTABLE
, 
EXT2_APPEND
);

175 
	}
}

182 
	$ext2fs_gro_ª«me_check_≥rmôãd
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

183 
vnode
 *
fdvp
, vnodê*
fvp
,

184 
vnode
 *
tdvp
, vnodê*
tvp
)

186 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

187 ()
mp
;

188 
	`KASSERT
(
mp
 !
NULL
);

189 
	`KASSERT
(
fdvp
 !
NULL
);

190 
	`KASSERT
(
fvp
 !
NULL
);

191 
	`KASSERT
(
tdvp
 !
NULL
);

192 
	`KASSERT
(
fdvp
 !
fvp
);

193 
	`KASSERT
(
fdvp
 !
tvp
);

194 
	`KASSERT
(
tdvp
 !
fvp
);

195 
	`KASSERT
(
tdvp
 !
tvp
);

196 
	`KASSERT
(
fvp
 !
tvp
);

197 
	`KASSERT
(
fdvp
->
v_ty≥
 =
VDIR
);

198 
	`KASSERT
(
tdvp
->
v_ty≥
 =
VDIR
);

199 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

200 
	`KASSERT
(
fvp
->
v_mou¡
 =
mp
);

201 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

202 
	`KASSERT
((
tvp
 =
NULL
Ë|| (tvp->
v_mou¡
 =
mp
));

203 
	`KASSERT
(
	`VOP_ISLOCKED
(
fdvp
Ë=
LK_EXCLUSIVE
);

204 
	`KASSERT
(
	`VOP_ISLOCKED
(
fvp
Ë=
LK_EXCLUSIVE
);

205 
	`KASSERT
(
	`VOP_ISLOCKED
(
tdvp
Ë=
LK_EXCLUSIVE
);

206 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
	`VOP_ISLOCKED
—vpË=
LK_EXCLUSIVE
));

208  
	`gífs_uf¶ike_ª«me_check_≥rmôãd
(
¸ed
,

209 
fdvp
, 
	`VTOI
(fdvp)->
i_e2fs_mode
, VTOI(fdvp)->
i_uid
,

210 
fvp
, 
	`VTOI
(fvp)->
i_uid
,

211 
tdvp
, 
	`VTOI
—dvp)->
i_e2fs_mode
, VTOI—dvp)->
i_uid
,

212 
tvp
, (tvp? 
	`VTOI
—vp)->
i_uid
 : 0));

213 
	}
}

220 
	$ext2fs_gro_ªmove_check_possibÀ
(
mou¡
 *
mp
,

221 
vnode
 *
dvp
, vnodê*
vp
)

223 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

224 ()
mp
;

225 
	`KASSERT
(
mp
 !
NULL
);

226 
	`KASSERT
(
dvp
 !
NULL
);

227 
	`KASSERT
(
vp
 !
NULL
);

228 
	`KASSERT
(
dvp
 !
vp
);

229 
	`KASSERT
(
dvp
->
v_ty≥
 =
VDIR
);

230 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

231 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

232 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

233 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

234 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

236  
	`gífs_uf¶ike_ªmove_check_possibÀ
(

237 
	`VTOI
(
dvp
)->
i_e2fs_Êags
, VTOI(
vp
)->i_e2fs_flags,

238 
EXT2_IMMUTABLE
, 
EXT2_APPEND
);

239 
	}
}

246 
	$ext2fs_gro_ªmove_check_≥rmôãd
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

247 
vnode
 *
dvp
, vnodê*
vp
)

249 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

250 ()
mp
;

251 
	`KASSERT
(
mp
 !
NULL
);

252 
	`KASSERT
(
dvp
 !
NULL
);

253 
	`KASSERT
(
vp
 !
NULL
);

254 
	`KASSERT
(
dvp
 !
vp
);

255 
	`KASSERT
(
dvp
->
v_ty≥
 =
VDIR
);

256 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

257 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

258 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

259 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

260 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

262  
	`gífs_uf¶ike_ªmove_check_≥rmôãd
(
¸ed
,

263 
dvp
, 
	`VTOI
(dvp)->
i_e2fs_mode
, VTOI(dvp)->
i_uid
,

264 
vp
, 
	`VTOI
(vp)->
i_uid
);

265 
	}
}

271 
	$ext2fs_gro_ª«me
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

272 
vnode
 *
fdvp
, 
comp⁄íäame
 *
f˙p
,

273 *
fde
, 
vnode
 *
fvp
,

274 
vnode
 *
tdvp
, 
comp⁄íäame
 *
t˙p
,

275 *
tde
, 
vnode
 *
tvp
)

277 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

278 
ufs_lookup_ªsu…s
 *
fuÃ
 = 
fde
;

279 
ufs_lookup_ªsu…s
 *
tuÃ
 = 
tde
;

280 
boﬁ
 
dúe˘‹y_p
, 
ª∑ª¡_p
;

281 
îr‹
;

283 ()
mp
;

284 
	`KASSERT
(
mp
 !
NULL
);

285 
	`KASSERT
(
fdvp
 !
NULL
);

286 
	`KASSERT
(
f˙p
 !
NULL
);

287 
	`KASSERT
(
fuÃ
 !
NULL
);

288 
	`KASSERT
(
fvp
 !
NULL
);

289 
	`KASSERT
(
tdvp
 !
NULL
);

290 
	`KASSERT
(
t˙p
 !
NULL
);

291 
	`KASSERT
(
tuÃ
 !
NULL
);

292 
	`KASSERT
(
fuÃ
 !
tuÃ
);

293 
	`KASSERT
(
fdvp
 !
fvp
);

294 
	`KASSERT
(
fdvp
 !
tvp
);

295 
	`KASSERT
(
tdvp
 !
fvp
);

296 
	`KASSERT
(
tdvp
 !
tvp
);

297 
	`KASSERT
(
fvp
 !
tvp
);

298 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

299 
	`KASSERT
(
fvp
->
v_mou¡
 =
mp
);

300 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

301 
	`KASSERT
((
tvp
 =
NULL
Ë|| (tvp->
v_mou¡
 =
mp
));

302 
	`KASSERT
(
	`VOP_ISLOCKED
(
fdvp
Ë=
LK_EXCLUSIVE
);

303 
	`KASSERT
(
	`VOP_ISLOCKED
(
fvp
Ë=
LK_EXCLUSIVE
);

304 
	`KASSERT
(
	`VOP_ISLOCKED
(
tdvp
Ë=
LK_EXCLUSIVE
);

305 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
	`VOP_ISLOCKED
—vpË=
LK_EXCLUSIVE
));

311 i‡((
∆ök_t
)
	`VTOI
(
fvp
)->
i_e2fs_∆ök
 >
LINK_MAX
)

312  
EMLINK
;

314 
dúe˘‹y_p
 = (
fvp
->
v_ty≥
 =
VDIR
);

315 
	`KASSERT
(
dúe˘‹y_p
 =((
	`VTOI
(
fvp
)->
i_e2fs_mode
 & 
IFMT
Ë=
IFDIR
));

316 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
dúe˘‹y_p
 =—vp->
v_ty≥
 =
VDIR
)));

317 
	`KASSERT
((
tvp
 =
NULL
Ë|| (
dúe˘‹y_p
 ==

318 ((
	`VTOI
(
tvp
)->
i_e2fs_mode
 & 
IFMT
Ë=
IFDIR
)));

320 
ª∑ª¡_p
 = (
fdvp
 !
tdvp
);

321 
	`KASSERT
(
ª∑ª¡_p
 =(
	`VTOI
(
fdvp
)->
i_numbî
 !VTOI(
tdvp
)->i_number));

334 
	`KASSERT
((
∆ök_t
)
	`VTOI
(
fvp
)->
i_e2fs_∆ök
 < 
LINK_MAX
);

335 
	`VTOI
(
fvp
)->
i_e2fs_∆ök
++;

336 
	`VTOI
(
fvp
)->
i_Êag
 |
IN_CHANGE
;

337 
îr‹
 = 
	`ext2fs_upd©e
(
fvp
, 
NULL
, NULL, 
UPDATE_WAIT
);

338 i‡(
îr‹
)

339 
whymu°ôhuπsomuch
;

349 i‡(
tvp
 =
NULL
) {

355 i‡(
dúe˘‹y_p
 && 
ª∑ª¡_p
) {

356 i‡((
∆ök_t
)
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
 >
LINK_MAX
) {

357 
îr‹
 = 
EMLINK
;

358 
whymu°ôhuπsomuch
;

360 
	`KASSERT
((
∆ök_t
)
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
 < 
LINK_MAX
);

361 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
++;

362 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

363 
îr‹
 = 
	`ext2fs_upd©e
(
tdvp
, 
NULL
, NULL, 
UPDATE_WAIT
);

364 i‡(
îr‹
) {

369 
	`KASSERT
(0 < 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
);

370 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
--;

371 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

372 
whymu°ôhuπsomuch
;

376 
îr‹
 = 
	`ext2fs_dúíãr
(
	`VTOI
(
fvp
), 
tdvp
, 
tuÃ
, 
t˙p
);

377 i‡(
îr‹
) {

378 i‡(
dúe˘‹y_p
 && 
ª∑ª¡_p
) {

385 
	`KASSERT
(0 < 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
);

386 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
--;

387 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

388 ()
	`ext2fs_upd©e
(
tdvp
, 
NULL
, NULL,

389 
UPDATE_WAIT
);

391 
whymu°ôhuπsomuch
;

394 i‡(
dúe˘‹y_p
)

396 
	`ˇche_purge
(
tdvp
);

402 
îr‹
 = 
	`ext2fs_dúªwrôe
(
	`VTOI
(
tdvp
), 
tuÃ
, VTOI(
fvp
), 
t˙p
);

403 i‡(
îr‹
)

404 
whymu°ôhuπsomuch
;

413 i‡(
dúe˘‹y_p
 && !
ª∑ª¡_p
) {

414 
	`KASSERT
(
fdvp
 =
tdvp
);

416 
	`KASSERT
(0 < 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
);

417 
	`VTOI
(
tdvp
)->
i_e2fs_∆ök
--;

418 
	`VTOI
(
tdvp
)->
i_Êag
 |
IN_CHANGE
;

432 
	`KASSERT
(0 < 
	`VTOI
(
tvp
)->
i_e2fs_∆ök
);

433 
	`VTOI
(
tvp
)->
i_e2fs_∆ök
--;

434 i‡(
dúe˘‹y_p
) {

439 i‡(
	`VTOI
(
tvp
)->
i_e2fs_∆ök
 != 1)

440 
	`ufs_dúbad
(
	`VTOI
(
tvp
), (
doff_t
)0,

442 
	`VTOI
(
tvp
)->
i_e2fs_∆ök
 = 0;

443 
îr‹
 = 
	`ext2fs_åunˇã
(
tvp
, (
off_t
)0, 
IO_SYNC
, 
¸ed
);

445 i‡(
îr‹
)

446 
whymu°ôhuπsomuch
;

453 
	`VTOI
(
tvp
)->
i_Êag
 |
IN_CHANGE
;

461 i‡(
dúe˘‹y_p
 && 
ª∑ª¡_p
) {

462 
îr‹
 = 
	`ext2fs_ª«me_ª∂a˚_dŸdŸ
(
fvp
, 
fdvp
, 
tdvp
, 
¸ed
);

463 i‡(
îr‹
)

464 
whymu°ôhuπsomuch
;

467 
	`ˇche_purge
(
fdvp
);

480 i‡(!
ª∑ª¡_p
 && (
tvp
 =
NULL
) &&

481 
	`ext2fs_ª«me_uÃ_ovîœp_p
(
fuÃ
, 
tuÃ
)) {

482 
îr‹
 = 
	`ext2fs_ª«me_ªˇlcuœã_fuÃ
(
fdvp
, 
fuÃ
, 
tuÃ
, 
f˙p
);

484 i‡(
îr‹
)

485 
whymu°ôhuπsomuch
;

489 
îr‹
 = 
	`ext2fs_dúªmove
(
fdvp
, 
fuÃ
, 
f˙p
);

490 i‡(
îr‹
)

491 
whymu°ôhuπsomuch
;

498 
	`gífs_ª«me_knŸe
(
fdvp
, 
fvp
, 
tdvp
, 
tvp
,

499 ((
tvp
 !
NULL
Ë&& (
	`VTOI
—vp)->
i_e2fs_∆ök
 == 0)));

501 
	`gífs_ª«me_ˇche_purge
(
fdvp
, 
fvp
, 
tdvp
, 
tvp
);

504 
whymu°ôhuπsomuch
:

505 
	`KASSERT
(0 < 
	`VTOI
(
fvp
)->
i_e2fs_∆ök
);

506 
	`VTOI
(
fvp
)->
i_e2fs_∆ök
--;

507 
	`VTOI
(
fvp
)->
i_Êag
 |
IN_CHANGE
;

508  
îr‹
;

509 
	}
}

515 
boﬁ


516 
	$ext2fs_ª«me_uÃ_ovîœp_p
(c⁄° 
ufs_lookup_ªsu…s
 *
fuÃ
,

517 c⁄° 
ufs_lookup_ªsu…s
 *
tuÃ
)

519 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

520 
doff_t
 
‰om_¥ev_°¨t
, 
‰om_¥ev_íd
, 
to_°¨t
, 
to_íd
;

522 
	`KASSERT
(
fuÃ
 !
NULL
);

523 
	`KASSERT
(
tuÃ
 !
NULL
);

524 
	`KASSERT
(
fuÃ
 !
tuÃ
);

530 
‰om_¥ev_íd
 = 
fuÃ
->
uÃ_off£t
;

531 
	`KASSERT
(
fuÃ
->
uÃ_cou¡
 <
‰om_¥ev_íd
);

532 
‰om_¥ev_°¨t
 = (
‰om_¥ev_íd
 - 
fuÃ
->
uÃ_cou¡
);

538 
to_°¨t
 = 
tuÃ
->
uÃ_off£t
;

539 
	`KASSERT
(
tuÃ
->
uÃ_cou¡
 < (
EXT2FS_MAXDIRSIZE
 - 
to_°¨t
));

540 
to_íd
 = (
to_°¨t
 + 
tuÃ
->
uÃ_cou¡
);

543 (((
to_°¨t
 <
‰om_¥ev_°¨t
Ë&& (‰om_¥ev_°¨à< 
to_íd
)) ||

544 ((
to_°¨t
 <
‰om_¥ev_íd
Ë&& (‰om_¥ev_íd < 
to_íd
)));

545 
	}
}

554 
	$ext2fs_ª«me_ªˇlcuœã_fuÃ
(
vnode
 *
dvp
,

555 
ufs_lookup_ªsu…s
 *
fuÃ
, c⁄° ufs_lookup_ªsu…†*
tuÃ
,

556 c⁄° 
comp⁄íäame
 *
f˙p
)

558 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

559 
mou¡
 *
mp
;

560 
ufsmou¡
 *
ump
;

562 
dúblksiz
;

563 
doff_t
 
£¨ch_°¨t
, 
£¨ch_íd
;

564 
doff_t
 
off£t
;

565 
buf
 *
bp
;

566 *
dúbuf
;

567 
ext2fs_dúe˘
 *
ï
;

570 
uöt32_t
 
ª˛í
;

571 
uöt32_t
 
¥ev_ª˛í
;

572 
îr‹
;

574 
	`KASSERT
(
dvp
 !
NULL
);

575 
	`KASSERT
(
dvp
->
v_mou¡
 !
NULL
);

576 
	`KASSERT
(
	`VTOI
(
dvp
Ë!
NULL
);

577 
	`KASSERT
(
fuÃ
 !
NULL
);

578 
	`KASSERT
(
tuÃ
 !
NULL
);

579 
	`KASSERT
(
fuÃ
 !
tuÃ
);

580 
	`KASSERT
(
	`ext2fs_ª«me_uÃ_ovîœp_p
(
fuÃ
, 
tuÃ
));

582 
mp
 = 
dvp
->
v_mou¡
;

583 
ump
 = 
	`VFSTOUFS
(
mp
);

584 
	`KASSERT
(
ump
 !
NULL
);

585 
	`KASSERT
(
ump
 =
	`VTOI
(
dvp
)->
i_ump
);

587 
dúblksiz
 = 
ump
->
um_dúblksiz
;

588 
	`KASSERT
(0 < 
dúblksiz
);

589 
	`KASSERT
((
dúblksiz
 & (dirblksiz - 1)) == 0);

592 
	`KASSERT
(
dúblksiz
 <
mp
->
m¡_°©
.
f_iosize
);

595 
£¨ch_°¨t
 = 
tuÃ
->
uÃ_off£t
;

596 
	`KASSERT
(
fuÃ
->
uÃ_ª˛í
 < (
EXT2FS_MAXDIRSIZE
 - fuÃ->
uÃ_off£t
));

597 
£¨ch_íd
 = (
fuÃ
->
uÃ_off£t
 + fuÃ->
uÃ_ª˛í
);

600 
	`KASSERT
(
£¨ch_°¨t
 <
£¨ch_íd
);

601 
	`KASSERT
((
£¨ch_íd
 - (
£¨ch_°¨t
 &~ (
dúblksiz
 - 1))) <= dirblksiz);

603 
dúbuf
 = 
NULL
;

604 
bp
 = 
NULL
;

605 
îr‹
 = 
	`ext2fs_blk©off
(
dvp
, (
off_t
)
£¨ch_°¨t
, &
dúbuf
, &
bp
);

606 i‡(
îr‹
)

607  
îr‹
;

608 
	`KASSERT
(
dúbuf
 !
NULL
);

609 
	`KASSERT
(
bp
 !
NULL
);

616 
	`KASSERT
((
£¨ch_íd
 - 
£¨ch_°¨t
) <=

617 (
bp
->
b_bcou¡
 - (
£¨ch_°¨t
 & (
mp
->
m¡_°©
.
f_iosize
 - 1))));

619 
¥ev_ª˛í
 = 
fuÃ
->
uÃ_cou¡
;

620 
off£t
 = 
£¨ch_°¨t
;

628 
	`KASSERT
(
£¨ch_°¨t
 <
off£t
);

629 
	`KASSERT
(
off£t
 < 
£¨ch_íd
);

634 
ï
 = (
ext2fs_dúe˘
 *)

635 (
dúbuf
 + (
off£t
 - 
£¨ch_°¨t
));

636 
ª˛í
 = 
	`fs2h16
(
ï
->
e2d_ª˛í
);

638 i‡(
ï
->
e2d_öo
 == 0)

639 
√xt
;

641 i‡(
	`fs2h32
(
ï
->
e2d_öo
Ë=
UFS_WINO
)

642 
√xt
;

644 i‡(
f˙p
->
˙_«mñí
 !
ï
->
e2d_«mÀn
)

645 
√xt
;

647 i‡(
	`memcmp
(
ï
->
e2d_«me
, 
f˙p
->
˙_«mïå
, f˙p->
˙_«mñí
))

648 
√xt
;

653 
√xt
:

654 i‡(! ((
ª˛í
 < 
£¨ch_íd
) &&

655 (
off£t
 < (
£¨ch_íd
 - 
ª˛í
)))) {

656 
	`bªl£
(
bp
, 0);

657  
EIO
;

661 
	`KASSERT
(
ª˛í
 < 
£¨ch_íd
);

662 
	`KASSERT
(
off£t
 < (
£¨ch_íd
 - 
ª˛í
));

668 
	`KASSERT
((
off£t
 &~ (
dúblksiz
 - 1)) ==

669 ((
off£t
 + 
ª˛í
Ë&~ (
dúblksiz
 - 1)));

671 
¥ev_ª˛í
 = 
ª˛í
;

672 
off£t
 +
ª˛í
;

678 
fuÃ
->
uÃ_off£t
 = 
off£t
;

679 
fuÃ
->
uÃ_ª˛í
 = 
ª˛í
;

685 
fuÃ
->
uÃ_cou¡
 = ((
off£t
 & (
dúblksiz
 - 1))? 
¥ev_ª˛í
 : 0);

687 
	`bªl£
(
bp
, 0);

689 
	}
}

696 
	$ext2fs_gro_ªmove
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

697 
vnode
 *
dvp
, 
comp⁄íäame
 *
˙p
, *
de
, vnodê*
vp
)

699 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

700 
ufs_lookup_ªsu…s
 *
uÃ
 = 
de
;

701 
îr‹
;

703 ()
mp
;

704 
	`KASSERT
(
mp
 !
NULL
);

705 
	`KASSERT
(
dvp
 !
NULL
);

706 
	`KASSERT
(
˙p
 !
NULL
);

707 
	`KASSERT
(
uÃ
 !
NULL
);

708 
	`KASSERT
(
vp
 !
NULL
);

709 
	`KASSERT
(
dvp
 !
vp
);

710 
	`KASSERT
(
dvp
->
v_mou¡
 =
mp
);

711 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

712 
	`KASSERT
(
dvp
->
v_ty≥
 =
VDIR
);

713 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

714 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

715 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

717 
îr‹
 = 
	`ext2fs_dúªmove
(
dvp
, 
uÃ
, 
˙p
);

718 i‡(
îr‹
)

719  
îr‹
;

721 
	`KASSERT
(0 < 
	`VTOI
(
vp
)->
i_e2fs_∆ök
);

722 
	`VTOI
(
vp
)->
i_e2fs_∆ök
--;

723 
	`VTOI
(
vp
)->
i_Êag
 |
IN_CHANGE
;

725 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
);

726 
	`VN_KNOTE
(
vp
, (
	`VTOI
(vp)->
i_e2fs_∆ök
? 
NOTE_LINK
 : 
NOTE_DELETE
));

729 
	}
}

735 
	$ext2fs_gro_lookup
(
mou¡
 *
mp
, 
vnode
 *
dvp
,

736 
comp⁄íäame
 *
˙p
, *
de_ªt
, 
vnode
 **
vp_ªt
)

738 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

739 
ufs_lookup_ªsu…s
 *
uÃ_ªt
 = 
de_ªt
;

740 
vnode
 *
vp
;

741 
îr‹
;

743 ()
mp
;

744 
	`KASSERT
(
mp
 !
NULL
);

745 
	`KASSERT
(
dvp
 !
NULL
);

746 
	`KASSERT
(
˙p
 !
NULL
);

747 
	`KASSERT
(
uÃ_ªt
 !
NULL
);

748 
	`KASSERT
(
vp_ªt
 !
NULL
);

749 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

752 
˙p
->
˙_Êags
 &=~ 
MODMASK
;

753 
˙p
->
˙_Êags
 |(
LOCKPARENT
 | 
LOCKLEAF
);

755 
îr‹
 = 
	`ªlookup
(
dvp
, &
vp
, 
˙p
, 0 );

756 i‡((
îr‹
 =0Ë&& (
vp
 =
NULL
)) {

757 
îr‹
 = 
ENOENT
;

758 
out
;

759 } i‡(
îr‹
) {

760  
îr‹
;

767 
	`KASSERT
(
vp
 !
NULL
);

768 
	`VOP_UNLOCK
(
vp
);

770 
out
: *
uÃ_ªt
 = 
	`VTOI
(
dvp
)->
i_¸≠
;

771 *
vp_ªt
 = 
vp
;

772  
îr‹
;

773 
	}
}

780 
boﬁ


781 
	$ext2fs_rmdúed_p
(
vnode
 *
vp
)

783 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

784 
	`KASSERT
(
vp
 !
NULL
);

785 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

786 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
);

789  (
	`ext2fs_size
(
	`VTOI
(
vp
)) == 0);

790 
	}
}

797 
	$ext2fs_gro_gíólogy
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
,

798 
vnode
 *
fdvp
, vnodê*
tdvp
,

799 
vnode
 **
öãrmedüã_node_ªt
)

801 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

802 
vnode
 *
vp
, *
dvp
;

803 
öo_t
 
dŸdŸ_öo
 = -1;

804 
îr‹
;

806 
	`KASSERT
(
mp
 !
NULL
);

807 
	`KASSERT
(
fdvp
 !
NULL
);

808 
	`KASSERT
(
tdvp
 !
NULL
);

809 
	`KASSERT
(
fdvp
 !
tdvp
);

810 
	`KASSERT
(
öãrmedüã_node_ªt
 !
NULL
);

811 
	`KASSERT
(
fdvp
->
v_mou¡
 =
mp
);

812 
	`KASSERT
(
tdvp
->
v_mou¡
 =
mp
);

813 
	`KASSERT
(
fdvp
->
v_ty≥
 =
VDIR
);

814 
	`KASSERT
(
tdvp
->
v_ty≥
 =
VDIR
);

820 
îr‹
 = 
	`ext2fs_gro_lock_dúe˘‹y
(
mp
, 
tdvp
);

821 i‡(
îr‹
)

822  
îr‹
;

824 
vp
 = 
tdvp
;

825 
	`vªf
(
vp
);

828 
	`KASSERT
(
vp
 !
NULL
);

829 
	`KASSERT
(
	`VOP_ISLOCKED
(
vp
Ë=
LK_EXCLUSIVE
);

830 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

831 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
);

832 
	`KASSERT
(!
	`ext2fs_rmdúed_p
(
vp
));

835 i‡(
	`VTOI
(
vp
)->
i_numbî
 =
UFS_ROOTINO
) {

836 
	`vput
(
vp
);

837 *
öãrmedüã_node_ªt
 = 
NULL
;

841 
îr‹
 = 
	`ext2fs_ªad_dŸdŸ
(
vp
, 
¸ed
, &
dŸdŸ_öo
);

842 i‡(
îr‹
) {

843 
	`vput
(
vp
);

844  
îr‹
;

848 i‡(
	`VTOI
(
fdvp
)->
i_numbî
 =
dŸdŸ_öo
) {

850 
	`VOP_UNLOCK
(
vp
);

851 *
öãrmedüã_node_ªt
 = 
vp
;

856 
îr‹
 = 
	`vˇche_gë
(
mp
, &
dŸdŸ_öo
, (dŸdŸ_öo), &
dvp
);

857 
	`vput
(
vp
);

858 i‡(
îr‹
)

859  
îr‹
;

860 
îr‹
 = 
	`vn_lock
(
dvp
, 
LK_EXCLUSIVE
);

861 i‡(
îr‹
) {

862 
	`vªÀ
(
dvp
);

863  
îr‹
;

866 
	`KASSERT
(
dvp
 !
NULL
);

867 
	`KASSERT
(
	`VOP_ISLOCKED
(
dvp
Ë=
LK_EXCLUSIVE
);

868 
vp
 = 
dvp
;

870 i‡(
vp
->
v_ty≥
 !
VDIR
) {

877 
	`vput
(
vp
);

878  
ENOTDIR
;

881 i‡(
	`ext2fs_rmdúed_p
(
vp
)) {

882 
	`vput
(
vp
);

883  
ENOENT
;

886 
	}
}

893 
	$ext2fs_ªad_dŸdŸ
(
vnode
 *
vp
, 
kauth_¸ed_t
 
¸ed
, 
öo_t
 *
öo_ªt
)

895 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

896 
ext2fs_dúãm∂©e
 
dúbuf
;

897 
îr‹
;

899 
	`KASSERT
(
vp
 !
NULL
);

900 
	`KASSERT
(
öo_ªt
 !
NULL
);

901 
	`KASSERT
(
vp
->
v_ty≥
 =
VDIR
);

903 
îr‹
 = 
	`ufs_bufio
(
UIO_READ
, 
vp
, &
dúbuf
,  dúbuf, (
off_t
)0,

904 
IO_NODELOCKED
, 
¸ed
, 
NULL
, NULL);

905 i‡(
îr‹
)

906  
îr‹
;

908 i‡(
dúbuf
.
dŸdŸ_«mÀn
 != 2 ||

909 
dúbuf
.
dŸdŸ_«me
[0] != '.' ||

910 
dúbuf
.
dŸdŸ_«me
[1] != '.')

912  
ENOTDIR
;

914 *
öo_ªt
 = 
	`fs2h32
(
dúbuf
.
dŸdŸ_öo
);

916 
	}
}

923 
	$ext2fs_ª«me_ª∂a˚_dŸdŸ
(
vnode
 *
vp
,

924 
vnode
 *
fdvp
, vnodê*
tdvp
,

925 
kauth_¸ed_t
 
¸ed
)

927 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

928 
ext2fs_dúãm∂©e
 
dúbuf
;

929 
îr‹
;

932 
	`KASSERT
(0 < 
	`VTOI
(
fdvp
)->
i_e2fs_∆ök
);

933 
	`VTOI
(
fdvp
)->
i_e2fs_∆ök
--;

934 
	`VTOI
(
fdvp
)->
i_Êag
 |
IN_CHANGE
;

936 
îr‹
 = 
	`ufs_bufio
(
UIO_READ
, 
vp
, &
dúbuf
,  dúbuf, (
off_t
)0,

937 
IO_NODELOCKED
, 
¸ed
, 
NULL
, NULL);

938 i‡(
îr‹
)

939  
îr‹
;

941 i‡(
dúbuf
.
dŸdŸ_«mÀn
 != 2 ||

942 
dúbuf
.
dŸdŸ_«me
[0] != '.' ||

943 
dúbuf
.
dŸdŸ_«me
[1] != '.') {

944 
	`ufs_dúbad
(
	`VTOI
(
vp
), (
doff_t
)12, "bad `..'Éntry");

948 i‡(
	`fs2h32
(
dúbuf
.
dŸdŸ_öo
Ë!
	`VTOI
(
fdvp
)->
i_numbî
) {

949 
	`ufs_dúbad
(
	`VTOI
(
vp
), (
doff_t
)12,

954 
dúbuf
.
dŸdŸ_öo
 = 
	`h2fs32
(
	`VTOI
(
tdvp
)->
i_numbî
);

956 ()
	`ufs_bufio
(
UIO_WRITE
, 
vp
, &
dúbuf
,  dúbuf, (
off_t
)0,

957 (
IO_NODELOCKED
 | 
IO_SYNC
), 
¸ed
, 
NULL
, NULL);

960 
	}
}

967 
	$ext2fs_gro_lock_dúe˘‹y
(
mou¡
 *
mp
, 
vnode
 *
vp
)

970 ()
mp
;

971 
	`KASSERT
(
mp
 !
NULL
);

972 
	`KASSERT
(
vp
 !
NULL
);

973 
	`KASSERT
(
vp
->
v_mou¡
 =
mp
);

975 
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

977 i‡(
	`ext2fs_rmdúed_p
(
vp
)) {

978 
	`VOP_UNLOCK
(
vp
);

979  
ENOENT
;

983 
	}
}

985 c⁄° 
gífs_ª«me_›s
 
	gext2fs_gífs_ª«me_›s
 = {

986 .
gro_dúe˘‹y_em±y_p
 = 
ext2fs_gro_dúe˘‹y_em±y_p
,

987 .
	ggro_ª«me_check_possibÀ
 = 
ext2fs_gro_ª«me_check_possibÀ
,

988 .
	ggro_ª«me_check_≥rmôãd
 = 
ext2fs_gro_ª«me_check_≥rmôãd
,

989 .
	ggro_ªmove_check_possibÀ
 = 
ext2fs_gro_ªmove_check_possibÀ
,

990 .
	ggro_ªmove_check_≥rmôãd
 = 
ext2fs_gro_ªmove_check_≥rmôãd
,

991 .
	ggro_ª«me
 = 
ext2fs_gro_ª«me
,

992 .
	ggro_ªmove
 = 
ext2fs_gro_ªmove
,

993 .
	ggro_lookup
 = 
ext2fs_gro_lookup
,

994 .
	ggro_gíólogy
 = 
ext2fs_gro_gíólogy
,

995 .
	ggro_lock_dúe˘‹y
 = 
ext2fs_gro_lock_dúe˘‹y
,

	@ext2fs_subr.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_subr.c,v 1.31 2015/03/28 19:24:04 maxv Exp $");

65 
	~<sys/∑øm.h
>

66 
	~<sys/sy°m.h
>

67 
	~<sys/vnode.h
>

68 
	~<sys/buf.h
>

69 
	~<sys/öây≥s.h
>

70 
	~<sys/kauth.h
>

72 
	~<ufs/ufs/öode.h
>

73 
	~<ufs/ext2fs/ext2fs.h
>

74 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

82 
	$ext2fs_blk©off
(
vnode
 *
vp
, 
off_t
 
off£t
, **
ªs
, 
buf
 **
bµ
)

84 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

85 
öode
 *
ù
;

86 
m_ext2fs
 *
fs
;

87 
buf
 *
bp
;

88 
daddr_t
 
lbn
;

89 
îr‹
;

91 
ù
 = 
	`VTOI
(
vp
);

92 
fs
 = 
ù
->
i_e2fs
;

93 
lbn
 = 
	`ext2_lblkno
(
fs
, 
off£t
);

95 *
bµ
 = 
NULL
;

96 i‡((
îr‹
 = 
	`bªad
(
vp
, 
lbn
, 
fs
->
e2fs_bsize
, 0, &
bp
)) != 0) {

97  (
îr‹
);

99 i‡(
ªs
)

100 *
ªs
 = (*)
bp
->
b_d©a
 + 
	`ext2_blkoff
(
fs
, 
off£t
);

101 *
bµ
 = 
bp
;

103 
	}
}

106 
	$ext2fs_ôimes
(
öode
 *
ù
, c⁄° 
time•ec
 *
acc
,

107 c⁄° 
time•ec
 *
mod
, c⁄° time•e¯*
¸e
)

109 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

110 
time•ec
 
now
;

112 i‡(!(
ù
->
i_Êag
 & (
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFY
))) {

116 
	`vfs_time°amp
(&
now
);

117 i‡(
ù
->
i_Êag
 & 
IN_ACCESS
) {

118 i‡(
acc
 =
NULL
)

119 
acc
 = &
now
;

120 
ù
->
i_e2fs_©ime
 = 
acc
->
tv_£c
;

122 i‡(
ù
->
i_Êag
 & (
IN_UPDATE
 | 
IN_MODIFY
)) {

123 i‡(
mod
 =
NULL
)

124 
mod
 = &
now
;

125 
ù
->
i_e2fs_mtime
 = 
mod
->
tv_£c
;

126 
ù
->
i_modªv
++;

128 i‡(
ù
->
i_Êag
 & (
IN_CHANGE
 | 
IN_MODIFY
)) {

129 i‡(
¸e
 =
NULL
)

130 
¸e
 = &
now
;

131 
ù
->
i_e2fs_˘ime
 = 
¸e
->
tv_£c
;

133 i‡(
ù
->
i_Êag
 & (
IN_ACCESS
 | 
IN_MODIFY
))

134 
ù
->
i_Êag
 |
IN_ACCESSED
;

135 i‡(
ù
->
i_Êag
 & (
IN_UPDATE
 | 
IN_CHANGE
))

136 
ù
->
i_Êag
 |
IN_MODIFIED
;

137 
ù
->
i_Êag
 &~(
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFY
);

138 
	}
}

	@ext2fs_vfsops.c

62 
	~<sys/cdefs.h
>

63 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_vfsops.c,v 1.193 2015/03/28 19:24:04 maxv Exp $");

65 #i‡
deföed
(
_KERNEL_OPT
)

66 
	~"›t_com∑t_√tbsd.h
"

69 
	~<sys/∑øm.h
>

70 
	~<sys/sy°m.h
>

71 
	~<sys/sys˘l.h
>

72 
	~<sys/«mei.h
>

73 
	~<sys/¥oc.h
>

74 
	~<sys/kî√l.h
>

75 
	~<sys/vnode.h
>

76 
	~<sys/sockë.h
>

77 
	~<sys/mou¡.h
>

78 
	~<sys/buf.h
>

79 
	~<sys/devi˚.h
>

80 
	~<sys/mbuf.h
>

81 
	~<sys/fûe.h
>

82 
	~<sys/diskœbñ.h
>

83 
	~<sys/io˘l.h
>

84 
	~<sys/î∫o.h
>

85 
	~<sys/poﬁ.h
>

86 
	~<sys/lock.h
>

87 
	~<sys/c⁄f.h
>

88 
	~<sys/kauth.h
>

89 
	~<sys/moduÀ.h
>

91 
	~<miscfs/gífs/gífs.h
>

92 
	~<miscfs/•ecfs/•ecdev.h
>

94 
	~<ufs/ufs/quŸa.h
>

95 
	~<ufs/ufs/ufsmou¡.h
>

96 
	~<ufs/ufs/öode.h
>

97 
	~<ufs/ufs/dú.h
>

98 
	~<ufs/ufs/ufs_exã∫.h
>

100 
	~<ufs/ext2fs/ext2fs.h
>

101 
	~<ufs/ext2fs/ext2fs_dú.h
>

102 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

104 
MODULE
(
MODULE_CLASS_VFS
, 
ext2fs
, "ffs");

106 
ext2fs_sbupd©e
(
ufsmou¡
 *, );

107 
ext2fs_sbfûl
(
m_ext2fs
 *, );

109 
sys˘Œog
 *
	gext2fs_sys˘l_log
;

111 c⁄° 
vnode›v_desc
 
ext2fs_vnode›_›v_desc
;

112 c⁄° 
vnode›v_desc
 
ext2fs_•ec›_›v_desc
;

113 c⁄° 
vnode›v_desc
 
ext2fs_fifo›_›v_desc
;

115 c⁄° 
vnode›v_desc
 * c⁄° 
	gext2fs_vnode›v_descs
[] = {

116 &
ext2fs_vnode›_›v_desc
,

117 &
ext2fs_•ec›_›v_desc
,

118 &
ext2fs_fifo›_›v_desc
,

119 
NULL
,

122 
vfs›s
 
	gext2fs_vfs›s
 = {

123 .
vfs_«me
 = 
MOUNT_EXT2FS
,

124 .
	gvfs_mö_mou¡_d©a
 =  (
ufs_¨gs
),

125 .
	gvfs_mou¡
 = 
ext2fs_mou¡
,

126 .
	gvfs_°¨t
 = 
ufs_°¨t
,

127 .
	gvfs_unmou¡
 = 
ext2fs_unmou¡
,

128 .
	gvfs_roŸ
 = 
ufs_roŸ
,

129 .
	gvfs_quŸa˘l
 = 
ufs_quŸa˘l
,

130 .
	gvfs_°©vfs
 = 
ext2fs_°©vfs
,

131 .
	gvfs_sync
 = 
ext2fs_sync
,

132 .
	gvfs_vgë
 = 
ufs_vgë
,

133 .
	gvfs_lﬂdvnode
 = 
ext2fs_lﬂdvnode
,

134 .
	gvfs_fhtovp
 = 
ext2fs_fhtovp
,

135 .
	gvfs_v±ofh
 = 
ext2fs_v±ofh
,

136 .
	gvfs_öô
 = 
ext2fs_öô
,

137 .
	gvfs_ªöô
 = 
ext2fs_ªöô
,

138 .
	gvfs_d⁄e
 = 
ext2fs_d⁄e
,

139 .
	gvfs_mou¡roŸ
 = 
ext2fs_mou¡roŸ
,

140 .
	gvfs_¢≠shŸ
 = (*)
e›nŸsuµ
,

141 .
	gvfs_exèâr˘l
 = 
vfs_°dexèâr˘l
,

142 .
	gvfs_su•íd˘l
 = (*)
e›nŸsuµ
,

143 .
	gvfs_ª«mñock_íãr
 = 
gífs_ª«mñock_íãr
,

144 .
	gvfs_ª«mñock_exô
 = 
gífs_ª«mñock_exô
,

145 .
	gvfs_fsync
 = (*)
e›nŸsuµ
,

146 .
	gvfs_›v_descs
 = 
ext2fs_vnode›v_descs


149 c⁄° 
gífs_›s
 
	gext2fs_gífs›s
 = {

150 .
g›_size
 = 
gífs_size
,

151 .
	gg›_Æloc
 = 
ext2fs_g›_Æloc
,

152 .
	gg›_wrôe
 = 
gífs_g›_wrôe
,

153 .
	gg›_m¨kupd©e
 = 
ufs_g›_m¨kupd©e
,

156 c⁄° 
ufs_›s
 
	gext2fs_ufs›s
 = {

157 .
uo_ôimes
 = 
ext2fs_ôimes
,

158 .
	guo_upd©e
 = 
ext2fs_upd©e
,

159 .
	guo_bu‰d
 = 
ext2fs_bu‰d
,

160 .
	guo_bufwr
 = 
ext2fs_bufwr
,

165 
	$ext2fs_£t_öode_guid
(
öode
 *
ù
)

167 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

169 
ù
->
i_gid
 = ip->
i_e2fs_gid
;

170 
ù
->
i_uid
 = ip->
i_e2fs_uid
;

171 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

172 
ù
->
i_gid
 |ù->
i_e2fs_gid_high
 << 16;

173 
ù
->
i_uid
 |ù->
i_e2fs_uid_high
 << 16;

175 
	}
}

178 
	$ext2fs_modcmd
(
modcmd_t
 
cmd
, *
¨g
)

180 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

181 
îr‹
;

183 
cmd
) {

184 
MODULE_CMD_INIT
:

185 
îr‹
 = 
	`vfs_©èch
(&
ext2fs_vfs›s
);

186 i‡(
îr‹
 != 0)

188 
	`sys˘l_¸óãv
(&
ext2fs_sys˘l_log
, 0, 
NULL
, NULL,

189 
CTLFLAG_PERMANENT
,

190 
CTLTYPE_NODE
, "ext2fs",

191 
	`SYSCTL_DESCR
("Linux EXT2FS file system"),

192 
NULL
, 0, NULL, 0,

193 
CTL_VFS
, 17, 
CTL_EOL
);

200 
MODULE_CMD_FINI
:

201 
îr‹
 = 
	`vfs_dëach
(&
ext2fs_vfs›s
);

202 i‡(
îr‹
 != 0)

204 
	`sys˘l_ã¨down
(&
ext2fs_sys˘l_log
);

207 
îr‹
 = 
ENOTTY
;

211  (
îr‹
);

212 
	}
}

217 
poﬁ
 
	gext2fs_öode_poﬁ
;

218 
poﬁ
 
	gext2fs_döode_poﬁ
;

220 
u_l⁄g
 
ext2gínumbî
;

223 
	$ext2fs_öô
()

225 
	`¥ötf
("insideÉxt2fs_init\n");

226 
	`poﬁ_öô
(&
ext2fs_öode_poﬁ
, (
öode
), 0, 0, 0,

227 "ext2fsö›l", &
poﬁ_Æloˇt‹_noöå
, 
IPL_NONE
);

228 
	`poﬁ_öô
(&
ext2fs_döode_poﬁ
, (
ext2fs_döode
), 0, 0, 0,

229 "ext2dö›l", &
poﬁ_Æloˇt‹_noöå
, 
IPL_NONE
);

230 
	`ufs_öô
();

231 
	}
}

234 
	$ext2fs_ªöô
()

236 
	`ufs_ªöô
();

237 
	}
}

240 
	$ext2fs_d⁄e
()

243 
	`ufs_d⁄e
();

244 
	`poﬁ_de°roy
(&
ext2fs_öode_poﬁ
);

245 
	`poﬁ_de°roy
(&
ext2fs_döode_poﬁ
);

246 
	}
}

255 
	$ext2fs_mou¡roŸ
()

257 
	`¥ötf
("ext2fs_mountroot\n");

258 
vnode
 *
roŸvp
;

259 
m_ext2fs
 *
fs
;

260 
mou¡
 *
mp
;

261 
ufsmou¡
 *
ump
;

262 
îr‹
;

264 i‡(
	`devi˚_˛ass
(
roŸ_devi˚
Ë!
DV_DISK
)

265  (
ENODEV
);

267 i‡((
îr‹
 = 
	`vfs_roŸmou¡Æloc
(
MOUNT_EXT2FS
, "roŸ_devi˚", &
mp
))) {

268 
	`vªÀ
(
roŸvp
);

269  (
îr‹
);

272 i‡((
îr‹
 = 
	`ext2fs_mou¡fs
(
roŸvp
, 
mp
)) != 0) {

273 
	`vfs_unbusy
(
mp
, 
Ál£
, 
NULL
);

274 
	`vfs_de°roy
(
mp
);

275  (
îr‹
);

277 
	`mou¡li°_≠≥nd
(
mp
);

278 
ump
 = 
	`VFSTOUFS
(
mp
);

279 
fs
 = 
ump
->
um_e2fs
;

280 
	`mem£t
(
fs
->
e2fs_fsm¡
, 0, (fs->e2fs_fsmnt));

281 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs_fsm¡
,

282 (
fs
->
e2fs_fsm¡
) - 1, 0);

283 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

284 
	`mem£t
(
fs
->
e2fs
.
e2fs_fsm¡
, 0, (fs->e2fs.e2fs_fsmnt));

285 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs
.
e2fs_fsm¡
,

286 (
fs
->
e2fs
.
e2fs_fsm¡
) - 1, 0);

288 ()
	`ext2fs_°©vfs
(
mp
, &mp->
m¡_°©
);

289 
	`vfs_unbusy
(
mp
, 
Ál£
, 
NULL
);

290 
	`£åoŸf°ime
((
time_t
)
fs
->
e2fs
.
e2fs_wtime
);

292 
	}
}

300 
	$ext2fs_mou¡
(
mou¡
 *
mp
, c⁄° *
∑th
, *
d©a
, 
size_t
 *
d©a_Àn
)

302 
	`¥ötf
("hello world\n");

303 
lwp
 *
l
 = 
cuæwp
;

304 
vnode
 *
devvp
;

305 
ufs_¨gs
 *
¨gs
 = 
d©a
;

306 
ufsmou¡
 *
ump
 = 
NULL
;

307 
m_ext2fs
 *
fs
;

308 
size_t
 
size
;

309 
îr‹
 = 0, 
Êags
, 
upd©e
;

310 
mode_t
 
ac˚ssmode
;

312 i‡(
¨gs
 =
NULL
)

313  
EINVAL
;

314 i‡(*
d©a_Àn
 <  *
¨gs
)

315  
EINVAL
;

317 i‡(
mp
->
m¡_Êag
 & 
MNT_GETARGS
) {

318 
ump
 = 
	`VFSTOUFS
(
mp
);

319 i‡(
ump
 =
NULL
)

320  
EIO
;

321 
	`mem£t
(
¨gs
, 0,  *args);

322 
¨gs
->
f•ec
 = 
NULL
;

323 *
d©a_Àn
 =  *
¨gs
;

327 
upd©e
 = 
mp
->
m¡_Êag
 & 
MNT_UPDATE
;

330 i‡(
¨gs
->
f•ec
 !
NULL
) {

334 
îr‹
 = 
	`«mei_sim∂e_u£r
(
¨gs
->
f•ec
,

335 
NSM_FOLLOW_NOEMULROOT
, &
devvp
);

336 i‡(
îr‹
 != 0)

337  (
îr‹
);

339 i‡(!
upd©e
) {

343 i‡(
devvp
->
v_ty≥
 !
VBLK
)

344 
îr‹
 = 
ENOTBLK
;

345 i‡(
	`bdevsw_lookup
(
devvp
->
v_rdev
Ë=
NULL
)

346 
îr‹
 = 
ENXIO
;

352 
ump
 = 
	`VFSTOUFS
(
mp
);

353 i‡(
devvp
 !
ump
->
um_devvp
) {

354 i‡(
devvp
->
v_rdev
 !
ump
->
um_devvp
->v_rdev)

355 
îr‹
 = 
EINVAL
;

357 
	`vªÀ
(
devvp
);

358 
devvp
 = 
ump
->
um_devvp
;

359 
	`vªf
(
devvp
);

364 i‡(!
upd©e
) {

366  (
EINVAL
);

368 
ump
 = 
	`VFSTOUFS
(
mp
);

369 
devvp
 = 
ump
->
um_devvp
;

370 
	`vªf
(
devvp
);

382 i‡(
îr‹
 == 0) {

383 
ac˚ssmode
 = 
VREAD
;

384 i‡(
upd©e
 ?

385 (
mp
->
m¡_iÊag
 & 
IMNT_WANTRDWR
) != 0 :

386 (
mp
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

387 
ac˚ssmode
 |
VWRITE
;

388 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

389 
îr‹
 = 
	`kauth_auth‹ize_sy°em
(
l
->
l_¸ed
, 
KAUTH_SYSTEM_MOUNT
,

390 
KAUTH_REQ_SYSTEM_MOUNT_DEVICE
, 
mp
, 
devvp
,

391 
	`KAUTH_ARG
(
ac˚ssmode
));

392 
	`VOP_UNLOCK
(
devvp
);

395 i‡(
îr‹
) {

396 
	`vªÀ
(
devvp
);

397  (
îr‹
);

400 i‡(!
upd©e
) {

401 
xÊags
;

403 i‡(
mp
->
m¡_Êag
 & 
MNT_RDONLY
)

404 
xÊags
 = 
FREAD
;

406 
xÊags
 = 
FREAD
|
FWRITE
;

407 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

408 
îr‹
 = 
	`VOP_OPEN
(
devvp
, 
xÊags
, 
FSCRED
);

409 
	`VOP_UNLOCK
(
devvp
);

410 i‡(
îr‹
)

411 
Áû
;

412 
îr‹
 = 
	`ext2fs_mou¡fs
(
devvp
, 
mp
);

413 i‡(
îr‹
) {

414 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

415 ()
	`VOP_CLOSE
(
devvp
, 
xÊags
, 
NOCRED
);

416 
	`VOP_UNLOCK
(
devvp
);

417 
Áû
;

420 
ump
 = 
	`VFSTOUFS
(
mp
);

421 
fs
 = 
ump
->
um_e2fs
;

432 
	`vªÀ
(
devvp
);

434 
ump
 = 
	`VFSTOUFS
(
mp
);

435 
fs
 = 
ump
->
um_e2fs
;

436 i‡(
fs
->
e2fs_r⁄ly
 =0 && (
mp
->
m¡_Êag
 & 
MNT_RDONLY
)) {

440 
Êags
 = 
WRITECLOSE
;

441 i‡(
mp
->
m¡_Êag
 & 
MNT_FORCE
)

442 
Êags
 |
FORCECLOSE
;

443 
îr‹
 = 
	`ext2fs_Êushfûes
(
mp
, 
Êags
);

444 i‡(
îr‹
 == 0 &&

445 
	`ext2fs_cgupd©e
(
ump
, 
MNT_WAIT
) == 0 &&

446 (
fs
->
e2fs
.
e2fs_°©e
 & 
E2FS_ERRORS
) == 0) {

447 
fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ISCLEAN
;

448 (Ë
	`ext2fs_sbupd©e
(
ump
, 
MNT_WAIT
);

450 i‡(
îr‹
)

451  (
îr‹
);

452 
fs
->
e2fs_r⁄ly
 = 1;

455 i‡(
mp
->
m¡_Êag
 & 
MNT_RELOAD
) {

456 
îr‹
 = 
	`ext2fs_ªlﬂd
(
mp
, 
l
->
l_¸ed
,Ü);

457 i‡(
îr‹
)

458  (
îr‹
);

461 i‡(
fs
->
e2fs_r⁄ly
 && (
mp
->
m¡_iÊag
 & 
IMNT_WANTRDWR
)) {

465 
fs
->
e2fs_r⁄ly
 = 0;

466 i‡(
fs
->
e2fs
.
e2fs_°©e
 =
E2FS_ISCLEAN
)

467 
fs
->
e2fs
.
e2fs_°©e
 = 0;

469 
fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ERRORS
;

470 
fs
->
e2fs_fmod
 = 1;

472 i‡(
¨gs
->
f•ec
 =
NULL
)

476 
îr‹
 = 
	`£t_°©vfs_öfo
(
∑th
, 
UIO_USERSPACE
, 
¨gs
->
f•ec
,

477 
UIO_USERSPACE
, 
mp
->
m¡_›
->
vfs_«me
, mp, 
l
);

478 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs_fsm¡
,

479 (
fs
->
e2fs_fsm¡
Ë- 1, &
size
);

480 
	`mem£t
(
fs
->
e2fs_fsm¡
 + 
size
, 0, (fs->e2fs_fsmnt) - size);

481 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

482 (Ë
	`c›y°r
(
mp
->
m¡_°©
.
f_m¡⁄«me
, 
fs
->
e2fs
.
e2fs_fsm¡
,

483 (
fs
->
e2fs
.
e2fs_fsm¡
Ë- 1, &
size
);

484 
	`mem£t
(
fs
->
e2fs
.
e2fs_fsm¡
, 0,

485 (
fs
->
e2fs
.
e2fs_fsm¡
Ë- 
size
);

487 i‡(
fs
->
e2fs_fmod
 != 0) {

488 
fs
->
e2fs_fmod
 = 0;

489 i‡(
fs
->
e2fs
.
e2fs_°©e
 == 0)

490 
fs
->
e2fs
.
e2fs_wtime
 = 
time_£c⁄d
;

492 
	`¥ötf
("%s: file systemÇot clean;Ölease fsck(8)\n",

493 
mp
->
m¡_°©
.
f_m¡‰om«me
);

494 (Ë
	`ext2fs_cgupd©e
(
ump
, 
MNT_WAIT
);

496  (
îr‹
);

498 
Áû
:

499 
	`vªÀ
(
devvp
);

500  (
îr‹
);

501 
	}
}

517 
	$ext2fs_ªlﬂd
(
mou¡
 *
mp
, 
kauth_¸ed_t
 
¸ed
, 
lwp
 *
l
)

519 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

520 
vnode
 *
vp
, *
devvp
;

521 
öode
 *
ù
;

522 
buf
 *
bp
;

523 
m_ext2fs
 *
fs
;

524 
ext2fs
 *
√wfs
;

525 
i
, 
îr‹
;

526 *
˝
;

527 
ufsmou¡
 *
ump
;

528 
vnode_ôî©‹
 *
m¨kî
;

530 i‡((
mp
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

531  (
EINVAL
);

533 
ump
 = 
	`VFSTOUFS
(
mp
);

537 
devvp
 = 
ump
->
um_devvp
;

538 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

539 
îr‹
 = 
	`vövÆbuf
(
devvp
, 0, 
¸ed
, 
l
, 0, 0);

540 
	`VOP_UNLOCK
(
devvp
);

541 i‡(
îr‹
)

542 
	`∑nic
("ext2fs_reload: dirty1");

544 
fs
 = 
ump
->
um_e2fs
;

549 
îr‹
 = 
	`bªad
(
devvp
, 
SBLOCK
, 
SBSIZE
, 0, &
bp
);

550 i‡(
îr‹
)

551  
îr‹
;

552 
√wfs
 = (
ext2fs
 *)
bp
->
b_d©a
;

553 
	`e2fs_sblﬂd
(
√wfs
, &
fs
->
e2fs
);

555 
	`bªl£
(
bp
, 0);

557 
îr‹
 = 
	`ext2fs_sbfûl
(
fs
, (
mp
->
m¡_Êag
 & 
MNT_RDONLY
) != 0);

558 i‡(
îr‹
)

559  
îr‹
;

564 
i
 = 0; i < 
fs
->
e2fs_ngdb
; i++) {

565 
îr‹
 = 
	`bªad
(
devvp
 ,

566 
	`EXT2_FSBTODB
(
fs
, fs->
e2fs
.
e2fs_fú°_dblock
 +

567 1 + 
i
),

568 
fs
->
e2fs_bsize
, 0, &
bp
);

569 i‡(
îr‹
) {

570  (
îr‹
);

572 
	`e2fs_cglﬂd
((
ext2_gd
 *)
bp
->
b_d©a
,

573 &
fs
->
e2fs_gd
[
i
 * fs->
e2fs_bsize
 / (
ext2_gd
)],

574 
fs
->
e2fs_bsize
);

575 
	`bªl£
(
bp
, 0);

578 
	`vfs_vnode_ôî©‹_öô
(
mp
, &
m¨kî
);

579 (
vp
 = 
	`vfs_vnode_ôî©‹_√xt
(
m¨kî
, 
NULL
, NULL))) {

583 i‡(
	`vªcy˛e
(
vp
))

588 i‡(
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
)) {

589 
	`vªÀ
(
vp
);

592 i‡(
	`vövÆbuf
(
vp
, 0, 
¸ed
, 
l
, 0, 0))

593 
	`∑nic
("ext2fs_reload: dirty2");

597 
ù
 = 
	`VTOI
(
vp
);

598 
îr‹
 = 
	`bªad
(
devvp
, 
	`EXT2_FSBTODB
(
fs
, 
	`öo_to_fsba
(fs, 
ù
->
i_numbî
)),

599 ()
fs
->
e2fs_bsize
, 0, &
bp
);

600 i‡(
îr‹
) {

601 
	`vput
(
vp
);

604 
˝
 = (*)
bp
->
b_d©a
 +

605 (
	`öo_to_fsbo
(
fs
, 
ù
->
i_numbî
Ë* 
	`EXT2_DINODE_SIZE
(fs));

606 
	`e2fs_ûﬂd
((
ext2fs_döode
 *)
˝
, 
ù
->
i_dö
.
e2fs_dö
);

607 
	`ext2fs_£t_öode_guid
(
ù
);

608 
	`bªl£
(
bp
, 0);

609 
	`vput
(
vp
);

611 
	`vfs_vnode_ôî©‹_de°roy
(
m¨kî
);

612  (
îr‹
);

613 
	}
}

619 
	$ext2fs_mou¡fs
(
vnode
 *
devvp
, 
mou¡
 *
mp
)

622 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

623 
lwp
 *
l
 = 
cuæwp
;

624 
ufsmou¡
 *
ump
;

625 
buf
 *
bp
;

626 
ext2fs
 *
fs
;

627 
m_ext2fs
 *
m_fs
;

628 
dev_t
 
dev
;

629 
îr‹
, 
i
, 
r⁄ly
;

630 
kauth_¸ed_t
 
¸ed
;

632 
dev
 = 
devvp
->
v_rdev
;

633 
¸ed
 = 
l
->
l_¸ed
;

636 
	`vn_lock
(
devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

637 
îr‹
 = 
	`vövÆbuf
(
devvp
, 
V_SAVE
, 
¸ed
, 
l
, 0, 0);

638 
	`VOP_UNLOCK
(
devvp
);

639 i‡(
îr‹
)

640  (
îr‹
);

642 
r⁄ly
 = (
mp
->
m¡_Êag
 & 
MNT_RDONLY
) != 0;

644 
bp
 = 
NULL
;

645 
ump
 = 
NULL
;

648 
îr‹
 = 
	`bªad
(
devvp
, 
SBLOCK
, 
SBSIZE
, 0, &
bp
);

649 i‡(
îr‹
)

650 
out
;

651 
fs
 = (
ext2fs
 *)
bp
->
b_d©a
;

652 
m_fs
 = 
	`kmem_zÆloc
((
m_ext2fs
), 
KM_SLEEP
);

653 
	`e2fs_sblﬂd
(
fs
, &
m_fs
->
e2fs
);

655 
	`bªl£
(
bp
, 0);

656 
bp
 = 
NULL
;

659 
îr‹
 = 
	`ext2fs_sbfûl
(
m_fs
, 
r⁄ly
);

660 i‡(
îr‹
) {

661 
	`kmem_‰ì
(
m_fs
, (
m_ext2fs
));

662 
out
;

664 
m_fs
->
e2fs_r⁄ly
 = 
r⁄ly
;

666 
ump
 = 
	`kmem_zÆloc
((*ump), 
KM_SLEEP
);

667 
ump
->
um_f°y≥
 = 
UFS1
;

668 
ump
->
um_›s
 = &
ext2fs_ufs›s
;

669 
ump
->
um_e2fs
 = 
m_fs
;

671 i‡(
r⁄ly
 == 0) {

672 i‡(
m_fs
->
e2fs
.
e2fs_°©e
 =
E2FS_ISCLEAN
)

673 
m_fs
->
e2fs
.
e2fs_°©e
 = 0;

675 
m_fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ERRORS
;

676 
m_fs
->
e2fs_fmod
 = 1;

680 
m_fs
->
e2fs_gd
 = 
	`kmem_Æloc
(m_fs->
e2fs_ngdb
 * m_fs->
e2fs_bsize
, 
KM_SLEEP
);

681 
i
 = 0; i < 
m_fs
->
e2fs_ngdb
; i++) {

682 
îr‹
 = 
	`bªad
(
devvp
,

683 
	`EXT2_FSBTODB
(
m_fs
, m_fs->
e2fs
.
e2fs_fú°_dblock
 +

684 1 + 
i
),

685 
m_fs
->
e2fs_bsize
, 0, &
bp
);

686 i‡(
îr‹
) {

687 
	`kmem_‰ì
(
m_fs
->
e2fs_gd
,

688 
m_fs
->
e2fs_ngdb
 * m_fs->
e2fs_bsize
);

689 
out
;

691 
	`e2fs_cglﬂd
((
ext2_gd
 *)
bp
->
b_d©a
,

692 &
m_fs
->
e2fs_gd
[

693 
i
 * 
m_fs
->
e2fs_bsize
 / (
ext2_gd
)],

694 
m_fs
->
e2fs_bsize
);

695 
	`bªl£
(
bp
, 0);

696 
bp
 = 
NULL
;

699 
mp
->
m¡_d©a
 = 
ump
;

700 
mp
->
m¡_°©
.
f_fsidx
.
__fsid_vÆ
[0] = ()
dev
;

701 
mp
->
m¡_°©
.
f_fsidx
.
__fsid_vÆ
[1] = 
	`makef°y≥
(
MOUNT_EXT2FS
);

702 
mp
->
m¡_°©
.
f_fsid
 = mp->m¡_°©.
f_fsidx
.
__fsid_vÆ
[0];

703 
mp
->
m¡_°©
.
f_«memax
 = 
EXT2FS_MAXNAMLEN
;

704 
mp
->
m¡_Êag
 |
MNT_LOCAL
;

705 
mp
->
m¡_dev_bshi·
 = 
DEV_BSHIFT
;

706 
mp
->
m¡_fs_bshi·
 = 
m_fs
->
e2fs_bshi·
;

707 
mp
->
m¡_iÊag
 |
IMNT_DTYPE
;

708 
ump
->
um_Êags
 = 0;

709 
ump
->
um_mou¡p
 = 
mp
;

710 
ump
->
um_dev
 = 
dev
;

711 
ump
->
um_devvp
 = 
devvp
;

712 
ump
->
um_nödú
 = 
	`EXT2_NINDIR
(
m_fs
);

713 
ump
->
um_lognödú
 = 
	`ffs
(
	`EXT2_NINDIR
(
m_fs
)) - 1;

714 
ump
->
um_b±πodb
 = 
m_fs
->
e2fs_fsbtodb
;

715 
ump
->
um_£qöc
 = 1;

716 
ump
->
um_maxsymlökÀn
 = 
EXT2_MAXSYMLINKLEN
;

717 
ump
->
um_dúblksiz
 = 
m_fs
->
e2fs_bsize
;

718 
ump
->
um_maxfûesize
 = ((
uöt64_t
)0x80000000 * 
m_fs
->
e2fs_bsize
 - 1);

719 
	`•ec_node_£tmou¡edfs
(
devvp
, 
mp
);

722 
out
:

723 i‡(
bp
 !
NULL
)

724 
	`bªl£
(
bp
, 0);

725 i‡(
ump
) {

726 
	`kmem_‰ì
(
ump
->
um_e2fs
, (
m_ext2fs
));

727 
	`kmem_‰ì
(
ump
, (*ump));

728 
mp
->
m¡_d©a
 = 
NULL
;

730  (
îr‹
);

731 
	}
}

737 
	$ext2fs_unmou¡
(
mou¡
 *
mp
, 
m¡Êags
)

740 
ufsmou¡
 *
ump
;

741 
m_ext2fs
 *
fs
;

742 
îr‹
, 
Êags
;

744 
Êags
 = 0;

745 i‡(
m¡Êags
 & 
MNT_FORCE
)

746 
Êags
 |
FORCECLOSE
;

747 i‡((
îr‹
 = 
	`ext2fs_Êushfûes
(
mp
, 
Êags
)) != 0)

748  (
îr‹
);

749 
ump
 = 
	`VFSTOUFS
(
mp
);

750 
fs
 = 
ump
->
um_e2fs
;

751 i‡(
fs
->
e2fs_r⁄ly
 == 0 &&

752 
	`ext2fs_cgupd©e
(
ump
, 
MNT_WAIT
) == 0 &&

753 (
fs
->
e2fs
.
e2fs_°©e
 & 
E2FS_ERRORS
) == 0) {

754 
fs
->
e2fs
.
e2fs_°©e
 = 
E2FS_ISCLEAN
;

755 (Ë
	`ext2fs_sbupd©e
(
ump
, 
MNT_WAIT
);

757 i‡(
ump
->
um_devvp
->
v_ty≥
 !
VBAD
)

758 
	`•ec_node_£tmou¡edfs
(
ump
->
um_devvp
, 
NULL
);

759 
	`vn_lock
(
ump
->
um_devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

760 
îr‹
 = 
	`VOP_CLOSE
(
ump
->
um_devvp
, 
fs
->
e2fs_r⁄ly
 ? 
FREAD
 : FREAD|
FWRITE
,

761 
NOCRED
);

762 
	`vput
(
ump
->
um_devvp
);

763 
	`kmem_‰ì
(
fs
->
e2fs_gd
, fs->
e2fs_ngdb
 * fs->
e2fs_bsize
);

764 
	`kmem_‰ì
(
fs
, (*fs));

765 
	`kmem_‰ì
(
ump
, (*ump));

766 
mp
->
m¡_d©a
 = 
NULL
;

767 
mp
->
m¡_Êag
 &~
MNT_LOCAL
;

768  (
îr‹
);

769 
	}
}

775 
	$ext2fs_Êushfûes
(
mou¡
 *
mp
, 
Êags
)

777 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

778 
dof‹˚
;

779 
îr‹
;

781 i‡(!
dof‹˚
)

782 
Êags
 &~
FORCECLOSE
;

783 
îr‹
 = 
	`vÊush
(
mp
, 
NULLVP
, 
Êags
);

784  (
îr‹
);

785 
	}
}

791 
	$ext2fs_°©vfs
(
mou¡
 *
mp
, 
°©vfs
 *
sbp
)

793 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

794 
ufsmou¡
 *
ump
;

795 
m_ext2fs
 *
fs
;

796 
uöt32_t
 
ovîhód
, 
ovîhód_≥r_group
, 
ngdb
;

797 
i
, 
ngroups
;

799 
ump
 = 
	`VFSTOUFS
(
mp
);

800 
fs
 = 
ump
->
um_e2fs
;

801 i‡(
fs
->
e2fs
.
e2fs_magic
 !
E2FS_MAGIC
)

802 
	`∑nic
("ext2fs_statvfs");

807 
ovîhód_≥r_group
 =

810 
fs
->
e2fs_ôpg
;

811 
ovîhód
 = 
fs
->
e2fs
.
e2fs_fú°_dblock
 +

812 
fs
->
e2fs_ncg
 * 
ovîhód_≥r_group
;

813 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

814 
fs
->
e2fs
.
e2fs_„©uªs_rocom∑t
 & 
EXT2F_ROCOMPAT_SPARSESUPER
) {

815 
i
 = 0, 
ngroups
 = 0; i < 
fs
->
e2fs_ncg
; i++) {

816 i‡(
	`cg_has_sb
(
i
))

817 
ngroups
++;

820 
ngroups
 = 
fs
->
e2fs_ncg
;

822 
ngdb
 = 
fs
->
e2fs_ngdb
;

823 i‡(
fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

824 
fs
->
e2fs
.
e2fs_„©uªs_com∑t
 & 
EXT2F_COMPAT_RESIZE
)

825 
ngdb
 +
fs
->
e2fs
.
e2fs_ª£rved_ngdb
;

826 
ovîhód
 +
ngroups
 * (1 + 
ngdb
);

828 
sbp
->
f_bsize
 = 
fs
->
e2fs_bsize
;

829 
sbp
->
f_‰size
 = 
MINBSIZE
 << 
fs
->
e2fs
.
e2fs_fsize
;

830 
sbp
->
f_iosize
 = 
fs
->
e2fs_bsize
;

831 
sbp
->
f_blocks
 = 
fs
->
e2fs
.
e2fs_bcou¡
 - 
ovîhód
;

832 
sbp
->
f_b‰ì
 = 
fs
->
e2fs
.
e2fs_fbcou¡
;

833 
sbp
->
f_bªsvd
 = 
fs
->
e2fs
.
e2fs_rbcou¡
;

834 i‡(
sbp
->
f_b‰ì
 > sbp->
f_bªsvd
)

835 
sbp
->
f_bavaû
 = sbp->
f_b‰ì
 - sbp->
f_bªsvd
;

837 
sbp
->
f_bavaû
 = 0;

838 
sbp
->
f_fûes
 = 
fs
->
e2fs
.
e2fs_icou¡
;

839 
sbp
->
f_f‰ì
 = 
fs
->
e2fs
.
e2fs_ficou¡
;

840 
sbp
->
f_Ávaû
 = 
fs
->
e2fs
.
e2fs_ficou¡
;

841 
sbp
->
f_‰esvd
 = 0;

842 
	`c›y_°©vfs_öfo
(
sbp
, 
mp
);

844 
	}
}

846 
boﬁ


847 
	$ext2fs_sync_£À˘‹
(*
˛
, 
vnode
 *
vp
)

849 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

850 
öode
 *
ù
;

852 
ù
 = 
	`VTOI
(
vp
);

856 i‡(
ù
 =
NULL
 || 
vp
->
v_ty≥
 =
VNON
)

857  
Ál£
;

859 i‡(((
ù
->
i_Êag
 &

860 (
IN_CHANGE
 | 
IN_UPDATE
 | 
IN_MODIFIED
)) == 0 &&

861 
	`LIST_EMPTY
(&
vp
->
v_dútyblkhd
) &&

862 
	`UVM_OBJ_IS_CLEAN
(&
vp
->
v_uobj
)))

863  
Ál£
;

864  
åue
;

865 
	}
}

875 
	$ext2fs_sync
(
mou¡
 *
mp
, 
waôf‹
, 
kauth_¸ed_t
 
¸ed
)

877 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

878 
vnode
 *
vp
;

879 
ufsmou¡
 *
ump
 = 
	`VFSTOUFS
(
mp
);

880 
m_ext2fs
 *
fs
;

881 
vnode_ôî©‹
 *
m¨kî
;

882 
îr‹
, 
ÆÀº‹
 = 0;

884 
fs
 = 
ump
->
um_e2fs
;

885 i‡(
fs
->
e2fs_fmod
 !0 && fs->
e2fs_r⁄ly
 != 0) {

886 
	`¥ötf
("f†%s\n", 
fs
->
e2fs_fsm¡
);

887 
	`∑nic
("update:Ñofs mod");

893 
	`vfs_vnode_ôî©‹_öô
(
mp
, &
m¨kî
);

894 (
vp
 = 
	`vfs_vnode_ôî©‹_√xt
(
m¨kî
, 
ext2fs_sync_£À˘‹
,

895 
NULL
)))

897 
îr‹
 = 
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
);

898 i‡(
îr‹
) {

899 
	`vªÀ
(
vp
);

902 i‡(
vp
->
v_ty≥
 =
VREG
 && 
waôf‹
 =
MNT_LAZY
)

903 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 0);

905 
îr‹
 = 
	`VOP_FSYNC
(
vp
, 
¸ed
,

906 
waôf‹
 =
MNT_WAIT
 ? 
FSYNC_WAIT
 : 0, 0, 0);

907 i‡(
îr‹
)

908 
ÆÀº‹
 = 
îr‹
;

909 
	`vput
(
vp
);

911 
	`vfs_vnode_ôî©‹_de°roy
(
m¨kî
);

915 i‡(
waôf‹
 !
MNT_LAZY
) {

916 
	`vn_lock
(
ump
->
um_devvp
, 
LK_EXCLUSIVE
 | 
LK_RETRY
);

917 i‡((
îr‹
 = 
	`VOP_FSYNC
(
ump
->
um_devvp
, 
¸ed
,

918 
waôf‹
 =
MNT_WAIT
 ? 
FSYNC_WAIT
 : 0, 0, 0)) != 0)

919 
ÆÀº‹
 = 
îr‹
;

920 
	`VOP_UNLOCK
(
ump
->
um_devvp
);

925 i‡(
fs
->
e2fs_fmod
 != 0) {

926 
fs
->
e2fs_fmod
 = 0;

927 
fs
->
e2fs
.
e2fs_wtime
 = 
time_£c⁄d
;

928 i‡((
îr‹
 = 
	`ext2fs_cgupd©e
(
ump
, 
waôf‹
)))

929 
ÆÀº‹
 = 
îr‹
;

931  (
ÆÀº‹
);

932 
	}
}

939 
	$ext2fs_lﬂdvnode
(
mou¡
 *
mp
, 
vnode
 *
vp
,

940 c⁄° *
key
, 
size_t
 
key_Àn
, c⁄° **
√w_key
)

942 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

943 
öo_t
 
öo
;

944 
m_ext2fs
 *
fs
;

945 
öode
 *
ù
;

946 
ufsmou¡
 *
ump
;

947 
buf
 *
bp
;

948 
dev_t
 
dev
;

949 
îr‹
;

950 *
˝
;

952 
	`KASSERT
(
key_Àn
 =(
öo
));

953 
	`mem˝y
(&
öo
, 
key
, 
key_Àn
);

954 
ump
 = 
	`VFSTOUFS
(
mp
);

955 
dev
 = 
ump
->
um_dev
;

956 
fs
 = 
ump
->
um_e2fs
;

959 
îr‹
 = 
	`bªad
(
ump
->
um_devvp
, 
	`EXT2_FSBTODB
(
fs
, 
	`öo_to_fsba
(fs, 
öo
)),

960 ()
fs
->
e2fs_bsize
, 0, &
bp
);

961 i‡(
îr‹
)

962  
îr‹
;

965 
ù
 = 
	`poﬁ_gë
(&
ext2fs_öode_poﬁ
, 
PR_WAITOK
);

966 
	`mem£t
(
ù
, 0, (
öode
));

967 
vp
->
v_èg
 = 
VT_EXT2FS
;

968 
vp
->
v_›
 = 
ext2fs_vnode›_p
;

969 
vp
->
v_vÊag
 |
VV_LOCKSWORK
;

970 
vp
->
v_d©a
 = 
ù
;

971 
ù
->
i_vnode
 = 
vp
;

972 
ù
->
i_ump
 = 
ump
;

973 
ù
->
i_e2fs
 = 
fs
;

974 
ù
->
i_dev
 = 
dev
;

975 
ù
->
i_numbî
 = 
öo
;

976 
ù
->
i_e2fs_œ°_lblk
 = 0;

977 
ù
->
i_e2fs_œ°_blk
 = 0;

980 
	`gífs_node_öô
(
vp
, &
ext2fs_gífs›s
);

982 
˝
 = (*)
bp
->
b_d©a
 + (
	`öo_to_fsbo
(
fs
, 
öo
Ë* 
	`EXT2_DINODE_SIZE
(fs));

983 
ù
->
i_dö
.
e2fs_dö
 = 
	`poﬁ_gë
(&
ext2fs_döode_poﬁ
, 
PR_WAITOK
);

984 
	`e2fs_ûﬂd
((
ext2fs_döode
 *)
˝
, 
ù
->
i_dö
.
e2fs_dö
);

985 
	`ext2fs_£t_öode_guid
(
ù
);

986 
	`bªl£
(
bp
, 0);

989 i‡(
ù
->
i_e2fs_dtime
 != 0) {

990 
ù
->
i_e2fs_mode
 = 0;

991 ()
	`ext2fs_£tsize
(
ù
, 0);

992 ()
	`ext2fs_£äblock
(
ù
, 0);

993 
	`mem£t
(
ù
->
i_e2fs_blocks
, 0, (ip->i_e2fs_blocks));

997 
	`ext2fs_vöô
(
mp
, 
ext2fs_•ec›_p
, 
ext2fs_fifo›_p
, &
vp
);

1000 
ù
->
i_devvp
 = 
ump
->
um_devvp
;

1001 
	`vªf
(
ù
->
i_devvp
);

1008 i‡(
ù
->
i_e2fs_gí
 == 0) {

1009 i‡(++
ext2gínumbî
 < (
u_l⁄g
)
time_£c⁄d
)

1010 
ext2gínumbî
 = 
time_£c⁄d
;

1011 
ù
->
i_e2fs_gí
 = 
ext2gínumbî
;

1012 i‡((
mp
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

1013 
ù
->
i_Êag
 |
IN_MODIFIED
;

1015 
	`uvm_v≈_£tsize
(
vp
, 
	`ext2fs_size
(
ù
));

1016 *
√w_key
 = &
ù
->
i_numbî
;

1018 
	}
}

1029 
	$ext2fs_fhtovp
(
mou¡
 *
mp
, 
fid
 *
fhp
, 
vnode
 **
vµ
)

1031 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1032 
öode
 *
ù
;

1033 
vnode
 *
nvp
;

1034 
îr‹
;

1035 
ufid
 
ufh
;

1036 
m_ext2fs
 *
fs
;

1038 i‡(
fhp
->
fid_Àn
 !(
ufid
))

1039  
EINVAL
;

1041 
	`mem˝y
(&
ufh
, 
fhp
, (
ufid
));

1042 
fs
 = 
	`VFSTOUFS
(
mp
)->
um_e2fs
;

1043 i‡((
ufh
.
ufid_öo
 < 
EXT2_FIRSTINO
 && ufh.ufid_öÿ!
EXT2_ROOTINO
) ||

1044 
ufh
.
ufid_öo
 >
fs
->
e2fs_ncg
 * fs->
e2fs
.
e2fs_ùg
)

1045  (
ESTALE
);

1047 i‡((
îr‹
 = 
	`VFS_VGET
(
mp
, 
ufh
.
ufid_öo
, &
nvp
)) != 0) {

1048 *
vµ
 = 
NULLVP
;

1049  (
îr‹
);

1051 
ù
 = 
	`VTOI
(
nvp
);

1052 i‡(
ù
->
i_e2fs_mode
 =0 || ip->
i_e2fs_dtime
 != 0 ||

1053 
ù
->
i_e2fs_gí
 !
ufh
.
ufid_gí
) {

1054 
	`vput
(
nvp
);

1055 *
vµ
 = 
NULLVP
;

1056  (
ESTALE
);

1058 *
vµ
 = 
nvp
;

1060 
	}
}

1067 
	$ext2fs_v±ofh
(
vnode
 *
vp
, 
fid
 *
fhp
, 
size_t
 *
fh_size
)

1069 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1070 
öode
 *
ù
;

1071 
ufid
 
ufh
;

1073 i‡(*
fh_size
 < (
ufid
)) {

1074 *
fh_size
 = (
ufid
);

1075  
E2BIG
;

1077 *
fh_size
 = (
ufid
);

1079 
ù
 = 
	`VTOI
(
vp
);

1080 
	`mem£t
(&
ufh
, 0, (ufh));

1081 
ufh
.
ufid_Àn
 = (
ufid
);

1082 
ufh
.
ufid_öo
 = 
ù
->
i_numbî
;

1083 
ufh
.
ufid_gí
 = 
ù
->
i_e2fs_gí
;

1084 
	`mem˝y
(
fhp
, &
ufh
, (ufh));

1086 
	}
}

1092 
	$ext2fs_sbupd©e
(
ufsmou¡
 *
mp
, 
waôf‹
)

1094 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1095 
m_ext2fs
 *
fs
 = 
mp
->
um_e2fs
;

1096 
buf
 *
bp
;

1097 
îr‹
 = 0;

1099 
bp
 = 
	`gëblk
(
mp
->
um_devvp
, 
SBLOCK
, 
SBSIZE
, 0, 0);

1100 
	`e2fs_sbßve
(&
fs
->
e2fs
, (
ext2fs
*)
bp
->
b_d©a
);

1101 i‡(
waôf‹
 =
MNT_WAIT
)

1102 
îr‹
 = 
	`bwrôe
(
bp
);

1104 
	`bawrôe
(
bp
);

1105  (
îr‹
);

1106 
	}
}

1109 
	$ext2fs_cgupd©e
(
ufsmou¡
 *
mp
, 
waôf‹
)

1111 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1112 
m_ext2fs
 *
fs
 = 
mp
->
um_e2fs
;

1113 
buf
 *
bp
;

1114 
i
, 
îr‹
 = 0, 
ÆÀº‹
 = 0;

1116 
ÆÀº‹
 = 
	`ext2fs_sbupd©e
(
mp
, 
waôf‹
);

1117 
i
 = 0; i < 
fs
->
e2fs_ngdb
; i++) {

1118 
bp
 = 
	`gëblk
(
mp
->
um_devvp
, 
	`EXT2_FSBTODB
(
fs
,

1119 
fs
->
e2fs
.
e2fs_fú°_dblock
 +

1120 1 + 
i
), 
fs
->
e2fs_bsize
, 0, 0);

1121 
	`e2fs_cgßve
(&
fs
->
e2fs_gd
[

1122 
i
 * 
fs
->
e2fs_bsize
 / (
ext2_gd
)],

1123 (
ext2_gd
 *)
bp
->
b_d©a
, 
fs
->
e2fs_bsize
);

1124 i‡(
waôf‹
 =
MNT_WAIT
)

1125 
îr‹
 = 
	`bwrôe
(
bp
);

1127 
	`bawrôe
(
bp
);

1130 i‡(!
ÆÀº‹
 && 
îr‹
)

1131 
ÆÀº‹
 = 
îr‹
;

1132  (
ÆÀº‹
);

1133 
	}
}

1140 
	$ext2fs_sbfûl
(
m_ext2fs
 *
m_fs
, 
r⁄ly
)

1142 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1143 
uöt32_t
 
u32
;

1144 
ext2fs
 *
fs
 = &
m_fs
->
e2fs
;

1149 i‡(
fs
->
e2fs_magic
 !
E2FS_MAGIC
)

1150  
EINVAL
;

1151 i‡(
fs
->
e2fs_ªv
 > 
E2FS_REV1
) {

1152 
	`¥ötf
("ext2fs: unsuµ‹ãdÑevisi⁄Çumbî: %x\n", 
fs
->
e2fs_ªv
);

1153  
EINVAL
;

1155 i‡(
fs
->
e2fs_log_bsize
 > 2) {

1157 
	`¥ötf
("ext2fs: bad block size: %d\n", 
fs
->
e2fs_log_bsize
);

1158  
EINVAL
;

1160 i‡(
fs
->
e2fs_bpg
 == 0) {

1161 
	`¥ötf
("ext2fs: zero blocksÖer group\n");

1162  
EINVAL
;

1164 i‡(
fs
->
e2fs_ùg
 == 0) {

1165 
	`¥ötf
("ext2fs: zero inodesÖer group\n");

1166  
EINVAL
;

1169 i‡(
fs
->
e2fs_fú°_dblock
 >fs->
e2fs_bcou¡
) {

1170 
	`¥ötf
("ext2fs: invalid first data block\n");

1171  
EINVAL
;

1173 i‡(
fs
->
e2fs_rbcou¡
 > fs->
e2fs_bcou¡
 ||

1174 
fs
->
e2fs_fbcou¡
 > fs->
e2fs_bcou¡
) {

1175 
	`¥ötf
("ext2fs: invalid block count\n");

1176  
EINVAL
;

1182 i‡(
fs
->
e2fs_ªv
 > 
E2FS_REV0
) {

1183 
buf
[256];

1184 i‡(
fs
->
e2fs_fú°_öo
 !
EXT2_FIRSTINO
) {

1185 
	`¥ötf
("ext2fs: unsupported first inodeÖosition\n");

1186  
EINVAL
;

1188 
u32
 = 
fs
->
e2fs_„©uªs_öcom∑t
 & ~(
EXT2F_INCOMPAT_SUPP
);

1189 i‡(
u32
) {

1191 
	`¢¥ötb
(
buf
, (buf), 
EXT2F_INCOMPAT_BITS
, 
u32
);

1192 
	`¥ötf
("ext2fs: unsuµ‹ãd incom∑à„©uªs: %s\n", 
buf
);

1193  
EINVAL
;

1195 
u32
 = 
fs
->
e2fs_„©uªs_rocom∑t
 & ~
EXT2F_ROCOMPAT_SUPP
;

1196 i‡(!
r⁄ly
 && 
u32
) {

1197 
	`¢¥ötb
(
buf
, (buf), 
EXT2F_ROCOMPAT_BITS
, 
u32
);

1198 
	`¥ötf
("ext2fs: unsupportedÑo-incompat features: %s\n",

1199 
buf
);

1200  
EROFS
;

1202 i‡(
fs
->
e2fs_öode_size
 =0 || !
	`powîof2
(fs->e2fs_inode_size)) {

1203 
	`¥ötf
("ext2fs: bad inode size\n");

1204  
EINVAL
;

1211 
u32
 = 
fs
->
e2fs_bcou¡
 - fs->
e2fs_fú°_dblock
;

1212 
m_fs
->
e2fs_ncg
 = 
	`howm™y
(
u32
, 
fs
->
e2fs_bpg
);

1213 i‡(
m_fs
->
e2fs_ncg
 == 0) {

1214 
	`¥ötf
("ext2fs: invalidÇumber of cylinder groups\n");

1215  
EINVAL
;

1218 
m_fs
->
e2fs_fsbtodb
 = 
fs
->
e2fs_log_bsize
 + 
LOG_MINBSIZE
 - 
DEV_BSHIFT
;

1219 
m_fs
->
e2fs_bsize
 = 
MINBSIZE
 << 
fs
->
e2fs_log_bsize
;

1220 
m_fs
->
e2fs_bshi·
 = 
LOG_MINBSIZE
 + 
fs
->
e2fs_log_bsize
;

1221 
m_fs
->
e2fs_qbmask
 = m_fs->
e2fs_bsize
 - 1;

1222 
m_fs
->
e2fs_bmask
 = ~m_fs->
e2fs_qbmask
;

1224 i‡((
u32
 = 
m_fs
->
e2fs_bsize
 / (
ext2_gd
)) == 0) {

1226 
	`¥ötf
("ext2fs: invalid block size\n");

1227  
EINVAL
;

1229 
m_fs
->
e2fs_ngdb
 = 
	`howm™y
(m_fs->
e2fs_ncg
, 
u32
);

1230 i‡(
m_fs
->
e2fs_ngdb
 == 0) {

1231 
	`¥ötf
("ext2fs: invalidÇumber of group descriptor blocks\n");

1232  
EINVAL
;

1235 i‡(
m_fs
->
e2fs_bsize
 < 
	`EXT2_DINODE_SIZE
(m_fs)) {

1236 
	`¥ötf
("ext2fs: invalid inode size\n");

1237  
EINVAL
;

1239 
m_fs
->
e2fs_ùb
 = m_fs->
e2fs_bsize
 / 
	`EXT2_DINODE_SIZE
(m_fs);

1241 
m_fs
->
e2fs_ôpg
 = 
fs
->
e2fs_ùg
 / m_fs->
e2fs_ùb
;

1244 
	}
}

	@ext2fs_vnops.c

67 
	~<sys/cdefs.h
>

68 
__KERNEL_RCSID
(0, "$NetBSD:Éxt2fs_vnops.c,v 1.117 2015/04/20 23:03:09Ñiastradh Exp $");

70 
	~<sys/∑øm.h
>

71 
	~<sys/sy°m.h
>

72 
	~<sys/ªsour˚v¨.h
>

73 
	~<sys/kî√l.h
>

74 
	~<sys/fûe.h
>

75 
	~<sys/°©.h
>

76 
	~<sys/buf.h
>

77 
	~<sys/¥oc.h
>

78 
	~<sys/mou¡.h
>

79 
	~<sys/«mei.h
>

80 
	~<sys/vnode.h
>

81 
	~<sys/lockf.h
>

82 
	~<sys/poﬁ.h
>

83 
	~<sys/sig«lv¨.h
>

84 
	~<sys/kauth.h
>

86 
	~<miscfs/fifofs/fifo.h
>

87 
	~<miscfs/gífs/gífs.h
>

88 
	~<miscfs/•ecfs/•ecdev.h
>

90 
	~<ufs/ufs/öode.h
>

91 
	~<ufs/ufs/ufs_exã∫.h
>

92 
	~<ufs/ufs/ufsmou¡.h
>

94 
	~<ufs/ext2fs/ext2fs.h
>

95 
	~<ufs/ext2fs/ext2fs_exã∫.h
>

96 
	~<ufs/ext2fs/ext2fs_dú.h
>

98 
¥è˘ive
;

100 
ext2fs_chmod
(
vnode
 *, , 
kauth_¸ed_t
, 
lwp
 *);

101 
ext2fs_chown
(
vnode
 *, 
uid_t
, 
gid_t
, 
kauth_¸ed_t
,

102 
lwp
 *);

104 
	u_qcvt
 {

105 
öt64_t
 
	mqcvt
;

106 
öt32_t
 
	mvÆ
[2];

109 
	#SETHIGH
(
q
, 
h
) { \

110 
_qcvt
 
tmp
; \

111 
tmp
.
qcvt
 = (
q
); \

112 
tmp
.
vÆ
[
_QUAD_HIGHWORD
] = (
h
); \

113 (
q
Ë
tmp
.
qcvt
; \

114 }

	)

115 
	#SETLOW
(
q
, 
l
) { \

116 
_qcvt
 
tmp
; \

117 
tmp
.
qcvt
 = (
q
); \

118 
tmp
.
vÆ
[
_QUAD_LOWWORD
] = (
l
); \

119 (
q
Ë
tmp
.
qcvt
; \

120 }

	)

126 
	$ext2fs_¸óã
(*
v
)

128 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

129 
v›_¸óã_v3_¨gs


134  *
≠
 = 
v
;

135 
îr‹
;

137 
îr‹
 =

138 
	`ext2fs_makeöode
(
	`MAKEIMODE
(
≠
->
a_v≠
->
va_ty≥
,áp->a_v≠->
va_mode
),

139 
≠
->
a_dvp
,áp->
a_vµ
,áp->
a_˙p
);

141 i‡(
îr‹
)

142  (
îr‹
);

143 
	`VN_KNOTE
(
≠
->
a_dvp
, 
NOTE_WRITE
);

144 
	`VOP_UNLOCK
(*
≠
->
a_vµ
);

146 
	}
}

153 
	$ext2fs_mknod
(*
v
)

155 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

156 
v›_mknod_v3_¨gs


161  *
≠
 = 
v
;

162 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

163 
vnode
 **
vµ
 = 
≠
->
a_vµ
;

164 
öode
 *
ù
;

165 
îr‹
;

166 
mou¡
 *
mp
;

167 
öo_t
 
öo
;

169 i‡((
îr‹
 = 
	`ext2fs_makeöode
(
	`MAKEIMODE
(
v≠
->
va_ty≥
, v≠->
va_mode
),

170 
≠
->
a_dvp
, 
vµ
,áp->
a_˙p
)) != 0)

171  (
îr‹
);

172 
	`VN_KNOTE
(
≠
->
a_dvp
, 
NOTE_WRITE
);

173 
ù
 = 
	`VTOI
(*
vµ
);

174 
mp
 = (*
vµ
)->
v_mou¡
;

175 
öo
 = 
ù
->
i_numbî
;

176 
ù
->
i_Êag
 |
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
;

177 i‡(
v≠
->
va_rdev
 !
VNOVAL
) {

182 
ù
->
i_dö
.
e2fs_dö
->
e2di_rdev
 = 
	`h2fs32
(
v≠
->
va_rdev
);

189 (*
vµ
)->
v_ty≥
 = 
VNON
;

190 
	`VOP_UNLOCK
(*
vµ
);

191 
	`vg⁄e
(*
vµ
);

192 
îr‹
 = 
	`vˇche_gë
(
mp
, &
öo
, (öo), 
vµ
);

193 i‡(
îr‹
 != 0) {

194 *
vµ
 = 
NULL
;

195  (
îr‹
);

198 
	}
}

207 
	$ext2fs_›í
(*
v
)

209 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

210 
v›_›í_¨gs


214  *
≠
 = 
v
;

219 i‡((
	`VTOI
(
≠
->
a_vp
)->
i_e2fs_Êags
 & 
EXT2_APPEND
) &&

220 (
≠
->
a_mode
 & (
FWRITE
 | 
O_APPEND
)) == FWRITE)

221  (
EPERM
);

223 
	}
}

226 
	$ext2fs_check_possibÀ
(
vnode
 *
vp
, 
öode
 *
ù
, 
mode_t
 
mode
)

228 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

234 i‡(
mode
 & 
VWRITE
) {

235 
vp
->
v_ty≥
) {

236 
VDIR
:

237 
VLNK
:

238 
VREG
:

239 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

240  (
EROFS
);

248 i‡((
mode
 & 
VWRITE
Ë&& (
ù
->
i_e2fs_Êags
 & 
EXT2_IMMUTABLE
))

249  (
EPERM
);

252 
	}
}

255 
	$ext2fs_check_≥rmôãd
(
vnode
 *
vp
, 
öode
 *
ù
, 
mode_t
 
mode
,

256 
kauth_¸ed_t
 
¸ed
)

258 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

259  
	`kauth_auth‹ize_vnode
(
¸ed
, 
	`KAUTH_ACCESS_ACTION
(
mode
, 
vp
->
v_ty≥
,

260 
ù
->
i_e2fs_mode
 & 
ALLPERMS
), 
vp
, 
NULL
, 
	`gífs_ˇn_ac˚ss
(vp->
v_ty≥
,

261 
ù
->
i_e2fs_mode
 & 
ALLPERMS
, ip->
i_uid
, ip->
i_gid
, 
mode
, 
¸ed
));

262 
	}
}

265 
	$ext2fs_ac˚ss
(*
v
)

267 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

268 
v›_ac˚ss_¨gs


272  *
≠
 = 
v
;

273 
vnode
 *
vp
 = 
≠
->
a_vp
;

274 
öode
 *
ù
 = 
	`VTOI
(
vp
);

275 
mode_t
 
mode
 = 
≠
->
a_mode
;

276 
îr‹
;

278 
îr‹
 = 
	`ext2fs_check_possibÀ
(
vp
, 
ù
, 
mode
);

279 i‡(
îr‹
)

280  
îr‹
;

282 
îr‹
 = 
	`ext2fs_check_≥rmôãd
(
vp
, 
ù
, 
mode
, 
≠
->
a_¸ed
);

283 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

284  
îr‹
;

285 
	}
}

289 
	$ext2fs_gë©å
(*
v
)

291 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

292 
v›_gë©å_¨gs


296  *
≠
 = 
v
;

297 
vnode
 *
vp
 = 
≠
->
a_vp
;

298 
öode
 *
ù
 = 
	`VTOI
(
vp
);

299 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

301 
	`EXT2FS_ITIMES
(
ù
, 
NULL
, NULL, NULL);

305 
v≠
->
va_fsid
 = 
ù
->
i_dev
;

306 
v≠
->
va_fûeid
 = 
ù
->
i_numbî
;

307 
v≠
->
va_mode
 = 
ù
->
i_e2fs_mode
 & 
ALLPERMS
;

308 
v≠
->
va_∆ök
 = 
ù
->
i_e2fs_∆ök
;

309 
v≠
->
va_uid
 = 
ù
->
i_uid
;

310 
v≠
->
va_gid
 = 
ù
->
i_gid
;

311 
v≠
->
va_rdev
 = (
dev_t
)
	`fs2h32
(
ù
->
i_dö
.
e2fs_dö
->
e2di_rdev
);

312 
v≠
->
va_size
 = 
vp
->
v_size
;

313 
v≠
->
va_©ime
.
tv_£c
 = 
ù
->
i_e2fs_©ime
;

314 
v≠
->
va_©ime
.
tv_n£c
 = 0;

315 
v≠
->
va_mtime
.
tv_£c
 = 
ù
->
i_e2fs_mtime
;

316 
v≠
->
va_mtime
.
tv_n£c
 = 0;

317 
v≠
->
va_˘ime
.
tv_£c
 = 
ù
->
i_e2fs_˘ime
;

318 
v≠
->
va_˘ime
.
tv_n£c
 = 0;

319 #ifde‡
EXT2FS_SYSTEM_FLAGS


320 
v≠
->
va_Êags
 = (
ù
->
i_e2fs_Êags
 & 
EXT2_APPEND
Ë? 
SF_APPEND
 : 0;

321 
v≠
->
va_Êags
 |(
ù
->
i_e2fs_Êags
 & 
EXT2_IMMUTABLE
Ë? 
SF_IMMUTABLE
 : 0;

323 
v≠
->
va_Êags
 = (
ù
->
i_e2fs_Êags
 & 
EXT2_APPEND
Ë? 
UF_APPEND
 : 0;

324 
v≠
->
va_Êags
 |(
ù
->
i_e2fs_Êags
 & 
EXT2_IMMUTABLE
Ë? 
UF_IMMUTABLE
 : 0;

326 
v≠
->
va_gí
 = 
ù
->
i_e2fs_gí
;

328 i‡(
vp
->
v_ty≥
 =
VBLK
)

329 
v≠
->
va_blocksize
 = 
BLKDEV_IOSIZE
;

330 i‡(
vp
->
v_ty≥
 =
VCHR
)

331 
v≠
->
va_blocksize
 = 
MAXBSIZE
;

333 
v≠
->
va_blocksize
 = 
vp
->
v_mou¡
->
m¡_°©
.
f_iosize
;

334 
v≠
->
va_byãs
 = 
	`dbtob
(
	`ext2fs_nblock
(
ù
));

335 
v≠
->
va_ty≥
 = 
vp
->
v_ty≥
;

336 
v≠
->
va_fûîev
 = 
ù
->
i_modªv
;

338 
	}
}

344 
	$ext2fs_£èâr
(*
v
)

346 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

347 
v›_£èâr_¨gs


351  *
≠
 = 
v
;

352 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

353 
vnode
 *
vp
 = 
≠
->
a_vp
;

354 
öode
 *
ù
 = 
	`VTOI
(
vp
);

355 
kauth_¸ed_t
 
¸ed
 = 
≠
->
a_¸ed
;

356 
lwp
 *
l
 = 
cuæwp
;

357 
îr‹
;

358 
kauth_a˘i⁄_t
 
a˘i⁄
 = 
KAUTH_VNODE_WRITE_FLAGS
;

359 
boﬁ
 
ch™gög_sysÊags
 = 
Ál£
;

364 i‡((
v≠
->
va_ty≥
 !
VNON
Ë|| (v≠->
va_∆ök
 !(
∆ök_t
)
VNOVAL
) ||

365 (
v≠
->
va_fsid
 !
VNOVAL
Ë|| (v≠->
va_fûeid
 != VNOVAL) ||

366 (
v≠
->
va_blocksize
 !
VNOVAL
Ë|| (v≠->
va_rdev
 != VNOVAL) ||

367 (()
v≠
->
va_byãs
 !
VNOVAL
Ë|| (v≠->
va_gí
 != VNOVAL)) {

368  (
EINVAL
);

370 i‡(
v≠
->
va_Êags
 !
VNOVAL
) {

371 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

372  (
EROFS
);

380 #ifde‡
EXT2FS_SYSTEM_FLAGS


382 i‡((
v≠
->
va_Êags
 & 
SF_APPEND
) ||

383 (
v≠
->
va_Êags
 & 
SF_IMMUTABLE
)) {

384 
a˘i⁄
 |
KAUTH_VNODE_WRITE_SYSFLAGS
;

385 
ch™gög_sysÊags
 = 
åue
;

389 i‡(
ù
->
i_e2fs_Êags
 & (
EXT2_APPEND
 | 
EXT2_IMMUTABLE
)) {

390 
a˘i⁄
 |
KAUTH_VNODE_HAS_SYSFLAGS
;

394 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
a˘i⁄
, 
vp
, 
NULL
,

395 
	`gífs_ˇn_chÊags
(
¸ed
, 
vp
->
v_ty≥
, 
ù
->
i_uid
,

396 
ch™gög_sysÊags
));

397 i‡(
îr‹
)

398  (
îr‹
);

400 #ifde‡
EXT2FS_SYSTEM_FLAGS


401 
ù
->
i_e2fs_Êags
 &~(
EXT2_APPEND
 | 
EXT2_IMMUTABLE
);

402 
ù
->
i_e2fs_Êags
 |=

403 (
v≠
->
va_Êags
 & 
SF_APPEND
Ë? 
EXT2_APPEND
 : 0 |

404 (
v≠
->
va_Êags
 & 
SF_IMMUTABLE
Ë? 
EXT2_IMMUTABLE
 : 0;

406 
ù
->
i_e2fs_Êags
 &~(
EXT2_APPEND
 | 
EXT2_IMMUTABLE
);

407 
ù
->
i_e2fs_Êags
 |=

408 (
v≠
->
va_Êags
 & 
UF_APPEND
Ë? 
EXT2_APPEND
 : 0 |

409 (
v≠
->
va_Êags
 & 
UF_IMMUTABLE
Ë? 
EXT2_IMMUTABLE
 : 0;

411 
ù
->
i_Êag
 |
IN_CHANGE
;

412 i‡(
v≠
->
va_Êags
 & (
IMMUTABLE
 | 
APPEND
))

415 i‡(
ù
->
i_e2fs_Êags
 & (
EXT2_APPEND
 | 
EXT2_IMMUTABLE
))

416  (
EPERM
);

420 i‡(
v≠
->
va_uid
 !(
uid_t
)
VNOVAL
 || v≠->
va_gid
 !(
gid_t
)VNOVAL) {

421 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

422  (
EROFS
);

423 
îr‹
 = 
	`ext2fs_chown
(
vp
, 
v≠
->
va_uid
, v≠->
va_gid
, 
¸ed
, 
l
);

424 i‡(
îr‹
)

425  (
îr‹
);

427 i‡(
v≠
->
va_size
 !
VNOVAL
) {

433 
vp
->
v_ty≥
) {

434 
VDIR
:

435  (
EISDIR
);

436 
VLNK
:

437 
VREG
:

438 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

439  (
EROFS
);

443 
îr‹
 = 
	`ext2fs_åunˇã
(
vp
, 
v≠
->
va_size
, 0, 
¸ed
);

444 i‡(
îr‹
)

445  (
îr‹
);

447 
ù
 = 
	`VTOI
(
vp
);

448 i‡(
v≠
->
va_©ime
.
tv_£c
 !
VNOVAL
 || v≠->
va_mtime
.tv_sec != VNOVAL) {

449 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

450  (
EROFS
);

451 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_WRITE_TIMES
, 
vp
,

452 
NULL
, 
	`gífs_ˇn_chtimes
(
vp
, 
v≠
->
va_vaÊags
, 
ù
->
i_uid
,

453 
¸ed
));

454 i‡(
îr‹
)

455  (
îr‹
);

456 i‡(
v≠
->
va_©ime
.
tv_£c
 !
VNOVAL
)

457 i‡(!(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_NOATIME
))

458 
ù
->
i_Êag
 |
IN_ACCESS
;

459 i‡(
v≠
->
va_mtime
.
tv_£c
 !
VNOVAL
) {

460 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

461 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RELATIME
)

462 
ù
->
i_Êag
 |
IN_ACCESS
;

464 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, &
v≠
->
va_©ime
, &v≠->
va_mtime
,

465 
UPDATE_WAIT
);

466 i‡(
îr‹
)

467  (
îr‹
);

469 
îr‹
 = 0;

470 i‡(
v≠
->
va_mode
 !(
mode_t
)
VNOVAL
) {

471 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
)

472  (
EROFS
);

473 
îr‹
 = 
	`ext2fs_chmod
(
vp
, ()
v≠
->
va_mode
, 
¸ed
, 
l
);

475 
	`VN_KNOTE
(
vp
, 
NOTE_ATTRIB
);

476  (
îr‹
);

477 
	}
}

484 
	$ext2fs_chmod
(
vnode
 *
vp
, 
mode
, 
kauth_¸ed_t
 
¸ed
, 
lwp
 *
l
)

486 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

487 
öode
 *
ù
 = 
	`VTOI
(
vp
);

488 
îr‹
;

490 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_WRITE_SECURITY
, 
vp
,

491 
NULL
, 
	`gífs_ˇn_chmod
(
vp
->
v_ty≥
, 
¸ed
, 
ù
->
i_uid
, ip->
i_gid
,

492 
mode
));

493 i‡(
îr‹
)

494  (
îr‹
);

496 
ù
->
i_e2fs_mode
 &~
ALLPERMS
;

497 
ù
->
i_e2fs_mode
 |(
mode
 & 
ALLPERMS
);

498 
ù
->
i_Êag
 |
IN_CHANGE
;

500 
	}
}

507 
	$ext2fs_chown
(
vnode
 *
vp
, 
uid_t
 
uid
, 
gid_t
 
gid
, 
kauth_¸ed_t
 
¸ed
,

508 
lwp
 *
l
)

510 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

511 
öode
 *
ù
 = 
	`VTOI
(
vp
);

512 
uid_t
 
ouid
;

513 
gid_t
 
ogid
;

514 
îr‹
;

516 i‡(
uid
 =(
uid_t
)
VNOVAL
)

517 
uid
 = 
ù
->
i_uid
;

518 i‡(
gid
 =(
gid_t
)
VNOVAL
)

519 
gid
 = 
ù
->
i_gid
;

521 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_CHANGE_OWNERSHIP
, 
vp
,

522 
NULL
, 
	`gífs_ˇn_chown
(
¸ed
, 
ù
->
i_uid
, ip->
i_gid
, 
uid
, 
gid
));

523 i‡(
îr‹
)

524  (
îr‹
);

526 
ogid
 = 
ù
->
i_gid
;

527 
ouid
 = 
ù
->
i_uid
;

529 
ù
->
i_e2fs_gid
 = 
gid
 & 0xffff;

530 
ù
->
i_e2fs_uid
 = 
uid
 & 0xffff;

531 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

532 
ù
->
i_e2fs_gid_high
 = (
gid
 >> 16) & 0xffff;

533 
ù
->
i_e2fs_uid_high
 = (
uid
 >> 16) & 0xffff;

535 
ù
->
i_e2fs_gid_high
 = 0;

536 
ù
->
i_e2fs_uid_high
 = 0;

538 i‡(
ouid
 !
uid
 || 
ogid
 !
gid
) {

539 
	`ext2fs_£t_öode_guid
(
ù
);

540 
ù
->
i_Êag
 |
IN_CHANGE
;

542 i‡(
ouid
 !
uid
 && (
ù
->
i_e2fs_mode
 & 
ISUID
) &&

543 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_RETAIN_SUID
,

544 
vp
, 
NULL
, 
EPERM
) != 0)

545 
ù
->
i_e2fs_mode
 &~
ISUID
;

546 i‡(
ogid
 !
gid
 && (
ù
->
i_e2fs_mode
 & 
ISGID
) &&

547 
	`kauth_auth‹ize_vnode
(
¸ed
, 
KAUTH_VNODE_RETAIN_SGID
,

548 
vp
, 
NULL
, 
EPERM
) != 0)

549 
ù
->
i_e2fs_mode
 &~
ISGID
;

551 
	}
}

554 
	$ext2fs_ªmove
(*
v
)

556 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

557 
v›_ªmove_¨gs


561  *
≠
 = 
v
;

562 
öode
 *
ù
;

563 
vnode
 *
vp
 = 
≠
->
a_vp
;

564 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

565 
ufs_lookup_ªsu…s
 *
uÃ
;

566 
îr‹
;

569 
uÃ
 = &
	`VTOI
(
dvp
)->
i_¸≠
;

570 
	`UFS_CHECK_CRAPCOUNTER
(
	`VTOI
(
dvp
));

572 
ù
 = 
	`VTOI
(
vp
);

573 i‡(
vp
->
v_ty≥
 =
VDIR
 ||

574 (
ù
->
i_e2fs_Êags
 & (
EXT2_IMMUTABLE
 | 
EXT2_APPEND
)) ||

575 (
	`VTOI
(
dvp
)->
i_e2fs_Êags
 & 
EXT2_APPEND
)) {

576 
îr‹
 = 
EPERM
;

578 
îr‹
 = 
	`ext2fs_dúªmove
(
dvp
, 
uÃ
, 
≠
->
a_˙p
);

579 i‡(
îr‹
 == 0) {

580 
ù
->
i_e2fs_∆ök
--;

581 
ù
->
i_Êag
 |
IN_CHANGE
;

585 
	`VN_KNOTE
(
vp
, 
NOTE_DELETE
);

586 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
);

587 i‡(
dvp
 =
vp
)

588 
	`vªÀ
(
vp
);

590 
	`vput
(
vp
);

591 
	`vput
(
dvp
);

592  (
îr‹
);

593 
	}
}

599 
	$ext2fs_lök
(*
v
)

601 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

602 
v›_lök_v2_¨gs


606  *
≠
 = 
v
;

607 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

608 
vnode
 *
vp
 = 
≠
->
a_vp
;

609 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

610 
öode
 *
ù
;

611 
îr‹
;

612 
ufs_lookup_ªsu…s
 *
uÃ
;

614 
	`KASSERT
(
dvp
 !
vp
);

615 
	`KASSERT
(
vp
->
v_ty≥
 !
VDIR
);

616 
	`KASSERT
(
dvp
->
v_mou¡
 =
vp
->v_mount);

619 
uÃ
 = &
	`VTOI
(
dvp
)->
i_¸≠
;

620 
	`UFS_CHECK_CRAPCOUNTER
(
	`VTOI
(
dvp
));

622 
îr‹
 = 
	`vn_lock
(
vp
, 
LK_EXCLUSIVE
);

623 i‡(
îr‹
) {

624 
	`VOP_ABORTOP
(
dvp
, 
˙p
);

625 
out2
;

627 
ù
 = 
	`VTOI
(
vp
);

628 i‡((
∆ök_t
)
ù
->
i_e2fs_∆ök
 >
LINK_MAX
) {

629 
	`VOP_ABORTOP
(
dvp
, 
˙p
);

630 
îr‹
 = 
EMLINK
;

631 
out1
;

633 i‡(
ù
->
i_e2fs_Êags
 & (
EXT2_IMMUTABLE
 | 
EXT2_APPEND
)) {

634 
	`VOP_ABORTOP
(
dvp
, 
˙p
);

635 
îr‹
 = 
EPERM
;

636 
out1
;

638 
ù
->
i_e2fs_∆ök
++;

639 
ù
->
i_Êag
 |
IN_CHANGE
;

640 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
UPDATE_WAIT
);

641 i‡(!
îr‹
)

642 
îr‹
 = 
	`ext2fs_dúíãr
(
ù
, 
dvp
, 
uÃ
, 
˙p
);

643 i‡(
îr‹
) {

644 
ù
->
i_e2fs_∆ök
--;

645 
ù
->
i_Êag
 |
IN_CHANGE
;

647 
out1
:

648 
	`VOP_UNLOCK
(
vp
);

649 
out2
:

650 
	`VN_KNOTE
(
vp
, 
NOTE_LINK
);

651 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
);

652  (
îr‹
);

653 
	}
}

659 
	$ext2fs_mkdú
(*
v
)

661 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

662 
v›_mkdú_v3_¨gs


667  *
≠
 = 
v
;

668 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

669 
v©å
 *
v≠
 = 
≠
->
a_v≠
;

670 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

671 
öode
 *
ù
, *
dp
 = 
	`VTOI
(
dvp
);

672 
vnode
 *
tvp
;

673 
ext2fs_dúãm∂©e
 
dúãm∂©e
;

674 
îr‹
, 
dmode
;

675 
ufs_lookup_ªsu…s
 *
uÃ
;

678 
uÃ
 = &
	`VTOI
(
dvp
)->
i_¸≠
;

679 
	`UFS_CHECK_CRAPCOUNTER
(
	`VTOI
(
dvp
));

681 i‡((
∆ök_t
)
dp
->
i_e2fs_∆ök
 >
LINK_MAX
) {

682 
îr‹
 = 
EMLINK
;

683 
out
;

685 
dmode
 = 
v≠
->
va_mode
 & 
ACCESSPERMS
;

686 
dmode
 |
IFDIR
;

692 i‡((
îr‹
 = 
	`ext2fs_vÆloc
(
dvp
, 
dmode
, 
˙p
->
˙_¸ed
, &
tvp
)) != 0)

693 
out
;

694 
ù
 = 
	`VTOI
(
tvp
);

695 
ù
->
i_uid
 = 
	`kauth_¸ed_gëeuid
(
˙p
->
˙_¸ed
);

696 
ù
->
i_e2fs_uid
 = ip->
i_uid
 & 0xffff;

697 
ù
->
i_e2fs_gid
 = 
dp
->i_e2fs_gid;

698 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

699 
ù
->
i_e2fs_uid_high
 = (ù->
i_uid
 >> 16) & 0xffff;

700 
ù
->
i_e2fs_gid_high
 = 
dp
->i_e2fs_gid_high;

702 
ù
->
i_e2fs_uid_high
 = 0;

703 
ù
->
i_e2fs_gid_high
 = 0;

705 
ù
->
i_gid
 = ip->
i_e2fs_gid
 | (ù->
i_e2fs_gid_high
 << 16);

706 
ù
->
i_Êag
 |
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
;

707 
ù
->
i_e2fs_mode
 = 
dmode
;

708 
tvp
->
v_ty≥
 = 
VDIR
;

709 
ù
->
i_e2fs_∆ök
 = 2;

717 
dp
->
i_e2fs_∆ök
++;

718 
dp
->
i_Êag
 |
IN_CHANGE
;

719 i‡((
îr‹
 = 
	`ext2fs_upd©e
(
dvp
, 
NULL
, NULL, 
UPDATE_DIROP
)) != 0)

720 
bad
;

723 
	`mem£t
(&
dúãm∂©e
, 0, (dirtemplate));

724 
dúãm∂©e
.
dŸ_öo
 = 
	`h2fs32
(
ù
->
i_numbî
);

725 
dúãm∂©e
.
dŸ_ª˛í
 = 
	`h2fs16
(12);

726 
dúãm∂©e
.
dŸ_«mÀn
 = 1;

727 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

728 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

729 
dúãm∂©e
.
dŸ_ty≥
 = 
EXT2_FT_DIR
;

731 
dúãm∂©e
.
dŸ_«me
[0] = '.';

732 
dúãm∂©e
.
dŸdŸ_öo
 = 
	`h2fs32
(
dp
->
i_numbî
);

733 
dúãm∂©e
.
dŸdŸ_ª˛í
 = 
	`h2fs16
(
	`VTOI
(
dvp
)->
i_e2fs
->
e2fs_bsize
 - 12);

734 
dúãm∂©e
.
dŸdŸ_«mÀn
 = 2;

735 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
 &&

736 (
ù
->
i_e2fs
->
e2fs
.
e2fs_„©uªs_öcom∑t
 & 
EXT2F_INCOMPAT_FTYPE
)) {

737 
dúãm∂©e
.
dŸdŸ_ty≥
 = 
EXT2_FT_DIR
;

739 
dúãm∂©e
.
dŸdŸ_«me
[0] = dirtemplate.dotdot_name[1] = '.';

740 
îr‹
 = 
	`ufs_bufio
(
UIO_WRITE
, 
tvp
, (*)&
dúãm∂©e
,

741  (
dúãm∂©e
), (
off_t
)0, 
IO_NODELOCKED
|
IO_SYNC
,

742 
˙p
->
˙_¸ed
, (
size_t
 *)0, 
NULL
);

743 i‡(
îr‹
) {

744 
dp
->
i_e2fs_∆ök
--;

745 
dp
->
i_Êag
 |
IN_CHANGE
;

746 
bad
;

748 i‡(
	`VTOI
(
dvp
)->
i_e2fs
->
e2fs_bsize
 > dvp->
v_mou¡
->
m¡_°©
.
f_bsize
)

749 
	`∑nic
("ext2fs_mkdir: blksize");

751 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
	`VTOI
(
dvp
)->
i_e2fs
->
e2fs_bsize
);

752 i‡(
îr‹
) {

753 
dp
->
i_e2fs_∆ök
--;

754 
dp
->
i_Êag
 |
IN_CHANGE
;

755 
bad
;

757 
ù
->
i_Êag
 |
IN_CHANGE
;

758 
	`uvm_v≈_£tsize
(
tvp
, 
	`ext2fs_size
(
ù
));

762 
îr‹
 = 
	`ext2fs_dúíãr
(
ù
, 
dvp
, 
uÃ
, 
˙p
);

763 i‡(
îr‹
 != 0) {

764 
dp
->
i_e2fs_∆ök
--;

765 
dp
->
i_Êag
 |
IN_CHANGE
;

767 
bad
:

772 i‡(
îr‹
) {

773 
ù
->
i_e2fs_∆ök
 = 0;

774 
ù
->
i_Êag
 |
IN_CHANGE
;

775 
	`vput
(
tvp
);

777 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
 | 
NOTE_LINK
);

778 
	`VOP_UNLOCK
(
tvp
);

779 *
≠
->
a_vµ
 = 
tvp
;

781 
out
:

782  (
îr‹
);

783 
	}
}

789 
	$ext2fs_rmdú
(*
v
)

791 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

792 
v›_rmdú_¨gs


796  *
≠
 = 
v
;

797 
vnode
 *
vp
 = 
≠
->
a_vp
;

798 
vnode
 *
dvp
 = 
≠
->
a_dvp
;

799 
comp⁄íäame
 *
˙p
 = 
≠
->
a_˙p
;

800 
öode
 *
ù
, *
dp
;

801 
îr‹
;

802 
ufs_lookup_ªsu…s
 *
uÃ
;

804 
ù
 = 
	`VTOI
(
vp
);

805 
dp
 = 
	`VTOI
(
dvp
);

808 
uÃ
 = &
dp
->
i_¸≠
;

809 
	`UFS_CHECK_CRAPCOUNTER
(
dp
);

814 i‡(
dp
 =
ù
) {

815 
	`vªÀ
(
dvp
);

816 
	`vput
(
vp
);

817  (
EINVAL
);

826 
îr‹
 = 0;

827 i‡(
ù
->
i_e2fs_∆ök
 != 2 ||

828 !
	`ext2fs_dúem±y
(
ù
, 
dp
->
i_numbî
, 
˙p
->
˙_¸ed
)) {

829 
îr‹
 = 
ENOTEMPTY
;

830 
out
;

832 i‡((
dp
->
i_e2fs_Êags
 & 
EXT2_APPEND
) ||

833 (
ù
->
i_e2fs_Êags
 & (
EXT2_IMMUTABLE
 | 
EXT2_APPEND
))) {

834 
îr‹
 = 
EPERM
;

835 
out
;

842 
îr‹
 = 
	`ext2fs_dúªmove
(
dvp
, 
uÃ
, 
˙p
);

843 i‡(
îr‹
 != 0)

844 
out
;

845 
dp
->
i_e2fs_∆ök
--;

846 
dp
->
i_Êag
 |
IN_CHANGE
;

847 
	`VN_KNOTE
(
dvp
, 
NOTE_WRITE
 | 
NOTE_LINK
);

848 
	`ˇche_purge
(
dvp
);

849 
	`vput
(
dvp
);

850 
dvp
 = 
NULL
;

862 
ù
->
i_e2fs_∆ök
 -= 2;

863 
îr‹
 = 
	`ext2fs_åunˇã
(
vp
, (
off_t
)0, 
IO_SYNC
, 
˙p
->
˙_¸ed
);

864 
	`ˇche_purge
(
	`ITOV
(
ù
));

865 
out
:

866 
	`VN_KNOTE
(
vp
, 
NOTE_DELETE
);

867 i‡(
dvp
)

868 
	`vput
(
dvp
);

869 
	`vput
(
vp
);

870  (
îr‹
);

871 
	}
}

877 
	$ext2fs_symlök
(*
v
)

879 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

880 
v›_symlök_v3_¨gs


886  *
≠
 = 
v
;

887 
vnode
 *
vp
, **
vµ
;

888 
öode
 *
ù
;

889 
Àn
, 
îr‹
;

891 
vµ
 = 
≠
->
a_vµ
;

892 
îr‹
 = 
	`ext2fs_makeöode
(
IFLNK
 | 
≠
->
a_v≠
->
va_mode
,áp->
a_dvp
,

893 
vµ
, 
≠
->
a_˙p
);

894 i‡(
îr‹
)

895  (
îr‹
);

896 
	`VN_KNOTE
(
≠
->
a_dvp
, 
NOTE_WRITE
);

897 
vp
 = *
vµ
;

898 
Àn
 = 
	`°æí
(
≠
->
a_èrgë
);

899 
ù
 = 
	`VTOI
(
vp
);

900 i‡(
Àn
 < 
ù
->
i_ump
->
um_maxsymlökÀn
) {

901 
	`mem˝y
((*)
ù
->
i_dö
.
e2fs_dö
->
e2di_sh‹éök
, 
≠
->
a_èrgë
, 
Àn
);

902 
îr‹
 = 
	`ext2fs_£tsize
(
ù
, 
Àn
);

903 i‡(
îr‹
)

904 
bad
;

905 
ù
->
i_Êag
 |
IN_CHANGE
 | 
IN_UPDATE
;

906 i‡(
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RELATIME
)

907 
ù
->
i_Êag
 |
IN_ACCESS
;

908 
	`uvm_v≈_£tsize
(
vp
, 
Àn
);

910 
îr‹
 = 
	`ufs_bufio
(
UIO_WRITE
, 
vp
, 
≠
->
a_èrgë
, 
Àn
, (
off_t
)0,

911 
IO_NODELOCKED
, 
≠
->
a_˙p
->
˙_¸ed
, (
size_t
 *)0, 
NULL
);

912 
bad
:

913 
	`VOP_UNLOCK
(
vp
);

914 i‡(
îr‹
)

915 
	`vªÀ
(
vp
);

916  (
îr‹
);

917 
	}
}

923 
	$ext2fs_ªadlök
(*
v
)

925 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

926 
v›_ªadlök_¨gs


930  *
≠
 = 
v
;

931 
vnode
 *
vp
 = 
≠
->
a_vp
;

932 
öode
 *
ù
 = 
	`VTOI
(
vp
);

933 
ufsmou¡
 *
ump
 = 
ù
->
i_ump
;

934 
isize
;

936 
isize
 = 
	`ext2fs_size
(
ù
);

937 i‡(
isize
 < 
ump
->
um_maxsymlökÀn
 ||

938 (
ump
->
um_maxsymlökÀn
 =0 && 
	`ext2fs_nblock
(
ù
) == 0)) {

939 
	`uiomove
((*)
ù
->
i_dö
.
e2fs_dö
->
e2di_sh‹éök
, 
isize
, 
≠
->
a_uio
);

942  (
	`UFS_BUFRD
(
vp
, 
≠
->
a_uio
, 0,áp->
a_¸ed
));

943 
	}
}

949 
	$ext2fs_advlock
(*
v
)

951 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

952 
v›_advlock_¨gs


958  *
≠
 = 
v
;

959 
öode
 *
ù
 = 
	`VTOI
(
≠
->
a_vp
);

961  
	`lf_advlock
(
≠
, &
ù
->
i_lockf
, 
	`ext2fs_size
(ip));

962 
	}
}

965 
	$ext2fs_fsync
(*
v
)

967 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

968 
v›_fsync_¨gs


975  *
≠
 = 
v
;

976 
vnode
 *
vp
 = 
≠
->
a_vp
;

977 
waô
;

978 
îr‹
;

980 
waô
 = (
≠
->
a_Êags
 & 
FSYNC_WAIT
) != 0;

982 i‡(
vp
->
v_ty≥
 =
VBLK
)

983 
îr‹
 = 
	`•ec_fsync
(
v
);

985 
îr‹
 = 
	`vÊushbuf
(
vp
, 
≠
->
a_Êags
);

986 i‡(
îr‹
 =0 && (
≠
->
a_Êags
 & 
FSYNC_DATAONLY
) == 0)

987 
îr‹
 = 
	`ext2fs_upd©e
(
vp
, 
NULL
, NULL, 
waô
 ? 
UPDATE_WAIT
 : 0);

989 i‡(
îr‹
 =0 && 
≠
->
a_Êags
 & 
FSYNC_CACHE
) {

990 
l
 = 0;

991 
îr‹
 = 
	`VOP_IOCTL
(
	`VTOI
(
vp
)->
i_devvp
, 
DIOCCACHESYNC
, &
l
, 
FWRITE
,

992 
cuæwp
->
l_¸ed
);

995  
îr‹
;

996 
	}
}

1003 
ext2fs_vöô
(
mou¡
 *
m¡p
, (**
•ec›s
)(*),

1004 (**
fifo›s
)(*), 
vnode
 **
vµ
)

1006 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1007 
timevÆ
 
tv
;

1008 
öode
 *
ù
;

1009 
vnode
 *
vp
;

1011 
vp
 = *
vµ
;

1012 
ù
 = 
	`VTOI
(
vp
);

1013 
vp
->
v_ty≥
 = 
	`IFTOVT
(
ù
->
i_e2fs_mode
)) {

1014 
VCHR
:

1015 
VBLK
:

1016 
vp
->
v_›
 = 
•ec›s
;

1017 
	`•ec_node_öô
(
vp
, 
	`fs2h32
(
ù
->
i_dö
.
e2fs_dö
->
e2di_rdev
));

1019 
VFIFO
:

1020 
vp
->
v_›
 = 
fifo›s
;

1022 
VNON
:

1023 
VBAD
:

1024 
VSOCK
:

1025 
VLNK
:

1026 
VDIR
:

1027 
VREG
:

1030 i‡(
ù
->
i_numbî
 =
UFS_ROOTINO
)

1031 
vp
->
v_vÊag
 |
VV_ROOT
;

1035 
	`gëmi¸ou±ime
(&
tv
);

1036 
	`SETHIGH
(
ù
->
i_modªv
, 
tv
.
tv_£c
);

1037 
	`SETLOW
(
ù
->
i_modªv
, 
tv
.
tv_u£c
 * 4294);

1038 *
vµ
 = 
vp
;

1040 
	}
}

1046 
	$ext2fs_makeöode
(
mode
, 
vnode
 *
dvp
, vnodê**
vµ
,

1047 
comp⁄íäame
 *
˙p
)

1049 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1050 
öode
 *
ù
, *
pdú
;

1051 
vnode
 *
tvp
;

1052 
îr‹
;

1053 
ufs_lookup_ªsu…s
 *
uÃ
;

1055 
pdú
 = 
	`VTOI
(
dvp
);

1058 
uÃ
 = &
pdú
->
i_¸≠
;

1059 
	`UFS_CHECK_CRAPCOUNTER
(
pdú
);

1061 *
vµ
 = 
NULL
;

1062 i‡((
mode
 & 
IFMT
) == 0)

1063 
mode
 |
IFREG
;

1065 i‡((
îr‹
 = 
	`ext2fs_vÆloc
(
dvp
, 
mode
, 
˙p
->
˙_¸ed
, &
tvp
)) != 0) {

1066  (
îr‹
);

1068 
ù
 = 
	`VTOI
(
tvp
);

1069 
ù
->
i_uid
 = 
	`kauth_¸ed_gëeuid
(
˙p
->
˙_¸ed
);

1070 
ù
->
i_e2fs_uid
 = ip->
i_uid
 & 0xffff;

1071 
ù
->
i_e2fs_gid
 = 
pdú
->i_e2fs_gid;

1072 i‡(
ù
->
i_e2fs
->
e2fs
.
e2fs_ªv
 > 
E2FS_REV0
) {

1073 
ù
->
i_e2fs_uid_high
 = (ù->
i_uid
 >> 16) & 0xffff;

1074 
ù
->
i_e2fs_gid_high
 = 
pdú
->i_e2fs_gid_high;

1076 
ù
->
i_e2fs_uid_high
 = 0;

1077 
ù
->
i_e2fs_gid_high
 = 0;

1079 
ù
->
i_gid
 = ip->
i_e2fs_gid
 | (ù->
i_e2fs_gid_high
 << 16);

1080 
ù
->
i_Êag
 |
IN_ACCESS
 | 
IN_CHANGE
 | 
IN_UPDATE
;

1081 
ù
->
i_e2fs_mode
 = 
mode
;

1082 
tvp
->
v_ty≥
 = 
	`IFTOVT
(
mode
);

1083 
ù
->
i_e2fs_∆ök
 = 1;

1086 i‡(
ù
->
i_e2fs_mode
 & 
ISGID
) {

1087 
îr‹
 = 
	`kauth_auth‹ize_vnode
(
˙p
->
˙_¸ed
, 
KAUTH_VNODE_WRITE_SECURITY
,

1088 
tvp
, 
NULL
, 
	`gífs_ˇn_chmod
—vp->
v_ty≥
, 
˙p
->
˙_¸ed
, 
ù
->
i_uid
,

1089 
ù
->
i_gid
, 
mode
));

1090 i‡(
îr‹
)

1091 
ù
->
i_e2fs_mode
 &~
ISGID
;

1097 i‡((
îr‹
 = 
	`ext2fs_upd©e
(
tvp
, 
NULL
, NULL, 
UPDATE_WAIT
)) != 0)

1098 
bad
;

1099 
îr‹
 = 
	`ext2fs_dúíãr
(
ù
, 
dvp
, 
uÃ
, 
˙p
);

1100 i‡(
îr‹
 != 0)

1101 
bad
;

1102 *
vµ
 = 
tvp
;

1105 
bad
:

1110 
tvp
->
v_ty≥
 = 
VNON
;

1111 
ù
->
i_e2fs_∆ök
 = 0;

1112 
ù
->
i_Êag
 |
IN_CHANGE
;

1113 
	`vput
(
tvp
);

1114  (
îr‹
);

1115 
	}
}

1121 
	$ext2fs_ª˛aim
(*
v
)

1123 
	`¥ötf
("I¿fûe: %s, fun: %s,löío: %d\n",
__FILE__
, 
__func__
, 
__LINE__
);

1124 
v›_ª˛aim_¨gs


1126  *
≠
 = 
v
;

1127 
vnode
 *
vp
 = 
≠
->
a_vp
;

1128 
öode
 *
ù
 = 
	`VTOI
(
vp
);

1129 
îr‹
;

1136 i‡(
ù
->
i_omode
 =1 && (
vp
->
v_mou¡
->
m¡_Êag
 & 
MNT_RDONLY
) == 0)

1137 
	`ext2fs_v‰ì
(
vp
, 
ù
->
i_numbî
, ip->
i_e2fs_mode
);

1138 i‡((
îr‹
 = 
	`ufs_ª˛aim
(
vp
)) != 0)

1139  (
îr‹
);

1140 i‡(
ù
->
i_dö
.
e2fs_dö
 !
NULL
)

1141 
	`poﬁ_put
(&
ext2fs_döode_poﬁ
, 
ù
->
i_dö
.
e2fs_dö
);

1142 
	`gífs_node_de°roy
(
vp
);

1143 
	`poﬁ_put
(&
ext2fs_öode_poﬁ
, 
vp
->
v_d©a
);

1144 
vp
->
v_d©a
 = 
NULL
;

1146 
	}
}

1149 (**
ext2fs_vnode›_p
)(*);

1150 c⁄° 
vnode›v_íåy_desc
 
ext2fs_vnode›_íåõs
[] = {

1151 { &
v›_deÁu…_desc
, 
vn_deÁu…_îr‹
 },

1152 { &
v›_lookup_desc
, 
ext2fs_lookup
 },

1153 { &
v›_¸óã_desc
, 
ext2fs_¸óã
 },

1154 { &
v›_mknod_desc
, 
ext2fs_mknod
 },

1155 { &
v›_›í_desc
, 
ext2fs_›í
 },

1156 { &
v›_˛o£_desc
, 
ufs_˛o£
 },

1157 { &
v›_ac˚ss_desc
, 
ext2fs_ac˚ss
 },

1158 { &
v›_gë©å_desc
, 
ext2fs_gë©å
 },

1159 { &
v›_£èâr_desc
, 
ext2fs_£èâr
 },

1160 { &
v›_ªad_desc
, 
ext2fs_ªad
 },

1161 { &
v›_wrôe_desc
, 
ext2fs_wrôe
 },

1162 { &
v›_ÁŒoˇã_desc
, 
gífs_e›nŸsuµ
 },

1163 { &
v›_fdisˇrd_desc
, 
gífs_e›nŸsuµ
 },

1164 { &
v›_io˘l_desc
, 
ufs_io˘l
 },

1165 { &
v›_f˙é_desc
, 
ufs_f˙é
 },

1166 { &
v›_pﬁl_desc
, 
ufs_pﬁl
 },

1167 { &
v›_kqfûãr_desc
, 
gífs_kqfûãr
 },

1168 { &
v›_ªvoke_desc
, 
ufs_ªvoke
 },

1169 { &
v›_mm≠_desc
, 
ufs_mm≠
 },

1170 { &
v›_fsync_desc
, 
ext2fs_fsync
 },

1171 { &
v›_£ek_desc
, 
ufs_£ek
 },

1172 { &
v›_ªmove_desc
, 
ext2fs_ªmove
 },

1173 { &
v›_lök_desc
, 
ext2fs_lök
 },

1174 { &
v›_ª«me_desc
, 
ext2fs_ª«me
 },

1175 { &
v›_mkdú_desc
, 
ext2fs_mkdú
 },

1176 { &
v›_rmdú_desc
, 
ext2fs_rmdú
 },

1177 { &
v›_symlök_desc
, 
ext2fs_symlök
 },

1178 { &
v›_ªaddú_desc
, 
ext2fs_ªaddú
 },

1179 { &
v›_ªadlök_desc
, 
ext2fs_ªadlök
 },

1180 { &
v›_ab‹t›_desc
, 
ufs_ab‹t›
 },

1181 { &
v›_öa˘ive_desc
, 
ext2fs_öa˘ive
 },

1182 { &
v›_ª˛aim_desc
, 
ext2fs_ª˛aim
 },

1183 { &
v›_lock_desc
, 
ufs_lock
 },

1184 { &
v›_u∆ock_desc
, 
ufs_u∆ock
 },

1185 { &
v›_bm≠_desc
, 
ext2fs_bm≠
 },

1186 { &
v›_°øãgy_desc
, 
ufs_°øãgy
 },

1187 { &
v›_¥öt_desc
, 
ufs_¥öt
 },

1188 { &
v›_i¶ocked_desc
, 
ufs_i¶ocked
 },

1189 { &
v›_∑thc⁄f_desc
, 
ufs_∑thc⁄f
 },

1190 { &
v›_advlock_desc
, 
ext2fs_advlock
 },

1191 { &
v›_bwrôe_desc
, 
vn_bwrôe
 },

1192 { &
v›_gë∑ges_desc
, 
gífs_gë∑ges
 },

1193 { &
v›_puçages_desc
, 
gífs_puçages
 },

1194 { 
NULL
, NULL }

1195 
	}
};

1196 c⁄° 
vnode›v_desc
 
	gext2fs_vnode›_›v_desc
 =

1197 { &
ext2fs_vnode›_p
, 
ext2fs_vnode›_íåõs
 };

1199 (**
ext2fs_•ec›_p
)(*);

1200 c⁄° 
vnode›v_íåy_desc
 
ext2fs_•ec›_íåõs
[] = {

1201 { &
v›_deÁu…_desc
, 
vn_deÁu…_îr‹
 },

1202 { &
v›_lookup_desc
, 
•ec_lookup
 },

1203 { &
v›_¸óã_desc
, 
•ec_¸óã
 },

1204 { &
v›_mknod_desc
, 
•ec_mknod
 },

1205 { &
v›_›í_desc
, 
•ec_›í
 },

1206 { &
v›_˛o£_desc
, 
ufs•ec_˛o£
 },

1207 { &
v›_ac˚ss_desc
, 
ext2fs_ac˚ss
 },

1208 { &
v›_gë©å_desc
, 
ext2fs_gë©å
 },

1209 { &
v›_£èâr_desc
, 
ext2fs_£èâr
 },

1210 { &
v›_ªad_desc
, 
ufs•ec_ªad
 },

1211 { &
v›_wrôe_desc
, 
ufs•ec_wrôe
 },

1212 { &
v›_ÁŒoˇã_desc
, 
•ec_ÁŒoˇã
 },

1213 { &
v›_fdisˇrd_desc
, 
•ec_fdisˇrd
 },

1214 { &
v›_io˘l_desc
, 
•ec_io˘l
 },

1215 { &
v›_f˙é_desc
, 
ufs_f˙é
 },

1216 { &
v›_pﬁl_desc
, 
•ec_pﬁl
 },

1217 { &
v›_kqfûãr_desc
, 
•ec_kqfûãr
 },

1218 { &
v›_ªvoke_desc
, 
•ec_ªvoke
 },

1219 { &
v›_mm≠_desc
, 
•ec_mm≠
 },

1220 { &
v›_fsync_desc
, 
ext2fs_fsync
 },

1221 { &
v›_£ek_desc
, 
•ec_£ek
 },

1222 { &
v›_ªmove_desc
, 
•ec_ªmove
 },

1223 { &
v›_lök_desc
, 
•ec_lök
 },

1224 { &
v›_ª«me_desc
, 
•ec_ª«me
 },

1225 { &
v›_mkdú_desc
, 
•ec_mkdú
 },

1226 { &
v›_rmdú_desc
, 
•ec_rmdú
 },

1227 { &
v›_symlök_desc
, 
•ec_symlök
 },

1228 { &
v›_ªaddú_desc
, 
•ec_ªaddú
 },

1229 { &
v›_ªadlök_desc
, 
•ec_ªadlök
 },

1230 { &
v›_ab‹t›_desc
, 
•ec_ab‹t›
 },

1231 { &
v›_öa˘ive_desc
, 
ext2fs_öa˘ive
 },

1232 { &
v›_ª˛aim_desc
, 
ext2fs_ª˛aim
 },

1233 { &
v›_lock_desc
, 
ufs_lock
 },

1234 { &
v›_u∆ock_desc
, 
ufs_u∆ock
 },

1235 { &
v›_bm≠_desc
, 
•ec_bm≠
 },

1236 { &
v›_°øãgy_desc
, 
•ec_°øãgy
 },

1237 { &
v›_¥öt_desc
, 
ufs_¥öt
 },

1238 { &
v›_i¶ocked_desc
, 
ufs_i¶ocked
 },

1239 { &
v›_∑thc⁄f_desc
, 
•ec_∑thc⁄f
 },

1240 { &
v›_advlock_desc
, 
•ec_advlock
 },

1241 { &
v›_bwrôe_desc
, 
vn_bwrôe
 },

1242 { &
v›_gë∑ges_desc
, 
•ec_gë∑ges
 },

1243 { &
v›_puçages_desc
, 
•ec_puçages
 },

1244 { 
NULL
, NULL }

1245 
	}
};

1246 c⁄° 
vnode›v_desc
 
	gext2fs_•ec›_›v_desc
 =

1247 { &
ext2fs_•ec›_p
, 
ext2fs_•ec›_íåõs
 };

1249 (**
ext2fs_fifo›_p
)(*);

1250 c⁄° 
vnode›v_íåy_desc
 
ext2fs_fifo›_íåõs
[] = {

1251 { &
v›_deÁu…_desc
, 
vn_deÁu…_îr‹
 },

1252 { &
v›_lookup_desc
, 
vn_fifo_by∑ss
 },

1253 { &
v›_¸óã_desc
, 
vn_fifo_by∑ss
 },

1254 { &
v›_mknod_desc
, 
vn_fifo_by∑ss
 },

1255 { &
v›_›í_desc
, 
vn_fifo_by∑ss
 },

1256 { &
v›_˛o£_desc
, 
ufsfifo_˛o£
 },

1257 { &
v›_ac˚ss_desc
, 
ext2fs_ac˚ss
 },

1258 { &
v›_gë©å_desc
, 
ext2fs_gë©å
 },

1259 { &
v›_£èâr_desc
, 
ext2fs_£èâr
 },

1260 { &
v›_ªad_desc
, 
ufsfifo_ªad
 },

1261 { &
v›_wrôe_desc
, 
ufsfifo_wrôe
 },

1262 { &
v›_ÁŒoˇã_desc
, 
vn_fifo_by∑ss
 },

1263 { &
v›_fdisˇrd_desc
, 
vn_fifo_by∑ss
 },

1264 { &
v›_io˘l_desc
, 
vn_fifo_by∑ss
 },

1265 { &
v›_f˙é_desc
, 
ufs_f˙é
 },

1266 { &
v›_pﬁl_desc
, 
vn_fifo_by∑ss
 },

1267 { &
v›_kqfûãr_desc
, 
vn_fifo_by∑ss
 },

1268 { &
v›_ªvoke_desc
, 
vn_fifo_by∑ss
 },

1269 { &
v›_mm≠_desc
, 
vn_fifo_by∑ss
 },

1270 { &
v›_fsync_desc
, 
ext2fs_fsync
 },

1271 { &
v›_£ek_desc
, 
vn_fifo_by∑ss
 },

1272 { &
v›_ªmove_desc
, 
vn_fifo_by∑ss
 },

1273 { &
v›_lök_desc
, 
vn_fifo_by∑ss
 },

1274 { &
v›_ª«me_desc
, 
vn_fifo_by∑ss
 },

1275 { &
v›_mkdú_desc
, 
vn_fifo_by∑ss
 },

1276 { &
v›_rmdú_desc
, 
vn_fifo_by∑ss
 },

1277 { &
v›_symlök_desc
, 
vn_fifo_by∑ss
 },

1278 { &
v›_ªaddú_desc
, 
vn_fifo_by∑ss
 },

1279 { &
v›_ªadlök_desc
, 
vn_fifo_by∑ss
 },

1280 { &
v›_ab‹t›_desc
, 
vn_fifo_by∑ss
 },

1281 { &
v›_öa˘ive_desc
, 
ext2fs_öa˘ive
 },

1282 { &
v›_ª˛aim_desc
, 
ext2fs_ª˛aim
 },

1283 { &
v›_lock_desc
, 
ufs_lock
 },

1284 { &
v›_u∆ock_desc
, 
ufs_u∆ock
 },

1285 { &
v›_bm≠_desc
, 
vn_fifo_by∑ss
 },

1286 { &
v›_°øãgy_desc
, 
vn_fifo_by∑ss
 },

1287 { &
v›_¥öt_desc
, 
ufs_¥öt
 },

1288 { &
v›_i¶ocked_desc
, 
ufs_i¶ocked
 },

1289 { &
v›_∑thc⁄f_desc
, 
vn_fifo_by∑ss
 },

1290 { &
v›_advlock_desc
, 
vn_fifo_by∑ss
 },

1291 { &
v›_bwrôe_desc
, 
vn_bwrôe
 },

1292 { &
v›_puçages_desc
, 
vn_fifo_by∑ss
 },

1293 { 
NULL
, NULL }

1294 
	}
};

1295 c⁄° 
vnode›v_desc
 
	gext2fs_fifo›_›v_desc
 =

1296 { &
ext2fs_fifo›_p
, 
ext2fs_fifo›_íåõs
 };

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


30 
	#__√ed_size_t


	)

31 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

35 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

43 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

46 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

47 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

65 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

69 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

74 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

77 #ifde‡
__OPTIMIZE__


78 
__exã∫_Æways_ölöe
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


81  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

84 
__exã∫_Æways_ölöe
 const *

85 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


87  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifde‡
__USE_GNU


100 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

103 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

106 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

107 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

114 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

117 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

126 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

128 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

129 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

133 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

134 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

136 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

137 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

140 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

141 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

143 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

150 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

151 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

152 
__THROW
 
	`__n⁄nuŒ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifde‡
__USE_XOPEN2K8


159 
	~<xloˇÀ.h
>

162 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

163 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

165 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

166 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

169 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8


171 *
	$°rdup
 (c⁄° *
__s
)

172 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

178 #i‡
deföed
 
__USE_XOPEN2K8


179 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

180 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

183 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


185 
	#°rdu∑
(
s
) \

186 (
__exãnsi⁄__
 \

188 c⁄° *
__ﬁd
 = (
s
); \

189 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

190 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

191 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

192 
	}
}))

	)

195 
	#°∫du∑
(
s
, 
n
) \

196 (
__exãnsi⁄__
 \

198 c⁄° *
__ﬁd
 = (
s
); \

199 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

200 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

201 
__√w
[
__Àn
] = '\0'; \

202 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
°rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

213 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

216 #ifde‡
__OPTIMIZE__


217 
__exã∫_Æways_ölöe
 *

218 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


220  
__buûtö_°rchr
 (
__s
, 
__c
);

223 
__exã∫_Æways_ölöe
 const *

224 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


226  
__buûtö_°rchr
 (
__s
, 
__c
);

231 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

232 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

235 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`°ºchr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

240 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

243 #ifde‡
__OPTIMIZE__


244 
__exã∫_Æways_ölöe
 *

245 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


247  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

250 
__exã∫_Æways_ölöe
 const *

251 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


253  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

259 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifde‡
__USE_GNU


266 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

269 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

272 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

273 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

281 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

284 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

285 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

287 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

291 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

292 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

293 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

295 #ifde‡
__OPTIMIZE__


296 
__exã∫_Æways_ölöe
 *

297 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


299  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

302 
__exã∫_Æways_ölöe
 const *

303 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


305  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

308 
	}
}

310 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

311 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

314 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

318 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

319 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

320 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

322 #ifde‡
__OPTIMIZE__


323 
__exã∫_Æways_ölöe
 *

324 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


326  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

329 
__exã∫_Æways_ölöe
 const *

330 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


332  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

335 
	}
}

337 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

338 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

343 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

344 
__THROW
 
	`__n⁄nuŒ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

350 c⁄° *
__ª°ri˘
 
__dñim
,

351 **
__ª°ri˘
 
__ßve_±r
)

352 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

353 #ifde‡
__USE_POSIX


354 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

355 **
__ª°ri˘
 
__ßve_±r
)

356 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

359 #ifde‡
__USE_GNU


361 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

363 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

364 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

365 c⁄° *
__√edÀ
)

366 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

368 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

369 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

373 #ifde‡
__USE_GNU


377 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

378 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

379 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

383 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

384 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

385 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

386 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

387 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

388 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$°æí
 (c⁄° *
__s
)

395 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

402 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifde‡
__USE_XOPEN2K


418 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


421 #ifde‡
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

423 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

424 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

426 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

427 
__THROW
 
	`__n⁄nuŒ
 ((2));

428 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

433 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

434 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

438 #ifde‡
__USE_XOPEN2K8


440 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

446 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

448 #ifde‡
__USE_MISC


450 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

451 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

454 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

457 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

461 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`ödex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

466 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

469 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__exã∫_Æways_ölöe
 *

471 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


473  
	`__buûtö_ödex
 (
__s
, 
__c
);

476 
__exã∫_Æways_ölöe
 const *

477 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


479  
	`__buûtö_ödex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$ödex
 (c⁄° *
__s
, 
__c
)

485 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

489 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`rödex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

494 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

497 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__exã∫_Æways_ölöe
 *

499 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


501  
	`__buûtö_rödex
 (
__s
, 
__c
);

504 
__exã∫_Æways_ölöe
 const *

505 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


507  
	`__buûtö_rödex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$rödex
 (c⁄° *
__s
, 
__c
)

513 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

518 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

522 #ifdef 
__USE_GNU


523 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

524 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

525 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

529 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

530 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

533 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

541 
__loˇÀ_t
 
__loc
)

542 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

544 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

545 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

546 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

553 c⁄° *
__ª°ri˘
 
__dñim
)

554 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

562 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

563 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

564 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

565 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

569 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

570 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

571 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

572 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

573 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

574 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

580 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

583 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

586 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

588 #i‚de‡
ba£«me


593 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£«me
 (*
__fûíame
)

595 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

596 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

597 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

599 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

605 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

606 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

607 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


627 
	~<bôs/°rög.h
>

630 
	~<bôs/°rög2.h
>

633 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


635 
	~<bôs/°rög3.h
>

639 #i‡
deföed
 
__USE_GNU
 && deföed 
__OPTIMIZE__
 \

640 && 
deföed
 
__exã∫_Æways_ölöe
 && 
	$__GNUC_PREREQ
 (3,2)

641 #i‡!
deföed
 
_FORCE_INLINES
 && !deföed 
_HAVE_STRING_ARCH_memp˝y


643 #unde‡
memp˝y


644 #unde‡
__memp˝y


645 
	#memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

646 
	#__memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

648 
__exã∫_Æways_ölöe
 *

649 
	$__memp˝y_ölöe
 (*
__ª°ri˘
 
__de°
,

650 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

652  (*Ë
	`mem˝y
 (
__de°
, 
__§c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #unde‡
__USE_ISOC11


98 #unde‡
__USE_ISOC99


99 #unde‡
__USE_ISOC95


100 #unde‡
__USE_ISOCXX11


101 #unde‡
__USE_POSIX


102 #unde‡
__USE_POSIX2


103 #unde‡
__USE_POSIX199309


104 #unde‡
__USE_POSIX199506


105 #unde‡
__USE_XOPEN


106 #unde‡
__USE_XOPEN_EXTENDED


107 #unde‡
__USE_UNIX98


108 #unde‡
__USE_XOPEN2K


109 #unde‡
__USE_XOPEN2KXSI


110 #unde‡
__USE_XOPEN2K8


111 #unde‡
__USE_XOPEN2K8XSI


112 #unde‡
__USE_LARGEFILE


113 #unde‡
__USE_LARGEFILE64


114 #unde‡
__USE_FILE_OFFSET64


115 #unde‡
__USE_MISC


116 #unde‡
__USE_ATFILE


117 #unde‡
__USE_GNU


118 #unde‡
__USE_REENTRANT


119 #unde‡
__USE_FORTIFY_LEVEL


120 #unde‡
__KERNEL_STRICT_NAMES


124 #i‚de‡
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

137 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

146 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

147 && !
deföed
 
	g_DEFAULT_SOURCE


152 #unde‡
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifde‡
_GNU_SOURCE


158 #unde‡
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #unde‡
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #unde‡
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #unde‡
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #unde‡
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #unde‡
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #unde‡
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #unde‡
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #unde‡
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #unde‡
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

183 || (!
deföed
 
	g__STRICT_ANSI__
 \

184 && !
deföed
 
	g_ISOC99_SOURCE
 \

185 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

186 && !
deföed
 
	g_XOPEN_SOURCE
))

187 #unde‡
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #i‡(
deföed
 
_ISOC11_SOURCE
 \

193 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

199 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

205 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

214 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifde‡
_DEFAULT_SOURCE


222 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #unde‡
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #unde‡
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #i‡((!
deföed
 
__STRICT_ANSI__
 \

231 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #i‡(
deföed
 
_POSIX_SOURCE
 \

247 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
deföed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #unde‡
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #unde‡
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #unde‡
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #unde‡
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

286 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #unde‡
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #unde‡
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifde‡
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifde‡
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifde‡
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #i‡
deföed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #i‡
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #i‡
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<°dc-¥edef.h
>

353 #unde‡
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

362 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

365 #i‚de‡
__ASSEMBLER__


366 #i‚de‡
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

381 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

382 && 
deföed
 
	g__exã∫_ölöe


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/°ubs.h
>

	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
21
355
ext2fs.h
ext2fs_alloc.c
ext2fs_balloc.c
ext2fs_bmap.c
ext2fs_bswap.c
ext2fs_dinode.h
ext2fs_dir.h
ext2fs_extents.c
ext2fs_extents.h
ext2fs_extern.h
ext2fs_inode.c
ext2fs_lookup.c
ext2fs_readwrite.c
ext2fs_rename.c
ext2fs_subr.c
ext2fs_vfsops.c
ext2fs_vnops.c
/usr/include/string.h
/usr/include/features.h
/usr/include/xlocale.h
/usr/include/stdc-predef.h
